{"version":3,"sources":["../../../src/common/interceptors/audit-log.interceptor.ts"],"sourcesContent":["import {\r\n    Injectable,\r\n    NestInterceptor,\r\n    ExecutionContext,\r\n    CallHandler,\r\n} from '@nestjs/common';\r\nimport { Observable } from 'rxjs';\r\nimport { tap } from 'rxjs/operators';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport { AuditAction } from '../constants';\r\nimport * as crypto from 'crypto';\r\n\r\n@Injectable()\r\nexport class AuditLogInterceptor implements NestInterceptor {\r\n    constructor(private prisma: PrismaService) { }\r\n\r\n    intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\r\n        const request = context.switchToHttp().getRequest();\r\n        const user = request.user;\r\n        const method = request.method;\r\n        const url = request.url;\r\n        const ip = request.ip || request.headers['x-forwarded-for'];\r\n        const userAgent = request.headers['user-agent'];\r\n\r\n        // Determine action based on method\r\n        let action: AuditAction;\r\n        switch (method) {\r\n            case 'POST':\r\n                action = AuditAction.CREATE;\r\n                break;\r\n            case 'PUT':\r\n            case 'PATCH':\r\n                action = AuditAction.UPDATE;\r\n                break;\r\n            case 'DELETE':\r\n                action = AuditAction.DELETE;\r\n                break;\r\n            default:\r\n                return next.handle();\r\n        }\r\n\r\n        return next.handle().pipe(\r\n            tap(async (response) => {\r\n                // Only log mutations\r\n                if (['POST', 'PUT', 'PATCH', 'DELETE'].includes(method)) {\r\n                    try {\r\n                        await this.prisma.auditLog.create({\r\n                            data: {\r\n                                id: crypto.randomUUID(),\r\n                                userId: user?.sub || user?.id,\r\n                                action,\r\n                                entityType: this.extractEntityType(url),\r\n                                entityId: response?.id || response?.data?.id || 'unknown',\r\n                                newValue: method !== 'DELETE' ? response : undefined,\r\n                                metadata: {\r\n                                    ip,\r\n                                    userAgent,\r\n                                    url,\r\n                                    method,\r\n                                },\r\n                            },\r\n                        });\r\n                    } catch (error) {\r\n                        // Don't fail the request if audit logging fails\r\n                        console.error('Audit log failed:', error);\r\n                    }\r\n                }\r\n            }),\r\n        );\r\n    }\r\n\r\n    private extractEntityType(url: string): string {\r\n        // Extract entity type from URL (e.g., /api/v1/jobs/123 -> Job)\r\n        const parts = url.split('/').filter(Boolean);\r\n        const entityIndex = parts.findIndex((p) => p === 'v1') + 1;\r\n        const entity = parts[entityIndex] || 'Unknown';\r\n        return entity.charAt(0).toUpperCase() + entity.slice(1, -1);\r\n    }\r\n}\r\n"],"names":["AuditLogInterceptor","intercept","context","next","request","switchToHttp","getRequest","user","method","url","ip","headers","userAgent","action","AuditAction","CREATE","UPDATE","DELETE","handle","pipe","tap","response","includes","prisma","auditLog","create","data","id","crypto","randomUUID","userId","sub","entityType","extractEntityType","entityId","newValue","undefined","metadata","error","console","parts","split","filter","Boolean","entityIndex","findIndex","p","entity","charAt","toUpperCase","slice"],"mappings":";;;;+BAaaA;;;eAAAA;;;wBARN;2BAEa;+BACU;2BACF;gEACJ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGjB,IAAA,AAAMA,sBAAN,MAAMA;IAGTC,UAAUC,OAAyB,EAAEC,IAAiB,EAAmB;QACrE,MAAMC,UAAUF,QAAQG,YAAY,GAAGC,UAAU;QACjD,MAAMC,OAAOH,QAAQG,IAAI;QACzB,MAAMC,SAASJ,QAAQI,MAAM;QAC7B,MAAMC,MAAML,QAAQK,GAAG;QACvB,MAAMC,KAAKN,QAAQM,EAAE,IAAIN,QAAQO,OAAO,CAAC,kBAAkB;QAC3D,MAAMC,YAAYR,QAAQO,OAAO,CAAC,aAAa;QAE/C,mCAAmC;QACnC,IAAIE;QACJ,OAAQL;YACJ,KAAK;gBACDK,SAASC,sBAAW,CAACC,MAAM;gBAC3B;YACJ,KAAK;YACL,KAAK;gBACDF,SAASC,sBAAW,CAACE,MAAM;gBAC3B;YACJ,KAAK;gBACDH,SAASC,sBAAW,CAACG,MAAM;gBAC3B;YACJ;gBACI,OAAOd,KAAKe,MAAM;QAC1B;QAEA,OAAOf,KAAKe,MAAM,GAAGC,IAAI,CACrBC,IAAAA,cAAG,EAAC,OAAOC;YACP,qBAAqB;YACrB,IAAI;gBAAC;gBAAQ;gBAAO;gBAAS;aAAS,CAACC,QAAQ,CAACd,SAAS;gBACrD,IAAI;oBACA,MAAM,IAAI,CAACe,MAAM,CAACC,QAAQ,CAACC,MAAM,CAAC;wBAC9BC,MAAM;4BACFC,IAAIC,QAAOC,UAAU;4BACrBC,QAAQvB,MAAMwB,OAAOxB,MAAMoB;4BAC3Bd;4BACAmB,YAAY,IAAI,CAACC,iBAAiB,CAACxB;4BACnCyB,UAAUb,UAAUM,MAAMN,UAAUK,MAAMC,MAAM;4BAChDQ,UAAU3B,WAAW,WAAWa,WAAWe;4BAC3CC,UAAU;gCACN3B;gCACAE;gCACAH;gCACAD;4BACJ;wBACJ;oBACJ;gBACJ,EAAE,OAAO8B,OAAO;oBACZ,gDAAgD;oBAChDC,QAAQD,KAAK,CAAC,qBAAqBA;gBACvC;YACJ;QACJ;IAER;IAEQL,kBAAkBxB,GAAW,EAAU;QAC3C,+DAA+D;QAC/D,MAAM+B,QAAQ/B,IAAIgC,KAAK,CAAC,KAAKC,MAAM,CAACC;QACpC,MAAMC,cAAcJ,MAAMK,SAAS,CAAC,CAACC,IAAMA,MAAM,QAAQ;QACzD,MAAMC,SAASP,KAAK,CAACI,YAAY,IAAI;QACrC,OAAOG,OAAOC,MAAM,CAAC,GAAGC,WAAW,KAAKF,OAAOG,KAAK,CAAC,GAAG,CAAC;IAC7D;IA/DA,YAAY,AAAQ3B,MAAqB,CAAE;aAAvBA,SAAAA;IAAyB;AAgEjD"}