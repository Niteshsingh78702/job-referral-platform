{"version":3,"sources":["../../../../src/modules/auth/services/google-auth.service.ts"],"sourcesContent":["import { Injectable, Logger, UnauthorizedException } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\n\r\ninterface GoogleTokenPayload {\r\n    sub: string; // Google user ID\r\n    email: string;\r\n    email_verified: boolean;\r\n    name?: string;\r\n    given_name?: string;\r\n    family_name?: string;\r\n    picture?: string;\r\n}\r\n\r\n@Injectable()\r\nexport class GoogleAuthService {\r\n    private readonly logger = new Logger(GoogleAuthService.name);\r\n    private readonly clientId: string;\r\n\r\n    constructor(private configService: ConfigService) {\r\n        this.clientId = this.configService.get('GOOGLE_CLIENT_ID', '');\r\n        if (!this.clientId) {\r\n            this.logger.warn('GOOGLE_CLIENT_ID not configured. Google Sign-In will not work.');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Verify Google ID token and extract user info\r\n     * Uses Google's tokeninfo endpoint for simplicity (no additional dependencies)\r\n     */\r\n    async verifyIdToken(idToken: string): Promise<GoogleTokenPayload> {\r\n        if (!this.clientId) {\r\n            throw new UnauthorizedException('Google Sign-In is not configured');\r\n        }\r\n\r\n        try {\r\n            // Use Google's tokeninfo endpoint to verify the token\r\n            const response = await fetch(\r\n                `https://oauth2.googleapis.com/tokeninfo?id_token=${idToken}`,\r\n            );\r\n\r\n            if (!response.ok) {\r\n                throw new UnauthorizedException('Invalid Google token');\r\n            }\r\n\r\n            const payload = await response.json();\r\n\r\n            // Verify the token was issued for our app\r\n            if (payload.aud !== this.clientId) {\r\n                this.logger.warn('Token audience mismatch');\r\n                throw new UnauthorizedException('Invalid token audience');\r\n            }\r\n\r\n            // Check token expiration\r\n            const expiry = parseInt(payload.exp, 10) * 1000;\r\n            if (Date.now() > expiry) {\r\n                throw new UnauthorizedException('Token has expired');\r\n            }\r\n\r\n            return {\r\n                sub: payload.sub,\r\n                email: payload.email,\r\n                email_verified: payload.email_verified === 'true',\r\n                name: payload.name,\r\n                given_name: payload.given_name,\r\n                family_name: payload.family_name,\r\n                picture: payload.picture,\r\n            };\r\n        } catch (error) {\r\n            if (error instanceof UnauthorizedException) {\r\n                throw error;\r\n            }\r\n            this.logger.error('Failed to verify Google token:', error);\r\n            throw new UnauthorizedException('Failed to verify Google token');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check if Google OAuth is configured\r\n     */\r\n    isConfigured(): boolean {\r\n        return !!this.clientId;\r\n    }\r\n}\r\n"],"names":["GoogleAuthService","verifyIdToken","idToken","clientId","UnauthorizedException","response","fetch","ok","payload","json","aud","logger","warn","expiry","parseInt","exp","Date","now","sub","email","email_verified","name","given_name","family_name","picture","error","isConfigured","configService","Logger","get"],"mappings":";;;;+BAcaA;;;eAAAA;;;wBAd6C;wBAC5B;;;;;;;;;;AAavB,IAAA,AAAMA,oBAAN,MAAMA;IAWT;;;KAGC,GACD,MAAMC,cAAcC,OAAe,EAA+B;QAC9D,IAAI,CAAC,IAAI,CAACC,QAAQ,EAAE;YAChB,MAAM,IAAIC,6BAAqB,CAAC;QACpC;QAEA,IAAI;YACA,sDAAsD;YACtD,MAAMC,WAAW,MAAMC,MACnB,CAAC,iDAAiD,EAAEJ,SAAS;YAGjE,IAAI,CAACG,SAASE,EAAE,EAAE;gBACd,MAAM,IAAIH,6BAAqB,CAAC;YACpC;YAEA,MAAMI,UAAU,MAAMH,SAASI,IAAI;YAEnC,0CAA0C;YAC1C,IAAID,QAAQE,GAAG,KAAK,IAAI,CAACP,QAAQ,EAAE;gBAC/B,IAAI,CAACQ,MAAM,CAACC,IAAI,CAAC;gBACjB,MAAM,IAAIR,6BAAqB,CAAC;YACpC;YAEA,yBAAyB;YACzB,MAAMS,SAASC,SAASN,QAAQO,GAAG,EAAE,MAAM;YAC3C,IAAIC,KAAKC,GAAG,KAAKJ,QAAQ;gBACrB,MAAM,IAAIT,6BAAqB,CAAC;YACpC;YAEA,OAAO;gBACHc,KAAKV,QAAQU,GAAG;gBAChBC,OAAOX,QAAQW,KAAK;gBACpBC,gBAAgBZ,QAAQY,cAAc,KAAK;gBAC3CC,MAAMb,QAAQa,IAAI;gBAClBC,YAAYd,QAAQc,UAAU;gBAC9BC,aAAaf,QAAQe,WAAW;gBAChCC,SAAShB,QAAQgB,OAAO;YAC5B;QACJ,EAAE,OAAOC,OAAO;YACZ,IAAIA,iBAAiBrB,6BAAqB,EAAE;gBACxC,MAAMqB;YACV;YACA,IAAI,CAACd,MAAM,CAACc,KAAK,CAAC,kCAAkCA;YACpD,MAAM,IAAIrB,6BAAqB,CAAC;QACpC;IACJ;IAEA;;KAEC,GACDsB,eAAwB;QACpB,OAAO,CAAC,CAAC,IAAI,CAACvB,QAAQ;IAC1B;IA/DA,YAAY,AAAQwB,aAA4B,CAAE;aAA9BA,gBAAAA;aAHHhB,SAAS,IAAIiB,cAAM,CAAC5B,kBAAkBqB,IAAI;QAIvD,IAAI,CAAClB,QAAQ,GAAG,IAAI,CAACwB,aAAa,CAACE,GAAG,CAAC,oBAAoB;QAC3D,IAAI,CAAC,IAAI,CAAC1B,QAAQ,EAAE;YAChB,IAAI,CAACQ,MAAM,CAACC,IAAI,CAAC;QACrB;IACJ;AA2DJ"}