{"version":3,"sources":["../../../../src/modules/auth/services/google-auth.service.ts"],"sourcesContent":["import { Injectable, Logger, UnauthorizedException } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\n\r\ninterface GoogleTokenPayload {\r\n  sub: string; // Google user ID\r\n  email: string;\r\n  email_verified: boolean;\r\n  name?: string;\r\n  given_name?: string;\r\n  family_name?: string;\r\n  picture?: string;\r\n}\r\n\r\n@Injectable()\r\nexport class GoogleAuthService {\r\n  private readonly logger = new Logger(GoogleAuthService.name);\r\n  private readonly clientId: string;\r\n\r\n  constructor(private configService: ConfigService) {\r\n    this.clientId = this.configService.get('GOOGLE_CLIENT_ID', '');\r\n    if (!this.clientId) {\r\n      this.logger.warn(\r\n        'GOOGLE_CLIENT_ID not configured. Google Sign-In will not work.',\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verify Google ID token and extract user info\r\n   * Uses Google's tokeninfo endpoint for simplicity (no additional dependencies)\r\n   */\r\n  async verifyIdToken(idToken: string): Promise<GoogleTokenPayload> {\r\n    if (!this.clientId) {\r\n      throw new UnauthorizedException('Google Sign-In is not configured');\r\n    }\r\n\r\n    try {\r\n      // Use Google's tokeninfo endpoint to verify the token\r\n      const response = await fetch(\r\n        `https://oauth2.googleapis.com/tokeninfo?id_token=${idToken}`,\r\n      );\r\n\r\n      if (!response.ok) {\r\n        throw new UnauthorizedException('Invalid Google token');\r\n      }\r\n\r\n      const payload = await response.json();\r\n\r\n      // Verify the token was issued for our app\r\n      if (payload.aud !== this.clientId) {\r\n        this.logger.warn('Token audience mismatch');\r\n        throw new UnauthorizedException('Invalid token audience');\r\n      }\r\n\r\n      // Check token expiration\r\n      const expiry = parseInt(payload.exp, 10) * 1000;\r\n      if (Date.now() > expiry) {\r\n        throw new UnauthorizedException('Token has expired');\r\n      }\r\n\r\n      return {\r\n        sub: payload.sub,\r\n        email: payload.email,\r\n        email_verified: payload.email_verified === 'true',\r\n        name: payload.name,\r\n        given_name: payload.given_name,\r\n        family_name: payload.family_name,\r\n        picture: payload.picture,\r\n      };\r\n    } catch (error) {\r\n      if (error instanceof UnauthorizedException) {\r\n        throw error;\r\n      }\r\n      this.logger.error('Failed to verify Google token:', error);\r\n      throw new UnauthorizedException('Failed to verify Google token');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if Google OAuth is configured\r\n   */\r\n  isConfigured(): boolean {\r\n    return !!this.clientId;\r\n  }\r\n}\r\n"],"names":["GoogleAuthService","verifyIdToken","idToken","clientId","UnauthorizedException","response","fetch","ok","payload","json","aud","logger","warn","expiry","parseInt","exp","Date","now","sub","email","email_verified","name","given_name","family_name","picture","error","isConfigured","configService","Logger","get"],"mappings":";;;;+BAcaA;;;eAAAA;;;wBAd6C;wBAC5B;;;;;;;;;;AAavB,IAAA,AAAMA,oBAAN,MAAMA;IAaX;;;GAGC,GACD,MAAMC,cAAcC,OAAe,EAA+B;QAChE,IAAI,CAAC,IAAI,CAACC,QAAQ,EAAE;YAClB,MAAM,IAAIC,6BAAqB,CAAC;QAClC;QAEA,IAAI;YACF,sDAAsD;YACtD,MAAMC,WAAW,MAAMC,MACrB,CAAC,iDAAiD,EAAEJ,SAAS;YAG/D,IAAI,CAACG,SAASE,EAAE,EAAE;gBAChB,MAAM,IAAIH,6BAAqB,CAAC;YAClC;YAEA,MAAMI,UAAU,MAAMH,SAASI,IAAI;YAEnC,0CAA0C;YAC1C,IAAID,QAAQE,GAAG,KAAK,IAAI,CAACP,QAAQ,EAAE;gBACjC,IAAI,CAACQ,MAAM,CAACC,IAAI,CAAC;gBACjB,MAAM,IAAIR,6BAAqB,CAAC;YAClC;YAEA,yBAAyB;YACzB,MAAMS,SAASC,SAASN,QAAQO,GAAG,EAAE,MAAM;YAC3C,IAAIC,KAAKC,GAAG,KAAKJ,QAAQ;gBACvB,MAAM,IAAIT,6BAAqB,CAAC;YAClC;YAEA,OAAO;gBACLc,KAAKV,QAAQU,GAAG;gBAChBC,OAAOX,QAAQW,KAAK;gBACpBC,gBAAgBZ,QAAQY,cAAc,KAAK;gBAC3CC,MAAMb,QAAQa,IAAI;gBAClBC,YAAYd,QAAQc,UAAU;gBAC9BC,aAAaf,QAAQe,WAAW;gBAChCC,SAAShB,QAAQgB,OAAO;YAC1B;QACF,EAAE,OAAOC,OAAO;YACd,IAAIA,iBAAiBrB,6BAAqB,EAAE;gBAC1C,MAAMqB;YACR;YACA,IAAI,CAACd,MAAM,CAACc,KAAK,CAAC,kCAAkCA;YACpD,MAAM,IAAIrB,6BAAqB,CAAC;QAClC;IACF;IAEA;;GAEC,GACDsB,eAAwB;QACtB,OAAO,CAAC,CAAC,IAAI,CAACvB,QAAQ;IACxB;IAjEA,YAAY,AAAQwB,aAA4B,CAAE;aAA9BA,gBAAAA;aAHHhB,SAAS,IAAIiB,cAAM,CAAC5B,kBAAkBqB,IAAI;QAIzD,IAAI,CAAClB,QAAQ,GAAG,IAAI,CAACwB,aAAa,CAACE,GAAG,CAAC,oBAAoB;QAC3D,IAAI,CAAC,IAAI,CAAC1B,QAAQ,EAAE;YAClB,IAAI,CAACQ,MAAM,CAACC,IAAI,CACd;QAEJ;IACF;AA2DF"}