{"version":3,"sources":["../../../../src/modules/auth/services/otp.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport Redis from 'ioredis';\r\nimport { REDIS_KEYS } from '../../../common/constants';\r\n\r\n@Injectable()\r\nexport class OtpService {\r\n  private redis: Redis | null = null;\r\n  private readonly logger = new Logger(OtpService.name);\r\n  private otpExpiry: number;\r\n  private otpLength: number;\r\n  // In-memory fallback\r\n  private otpStore: Map<string, { otp: string; expiry: number }> = new Map();\r\n\r\n  constructor(private configService: ConfigService) {\r\n    this.otpExpiry = this.configService.get('OTP_EXPIRY_MINUTES', 10) * 60;\r\n    this.otpLength = this.configService.get('OTP_LENGTH', 6);\r\n    this.initRedis();\r\n  }\r\n\r\n  private initRedis(): void {\r\n    const redisUrl = this.configService.get('REDIS_URL');\r\n    const redisHost = this.configService.get('REDIS_HOST');\r\n\r\n    if (redisUrl || redisHost) {\r\n      try {\r\n        if (redisUrl) {\r\n          this.redis = new Redis(redisUrl);\r\n        } else {\r\n          this.redis = new Redis({\r\n            host: redisHost || 'localhost',\r\n            port: this.configService.get('REDIS_PORT', 6379),\r\n            password: this.configService.get('REDIS_PASSWORD'),\r\n          });\r\n        }\r\n\r\n        this.redis.on('error', (err) => {\r\n          this.logger.warn(`Redis error: ${err.message}. Using in-memory.`);\r\n          this.redis = null;\r\n        });\r\n      } catch {\r\n        this.logger.warn('Redis not available. Using in-memory OTP storage.');\r\n      }\r\n    }\r\n  }\r\n\r\n  // Generate OTP\r\n  generateOtp(): string {\r\n    const digits = '0123456789';\r\n    let otp = '';\r\n    for (let i = 0; i < this.otpLength; i++) {\r\n      otp += digits[Math.floor(Math.random() * 10)];\r\n    }\r\n    return otp;\r\n  }\r\n\r\n  // Store OTP\r\n  async storeOtp(userId: string, type: string, otp: string): Promise<void> {\r\n    const key = REDIS_KEYS.OTP(userId, type);\r\n\r\n    if (this.redis) {\r\n      try {\r\n        await this.redis.set(key, otp, 'EX', this.otpExpiry);\r\n        return;\r\n      } catch {\r\n        // Fall through to in-memory\r\n      }\r\n    }\r\n\r\n    this.otpStore.set(key, {\r\n      otp,\r\n      expiry: Date.now() + this.otpExpiry * 1000,\r\n    });\r\n  }\r\n\r\n  // Verify OTP\r\n  async verifyOtp(userId: string, type: string, otp: string): Promise<boolean> {\r\n    const key = REDIS_KEYS.OTP(userId, type);\r\n\r\n    if (this.redis) {\r\n      try {\r\n        const storedOtp = await this.redis.get(key);\r\n        if (!storedOtp || storedOtp !== otp) {\r\n          return false;\r\n        }\r\n        await this.redis.del(key);\r\n        return true;\r\n      } catch {\r\n        // Fall through to in-memory\r\n      }\r\n    }\r\n\r\n    const stored = this.otpStore.get(key);\r\n    if (!stored || stored.otp !== otp) {\r\n      return false;\r\n    }\r\n    if (Date.now() > stored.expiry) {\r\n      this.otpStore.delete(key);\r\n      return false;\r\n    }\r\n    this.otpStore.delete(key);\r\n    return true;\r\n  }\r\n\r\n  // Invalidate OTP\r\n  async invalidateOtp(userId: string, type: string): Promise<void> {\r\n    const key = REDIS_KEYS.OTP(userId, type);\r\n\r\n    if (this.redis) {\r\n      try {\r\n        await this.redis.del(key);\r\n      } catch {\r\n        this.otpStore.delete(key);\r\n      }\r\n    } else {\r\n      this.otpStore.delete(key);\r\n    }\r\n  }\r\n\r\n  // Check if OTP exists\r\n  async hasOtp(userId: string, type: string): Promise<boolean> {\r\n    const key = REDIS_KEYS.OTP(userId, type);\r\n\r\n    if (this.redis) {\r\n      try {\r\n        const exists = await this.redis.exists(key);\r\n        return exists === 1;\r\n      } catch {\r\n        // Fall through\r\n      }\r\n    }\r\n\r\n    const stored = this.otpStore.get(key);\r\n    if (!stored) return false;\r\n    if (Date.now() > stored.expiry) {\r\n      this.otpStore.delete(key);\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n}\r\n"],"names":["OtpService","initRedis","redisUrl","configService","get","redisHost","redis","Redis","host","port","password","on","err","logger","warn","message","generateOtp","digits","otp","i","otpLength","Math","floor","random","storeOtp","userId","type","key","REDIS_KEYS","OTP","set","otpExpiry","otpStore","expiry","Date","now","verifyOtp","storedOtp","del","stored","delete","invalidateOtp","hasOtp","exists","Logger","name","Map"],"mappings":"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"}