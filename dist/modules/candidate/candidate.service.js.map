{"version":3,"sources":["../../../src/modules/candidate/candidate.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  NotFoundException,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport {\r\n  UpdateCandidateProfileDto,\r\n  AddSkillDto,\r\n  AddExperienceDto,\r\n  AddEducationDto,\r\n} from './dto';\r\nimport { ApplicationStatus } from '../../common/constants';\r\n\r\n@Injectable()\r\nexport class CandidateService {\r\n  constructor(private prisma: PrismaService) { }\r\n\r\n  // Get candidate profile\r\n  async getProfile(userId: string) {\r\n    const candidate = await this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n      include: {\r\n        CandidateSkill: true,\r\n        Experience: {\r\n          orderBy: { startDate: 'desc' },\r\n        },\r\n        Education: {\r\n          orderBy: { startYear: 'desc' },\r\n        },\r\n        User: {\r\n          select: {\r\n            email: true,\r\n            phone: true,\r\n            emailVerified: true,\r\n            phoneVerified: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!candidate) {\r\n      throw new NotFoundException('Candidate profile not found');\r\n    }\r\n\r\n    return candidate;\r\n  }\r\n\r\n  // Update profile\r\n  async updateProfile(userId: string, dto: UpdateCandidateProfileDto) {\r\n    const candidate = await this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!candidate) {\r\n      throw new NotFoundException('Candidate profile not found');\r\n    }\r\n\r\n    // Extract phone from DTO (phone is stored in User table)\r\n    const { phone, linkedIn, ...candidateData } = dto;\r\n\r\n    // Use transaction to update both User and Candidate\r\n    const result = await this.prisma.$transaction(async (tx) => {\r\n      // Update phone in User table if provided\r\n      if (phone !== undefined) {\r\n        await tx.user.update({\r\n          where: { id: userId },\r\n          data: { phone },\r\n        });\r\n      }\r\n\r\n      // Update candidate data (including linkedIn)\r\n      const updatedCandidate = await tx.candidate.update({\r\n        where: { userId },\r\n        data: {\r\n          ...candidateData,\r\n          linkedIn,\r\n        },\r\n        include: {\r\n          CandidateSkill: true,\r\n          Experience: true,\r\n          Education: true,\r\n          User: {\r\n            select: {\r\n              email: true,\r\n              phone: true,\r\n            },\r\n          },\r\n        },\r\n      });\r\n\r\n      return updatedCandidate;\r\n    });\r\n\r\n    return result;\r\n  }\r\n\r\n  // Upload resume\r\n  async updateResume(userId: string, resumeUrl: string) {\r\n    return this.prisma.candidate.update({\r\n      where: { userId },\r\n      data: { resumeUrl },\r\n    });\r\n  }\r\n\r\n  // Upload resume with parsed data from Cloudinary\r\n  async updateResumeWithParsedData(\r\n    userId: string,\r\n    resumeUrl: string,\r\n    cloudinaryPublicId: string,\r\n    parsedData: {\r\n      JobSkill: string[];\r\n      experience: { years: number; positions: string[] };\r\n      education: string[];\r\n    },\r\n  ) {\r\n    const candidate = await this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!candidate) {\r\n      throw new NotFoundException('Candidate profile not found');\r\n    }\r\n\r\n    // Update candidate with resume URL\r\n    const updatedCandidate = await this.prisma.candidate.update({\r\n      where: { userId },\r\n      data: {\r\n        resumeUrl,\r\n        // Store Cloudinary public ID for future deletion\r\n        // You may want to add this field to your schema\r\n      },\r\n    });\r\n\r\n    // Auto-add parsed skills if they don't exist\r\n    const skills = parsedData.JobSkill || [];\r\n    for (const skillName of skills.slice(0, 10)) {\r\n      // Limit to 10 skills\r\n      const existingSkill = await this.prisma.candidateSkill.findFirst({\r\n        where: {\r\n          candidateId: candidate.id,\r\n          name: { equals: skillName, mode: 'insensitive' },\r\n        },\r\n      });\r\n\r\n      if (!existingSkill) {\r\n        await this.prisma.candidateSkill.create({\r\n          data: {\r\n            id: uuidv4(),\r\n            candidateId: candidate.id,\r\n            name: skillName,\r\n            level: 3, // Default mid-level\r\n          },\r\n        });\r\n      }\r\n    }\r\n\r\n    return this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n      include: {\r\n        CandidateSkill: true,\r\n        Experience: true,\r\n        Education: true,\r\n      },\r\n    });\r\n  }\r\n\r\n  // Add skill\r\n  async addSkill(userId: string, dto: AddSkillDto) {\r\n    console.log(`Adding skill for user ${userId}:`, dto);\r\n    try {\r\n      const candidate = await this.prisma.candidate.findUnique({\r\n        where: { userId },\r\n      });\r\n\r\n      if (!candidate) {\r\n        console.error(`Candidate profile not found for user ${userId}`);\r\n        throw new NotFoundException('Candidate profile not found');\r\n      }\r\n\r\n      // Use upsert to handle duplicates gracefully\r\n      return await this.prisma.candidateSkill.upsert({\r\n        where: {\r\n          candidateId_name: {\r\n            candidateId: candidate.id,\r\n            name: dto.name,\r\n          },\r\n        },\r\n        update: {\r\n          level: dto.level || 1,\r\n          yearsOfExp: dto.yearsOfExp,\r\n        },\r\n        create: {\r\n          id: uuidv4(),\r\n          candidateId: candidate.id,\r\n          name: dto.name,\r\n          level: dto.level || 1,\r\n          yearsOfExp: dto.yearsOfExp,\r\n        },\r\n      });\r\n    } catch (error) {\r\n      console.error('Error adding skill:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Remove skill\r\n  async removeSkill(userId: string, skillId: string) {\r\n    const candidate = await this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!candidate) {\r\n      throw new NotFoundException('Candidate profile not found');\r\n    }\r\n\r\n    return this.prisma.candidateSkill.delete({\r\n      where: {\r\n        id: skillId,\r\n        candidateId: candidate.id,\r\n      },\r\n    });\r\n  }\r\n\r\n  // Add experience\r\n  async addExperience(userId: string, dto: AddExperienceDto) {\r\n    const candidate = await this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!candidate) {\r\n      throw new NotFoundException('Candidate profile not found');\r\n    }\r\n\r\n    return this.prisma.experience.create({\r\n      data: {\r\n        id: uuidv4(),\r\n        candidateId: candidate.id,\r\n        company: dto.company,\r\n        role: dto.role,\r\n        description: dto.description,\r\n        location: dto.location,\r\n        startDate: new Date(dto.startDate),\r\n        endDate: dto.endDate ? new Date(dto.endDate) : null,\r\n        isCurrent: dto.isCurrent || false,\r\n      },\r\n    });\r\n  }\r\n\r\n  // Remove experience\r\n  async removeExperience(userId: string, experienceId: string) {\r\n    const candidate = await this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!candidate) {\r\n      throw new NotFoundException('Candidate profile not found');\r\n    }\r\n\r\n    return this.prisma.experience.delete({\r\n      where: {\r\n        id: experienceId,\r\n        candidateId: candidate.id,\r\n      },\r\n    });\r\n  }\r\n\r\n  // Add education\r\n  async addEducation(userId: string, dto: AddEducationDto) {\r\n    const candidate = await this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!candidate) {\r\n      throw new NotFoundException('Candidate profile not found');\r\n    }\r\n\r\n    return this.prisma.education.create({\r\n      data: {\r\n        id: uuidv4(),\r\n        candidateId: candidate.id,\r\n        institution: dto.institution,\r\n        degree: dto.degree,\r\n        field: dto.field,\r\n        grade: dto.grade,\r\n        startYear: dto.startYear,\r\n        endYear: dto.endYear,\r\n      },\r\n    });\r\n  }\r\n\r\n  // Remove education\r\n  async removeEducation(userId: string, educationId: string) {\r\n    const candidate = await this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!candidate) {\r\n      throw new NotFoundException('Candidate profile not found');\r\n    }\r\n\r\n    return this.prisma.education.delete({\r\n      where: {\r\n        id: educationId,\r\n        candidateId: candidate.id,\r\n      },\r\n    });\r\n  }\r\n\r\n  // Get applications\r\n  async getApplications(userId: string, status?: ApplicationStatus) {\r\n    const candidate = await this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!candidate) {\r\n      throw new NotFoundException('Candidate profile not found');\r\n    }\r\n\r\n    return this.prisma.jobApplication.findMany({\r\n      where: {\r\n        candidateId: candidate.id,\r\n        ...(status && { status }),\r\n      },\r\n      include: {\r\n        Job: {\r\n          select: {\r\n            id: true,\r\n            title: true,\r\n            companyName: true,\r\n            location: true,\r\n            salaryMin: true,\r\n            salaryMax: true,\r\n            status: true,\r\n            skillBucketId: true,\r\n          },\r\n        },\r\n        Referral: {\r\n          select: {\r\n            status: true,\r\n            type: true,\r\n          },\r\n        },\r\n        Payment: {\r\n          select: {\r\n            status: true,\r\n            amount: true,\r\n            paidAt: true,\r\n          },\r\n        },\r\n        Interview: {\r\n          select: {\r\n            id: true,\r\n            status: true,\r\n            paymentStatus: true,\r\n            scheduledAt: true,\r\n            scheduledDate: true,\r\n            scheduledTime: true,\r\n            mode: true,\r\n            hrNotes: true,\r\n            interviewLink: true,\r\n            callDetails: true,\r\n            paidAt: true,\r\n          },\r\n        },\r\n        TestSession: {\r\n          select: {\r\n            id: true,\r\n            status: true,\r\n            score: true,\r\n            isPassed: true,\r\n            submittedAt: true,\r\n          },\r\n          take: 1,\r\n          orderBy: { createdAt: 'desc' },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  // Withdraw/Cancel an application\r\n  async withdrawApplication(userId: string, applicationId: string) {\r\n    const candidate = await this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!candidate) {\r\n      throw new NotFoundException('Candidate profile not found');\r\n    }\r\n\r\n    // Find the application and verify ownership\r\n    const application = await this.prisma.jobApplication.findUnique({\r\n      where: { id: applicationId },\r\n      include: {\r\n        Job: { select: { title: true, companyName: true } },\r\n        Interview: { select: { status: true, paymentStatus: true } },\r\n        Payment: { select: { status: true } },\r\n      },\r\n    });\r\n\r\n    if (!application) {\r\n      throw new NotFoundException('Application not found');\r\n    }\r\n\r\n    if (application.candidateId !== candidate.id) {\r\n      throw new BadRequestException('You can only withdraw your own applications');\r\n    }\r\n\r\n    // Prevent withdrawal if already in advanced stages\r\n    const nonWithdrawableStatuses = [\r\n      'PAYMENT_SUCCESS',\r\n      'INTERVIEW_COMPLETED',\r\n      'SELECTED',\r\n      'INTERVIEW_REJECTED',\r\n      'WITHDRAWN',\r\n    ];\r\n\r\n    if (nonWithdrawableStatuses.includes(application.status)) {\r\n      throw new BadRequestException(\r\n        `Cannot withdraw application with status: ${application.status}. This application has progressed too far.`\r\n      );\r\n    }\r\n\r\n    // Check if payment has been made (Payment is an array)\r\n    const payment = application.Payment?.[0];\r\n    if (payment?.status === 'SUCCESS' || application.Interview?.paymentStatus === 'SUCCESS') {\r\n      throw new BadRequestException(\r\n        'Cannot withdraw after payment has been made. Please contact support for refund.'\r\n      );\r\n    }\r\n\r\n    // Update application status to WITHDRAWN\r\n    const updatedApplication = await this.prisma.jobApplication.update({\r\n      where: { id: applicationId },\r\n      data: {\r\n        status: 'WITHDRAWN' as any,\r\n        updatedAt: new Date(),\r\n      },\r\n      include: {\r\n        Job: { select: { title: true, companyName: true } },\r\n      },\r\n    });\r\n\r\n    const jobTitle = (updatedApplication as any).Job?.title;\r\n    const companyName = (updatedApplication as any).Job?.companyName;\r\n    console.log(`Application withdrawn: ${applicationId} for job ${jobTitle} at ${companyName}`);\r\n\r\n    return {\r\n      message: `Application for ${jobTitle} at ${companyName} has been withdrawn.`,\r\n      applicationId,\r\n      jobId: application.jobId,\r\n      withdrawnAt: new Date().toISOString(),\r\n    };\r\n  }\r\n\r\n  // Get test history\r\n  async getTestHistory(userId: string) {\r\n    const candidate = await this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!candidate) {\r\n      throw new NotFoundException('Candidate profile not found');\r\n    }\r\n\r\n    const applications = await this.prisma.jobApplication.findMany({\r\n      where: { candidateId: candidate.id },\r\n      select: { id: true },\r\n    });\r\n\r\n    const applicationIds = applications.map((a) => a.id);\r\n\r\n    return this.prisma.testSession.findMany({\r\n      where: {\r\n        applicationId: { in: applicationIds },\r\n      },\r\n      include: {\r\n        Test: {\r\n          select: {\r\n            title: true,\r\n            duration: true,\r\n            passingScore: true,\r\n          },\r\n        },\r\n        JobApplication: {\r\n          include: {\r\n            Job: {\r\n              select: {\r\n                title: true,\r\n                companyName: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  // Get payment history\r\n  async getPaymentHistory(userId: string) {\r\n    const candidate = await this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!candidate) {\r\n      throw new NotFoundException('Candidate profile not found');\r\n    }\r\n\r\n    const applications = await this.prisma.jobApplication.findMany({\r\n      where: { candidateId: candidate.id },\r\n      select: { id: true },\r\n    });\r\n\r\n    const applicationIds = applications.map((a) => a.id);\r\n\r\n    return this.prisma.payment.findMany({\r\n      where: {\r\n        applicationId: { in: applicationIds },\r\n      },\r\n      include: {\r\n        JobApplication: {\r\n          include: {\r\n            Job: {\r\n              select: {\r\n                title: true,\r\n                companyName: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n        Refund: true,\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  // Delete own account\r\n  async deleteAccount(userId: string) {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n      include: {\r\n        Candidate: true,\r\n      },\r\n    });\r\n\r\n    if (!user || !user.Candidate) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n\r\n    await this.prisma.$transaction(async (tx) => {\r\n      // Delete related authentication and session records\r\n      await tx.oTPToken.deleteMany({ where: { userId } });\r\n      await tx.refreshToken.deleteMany({ where: { userId } });\r\n      await tx.passwordResetToken.deleteMany({ where: { userId } });\r\n      await tx.deviceLog.deleteMany({ where: { userId } });\r\n      await tx.notification.deleteMany({ where: { userId } });\r\n\r\n      // Nullify audit logs (don't delete, keep for records)\r\n      await tx.auditLog.updateMany({\r\n        where: { userId },\r\n        data: { userId: null },\r\n      });\r\n\r\n      // Nullify suspicious activities\r\n      await tx.suspiciousActivity.updateMany({\r\n        where: { userId },\r\n        data: { userId: null },\r\n      });\r\n\r\n      // Delete skill test attempts\r\n      await tx.skillTestAttempt.deleteMany({\r\n        where: { candidateId: user.Candidate!.id },\r\n      });\r\n\r\n      // Delete the candidate (CandidateSkill, Education, Experience cascade)\r\n      await tx.candidate.delete({ where: { userId } });\r\n\r\n      // Delete the user\r\n      await tx.user.delete({ where: { id: userId } });\r\n    });\r\n\r\n    return { success: true, message: 'Account deleted successfully' };\r\n  }\r\n}\r\n"],"names":["CandidateService","getProfile","userId","candidate","prisma","findUnique","where","include","CandidateSkill","Experience","orderBy","startDate","Education","startYear","User","select","email","phone","emailVerified","phoneVerified","NotFoundException","updateProfile","dto","linkedIn","candidateData","result","$transaction","tx","undefined","user","update","id","data","updatedCandidate","updateResume","resumeUrl","updateResumeWithParsedData","cloudinaryPublicId","parsedData","skills","JobSkill","skillName","slice","existingSkill","candidateSkill","findFirst","candidateId","name","equals","mode","create","uuidv4","level","addSkill","console","log","error","upsert","candidateId_name","yearsOfExp","removeSkill","skillId","delete","addExperience","experience","company","role","description","location","Date","endDate","isCurrent","removeExperience","experienceId","addEducation","education","institution","degree","field","grade","endYear","removeEducation","educationId","getApplications","status","jobApplication","findMany","Job","title","companyName","salaryMin","salaryMax","skillBucketId","Referral","type","Payment","amount","paidAt","Interview","paymentStatus","scheduledAt","scheduledDate","scheduledTime","hrNotes","interviewLink","callDetails","TestSession","score","isPassed","submittedAt","take","createdAt","withdrawApplication","applicationId","application","BadRequestException","nonWithdrawableStatuses","includes","payment","updatedApplication","updatedAt","jobTitle","message","jobId","withdrawnAt","toISOString","getTestHistory","applications","applicationIds","map","a","testSession","in","Test","duration","passingScore","JobApplication","getPaymentHistory","Refund","deleteAccount","Candidate","oTPToken","deleteMany","refreshToken","passwordResetToken","deviceLog","notification","auditLog","updateMany","suspiciousActivity","skillTestAttempt","success"],"mappings":"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"}