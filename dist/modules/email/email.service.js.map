{"version":3,"sources":["../../../src/modules/email/email.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport * as nodemailer from 'nodemailer';\r\nimport { Transporter } from 'nodemailer';\r\nimport {\r\n    getPasswordResetTemplate,\r\n    getEmailVerificationTemplate,\r\n    getWelcomeTemplate,\r\n} from './templates';\r\n\r\nexport interface EmailOptions {\r\n    to: string;\r\n    subject: string;\r\n    html: string;\r\n    text?: string;\r\n}\r\n\r\n@Injectable()\r\nexport class EmailService {\r\n    private transporter: Transporter | null = null;\r\n    private readonly logger = new Logger(EmailService.name);\r\n    private readonly fromEmail: string;\r\n    private readonly isEnabled: boolean;\r\n\r\n    constructor(private configService: ConfigService) {\r\n        this.fromEmail = this.configService.get('EMAIL_FROM', 'noreply@jobrefer.com');\r\n        this.isEnabled = this.initTransporter();\r\n    }\r\n\r\n    private initTransporter(): boolean {\r\n        const smtpHost = this.configService.get('SMTP_HOST');\r\n        const smtpPort = this.configService.get('SMTP_PORT');\r\n        const smtpUser = this.configService.get('SMTP_USER');\r\n        const smtpPass = this.configService.get('SMTP_PASS');\r\n\r\n        if (!smtpHost || !smtpUser || !smtpPass) {\r\n            this.logger.warn('SMTP not configured. Emails will be logged to console.');\r\n            return false;\r\n        }\r\n\r\n        try {\r\n            this.transporter = nodemailer.createTransport({\r\n                host: smtpHost,\r\n                port: parseInt(smtpPort || '587', 10),\r\n                secure: smtpPort === '465',\r\n                auth: {\r\n                    user: smtpUser,\r\n                    pass: smtpPass,\r\n                },\r\n            });\r\n            this.logger.log('Email service initialized with SMTP');\r\n            return true;\r\n        } catch (error) {\r\n            this.logger.error('Failed to initialize email transporter:', error);\r\n            return false;\r\n        }\r\n    }\r\n\r\n    async sendEmail(options: EmailOptions): Promise<boolean> {\r\n        const { to, subject, html, text } = options;\r\n\r\n        // Log email in development or if SMTP not configured\r\n        if (!this.isEnabled || this.configService.get('NODE_ENV') === 'development') {\r\n            this.logger.log('='.repeat(60));\r\n            this.logger.log(`ðŸ“§ EMAIL (${this.isEnabled ? 'also sent' : 'console only'})`);\r\n            this.logger.log(`To: ${to}`);\r\n            this.logger.log(`Subject: ${subject}`);\r\n            this.logger.log('-'.repeat(60));\r\n            if (text) {\r\n                this.logger.log(text);\r\n            }\r\n            this.logger.log('='.repeat(60));\r\n        }\r\n\r\n        if (!this.transporter) {\r\n            return !this.isEnabled; // Return true if email is intentionally disabled\r\n        }\r\n\r\n        try {\r\n            await this.transporter.sendMail({\r\n                from: `\"JobRefer\" <${this.fromEmail}>`,\r\n                to,\r\n                subject,\r\n                html,\r\n                text: text || this.stripHtml(html),\r\n            });\r\n            this.logger.log(`Email sent successfully to ${to}`);\r\n            return true;\r\n        } catch (error) {\r\n            this.logger.error(`Failed to send email to ${to}:`, error);\r\n            return false;\r\n        }\r\n    }\r\n\r\n    private stripHtml(html: string): string {\r\n        return html\r\n            .replace(/<[^>]*>/g, '')\r\n            .replace(/\\s+/g, ' ')\r\n            .trim();\r\n    }\r\n\r\n    // Send password reset email with link\r\n    async sendPasswordResetEmail(\r\n        to: string,\r\n        resetToken: string,\r\n        userName?: string,\r\n    ): Promise<boolean> {\r\n        const frontendUrl = this.configService.get('FRONTEND_URL', 'http://localhost:3000');\r\n        const resetUrl = `${frontendUrl}#reset-password?token=${resetToken}`;\r\n\r\n        const html = getPasswordResetTemplate({\r\n            userName: userName || 'User',\r\n            resetUrl,\r\n            expiryMinutes: 60,\r\n        });\r\n\r\n        return this.sendEmail({\r\n            to,\r\n            subject: 'Reset Your JobRefer Password',\r\n            html,\r\n            text: `Reset your password using this link: ${resetUrl}\\n\\nThis link will expire in 60 minutes.`,\r\n        });\r\n    }\r\n\r\n    // Send email verification\r\n    async sendVerificationEmail(\r\n        to: string,\r\n        otp: string,\r\n        userName?: string,\r\n    ): Promise<boolean> {\r\n        const html = getEmailVerificationTemplate({\r\n            userName: userName || 'User',\r\n            otp,\r\n            expiryMinutes: 10,\r\n        });\r\n\r\n        return this.sendEmail({\r\n            to,\r\n            subject: 'Verify Your JobRefer Email',\r\n            html,\r\n            text: `Your verification code is: ${otp}\\n\\nThis code will expire in 10 minutes.`,\r\n        });\r\n    }\r\n\r\n    // Send welcome email\r\n    async sendWelcomeEmail(to: string, userName: string): Promise<boolean> {\r\n        const frontendUrl = this.configService.get('FRONTEND_URL', 'http://localhost:3000');\r\n        const html = getWelcomeTemplate({\r\n            userName,\r\n            dashboardUrl: `${frontendUrl}#dashboard`,\r\n        });\r\n\r\n        return this.sendEmail({\r\n            to,\r\n            subject: 'Welcome to JobRefer! ðŸŽ‰',\r\n            html,\r\n        });\r\n    }\r\n}\r\n"],"names":["EmailService","initTransporter","smtpHost","configService","get","smtpPort","smtpUser","smtpPass","logger","warn","transporter","nodemailer","createTransport","host","port","parseInt","secure","auth","user","pass","log","error","sendEmail","options","to","subject","html","text","isEnabled","repeat","sendMail","from","fromEmail","stripHtml","replace","trim","sendPasswordResetEmail","resetToken","userName","frontendUrl","resetUrl","getPasswordResetTemplate","expiryMinutes","sendVerificationEmail","otp","getEmailVerificationTemplate","sendWelcomeEmail","getWelcomeTemplate","dashboardUrl","Logger","name"],"mappings":"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"}