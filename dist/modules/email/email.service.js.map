{"version":3,"sources":["../../../src/modules/email/email.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport * as nodemailer from 'nodemailer';\r\nimport { Transporter } from 'nodemailer';\r\nimport {\r\n  getPasswordResetTemplate,\r\n  getEmailVerificationTemplate,\r\n  getWelcomeTemplate,\r\n} from './templates';\r\n\r\nexport interface EmailOptions {\r\n  to: string;\r\n  subject: string;\r\n  html: string;\r\n  text?: string;\r\n}\r\n\r\n@Injectable()\r\nexport class EmailService {\r\n  private transporter: Transporter | null = null;\r\n  private readonly logger = new Logger(EmailService.name);\r\n  private readonly fromEmail: string;\r\n  private readonly isEnabled: boolean;\r\n\r\n  constructor(private configService: ConfigService) {\r\n    this.fromEmail = this.configService.get(\r\n      'EMAIL_FROM',\r\n      'noreply@jobrefer.com',\r\n    );\r\n    this.isEnabled = this.initTransporter();\r\n  }\r\n\r\n  private initTransporter(): boolean {\r\n    const smtpHost = this.configService.get('SMTP_HOST');\r\n    const smtpPort = this.configService.get('SMTP_PORT');\r\n    const smtpUser = this.configService.get('SMTP_USER');\r\n    const smtpPass = this.configService.get('SMTP_PASS');\r\n\r\n    if (!smtpHost || !smtpUser || !smtpPass) {\r\n      this.logger.warn(\r\n        'SMTP not configured. Emails will be logged to console.',\r\n      );\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      this.transporter = nodemailer.createTransport({\r\n        host: smtpHost,\r\n        port: parseInt(smtpPort || '587', 10),\r\n        secure: smtpPort === '465',\r\n        auth: {\r\n          user: smtpUser,\r\n          pass: smtpPass,\r\n        },\r\n      });\r\n      this.logger.log('Email service initialized with SMTP');\r\n      return true;\r\n    } catch (error) {\r\n      this.logger.error('Failed to initialize email transporter:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async sendEmail(options: EmailOptions): Promise<boolean> {\r\n    const { to, subject, html, text } = options;\r\n\r\n    // Log email in development or if SMTP not configured\r\n    if (\r\n      !this.isEnabled ||\r\n      this.configService.get('NODE_ENV') === 'development'\r\n    ) {\r\n      this.logger.log('='.repeat(60));\r\n      this.logger.log(\r\n        `ðŸ“§ EMAIL (${this.isEnabled ? 'also sent' : 'console only'})`,\r\n      );\r\n      this.logger.log(`To: ${to}`);\r\n      this.logger.log(`Subject: ${subject}`);\r\n      this.logger.log('-'.repeat(60));\r\n      if (text) {\r\n        this.logger.log(text);\r\n      }\r\n      this.logger.log('='.repeat(60));\r\n    }\r\n\r\n    if (!this.transporter) {\r\n      return !this.isEnabled; // Return true if email is intentionally disabled\r\n    }\r\n\r\n    try {\r\n      await this.transporter.sendMail({\r\n        from: `\"JobRefer\" <${this.fromEmail}>`,\r\n        to,\r\n        subject,\r\n        html,\r\n        text: text || this.stripHtml(html),\r\n      });\r\n      this.logger.log(`Email sent successfully to ${to}`);\r\n      return true;\r\n    } catch (error) {\r\n      this.logger.error(`Failed to send email to ${to}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  private stripHtml(html: string): string {\r\n    return html\r\n      .replace(/<[^>]*>/g, '')\r\n      .replace(/\\s+/g, ' ')\r\n      .trim();\r\n  }\r\n\r\n  // Send password reset email with link\r\n  async sendPasswordResetEmail(\r\n    to: string,\r\n    resetToken: string,\r\n    userName?: string,\r\n  ): Promise<boolean> {\r\n    const frontendUrl = this.configService.get(\r\n      'FRONTEND_URL',\r\n      'http://localhost:3000',\r\n    );\r\n    const resetUrl = `${frontendUrl}#reset-password?token=${resetToken}`;\r\n\r\n    const html = getPasswordResetTemplate({\r\n      userName: userName || 'User',\r\n      resetUrl,\r\n      expiryMinutes: 60,\r\n    });\r\n\r\n    return this.sendEmail({\r\n      to,\r\n      subject: 'Reset Your JobRefer Password',\r\n      html,\r\n      text: `Reset your password using this link: ${resetUrl}\\n\\nThis link will expire in 60 minutes.`,\r\n    });\r\n  }\r\n\r\n  // Send email verification\r\n  async sendVerificationEmail(\r\n    to: string,\r\n    otp: string,\r\n    userName?: string,\r\n  ): Promise<boolean> {\r\n    const html = getEmailVerificationTemplate({\r\n      userName: userName || 'User',\r\n      otp,\r\n      expiryMinutes: 10,\r\n    });\r\n\r\n    return this.sendEmail({\r\n      to,\r\n      subject: 'Verify Your JobRefer Email',\r\n      html,\r\n      text: `Your verification code is: ${otp}\\n\\nThis code will expire in 10 minutes.`,\r\n    });\r\n  }\r\n\r\n  // Send welcome email\r\n  async sendWelcomeEmail(to: string, userName: string): Promise<boolean> {\r\n    const frontendUrl = this.configService.get(\r\n      'FRONTEND_URL',\r\n      'http://localhost:3000',\r\n    );\r\n    const html = getWelcomeTemplate({\r\n      userName,\r\n      dashboardUrl: `${frontendUrl}#dashboard`,\r\n    });\r\n\r\n    return this.sendEmail({\r\n      to,\r\n      subject: 'Welcome to JobRefer! ðŸŽ‰',\r\n      html,\r\n    });\r\n  }\r\n}\r\n"],"names":["EmailService","initTransporter","smtpHost","configService","get","smtpPort","smtpUser","smtpPass","logger","warn","transporter","nodemailer","createTransport","host","port","parseInt","secure","auth","user","pass","log","error","sendEmail","options","to","subject","html","text","isEnabled","repeat","sendMail","from","fromEmail","stripHtml","replace","trim","sendPasswordResetEmail","resetToken","userName","frontendUrl","resetUrl","getPasswordResetTemplate","expiryMinutes","sendVerificationEmail","otp","getEmailVerificationTemplate","sendWelcomeEmail","getWelcomeTemplate","dashboardUrl","Logger","name"],"mappings":"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"}