{"version":3,"sources":["../../../src/modules/employee/employee.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  NotFoundException,\r\n  BadRequestException,\r\n  ForbiddenException,\r\n} from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport {\r\n  UpdateEmployeeProfileDto,\r\n  ReferralFiltersDto,\r\n  EarningsFiltersDto,\r\n} from './dto';\r\nimport {\r\n  ReferralStatus,\r\n  ReferralType,\r\n  ApplicationStatus,\r\n  EarningStatus,\r\n} from '../../common/constants';\r\n\r\n@Injectable()\r\nexport class EmployeeService {\r\n  constructor(private prisma: PrismaService) { }\r\n\r\n  // Helper to get or create employee profile\r\n  private async getOrCreateEmployee(userId: string) {\r\n    let employee = await this.prisma.employee.findUnique({\r\n      where: { userId },\r\n      include: {\r\n        User: {\r\n          select: {\r\n            email: true,\r\n            phone: true,\r\n            emailVerified: true,\r\n            phoneVerified: true,\r\n            lastLoginAt: true,\r\n            role: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    // If employee doesn't exist but user has EMPLOYEE role, create one\r\n    if (!employee) {\r\n      const user = await this.prisma.user.findUnique({\r\n        where: { id: userId },\r\n      });\r\n\r\n      if (user && user.role === 'EMPLOYEE') {\r\n        // Auto-create employee profile\r\n        employee = await this.prisma.employee.create({\r\n          data: {\r\n            id: require('crypto').randomUUID(),\r\n            userId: user.id,\r\n            companyName:\r\n              user.email.split('@')[1]?.split('.')[0] || 'Unknown Company',\r\n            companyEmail: user.email,\r\n            isVerified: false,\r\n            updatedAt: new Date(),\r\n          },\r\n          include: {\r\n            User: {\r\n              select: {\r\n                email: true,\r\n                phone: true,\r\n                emailVerified: true,\r\n                phoneVerified: true,\r\n                lastLoginAt: true,\r\n                role: true,\r\n              },\r\n            },\r\n          },\r\n        });\r\n      }\r\n    }\r\n\r\n    return employee;\r\n  }\r\n\r\n  // Get employee profile with stats\r\n  async getProfile(userId: string) {\r\n    const employee = await this.getOrCreateEmployee(userId);\r\n\r\n    if (!employee) {\r\n      throw new NotFoundException(\r\n        'Employee profile not found. Please ensure you registered as an Employee.',\r\n      );\r\n    }\r\n\r\n    // Get current tier\r\n    const tier = await this.getCurrentTier(userId);\r\n\r\n    return {\r\n      ...employee,\r\n      currentTier: tier,\r\n    };\r\n  }\r\n\r\n  // Get dashboard statistics\r\n  async getDashboardStats(userId: string) {\r\n    const employee = await this.getOrCreateEmployee(userId);\r\n\r\n    if (!employee) {\r\n      throw new NotFoundException(\r\n        'Employee profile not found. Please ensure you registered as an Employee.',\r\n      );\r\n    }\r\n\r\n    // Get referral stats\r\n    const referralStats = await this.prisma.referral.groupBy({\r\n      by: ['status'],\r\n      where: { employeeId: employee.id },\r\n      _count: true,\r\n    });\r\n\r\n    // Get earnings summary\r\n    const earningsStats = await this.prisma.employeeEarning.aggregate({\r\n      where: { employeeId: employee.id },\r\n      _sum: {\r\n        amount: true,\r\n        bonusAmount: true,\r\n      },\r\n    });\r\n\r\n    const paidEarnings = await this.prisma.employeeEarning.aggregate({\r\n      where: {\r\n        employeeId: employee.id,\r\n        status: EarningStatus.PAID,\r\n      },\r\n      _sum: {\r\n        amount: true,\r\n        bonusAmount: true,\r\n      },\r\n    });\r\n\r\n    const pendingEarnings = await this.prisma.employeeEarning.aggregate({\r\n      where: {\r\n        employeeId: employee.id,\r\n        status: { in: [EarningStatus.PENDING, EarningStatus.ELIGIBLE] },\r\n      },\r\n      _sum: {\r\n        amount: true,\r\n        bonusAmount: true,\r\n      },\r\n    });\r\n\r\n    // Get available referrals count\r\n    const availableReferrals = await this.prisma.referral.count({\r\n      where: {\r\n        status: ReferralStatus.PENDING,\r\n        type: ReferralType.EMPLOYEE,\r\n        employeeId: null,\r\n        JobApplication: {\r\n          Job: {\r\n            companyName: {\r\n              equals: employee.companyName,\r\n              mode: 'insensitive',\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    // Get this month's referrals\r\n    const startOfMonth = new Date();\r\n    startOfMonth.setDate(1);\r\n    startOfMonth.setHours(0, 0, 0, 0);\r\n\r\n    const thisMonthReferrals = await this.prisma.referral.count({\r\n      where: {\r\n        employeeId: employee.id,\r\n        createdAt: { gte: startOfMonth },\r\n      },\r\n    });\r\n\r\n    const currentTier = await this.getCurrentTier(userId);\r\n\r\n    return {\r\n      totalReferral: employee.referralCount,\r\n      successfulReferral: employee.successfulReferrals,\r\n      pendingReferral:\r\n        referralStats.find((s) => s.status === ReferralStatus.PENDING)\r\n          ?._count || 0,\r\n      confirmedReferral:\r\n        referralStats.find((s) => s.status === ReferralStatus.CONFIRMED)\r\n          ?._count || 0,\r\n      availableReferrals,\r\n      thisMonthReferrals,\r\n      totalEarnings:\r\n        (earningsStats._sum.amount || 0) +\r\n        (earningsStats._sum.bonusAmount || 0),\r\n      paidEarnings:\r\n        (paidEarnings._sum.amount || 0) + (paidEarnings._sum.bonusAmount || 0),\r\n      pendingEarnings:\r\n        (pendingEarnings._sum.amount || 0) +\r\n        (pendingEarnings._sum.bonusAmount || 0),\r\n      points: employee.points,\r\n      badges: employee.badges,\r\n      currentTier: currentTier,\r\n    };\r\n  }\r\n\r\n  // Get available referrals - candidates awaiting referral at employee's company\r\n  async getAvailableReferrals(userId: string, search?: string) {\r\n    const employee = await this.prisma.employee.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!employee) {\r\n      throw new NotFoundException('Employee profile not found');\r\n    }\r\n\r\n    if (!employee.isVerified) {\r\n      throw new ForbiddenException(\r\n        'Your employee account is not verified yet. Please wait for verification.',\r\n      );\r\n    }\r\n\r\n    const referrals = await this.prisma.referral.findMany({\r\n      where: {\r\n        status: ReferralStatus.PENDING,\r\n        type: ReferralType.EMPLOYEE,\r\n        employeeId: null, // Not yet claimed by any employee\r\n        JobApplication: {\r\n          Job: {\r\n            companyName: {\r\n              equals: employee.companyName,\r\n              mode: 'insensitive',\r\n            },\r\n          },\r\n          ...(search\r\n            ? {\r\n              OR: [\r\n                {\r\n                  Candidate: {\r\n                    firstName: { contains: search, mode: 'insensitive' },\r\n                  },\r\n                },\r\n                {\r\n                  Candidate: {\r\n                    lastName: { contains: search, mode: 'insensitive' },\r\n                  },\r\n                },\r\n                {\r\n                  Job: {\r\n                    title: { contains: search, mode: 'insensitive' },\r\n                  },\r\n                },\r\n              ],\r\n            }\r\n            : {}),\r\n        },\r\n      },\r\n      include: {\r\n        JobApplication: {\r\n          include: {\r\n            Candidate: {\r\n              select: {\r\n                id: true,\r\n                firstName: true,\r\n                lastName: true,\r\n                headline: true,\r\n                totalExperience: true,\r\n                currentCompany: true,\r\n                CandidateSkill: {\r\n                  select: { name: true, level: true },\r\n                },\r\n              },\r\n            },\r\n            Job: {\r\n              select: {\r\n                id: true,\r\n                title: true,\r\n                companyName: true,\r\n                location: true,\r\n                referralFee: true,\r\n              },\r\n            },\r\n            TestSession: {\r\n              where: { isPassed: true },\r\n              select: { score: true },\r\n              take: 1,\r\n            },\r\n          },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    // Calculate potential earning for each\r\n    const tier = await this.getCurrentTier(userId);\r\n    const commissionRate = tier?.current?.commissionPercent || 10; // Default 10%\r\n    const bonusPerReferral = tier?.current?.bonusPerReferral || 0;\r\n\r\n    return referrals.map((ref) => ({\r\n      ...ref,\r\n      potentialEarning:\r\n        (ref.JobApplication.Job.referralFee * commissionRate) / 100 +\r\n        bonusPerReferral,\r\n      candidateTestScore: ref.JobApplication.TestSession[0]?.score || null,\r\n    }));\r\n  }\r\n\r\n  // Get employee's referrals with filters\r\n  async getMyReferrals(userId: string, filters: ReferralFiltersDto) {\r\n    const employee = await this.prisma.employee.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!employee) {\r\n      throw new NotFoundException('Employee profile not found');\r\n    }\r\n\r\n    const { status, fromDate, toDate, page = 1, limit = 10 } = filters;\r\n\r\n    const where: any = {\r\n      employeeId: employee.id,\r\n    };\r\n\r\n    if (status && status !== 'ALL') {\r\n      where.status = status;\r\n    }\r\n\r\n    if (fromDate) {\r\n      where.createdAt = { ...(where.createdAt || {}), gte: new Date(fromDate) };\r\n    }\r\n\r\n    if (toDate) {\r\n      where.createdAt = { ...(where.createdAt || {}), lte: new Date(toDate) };\r\n    }\r\n\r\n    const [referrals, total] = await Promise.all([\r\n      this.prisma.referral.findMany({\r\n        where,\r\n        include: {\r\n          JobApplication: {\r\n            include: {\r\n              Candidate: {\r\n                select: {\r\n                  firstName: true,\r\n                  lastName: true,\r\n                  headline: true,\r\n                },\r\n              },\r\n              Job: {\r\n                select: {\r\n                  title: true,\r\n                  companyName: true,\r\n                  referralFee: true,\r\n                },\r\n              },\r\n            },\r\n          },\r\n          EmployeeEarning: {\r\n            select: {\r\n              amount: true,\r\n              status: true,\r\n              paidAt: true,\r\n            },\r\n          },\r\n        },\r\n        orderBy: { createdAt: 'desc' },\r\n        skip: (page - 1) * limit,\r\n        take: limit,\r\n      }),\r\n      this.prisma.referral.count({ where }),\r\n    ]);\r\n\r\n    return {\r\n      data: referrals,\r\n      pagination: {\r\n        page,\r\n        limit,\r\n        total,\r\n        totalPages: Math.ceil(total / limit),\r\n      },\r\n    };\r\n  }\r\n\r\n  // Confirm/claim a referral\r\n  async confirmReferral(userId: string, applicationId: string) {\r\n    const employee = await this.prisma.employee.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!employee) {\r\n      throw new NotFoundException('Employee profile not found');\r\n    }\r\n\r\n    if (!employee.isVerified) {\r\n      throw new ForbiddenException('Your employee account is not verified');\r\n    }\r\n\r\n    // Find the referral for this application\r\n    const referral = await this.prisma.referral.findUnique({\r\n      where: { applicationId },\r\n      include: {\r\n        JobApplication: {\r\n          include: {\r\n            Job: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!referral) {\r\n      throw new NotFoundException('Referral not found');\r\n    }\r\n\r\n    if (referral.status !== ReferralStatus.PENDING) {\r\n      throw new BadRequestException('Referral is not in pending state');\r\n    }\r\n\r\n    if (referral.employeeId) {\r\n      throw new BadRequestException(\r\n        'Referral already claimed by another employee',\r\n      );\r\n    }\r\n\r\n    // Verify company match\r\n    if (\r\n      employee.companyName.toLowerCase() !==\r\n      referral.JobApplication.Job.companyName.toLowerCase()\r\n    ) {\r\n      throw new ForbiddenException('Cannot refer for a different company');\r\n    }\r\n\r\n    // Get current tier for commission calculation\r\n    const tier = await this.getCurrentTierInternal(employee.id);\r\n    const commissionRate = tier?.current?.commissionPercent || 10;\r\n    const bonusAmount = tier?.current?.bonusPerReferral || 0;\r\n    const earningAmount =\r\n      (referral.JobApplication.Job.referralFee * commissionRate) / 100;\r\n\r\n    // Perform transaction\r\n    const result = await this.prisma.$transaction(async (tx) => {\r\n      // Update referral\r\n      const updatedReferral = await tx.referral.update({\r\n        where: { id: referral.id },\r\n        data: {\r\n          employeeId: employee.id,\r\n          status: ReferralStatus.CONFIRMED,\r\n          confirmedAt: new Date(),\r\n          expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days expiry\r\n        },\r\n      });\r\n\r\n      // Update application status - keep as APPLIED (waiting for HR interview confirmation)\r\n      await tx.jobApplication.update({\r\n        where: { id: referral.applicationId },\r\n        data: { status: ApplicationStatus.APPLIED },\r\n      });\r\n\r\n      // Create earning record\r\n      const earning = await tx.employeeEarning.create({\r\n        data: {\r\n          id: require('crypto').randomUUID(),\r\n          employeeId: employee.id,\r\n          referralId: referral.id,\r\n          amount: earningAmount,\r\n          bonusAmount: bonusAmount,\r\n          status: EarningStatus.PENDING,\r\n          tierName: tier?.current?.name || 'Base',\r\n          commissionRate: commissionRate,\r\n          updatedAt: new Date(),\r\n        },\r\n      });\r\n\r\n      // Update employee stats\r\n      await tx.employee.update({\r\n        where: { id: employee.id },\r\n        data: {\r\n          referralCount: { increment: 1 },\r\n          points: { increment: 10 }, // 10 points per referral\r\n        },\r\n      });\r\n\r\n      return { Referral: updatedReferral, earning };\r\n    });\r\n\r\n    // Check for badge achievements\r\n    await this.checkAndAwardBadges(employee.id);\r\n\r\n    return result;\r\n  }\r\n\r\n  // Get earnings history\r\n  async getEarnings(userId: string, filters: EarningsFiltersDto) {\r\n    const employee = await this.prisma.employee.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!employee) {\r\n      throw new NotFoundException('Employee profile not found');\r\n    }\r\n\r\n    const { status, fromDate, toDate, page = 1, limit = 10 } = filters;\r\n\r\n    const where: any = {\r\n      employeeId: employee.id,\r\n    };\r\n\r\n    if (status && status !== 'ALL') {\r\n      where.status = status;\r\n    }\r\n\r\n    if (fromDate) {\r\n      where.createdAt = { ...(where.createdAt || {}), gte: new Date(fromDate) };\r\n    }\r\n\r\n    if (toDate) {\r\n      where.createdAt = { ...(where.createdAt || {}), lte: new Date(toDate) };\r\n    }\r\n\r\n    const [earnings, total, summary] = await Promise.all([\r\n      this.prisma.employeeEarning.findMany({\r\n        where,\r\n        include: {\r\n          Referral: {\r\n            include: {\r\n              JobApplication: {\r\n                include: {\r\n                  Candidate: {\r\n                    select: { firstName: true, lastName: true },\r\n                  },\r\n                  Job: {\r\n                    select: { title: true, companyName: true },\r\n                  },\r\n                },\r\n              },\r\n            },\r\n          },\r\n        },\r\n        orderBy: { createdAt: 'desc' },\r\n        skip: (page - 1) * limit,\r\n        take: limit,\r\n      }),\r\n      this.prisma.employeeEarning.count({ where }),\r\n      this.prisma.employeeEarning.aggregate({\r\n        where: { employeeId: employee.id },\r\n        _sum: { amount: true, bonusAmount: true },\r\n      }),\r\n    ]);\r\n\r\n    // Group by status for summary\r\n    const statusSummary = await this.prisma.employeeEarning.groupBy({\r\n      by: ['status'],\r\n      where: { employeeId: employee.id },\r\n      _sum: { amount: true, bonusAmount: true },\r\n      _count: true,\r\n    });\r\n\r\n    return {\r\n      data: earnings,\r\n      pagination: {\r\n        page,\r\n        limit,\r\n        total,\r\n        totalPages: Math.ceil(total / limit),\r\n      },\r\n      summary: {\r\n        totalAmount:\r\n          (summary._sum.amount || 0) + (summary._sum.bonusAmount || 0),\r\n        byStatus: statusSummary.reduce(\r\n          (acc, item) => {\r\n            acc[item.status] = {\r\n              count: item._count,\r\n              amount: (item._sum.amount || 0) + (item._sum.bonusAmount || 0),\r\n            };\r\n            return acc;\r\n          },\r\n          {} as Record<string, { count: number; amount: number }>,\r\n        ),\r\n      },\r\n    };\r\n  }\r\n\r\n  // Get company leaderboard\r\n  async getLeaderboard(userId: string, period: 'month' | 'all' = 'all') {\r\n    const employee = await this.prisma.employee.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!employee) {\r\n      throw new NotFoundException('Employee profile not found');\r\n    }\r\n\r\n    let dateFilter = {};\r\n    if (period === 'month') {\r\n      const startOfMonth = new Date();\r\n      startOfMonth.setDate(1);\r\n      startOfMonth.setHours(0, 0, 0, 0);\r\n      dateFilter = { createdAt: { gte: startOfMonth } };\r\n    }\r\n\r\n    // Get all employees from same company with their referral count\r\n    const employees = await this.prisma.employee.findMany({\r\n      where: {\r\n        companyName: { equals: employee.companyName, mode: 'insensitive' },\r\n        isVerified: true,\r\n      },\r\n      select: {\r\n        id: true,\r\n        userId: true,\r\n        designation: true,\r\n        referralCount: true,\r\n        successfulReferrals: true,\r\n        points: true,\r\n        badges: true,\r\n        User: {\r\n          select: {\r\n            email: true,\r\n          },\r\n        },\r\n        Referral:\r\n          period === 'month'\r\n            ? {\r\n              where: dateFilter,\r\n              select: { id: true },\r\n            }\r\n            : undefined,\r\n      },\r\n      orderBy: period === 'month' ? undefined : { successfulReferrals: 'desc' },\r\n      take: 20,\r\n    });\r\n\r\n    // Sort by month count if monthly\r\n    let leaderboard = employees.map((emp, index) => ({\r\n      rank: index + 1,\r\n      employeeId: emp.id,\r\n      email: emp.User.email.replace(/(.{3}).*@/, '$1***@'), // Partial hide email\r\n      designation: emp.designation,\r\n      referralCount:\r\n        period === 'month' ? emp.Referral?.length || 0 : emp.referralCount,\r\n      successfulReferrals: emp.successfulReferrals,\r\n      points: emp.points,\r\n      badges: emp.badges,\r\n      isCurrentUser: emp.userId === userId,\r\n    }));\r\n\r\n    if (period === 'month') {\r\n      leaderboard = leaderboard\r\n        .sort((a, b) => (b.referralCount || 0) - (a.referralCount || 0))\r\n        .map((emp, index) => ({ ...emp, rank: index + 1 }));\r\n    }\r\n\r\n    // Find current user's rank if not in top 20\r\n    const currentUserInLeaderboard = leaderboard.find((e) => e.isCurrentUser);\r\n    let currentUserRank: number | null = null;\r\n\r\n    if (!currentUserInLeaderboard) {\r\n      // Calculate rank\r\n      const higherRanked = await this.prisma.employee.count({\r\n        where: {\r\n          companyName: { equals: employee.companyName, mode: 'insensitive' },\r\n          successfulReferrals: { gt: employee.successfulReferrals },\r\n        },\r\n      });\r\n      currentUserRank = higherRanked + 1;\r\n    }\r\n\r\n    return {\r\n      leaderboard: leaderboard.slice(0, 10),\r\n      currentUserRank: currentUserInLeaderboard?.rank || currentUserRank,\r\n      currentUserStats: {\r\n        referralCount: employee.referralCount,\r\n        successfulReferrals: employee.successfulReferrals,\r\n        points: employee.points,\r\n      },\r\n    };\r\n  }\r\n\r\n  // Get current tier\r\n  async getCurrentTier(userId: string) {\r\n    const employee = await this.prisma.employee.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!employee) {\r\n      return null;\r\n    }\r\n\r\n    return this.getCurrentTierInternal(employee.id);\r\n  }\r\n\r\n  private async getCurrentTierInternal(employeeId: string) {\r\n    const employee = await this.prisma.employee.findUnique({\r\n      where: { id: employeeId },\r\n    });\r\n\r\n    if (!employee) {\r\n      return null;\r\n    }\r\n\r\n    const tier = await this.prisma.commissionTier.findFirst({\r\n      where: {\r\n        minReferrals: { lte: employee.successfulReferrals },\r\n        isActive: true,\r\n      },\r\n      orderBy: { minReferrals: 'desc' },\r\n    });\r\n\r\n    // Get next tier\r\n    const nextTier = await this.prisma.commissionTier.findFirst({\r\n      where: {\r\n        minReferrals: { gt: employee.successfulReferrals },\r\n        isActive: true,\r\n      },\r\n      orderBy: { minReferrals: 'asc' },\r\n    });\r\n\r\n    return {\r\n      current: tier,\r\n      next: nextTier,\r\n      referralsToNextTier: nextTier\r\n        ? nextTier.minReferrals - employee.successfulReferrals\r\n        : null,\r\n    };\r\n  }\r\n\r\n  // Update employee profile\r\n  async updateProfile(userId: string, dto: UpdateEmployeeProfileDto) {\r\n    const employee = await this.prisma.employee.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!employee) {\r\n      throw new NotFoundException('Employee profile not found');\r\n    }\r\n\r\n    return this.prisma.employee.update({\r\n      where: { id: employee.id },\r\n      data: {\r\n        designation: dto.designation,\r\n        employeeId: dto.employeeId,\r\n        linkedinUrl: dto.linkedinUrl,\r\n      },\r\n    });\r\n  }\r\n\r\n  // Check and award badges\r\n  private async checkAndAwardBadges(employeeId: string) {\r\n    const employee = await this.prisma.employee.findUnique({\r\n      where: { id: employeeId },\r\n    });\r\n\r\n    if (!employee) return;\r\n\r\n    const badges = [...employee.badges];\r\n\r\n    // First referral badge\r\n    if (employee.referralCount === 1 && !badges.includes('first-referral')) {\r\n      badges.push('first-referral');\r\n    }\r\n\r\n    // 5 referrals badge\r\n    if (employee.referralCount >= 5 && !badges.includes('referral-pro')) {\r\n      badges.push('referral-pro');\r\n    }\r\n\r\n    // 10 referrals badge\r\n    if (employee.referralCount >= 10 && !badges.includes('super-referrer')) {\r\n      badges.push('super-referrer');\r\n    }\r\n\r\n    // 25 referrals badge\r\n    if (employee.referralCount >= 25 && !badges.includes('referral-champion')) {\r\n      badges.push('referral-champion');\r\n    }\r\n\r\n    // First successful hire badge\r\n    if (employee.successfulReferrals >= 1 && !badges.includes('first-hire')) {\r\n      badges.push('first-hire');\r\n    }\r\n\r\n    // 5 successful hires badge\r\n    if (employee.successfulReferrals >= 5 && !badges.includes('hiring-hero')) {\r\n      badges.push('hiring-hero');\r\n    }\r\n\r\n    if (badges.length !== employee.badges.length) {\r\n      await this.prisma.employee.update({\r\n        where: { id: employeeId },\r\n        data: { badges },\r\n      });\r\n    }\r\n  }\r\n\r\n  // Mark referral as hired (called by HR/Admin)\r\n  async markReferralAsHired(referralId: string) {\r\n    const referral = await this.prisma.referral.findUnique({\r\n      where: { id: referralId },\r\n      include: {\r\n        EmployeeEarning: true,\r\n        Employee: true,\r\n      },\r\n    });\r\n\r\n    if (!referral) {\r\n      throw new NotFoundException('Referral not found');\r\n    }\r\n\r\n    if (referral.status !== ReferralStatus.CONFIRMED) {\r\n      throw new BadRequestException('Referral must be confirmed first');\r\n    }\r\n\r\n    return this.prisma.$transaction(async (tx) => {\r\n      // Update referral status\r\n      await tx.referral.update({\r\n        where: { id: referralId },\r\n        data: {\r\n          status: ReferralStatus.CLOSED,\r\n          closedAt: new Date(),\r\n        },\r\n      });\r\n\r\n      // Update earning to eligible\r\n      if (referral.EmployeeEarning) {\r\n        await tx.employeeEarning.update({\r\n          where: { id: referral.EmployeeEarning.id },\r\n          data: { status: EarningStatus.ELIGIBLE },\r\n        });\r\n      }\r\n\r\n      // Update employee stats\r\n      if (referral.employeeId) {\r\n        await tx.employee.update({\r\n          where: { id: referral.employeeId },\r\n          data: {\r\n            successfulReferrals: { increment: 1 },\r\n            points: { increment: 50 }, // Bonus points for successful hire\r\n          },\r\n        });\r\n\r\n        // Check for badges\r\n        await this.checkAndAwardBadges(referral.employeeId);\r\n      }\r\n\r\n      return { success: true };\r\n    });\r\n  }\r\n\r\n  // Get notifications for employee\r\n  async getNotifications(userId: string, limit = 10) {\r\n    return this.prisma.notification.findMany({\r\n      where: { userId },\r\n      orderBy: { createdAt: 'desc' },\r\n      take: limit,\r\n    });\r\n  }\r\n\r\n  // Mark notification as read\r\n  async markNotificationRead(userId: string, notificationId: string) {\r\n    const notification = await this.prisma.notification.findFirst({\r\n      where: { id: notificationId, userId },\r\n    });\r\n\r\n    if (!notification) {\r\n      throw new NotFoundException('Notification not found');\r\n    }\r\n\r\n    return this.prisma.notification.update({\r\n      where: { id: notificationId },\r\n      data: { isRead: true, readAt: new Date() },\r\n    });\r\n  }\r\n}\r\n"],"names":["EmployeeService","getOrCreateEmployee","userId","employee","prisma","findUnique","where","include","User","select","email","phone","emailVerified","phoneVerified","lastLoginAt","role","user","id","create","data","require","randomUUID","companyName","split","companyEmail","isVerified","updatedAt","Date","getProfile","NotFoundException","tier","getCurrentTier","currentTier","getDashboardStats","referralStats","referral","groupBy","by","employeeId","_count","earningsStats","employeeEarning","aggregate","_sum","amount","bonusAmount","paidEarnings","status","EarningStatus","PAID","pendingEarnings","in","PENDING","ELIGIBLE","availableReferrals","count","ReferralStatus","type","ReferralType","EMPLOYEE","JobApplication","Job","equals","mode","startOfMonth","setDate","setHours","thisMonthReferrals","createdAt","gte","totalReferral","referralCount","successfulReferral","successfulReferrals","pendingReferral","find","s","confirmedReferral","CONFIRMED","totalEarnings","points","badges","getAvailableReferrals","search","ForbiddenException","referrals","findMany","OR","Candidate","firstName","contains","lastName","title","headline","totalExperience","currentCompany","CandidateSkill","name","level","location","referralFee","TestSession","isPassed","score","take","orderBy","commissionRate","current","commissionPercent","bonusPerReferral","map","ref","potentialEarning","candidateTestScore","getMyReferrals","filters","fromDate","toDate","page","limit","lte","total","Promise","all","EmployeeEarning","paidAt","skip","pagination","totalPages","Math","ceil","confirmReferral","applicationId","BadRequestException","toLowerCase","getCurrentTierInternal","earningAmount","result","$transaction","tx","updatedReferral","update","confirmedAt","expiresAt","now","jobApplication","ApplicationStatus","APPLIED","earning","referralId","tierName","increment","Referral","checkAndAwardBadges","getEarnings","earnings","summary","statusSummary","totalAmount","byStatus","reduce","acc","item","getLeaderboard","period","dateFilter","employees","designation","undefined","leaderboard","emp","index","rank","replace","length","isCurrentUser","sort","a","b","currentUserInLeaderboard","e","currentUserRank","higherRanked","gt","slice","currentUserStats","commissionTier","findFirst","minReferrals","isActive","nextTier","next","referralsToNextTier","updateProfile","dto","linkedinUrl","includes","push","markReferralAsHired","Employee","CLOSED","closedAt","success","getNotifications","notification","markNotificationRead","notificationId","isRead","readAt"],"mappings":"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"}