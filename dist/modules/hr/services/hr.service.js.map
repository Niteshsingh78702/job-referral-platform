{"version":3,"sources":["../../../../src/modules/hr/services/hr.service.ts"],"sourcesContent":["import {\r\n    Injectable,\r\n    UnauthorizedException,\r\n    ConflictException,\r\n    BadRequestException,\r\n    NotFoundException,\r\n    ForbiddenException,\r\n} from '@nestjs/common';\r\nimport * as bcrypt from 'bcrypt';\r\nimport { PrismaService } from '../../../prisma/prisma.service';\r\nimport { TokenService, JwtPayload } from '../../auth/services/token.service';\r\nimport { HRRegisterDto, HRLoginDto, UpdateHRProfileDto, CreateJobDto, UpdateJobStatusDto, UpdateJobDto } from '../dto';\r\nimport { UserRole, UserStatus, HRApprovalStatus, AuditAction } from '../../../common/constants';\r\nimport { JobStatus as PrismaJobStatus } from '@prisma/client';\r\n\r\n// Rate limiting constants\r\nconst MAX_LOGIN_ATTEMPTS = 5;\r\nconst LOCKOUT_DURATION_MS = 15 * 60 * 1000; // 15 minutes\r\n\r\n@Injectable()\r\nexport class HRService {\r\n    constructor(\r\n        private prisma: PrismaService,\r\n        private tokenService: TokenService,\r\n    ) { }\r\n\r\n    /**\r\n     * Register a new HR account\r\n     * - Validates corporate email domain\r\n     * - Creates user with HR role\r\n     * - Creates HR profile with pending approval status (auto-approved for dev)\r\n     */\r\n    async register(dto: HRRegisterDto, deviceInfo?: any) {\r\n        // Check if email already exists\r\n        const existingUser = await this.prisma.user.findUnique({\r\n            where: { email: dto.email },\r\n        });\r\n\r\n        if (existingUser) {\r\n            throw new ConflictException('Email already registered');\r\n        }\r\n\r\n        // Check phone if provided\r\n        if (dto.phone) {\r\n            const existingPhone = await this.prisma.user.findUnique({\r\n                where: { phone: dto.phone },\r\n            });\r\n            if (existingPhone) {\r\n                throw new ConflictException('Phone number already registered');\r\n            }\r\n        }\r\n\r\n        // Check company email already registered as HR\r\n        const existingHR = await this.prisma.hR.findFirst({\r\n            where: { companyEmail: dto.companyEmail },\r\n        });\r\n\r\n        if (existingHR) {\r\n            throw new ConflictException('Company email already registered');\r\n        }\r\n\r\n        // Hash password\r\n        const passwordHash = await bcrypt.hash(dto.password, 12);\r\n\r\n        // Create user and HR profile in transaction\r\n        const result = await this.prisma.$transaction(async (tx) => {\r\n            // Create user with HR role\r\n            const user = await tx.user.create({\r\n                data: {\r\n                    email: dto.email,\r\n                    phone: dto.phone,\r\n                    passwordHash,\r\n                    role: UserRole.HR,\r\n                    status: UserStatus.ACTIVE, // Auto-activate for dev\r\n                    emailVerified: true, // Auto-verify for dev\r\n                },\r\n            });\r\n\r\n            // Create HR profile - Auto-approved for development\r\n            const hr = await tx.hR.create({\r\n                data: {\r\n                    userId: user.id,\r\n                    companyName: dto.companyName,\r\n                    companyEmail: dto.companyEmail,\r\n                    companyWebsite: dto.companyWebsite,\r\n                    designation: dto.designation,\r\n                    linkedinUrl: dto.linkedinUrl,\r\n                    approvalStatus: HRApprovalStatus.APPROVED, // Auto-approve for dev\r\n                    approvedAt: new Date(),\r\n                },\r\n            });\r\n\r\n            // Log device\r\n            if (deviceInfo) {\r\n                await tx.deviceLog.create({\r\n                    data: {\r\n                        userId: user.id,\r\n                        deviceId: deviceInfo.deviceId || 'unknown',\r\n                        ipAddress: deviceInfo.ip || 'unknown',\r\n                        userAgent: deviceInfo.userAgent,\r\n                    },\r\n                });\r\n            }\r\n\r\n            // Create audit log\r\n            await tx.auditLog.create({\r\n                data: {\r\n                    userId: user.id,\r\n                    action: AuditAction.CREATE,\r\n                    entityType: 'HR',\r\n                    entityId: hr.id,\r\n                    metadata: { registrationSource: 'hr_portal' },\r\n                },\r\n            });\r\n\r\n            return { user, hr };\r\n        });\r\n\r\n        // Generate tokens\r\n        const payload: JwtPayload = {\r\n            sub: result.user.id,\r\n            email: result.user.email,\r\n            role: result.user.role,\r\n        };\r\n\r\n        const tokens = await this.tokenService.generateTokenPair(payload);\r\n\r\n        return {\r\n            ...tokens,\r\n            User: {\r\n                id: result.user.id,\r\n                email: result.user.email,\r\n                role: result.user.role,\r\n                HR: {\r\n                    id: result.HR.id,\r\n                    companyName: result.HR.companyName,\r\n                    approvalStatus: result.HR.approvalStatus,\r\n                },\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Login for HR users\r\n     * - Implements rate limiting (5 attempts per 15 min)\r\n     * - Checks HR approval status\r\n     */\r\n    async login(dto: HRLoginDto, deviceInfo?: any) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { email: dto.email },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.passwordHash) {\r\n            throw new UnauthorizedException('Invalid credentials');\r\n        }\r\n\r\n        if (user.role !== UserRole.HR) {\r\n            throw new UnauthorizedException('This login is for HR accounts only');\r\n        }\r\n\r\n        if (user.status === UserStatus.BLOCKED) {\r\n            throw new UnauthorizedException('Account is blocked. Please contact support.');\r\n        }\r\n\r\n        // Check HR approval status\r\n        if (!user.HR) {\r\n            throw new BadRequestException('HR profile not found');\r\n        }\r\n\r\n        if (user.HR.approvalStatus === HRApprovalStatus.PENDING) {\r\n            throw new ForbiddenException('Your account is pending approval. Please wait for admin verification.');\r\n        }\r\n\r\n        if (user.HR.approvalStatus === HRApprovalStatus.REJECTED) {\r\n            throw new ForbiddenException(`Account rejected: ${user.HR.rejectionReason || 'Please contact support.'}`);\r\n        }\r\n\r\n        // Verify password\r\n        const isValid = await bcrypt.compare(dto.password, user.passwordHash);\r\n        if (!isValid) {\r\n            throw new UnauthorizedException('Invalid credentials');\r\n        }\r\n\r\n        // Update last login\r\n        await this.prisma.$transaction(async (tx) => {\r\n            await tx.user.update({\r\n                where: { id: user.id },\r\n                data: { lastLoginAt: new Date() },\r\n            });\r\n\r\n            // Log device\r\n            if (deviceInfo) {\r\n                await tx.deviceLog.create({\r\n                    data: {\r\n                        userId: user.id,\r\n                        deviceId: deviceInfo.deviceId || 'unknown',\r\n                        ipAddress: deviceInfo.ip || 'unknown',\r\n                        userAgent: deviceInfo.userAgent,\r\n                    },\r\n                });\r\n            }\r\n\r\n            // Audit log\r\n            await tx.auditLog.create({\r\n                data: {\r\n                    userId: user.id,\r\n                    action: AuditAction.LOGIN,\r\n                    entityType: 'HR',\r\n                    entityId: user.HR!.id,\r\n                    metadata: { ip: deviceInfo?.ip, portal: 'hr' },\r\n                },\r\n            });\r\n        });\r\n\r\n        // Generate tokens\r\n        const payload: JwtPayload = {\r\n            sub: user.id,\r\n            email: user.email,\r\n            role: user.role,\r\n        };\r\n\r\n        const tokens = await this.tokenService.generateTokenPair(payload);\r\n\r\n        return {\r\n            ...tokens,\r\n            User: {\r\n                id: user.id,\r\n                email: user.email,\r\n                role: user.role,\r\n                HR: {\r\n                    id: user.HR.id,\r\n                    companyName: user.HR.companyName,\r\n                    designation: user.HR.designation,\r\n                },\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get HR profile with stats\r\n     */\r\n    async getProfile(userId: string) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: {\r\n                HR: {\r\n                    include: {\r\n                        jobs: {\r\n                            select: {\r\n                                id: true,\r\n                                title: true,\r\n                                status: true,\r\n                                applicationCount: true,\r\n                            },\r\n                        },\r\n                    },\r\n                },\r\n            },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const { passwordHash, ...userWithoutPassword } = user;\r\n        return userWithoutPassword;\r\n    }\r\n\r\n    /**\r\n     * Update HR profile\r\n     */\r\n    async updateProfile(userId: string, dto: UpdateHRProfileDto) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const updated = await this.prisma.hR.update({\r\n            where: { id: user.HR.id },\r\n            data: {\r\n                companyName: dto.companyName,\r\n                companyWebsite: dto.companyWebsite,\r\n                designation: dto.designation,\r\n                linkedinUrl: dto.linkedinUrl,\r\n            },\r\n        });\r\n\r\n        return updated;\r\n    }\r\n\r\n    /**\r\n     * Get dashboard statistics\r\n     */\r\n    async getDashboardStats(userId: string) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const hrId = user.HR.id;\r\n\r\n        // Get job stats\r\n        const jobs = await this.prisma.job.findMany({\r\n            where: { hrId },\r\n            include: {\r\n                JobApplication: {\r\n                    select: {\r\n                        id: true,\r\n                        status: true,\r\n                        createdAt: true,\r\n                    },\r\n                },\r\n            },\r\n        });\r\n\r\n        const now = new Date();\r\n        const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\r\n\r\n        const totalJobs = jobs.length;\r\n        const activeJobs = jobs.filter(j => j.status === PrismaJobStatus.ACTIVE).length;\r\n        const totalApplications = jobs.reduce((acc, j) => acc + j.jobApplication.length, 0);\r\n        const recentApplications = jobs.reduce((acc, j) =>\r\n            acc + j.jobApplication.filter(a => a.createdAt >= thirtyDaysAgo).length, 0);\r\n\r\n        const pendingReferrals = await this.prisma.referral.count({\r\n            where: {\r\n                hrId,\r\n                status: 'PENDING',\r\n            },\r\n        });\r\n\r\n        const confirmedReferrals = await this.prisma.referral.count({\r\n            where: {\r\n                hrId,\r\n                status: 'CONFIRMED',\r\n            },\r\n        });\r\n\r\n        return {\r\n            totalJobs,\r\n            activeJobs,\r\n            totalApplications,\r\n            recentApplications,\r\n            pendingReferrals,\r\n            confirmedReferrals,\r\n            jobsByStatus: {\r\n                draft: jobs.filter(j => j.status === PrismaJobStatus.DRAFT).length,\r\n                active: activeJobs,\r\n                closed: jobs.filter(j => j.status === PrismaJobStatus.CLOSED).length,\r\n                expired: jobs.filter(j => j.status === PrismaJobStatus.EXPIRED).length,\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get recent activity for dashboard\r\n     */\r\n    async getRecentActivity(userId: string, limit: number = 10) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        // Get recent applications on HR's jobs\r\n        const recentApplications = await this.prisma.jobApplication.findMany({\r\n            where: {\r\n                Job: { hrId: user.HR.id },\r\n            },\r\n            orderBy: { createdAt: 'desc' },\r\n            take: limit,\r\n            include: {\r\n                Candidate: {\r\n                    select: {\r\n                        firstName: true,\r\n                        lastName: true,\r\n                    },\r\n                },\r\n                Job: {\r\n                    select: {\r\n                        title: true,\r\n                        companyName: true,\r\n                    },\r\n                },\r\n            },\r\n        });\r\n\r\n        return recentApplications.map(app => ({\r\n            id: app.id,\r\n            type: 'application',\r\n            Candidate: `${app.candidate.firstName} ${app.candidate.lastName}`,\r\n            jobTitle: app.job.title,\r\n            status: app.status,\r\n            createdAt: app.createdAt,\r\n        }));\r\n    }\r\n\r\n    /**\r\n     * Get HR's jobs\r\n     */\r\n    async getJobs(userId: string, filters?: { status?: string; page?: number; limit?: number }) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const page = filters?.page || 1;\r\n        const limit = filters?.limit || 10;\r\n        const skip = (page - 1) * limit;\r\n\r\n        const where: any = { hrId: user.HR.id };\r\n        if (filters?.status) {\r\n            where.status = filters.status;\r\n        }\r\n\r\n        const [jobs, total] = await Promise.all([\r\n            this.prisma.job.findMany({\r\n                where,\r\n                skip,\r\n                take: limit,\r\n                orderBy: { createdAt: 'desc' },\r\n                include: {\r\n                    _count: {\r\n                        select: { JobApplication: true },\r\n                    },\r\n                    JobSkill: true,\r\n                },\r\n            }),\r\n            this.prisma.job.count({ where }),\r\n        ]);\r\n\r\n        return {\r\n            jobs,\r\n            pagination: {\r\n                page,\r\n                limit,\r\n                total,\r\n                totalPages: Math.ceil(total / limit),\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Create a new job posting\r\n     */\r\n    async createJob(userId: string, dto: CreateJobDto) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        // Generate slug from title\r\n        const baseSlug = dto.title\r\n            .toLowerCase()\r\n            .replace(/[^a-z0-9]+/g, '-')\r\n            .replace(/^-|-$/g, '');\r\n        const randomSuffix = Math.random().toString(36).substring(2, 8);\r\n        const slug = `${baseSlug}-${randomSuffix}`;\r\n\r\n        const job = await this.prisma.$transaction(async (tx) => {\r\n            const newJob = await tx.job.create({\r\n                data: {\r\n                    slug,\r\n                    title: dto.title,\r\n                    description: dto.description,\r\n                    requirements: dto.requirements,\r\n                    responsibilities: dto.responsibilities,\r\n                    companyName: user.HR!.companyName,\r\n                    location: dto.location,\r\n                    isRemote: dto.isRemote ?? false,\r\n                    salaryMin: dto.salaryMin,\r\n                    salaryMax: dto.salaryMax,\r\n                    experienceMin: dto.experienceMin,\r\n                    experienceMax: dto.experienceMax,\r\n                    educationLevel: dto.educationLevel,\r\n                    maxJobApplication: dto.maxApplications ?? 100,\r\n                    referralFee: dto.referralFee ?? 499,\r\n                    status: PrismaJobStatus.DRAFT,\r\n                    hrId: user.HR!.id,\r\n                },\r\n            });\r\n\r\n            // Add skills\r\n            if (dto.JobSkill && dto.jobSkill.length > 0) {\r\n                await tx.jobSkill.createMany({\r\n                    data: dto.jobSkill.map(skill => ({\r\n                        jobId: newJob.id,\r\n                        name: skill,\r\n                        isRequired: true,\r\n                    })),\r\n                });\r\n            }\r\n\r\n            // Update HR stats\r\n            await tx.hR.update({\r\n                where: { id: user.HR!.id },\r\n                data: { totalJobsPosted: { increment: 1 } },\r\n            });\r\n\r\n            // Audit log\r\n            await tx.auditLog.create({\r\n                data: {\r\n                    userId: user.id,\r\n                    action: AuditAction.CREATE,\r\n                    entityType: 'Job',\r\n                    entityId: newJob.id,\r\n                },\r\n            });\r\n\r\n            return newJob;\r\n        });\r\n\r\n        return job;\r\n    }\r\n\r\n    /**\r\n     * Update job status (publish, close, etc.)\r\n     */\r\n    async updateJobStatus(userId: string, jobId: string, dto: UpdateJobStatusDto) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const job = await this.prisma.job.findUnique({\r\n            where: { id: jobId },\r\n        });\r\n\r\n        if (!job) {\r\n            throw new NotFoundException('Job not found');\r\n        }\r\n\r\n        if (job.hrId !== user.HR.id) {\r\n            throw new ForbiddenException('You can only modify your own jobs');\r\n        }\r\n\r\n        const newStatus = dto.status as PrismaJobStatus;\r\n        const originalStatus = job.status;\r\n\r\n        const updatedJob = await this.prisma.$transaction(async (tx) => {\r\n            const updated = await tx.job.update({\r\n                where: { id: jobId },\r\n                data: {\r\n                    status: newStatus,\r\n                    postedAt: newStatus === PrismaJobStatus.ACTIVE ? new Date() : undefined,\r\n                },\r\n            });\r\n\r\n            // Update active jobs count\r\n            if (newStatus === PrismaJobStatus.ACTIVE && originalStatus !== PrismaJobStatus.ACTIVE) {\r\n                await tx.hR.update({\r\n                    where: { id: user.HR!.id },\r\n                    data: { activeJobs: { increment: 1 } },\r\n                });\r\n            } else if (originalStatus === PrismaJobStatus.ACTIVE && newStatus !== PrismaJobStatus.ACTIVE) {\r\n                await tx.hR.update({\r\n                    where: { id: user.HR!.id },\r\n                    data: { activeJobs: { decrement: 1 } },\r\n                });\r\n            }\r\n\r\n            // Audit log\r\n            await tx.auditLog.create({\r\n                data: {\r\n                    userId: user.id,\r\n                    action: AuditAction.UPDATE,\r\n                    entityType: 'Job',\r\n                    entityId: jobId,\r\n                    oldValue: { status: job.status },\r\n                    newValue: { status: dto.status },\r\n                },\r\n            });\r\n\r\n            return updated;\r\n        });\r\n\r\n        return updatedJob;\r\n    }\r\n\r\n    /**\r\n     * Get a single job by ID\r\n     */\r\n    async getJobById(userId: string, jobId: string) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const job = await this.prisma.job.findUnique({\r\n            where: { id: jobId },\r\n            include: {\r\n                JobSkill: true,\r\n                JobApplication: {\r\n                    select: {\r\n                        id: true,\r\n                        status: true,\r\n                        createdAt: true,\r\n                    },\r\n                },\r\n            },\r\n        });\r\n\r\n        if (!job) {\r\n            throw new NotFoundException('Job not found');\r\n        }\r\n\r\n        if (job.hrId !== user.HR.id) {\r\n            throw new ForbiddenException('You can only view your own jobs');\r\n        }\r\n\r\n        return job;\r\n    }\r\n\r\n    /**\r\n     * Update a job (full edit)\r\n     */\r\n    async updateJob(userId: string, jobId: string, dto: UpdateJobDto) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const existingJob = await this.prisma.job.findUnique({\r\n            where: { id: jobId },\r\n            include: { JobSkill: true },\r\n        });\r\n\r\n        if (!existingJob) {\r\n            throw new NotFoundException('Job not found');\r\n        }\r\n\r\n        if (existingJob.hrId !== user.HR.id) {\r\n            throw new ForbiddenException('You can only modify your own jobs');\r\n        }\r\n\r\n        const updatedJob = await this.prisma.$transaction(async (tx) => {\r\n            // Update skills if provided\r\n            if (dto.JobSkill && dto.jobSkill.length > 0) {\r\n                // Delete existing skills\r\n                await tx.jobSkill.deleteMany({\r\n                    where: { jobId },\r\n                });\r\n                // Add new skills\r\n                await tx.jobSkill.createMany({\r\n                    data: dto.jobSkill.map(skill => ({\r\n                        jobId,\r\n                        name: skill,\r\n                        isRequired: true,\r\n                    })),\r\n                });\r\n            }\r\n\r\n            // Update job data\r\n            const updated = await tx.job.update({\r\n                where: { id: jobId },\r\n                data: {\r\n                    title: dto.title,\r\n                    description: dto.description,\r\n                    requirements: dto.requirements,\r\n                    responsibilities: dto.responsibilities,\r\n                    location: dto.location,\r\n                    isRemote: dto.isRemote,\r\n                    salaryMin: dto.salaryMin,\r\n                    salaryMax: dto.salaryMax,\r\n                    experienceMin: dto.experienceMin,\r\n                    experienceMax: dto.experienceMax,\r\n                    educationLevel: dto.educationLevel,\r\n                    maxJobApplication: dto.maxApplications,\r\n                    referralFee: dto.referralFee,\r\n                    status: dto.status ? dto.status as PrismaJobStatus : undefined,\r\n                },\r\n                include: { JobSkill: true },\r\n            });\r\n\r\n            // Audit log\r\n            await tx.auditLog.create({\r\n                data: {\r\n                    userId: user.id,\r\n                    action: AuditAction.UPDATE,\r\n                    entityType: 'Job',\r\n                    entityId: jobId,\r\n                    oldValue: { title: existingJob.title, status: existingJob.status },\r\n                    newValue: { title: dto.title || existingJob.title, status: dto.status || existingJob.status },\r\n                },\r\n            });\r\n\r\n            return updated;\r\n        });\r\n\r\n        return updatedJob;\r\n    }\r\n\r\n    /**\r\n     * Delete a job\r\n     */\r\n    async deleteJob(userId: string, jobId: string) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const job = await this.prisma.job.findUnique({\r\n            where: { id: jobId },\r\n        });\r\n\r\n        if (!job) {\r\n            throw new NotFoundException('Job not found');\r\n        }\r\n\r\n        if (job.hrId !== user.HR.id) {\r\n            throw new ForbiddenException('You can only delete your own jobs');\r\n        }\r\n\r\n        await this.prisma.$transaction(async (tx) => {\r\n            // Delete related records first\r\n            await tx.jobSkill.deleteMany({ where: { jobId } });\r\n            await tx.jobApplication.deleteMany({ where: { jobId } });\r\n\r\n            // Delete the job\r\n            await tx.job.delete({ where: { id: jobId } });\r\n\r\n            // Update HR stats\r\n            await tx.hR.update({\r\n                where: { id: user.HR!.id },\r\n                data: {\r\n                    totalJobsPosted: { decrement: 1 },\r\n                    activeJobs: job.status === PrismaJobStatus.ACTIVE ? { decrement: 1 } : undefined,\r\n                },\r\n            });\r\n\r\n            // Audit log\r\n            await tx.auditLog.create({\r\n                data: {\r\n                    userId: user.id,\r\n                    action: AuditAction.DELETE,\r\n                    entityType: 'Job',\r\n                    entityId: jobId,\r\n                    oldValue: { title: job.title, status: job.status },\r\n                },\r\n            });\r\n        });\r\n\r\n        return { message: 'Job deleted successfully' };\r\n    }\r\n\r\n    /**\r\n     * Get applications for HR's jobs\r\n     */\r\n    async getApplications(userId: string, filters?: { jobId?: string; status?: string; page?: number; limit?: number }) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const page = filters?.page || 1;\r\n        const limit = filters?.limit || 20;\r\n        const skip = (page - 1) * limit;\r\n\r\n        const where: any = {\r\n            Job: { hrId: user.HR.id },\r\n        };\r\n\r\n        if (filters?.jobId) {\r\n            where.jobId = filters.jobId;\r\n        }\r\n\r\n        if (filters?.status) {\r\n            where.status = filters.status;\r\n        }\r\n\r\n        const [applications, total] = await Promise.all([\r\n            this.prisma.jobApplication.findMany({\r\n                where,\r\n                skip,\r\n                take: limit,\r\n                orderBy: { createdAt: 'desc' },\r\n                include: {\r\n                    Candidate: {\r\n                        select: {\r\n                            firstName: true,\r\n                            lastName: true,\r\n                            headline: true,\r\n                            totalExperience: true,\r\n                            currentCompany: true,\r\n                            JobSkill: {\r\n                                select: {\r\n                                    name: true,\r\n                                    level: true,\r\n                                },\r\n                            },\r\n                        },\r\n                    },\r\n                    Job: {\r\n                        select: {\r\n                            id: true,\r\n                            title: true,\r\n                            companyName: true,\r\n                        },\r\n                    },\r\n                },\r\n            }),\r\n            this.prisma.jobApplication.count({ where }),\r\n        ]);\r\n\r\n        return {\r\n            applications,\r\n            pagination: {\r\n                page,\r\n                limit,\r\n                total,\r\n                totalPages: Math.ceil(total / limit),\r\n            },\r\n        };\r\n    }\r\n}\r\n\r\n"],"names":["HRService","MAX_LOGIN_ATTEMPTS","LOCKOUT_DURATION_MS","register","dto","deviceInfo","existingUser","prisma","user","findUnique","where","email","ConflictException","phone","existingPhone","existingHR","hR","findFirst","companyEmail","passwordHash","bcrypt","hash","password","result","$transaction","tx","create","data","role","UserRole","HR","status","UserStatus","ACTIVE","emailVerified","hr","userId","id","companyName","companyWebsite","designation","linkedinUrl","approvalStatus","HRApprovalStatus","APPROVED","approvedAt","Date","deviceLog","deviceId","ipAddress","ip","userAgent","auditLog","action","AuditAction","CREATE","entityType","entityId","metadata","registrationSource","payload","sub","tokens","tokenService","generateTokenPair","User","login","include","UnauthorizedException","BLOCKED","BadRequestException","PENDING","ForbiddenException","REJECTED","rejectionReason","isValid","compare","update","lastLoginAt","LOGIN","portal","getProfile","jobs","select","title","applicationCount","NotFoundException","userWithoutPassword","updateProfile","updated","getDashboardStats","hrId","job","findMany","JobApplication","createdAt","now","thirtyDaysAgo","getTime","totalJobs","length","activeJobs","filter","j","PrismaJobStatus","totalApplications","reduce","acc","jobApplication","recentApplications","a","pendingReferrals","referral","count","confirmedReferrals","jobsByStatus","draft","DRAFT","active","closed","CLOSED","expired","EXPIRED","getRecentActivity","limit","Job","orderBy","take","Candidate","firstName","lastName","map","app","type","candidate","jobTitle","getJobs","filters","page","skip","total","Promise","all","_count","JobSkill","pagination","totalPages","Math","ceil","createJob","baseSlug","toLowerCase","replace","randomSuffix","random","toString","substring","slug","newJob","description","requirements","responsibilities","location","isRemote","salaryMin","salaryMax","experienceMin","experienceMax","educationLevel","maxJobApplication","maxApplications","referralFee","jobSkill","createMany","skill","jobId","name","isRequired","totalJobsPosted","increment","updateJobStatus","newStatus","originalStatus","updatedJob","postedAt","undefined","decrement","UPDATE","oldValue","newValue","getJobById","updateJob","existingJob","deleteMany","deleteJob","delete","DELETE","message","getApplications","applications","headline","totalExperience","currentCompany","level"],"mappings":"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"}