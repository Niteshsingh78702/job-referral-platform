{"version":3,"sources":["../../../../src/modules/hr/services/hr.service.ts"],"sourcesContent":["import {\r\n    Injectable,\r\n    UnauthorizedException,\r\n    ConflictException,\r\n    BadRequestException,\r\n    NotFoundException,\r\n    ForbiddenException,\r\n} from '@nestjs/common';\r\nimport * as bcrypt from 'bcrypt';\r\nimport * as crypto from 'crypto';\r\nimport { PrismaService } from '../../../prisma/prisma.service';\r\nimport { TokenService, JwtPayload } from '../../auth/services/token.service';\r\nimport { HRRegisterDto, HRLoginDto, UpdateHRProfileDto, CreateJobDto, UpdateJobStatusDto, UpdateJobDto } from '../dto';\r\nimport { UserRole, UserStatus, HRApprovalStatus, AuditAction } from '../../../common/constants';\r\nimport { JobStatus as PrismaJobStatus } from '@prisma/client';\r\n\r\n// Rate limiting constants\r\nconst MAX_LOGIN_ATTEMPTS = 5;\r\nconst LOCKOUT_DURATION_MS = 15 * 60 * 1000; // 15 minutes\r\n\r\n@Injectable()\r\nexport class HRService {\r\n    constructor(\r\n        private prisma: PrismaService,\r\n        private tokenService: TokenService,\r\n    ) { }\r\n\r\n    /**\r\n     * Register a new HR account\r\n     * - Validates corporate email domain\r\n     * - Creates user with HR role\r\n     * - Creates HR profile with pending approval status (auto-approved for dev)\r\n     */\r\n    async register(dto: HRRegisterDto, deviceInfo?: any) {\r\n        // Check if email already exists\r\n        const existingUser = await this.prisma.user.findUnique({\r\n            where: { email: dto.email },\r\n        });\r\n\r\n        if (existingUser) {\r\n            throw new ConflictException('Email already registered');\r\n        }\r\n\r\n        // Check phone if provided\r\n        if (dto.phone) {\r\n            const existingPhone = await this.prisma.user.findUnique({\r\n                where: { phone: dto.phone },\r\n            });\r\n            if (existingPhone) {\r\n                throw new ConflictException('Phone number already registered');\r\n            }\r\n        }\r\n\r\n        // Check company email already registered as HR\r\n        const existingHR = await this.prisma.hR.findFirst({\r\n            where: { companyEmail: dto.companyEmail },\r\n        });\r\n\r\n        if (existingHR) {\r\n            throw new ConflictException('Company email already registered');\r\n        }\r\n\r\n        // Hash password\r\n        const passwordHash = await bcrypt.hash(dto.password, 12);\r\n\r\n        // Create user and HR profile in transaction\r\n        const result = await this.prisma.$transaction(async (tx) => {\r\n            // Create user with HR role\r\n            const user = await tx.user.create({\r\n                data: {\r\n                    id: crypto.randomUUID(),\r\n                    email: dto.email,\r\n                    phone: dto.phone,\r\n                    passwordHash,\r\n                    role: UserRole.HR,\r\n                    status: UserStatus.ACTIVE, // Auto-activate for dev\r\n                    emailVerified: true, // Auto-verify for dev\r\n                    updatedAt: new Date(),\r\n                },\r\n            });\r\n\r\n            // Create HR profile - Auto-approved for development\r\n            const hr = await tx.hR.create({\r\n                data: {\r\n                    id: crypto.randomUUID(),\r\n                    userId: user.id,\r\n                    companyName: dto.companyName,\r\n                    companyEmail: dto.companyEmail,\r\n                    companyWebsite: dto.companyWebsite,\r\n                    designation: dto.designation,\r\n                    linkedinUrl: dto.linkedinUrl,\r\n                    approvalStatus: HRApprovalStatus.APPROVED, // Auto-approve for dev\r\n                    approvedAt: new Date(),\r\n                    updatedAt: new Date(),\r\n                },\r\n            });\r\n\r\n            // Log device\r\n            if (deviceInfo) {\r\n                await tx.deviceLog.create({\r\n                    data: {\r\n                        id: crypto.randomUUID(),\r\n                        userId: user.id,\r\n                        deviceId: deviceInfo.deviceId || 'unknown',\r\n                        ipAddress: deviceInfo.ip || 'unknown',\r\n                        userAgent: deviceInfo.userAgent,\r\n                    },\r\n                });\r\n            }\r\n\r\n            // Create audit log\r\n            await tx.auditLog.create({\r\n                data: {\r\n                    id: crypto.randomUUID(),\r\n                    userId: user.id,\r\n                    action: AuditAction.CREATE,\r\n                    entityType: 'HR',\r\n                    entityId: hr.id,\r\n                    metadata: { registrationSource: 'hr_portal' },\r\n                },\r\n            });\r\n\r\n            return { user, hr };\r\n        });\r\n\r\n        // Generate tokens\r\n        const payload: JwtPayload = {\r\n            sub: result.user.id,\r\n            email: result.user.email,\r\n            role: result.user.role,\r\n        };\r\n\r\n        const tokens = await this.tokenService.generateTokenPair(payload);\r\n\r\n        return {\r\n            ...tokens,\r\n            User: {\r\n                id: result.user.id,\r\n                email: result.user.email,\r\n                role: result.user.role,\r\n                HR: {\r\n                    id: result.hr.id,\r\n                    companyName: result.hr.companyName,\r\n                    approvalStatus: result.hr.approvalStatus,\r\n                },\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Login for HR users\r\n     * - Implements rate limiting (5 attempts per 15 min)\r\n     * - Checks HR approval status\r\n     */\r\n    async login(dto: HRLoginDto, deviceInfo?: any) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { email: dto.email },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.passwordHash) {\r\n            throw new UnauthorizedException('Invalid credentials');\r\n        }\r\n\r\n        if (user.role !== UserRole.HR) {\r\n            throw new UnauthorizedException('This login is for HR accounts only');\r\n        }\r\n\r\n        if (user.status === UserStatus.BLOCKED) {\r\n            throw new UnauthorizedException('Account is blocked. Please contact support.');\r\n        }\r\n\r\n        // Check HR approval status\r\n        if (!user.HR) {\r\n            throw new BadRequestException('HR profile not found');\r\n        }\r\n\r\n        if (user.HR.approvalStatus === HRApprovalStatus.PENDING) {\r\n            throw new ForbiddenException('Your account is pending approval. Please wait for admin verification.');\r\n        }\r\n\r\n        if (user.HR.approvalStatus === HRApprovalStatus.REJECTED) {\r\n            throw new ForbiddenException(`Account rejected: ${user.HR.rejectionReason || 'Please contact support.'}`);\r\n        }\r\n\r\n        // Verify password\r\n        const isValid = await bcrypt.compare(dto.password, user.passwordHash);\r\n        if (!isValid) {\r\n            throw new UnauthorizedException('Invalid credentials');\r\n        }\r\n\r\n        // Update last login\r\n        await this.prisma.$transaction(async (tx) => {\r\n            await tx.user.update({\r\n                where: { id: user.id },\r\n                data: { lastLoginAt: new Date() },\r\n            });\r\n\r\n            // Log device\r\n            if (deviceInfo) {\r\n                await tx.deviceLog.create({\r\n                    data: {\r\n                        id: crypto.randomUUID(),\r\n                        userId: user.id,\r\n                        deviceId: deviceInfo.deviceId || 'unknown',\r\n                        ipAddress: deviceInfo.ip || 'unknown',\r\n                        userAgent: deviceInfo.userAgent,\r\n                    },\r\n                });\r\n            }\r\n\r\n            // Audit log\r\n            await tx.auditLog.create({\r\n                data: {\r\n                    id: crypto.randomUUID(),\r\n                    userId: user.id,\r\n                    action: AuditAction.LOGIN,\r\n                    entityType: 'HR',\r\n                    entityId: user.HR!.id,\r\n                    metadata: { ip: deviceInfo?.ip, portal: 'hr' },\r\n                },\r\n            });\r\n        });\r\n\r\n        // Generate tokens\r\n        const payload: JwtPayload = {\r\n            sub: user.id,\r\n            email: user.email,\r\n            role: user.role,\r\n        };\r\n\r\n        const tokens = await this.tokenService.generateTokenPair(payload);\r\n\r\n        return {\r\n            ...tokens,\r\n            User: {\r\n                id: user.id,\r\n                email: user.email,\r\n                role: user.role,\r\n                HR: {\r\n                    id: user.HR.id,\r\n                    companyName: user.HR.companyName,\r\n                    designation: user.HR.designation,\r\n                },\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get HR profile with stats\r\n     */\r\n    async getProfile(userId: string) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: {\r\n                HR: {\r\n                    include: {\r\n                        Job: {\r\n                            select: {\r\n                                id: true,\r\n                                title: true,\r\n                                status: true,\r\n                                applicationCount: true,\r\n                            },\r\n                        },\r\n                    },\r\n                },\r\n            },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const { passwordHash, ...userWithoutPassword } = user;\r\n        return userWithoutPassword;\r\n    }\r\n\r\n    /**\r\n     * Update HR profile\r\n     */\r\n    async updateProfile(userId: string, dto: UpdateHRProfileDto) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const updated = await this.prisma.hR.update({\r\n            where: { id: user.HR.id },\r\n            data: {\r\n                companyName: dto.companyName,\r\n                companyWebsite: dto.companyWebsite,\r\n                designation: dto.designation,\r\n                linkedinUrl: dto.linkedinUrl,\r\n            },\r\n        });\r\n\r\n        return updated;\r\n    }\r\n\r\n    /**\r\n     * Get dashboard statistics\r\n     */\r\n    async getDashboardStats(userId: string) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const hrId = user.HR.id;\r\n\r\n        // Get job stats\r\n        const jobs = await this.prisma.job.findMany({\r\n            where: { hrId },\r\n            include: {\r\n                JobApplication: {\r\n                    select: {\r\n                        id: true,\r\n                        status: true,\r\n                        createdAt: true,\r\n                    },\r\n                },\r\n            },\r\n        });\r\n\r\n        const now = new Date();\r\n        const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\r\n\r\n        const totalJobs = jobs.length;\r\n        const activeJobs = jobs.filter(j => j.status === PrismaJobStatus.ACTIVE).length;\r\n        const totalApplications = jobs.reduce((acc, j) => acc + j.JobApplication.length, 0);\r\n        const recentApplications = jobs.reduce((acc, j) =>\r\n            acc + j.JobApplication.filter(a => a.createdAt >= thirtyDaysAgo).length, 0);\r\n\r\n        const pendingReferrals = await this.prisma.referral.count({\r\n            where: {\r\n                hrId,\r\n                status: 'PENDING',\r\n            },\r\n        });\r\n\r\n        const confirmedReferrals = await this.prisma.referral.count({\r\n            where: {\r\n                hrId,\r\n                status: 'CONFIRMED',\r\n            },\r\n        });\r\n\r\n        return {\r\n            totalJobs,\r\n            activeJobs,\r\n            totalApplications,\r\n            recentApplications,\r\n            pendingReferrals,\r\n            confirmedReferrals,\r\n            jobsByStatus: {\r\n                draft: jobs.filter(j => j.status === PrismaJobStatus.DRAFT).length,\r\n                active: activeJobs,\r\n                closed: jobs.filter(j => j.status === PrismaJobStatus.CLOSED).length,\r\n                expired: jobs.filter(j => j.status === PrismaJobStatus.EXPIRED).length,\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get recent activity for dashboard\r\n     */\r\n    async getRecentActivity(userId: string, limit: number = 10) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        // Get recent applications on HR's jobs\r\n        const recentApplications = await this.prisma.jobApplication.findMany({\r\n            where: {\r\n                Job: { hrId: user.HR.id },\r\n            },\r\n            orderBy: { createdAt: 'desc' },\r\n            take: limit,\r\n            include: {\r\n                Candidate: {\r\n                    select: {\r\n                        firstName: true,\r\n                        lastName: true,\r\n                    },\r\n                },\r\n                Job: {\r\n                    select: {\r\n                        title: true,\r\n                        companyName: true,\r\n                    },\r\n                },\r\n            },\r\n        });\r\n\r\n        return recentApplications.map(app => ({\r\n            id: app.id,\r\n            type: 'application',\r\n            Candidate: `${app.Candidate.firstName} ${app.Candidate.lastName}`,\r\n            jobTitle: app.Job.title,\r\n            status: app.status,\r\n            createdAt: app.createdAt,\r\n        }));\r\n    }\r\n\r\n    /**\r\n     * Get HR's jobs\r\n     */\r\n    async getJobs(userId: string, filters?: { status?: string; page?: number; limit?: number }) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const page = filters?.page || 1;\r\n        const limit = filters?.limit || 10;\r\n        const skip = (page - 1) * limit;\r\n\r\n        const where: any = { hrId: user.HR.id };\r\n        if (filters?.status) {\r\n            where.status = filters.status;\r\n        }\r\n\r\n        const [jobs, total] = await Promise.all([\r\n            this.prisma.job.findMany({\r\n                where,\r\n                skip,\r\n                take: limit,\r\n                orderBy: { createdAt: 'desc' },\r\n                include: {\r\n                    _count: {\r\n                        select: { JobApplication: true },\r\n                    },\r\n                    JobSkill: true,\r\n                },\r\n            }),\r\n            this.prisma.job.count({ where }),\r\n        ]);\r\n\r\n        return {\r\n            jobs,\r\n            pagination: {\r\n                page,\r\n                limit,\r\n                total,\r\n                totalPages: Math.ceil(total / limit),\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Create a new job posting\r\n     */\r\n    async createJob(userId: string, dto: CreateJobDto) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        // Generate slug from title\r\n        const baseSlug = dto.title\r\n            .toLowerCase()\r\n            .replace(/[^a-z0-9]+/g, '-')\r\n            .replace(/^-|-$/g, '');\r\n        const randomSuffix = Math.random().toString(36).substring(2, 8);\r\n        const slug = `${baseSlug}-${randomSuffix}`;\r\n\r\n        const job = await this.prisma.$transaction(async (tx) => {\r\n            const newJob = await tx.job.create({\r\n                data: {\r\n                    id: crypto.randomUUID(),\r\n                    slug,\r\n                    title: dto.title,\r\n                    description: dto.description,\r\n                    requirements: dto.requirements,\r\n                    responsibilities: dto.responsibilities,\r\n                    companyName: user.HR!.companyName,\r\n                    location: dto.location,\r\n                    isRemote: dto.isRemote ?? false,\r\n                    salaryMin: dto.salaryMin,\r\n                    salaryMax: dto.salaryMax,\r\n                    experienceMin: dto.experienceMin,\r\n                    experienceMax: dto.experienceMax,\r\n                    educationLevel: dto.educationLevel,\r\n                    maxApplications: dto.maxApplications ?? 100, // Ensure field name matches schema\r\n                    referralFee: dto.referralFee ?? 499,\r\n                    status: PrismaJobStatus.DRAFT,\r\n                    hrId: user.HR!.id,\r\n                    updatedAt: new Date(),\r\n                },\r\n            });\r\n\r\n            // Add skills\r\n            if (dto.jobSkill && dto.jobSkill.length > 0) {\r\n                await tx.jobSkill.createMany({\r\n                    data: dto.jobSkill.map(skill => ({\r\n                        id: crypto.randomUUID(),\r\n                        jobId: newJob.id,\r\n                        name: skill,\r\n                        isRequired: true,\r\n                    })),\r\n                });\r\n            }\r\n\r\n            // Update HR stats\r\n            await tx.hR.update({\r\n                where: { id: user.HR!.id },\r\n                data: { totalJobsPosted: { increment: 1 } },\r\n            });\r\n\r\n            // Audit log\r\n            await tx.auditLog.create({\r\n                data: {\r\n                    id: crypto.randomUUID(),\r\n                    userId: user.id,\r\n                    action: AuditAction.CREATE,\r\n                    entityType: 'Job',\r\n                    entityId: newJob.id,\r\n                },\r\n            });\r\n\r\n            return newJob;\r\n        });\r\n\r\n        return job;\r\n    }\r\n\r\n    /**\r\n     * Update job status (publish, close, etc.)\r\n     */\r\n    async updateJobStatus(userId: string, jobId: string, dto: UpdateJobStatusDto) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const job = await this.prisma.job.findUnique({\r\n            where: { id: jobId },\r\n        });\r\n\r\n        if (!job) {\r\n            throw new NotFoundException('Job not found');\r\n        }\r\n\r\n        if (job.hrId !== user.HR.id) {\r\n            throw new ForbiddenException('You can only modify your own jobs');\r\n        }\r\n\r\n        const newStatus = dto.status as PrismaJobStatus;\r\n        const originalStatus = job.status;\r\n\r\n        const updatedJob = await this.prisma.$transaction(async (tx) => {\r\n            const updated = await tx.job.update({\r\n                where: { id: jobId },\r\n                data: {\r\n                    status: newStatus,\r\n                    postedAt: newStatus === PrismaJobStatus.ACTIVE ? new Date() : undefined,\r\n                },\r\n            });\r\n\r\n            // Update active jobs count\r\n            if (newStatus === PrismaJobStatus.ACTIVE && originalStatus !== PrismaJobStatus.ACTIVE) {\r\n                await tx.hR.update({\r\n                    where: { id: user.HR!.id },\r\n                    data: { activeJobs: { increment: 1 } },\r\n                });\r\n            } else if (originalStatus === PrismaJobStatus.ACTIVE && newStatus !== PrismaJobStatus.ACTIVE) {\r\n                await tx.hR.update({\r\n                    where: { id: user.HR!.id },\r\n                    data: { activeJobs: { decrement: 1 } },\r\n                });\r\n            }\r\n\r\n            // Audit log\r\n            await tx.auditLog.create({\r\n                data: {\r\n                    id: crypto.randomUUID(),\r\n                    userId: user.id,\r\n                    action: AuditAction.UPDATE,\r\n                    entityType: 'Job',\r\n                    entityId: jobId,\r\n                    oldValue: { status: job.status },\r\n                    newValue: { status: dto.status },\r\n                },\r\n            });\r\n\r\n            return updated;\r\n        });\r\n\r\n        return updatedJob;\r\n    }\r\n\r\n    /**\r\n     * Get a single job by ID\r\n     */\r\n    async getJobById(userId: string, jobId: string) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const job = await this.prisma.job.findUnique({\r\n            where: { id: jobId },\r\n            include: {\r\n                JobSkill: true,\r\n                JobApplication: {\r\n                    select: {\r\n                        id: true,\r\n                        status: true,\r\n                        createdAt: true,\r\n                    },\r\n                },\r\n            },\r\n        });\r\n\r\n        if (!job) {\r\n            throw new NotFoundException('Job not found');\r\n        }\r\n\r\n        if (job.hrId !== user.HR.id) {\r\n            throw new ForbiddenException('You can only view your own jobs');\r\n        }\r\n\r\n        return job;\r\n    }\r\n\r\n    /**\r\n     * Update a job (full edit)\r\n     */\r\n    async updateJob(userId: string, jobId: string, dto: UpdateJobDto) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const existingJob = await this.prisma.job.findUnique({\r\n            where: { id: jobId },\r\n            include: { JobSkill: true },\r\n        });\r\n\r\n        if (!existingJob) {\r\n            throw new NotFoundException('Job not found');\r\n        }\r\n\r\n        if (existingJob.hrId !== user.HR.id) {\r\n            throw new ForbiddenException('You can only modify your own jobs');\r\n        }\r\n\r\n        const updatedJob = await this.prisma.$transaction(async (tx) => {\r\n            // Update skills if provided\r\n            if (dto.jobSkill && dto.jobSkill.length > 0) {\r\n                // Delete existing skills\r\n                await tx.jobSkill.deleteMany({\r\n                    where: { jobId },\r\n                });\r\n                // Add new skills\r\n                await tx.jobSkill.createMany({\r\n                    data: dto.jobSkill.map(skill => ({\r\n                        id: crypto.randomUUID(),\r\n                        jobId,\r\n                        name: skill,\r\n                        isRequired: true,\r\n                    })),\r\n                });\r\n            }\r\n\r\n            // Update job data\r\n            const updated = await tx.job.update({\r\n                where: { id: jobId },\r\n                data: {\r\n                    title: dto.title,\r\n                    description: dto.description,\r\n                    requirements: dto.requirements,\r\n                    responsibilities: dto.responsibilities,\r\n                    location: dto.location,\r\n                    isRemote: dto.isRemote,\r\n                    salaryMin: dto.salaryMin,\r\n                    salaryMax: dto.salaryMax,\r\n                    experienceMin: dto.experienceMin,\r\n                    experienceMax: dto.experienceMax,\r\n                    educationLevel: dto.educationLevel,\r\n                    maxApplications: dto.maxApplications,\r\n                    referralFee: dto.referralFee,\r\n                    status: dto.status ? dto.status as PrismaJobStatus : undefined,\r\n                },\r\n                include: { JobSkill: true },\r\n            });\r\n\r\n            // Audit log\r\n            await tx.auditLog.create({\r\n                data: {\r\n                    id: crypto.randomUUID(),\r\n                    userId: user.id,\r\n                    action: AuditAction.UPDATE,\r\n                    entityType: 'Job',\r\n                    entityId: jobId,\r\n                    oldValue: { title: existingJob.title, status: existingJob.status },\r\n                    newValue: { title: dto.title || existingJob.title, status: dto.status || existingJob.status },\r\n                },\r\n            });\r\n\r\n            return updated;\r\n        });\r\n\r\n        return updatedJob;\r\n    }\r\n\r\n    /**\r\n     * Delete a job\r\n     */\r\n    async deleteJob(userId: string, jobId: string) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const job = await this.prisma.job.findUnique({\r\n            where: { id: jobId },\r\n        });\r\n\r\n        if (!job) {\r\n            throw new NotFoundException('Job not found');\r\n        }\r\n\r\n        if (job.hrId !== user.HR.id) {\r\n            throw new ForbiddenException('You can only delete your own jobs');\r\n        }\r\n\r\n        await this.prisma.$transaction(async (tx) => {\r\n            // Delete related records first\r\n            await tx.jobSkill.deleteMany({ where: { jobId } });\r\n            await tx.jobApplication.deleteMany({ where: { jobId } });\r\n\r\n            // Delete the job\r\n            await tx.job.delete({ where: { id: jobId } });\r\n\r\n            // Update HR stats\r\n            await tx.hR.update({\r\n                where: { id: user.HR!.id },\r\n                data: {\r\n                    totalJobsPosted: { decrement: 1 },\r\n                    activeJobs: job.status === PrismaJobStatus.ACTIVE ? { decrement: 1 } : undefined,\r\n                },\r\n            });\r\n\r\n            // Audit log\r\n            await tx.auditLog.create({\r\n                data: {\r\n                    id: crypto.randomUUID(),\r\n                    userId: user.id,\r\n                    action: AuditAction.DELETE,\r\n                    entityType: 'Job',\r\n                    entityId: jobId,\r\n                    oldValue: { title: job.title, status: job.status },\r\n                },\r\n            });\r\n        });\r\n\r\n        return { message: 'Job deleted successfully' };\r\n    }\r\n\r\n    /**\r\n     * Get applications for HR's jobs\r\n     */\r\n    async getApplications(userId: string, filters?: { jobId?: string; status?: string; page?: number; limit?: number }) {\r\n        const user = await this.prisma.user.findUnique({\r\n            where: { id: userId },\r\n            include: { HR: true },\r\n        });\r\n\r\n        if (!user || !user.HR) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const page = filters?.page || 1;\r\n        const limit = filters?.limit || 20;\r\n        const skip = (page - 1) * limit;\r\n\r\n        const where: any = {\r\n            Job: { hrId: user.HR.id },\r\n        };\r\n\r\n        if (filters?.jobId) {\r\n            where.jobId = filters.jobId;\r\n        }\r\n\r\n        if (filters?.status) {\r\n            where.status = filters.status;\r\n        }\r\n\r\n        const [applications, total] = await Promise.all([\r\n            this.prisma.jobApplication.findMany({\r\n                where,\r\n                skip,\r\n                take: limit,\r\n                orderBy: { createdAt: 'desc' },\r\n                include: {\r\n                    Candidate: {\r\n                        select: {\r\n                            firstName: true,\r\n                            lastName: true,\r\n                            headline: true,\r\n                            totalExperience: true,\r\n                            currentCompany: true,\r\n                            CandidateSkill: {\r\n                                select: {\r\n                                    name: true,\r\n                                    level: true,\r\n                                },\r\n                            },\r\n                        },\r\n                    },\r\n                    Job: {\r\n                        select: {\r\n                            id: true,\r\n                            title: true,\r\n                            companyName: true,\r\n                        },\r\n                    },\r\n                },\r\n            }),\r\n            this.prisma.jobApplication.count({ where }),\r\n        ]);\r\n\r\n        return {\r\n            applications,\r\n            pagination: {\r\n                page,\r\n                limit,\r\n                total,\r\n                totalPages: Math.ceil(total / limit),\r\n            },\r\n        };\r\n    }\r\n}\r\n\r\n"],"names":["HRService","MAX_LOGIN_ATTEMPTS","LOCKOUT_DURATION_MS","register","dto","deviceInfo","existingUser","prisma","user","findUnique","where","email","ConflictException","phone","existingPhone","existingHR","hR","findFirst","companyEmail","passwordHash","bcrypt","hash","password","result","$transaction","tx","create","data","id","crypto","randomUUID","role","UserRole","HR","status","UserStatus","ACTIVE","emailVerified","updatedAt","Date","hr","userId","companyName","companyWebsite","designation","linkedinUrl","approvalStatus","HRApprovalStatus","APPROVED","approvedAt","deviceLog","deviceId","ipAddress","ip","userAgent","auditLog","action","AuditAction","CREATE","entityType","entityId","metadata","registrationSource","payload","sub","tokens","tokenService","generateTokenPair","User","login","include","UnauthorizedException","BLOCKED","BadRequestException","PENDING","ForbiddenException","REJECTED","rejectionReason","isValid","compare","update","lastLoginAt","LOGIN","portal","getProfile","Job","select","title","applicationCount","NotFoundException","userWithoutPassword","updateProfile","updated","getDashboardStats","hrId","jobs","job","findMany","JobApplication","createdAt","now","thirtyDaysAgo","getTime","totalJobs","length","activeJobs","filter","j","PrismaJobStatus","totalApplications","reduce","acc","recentApplications","a","pendingReferrals","referral","count","confirmedReferrals","jobsByStatus","draft","DRAFT","active","closed","CLOSED","expired","EXPIRED","getRecentActivity","limit","jobApplication","orderBy","take","Candidate","firstName","lastName","map","app","type","jobTitle","getJobs","filters","page","skip","total","Promise","all","_count","JobSkill","pagination","totalPages","Math","ceil","createJob","baseSlug","toLowerCase","replace","randomSuffix","random","toString","substring","slug","newJob","description","requirements","responsibilities","location","isRemote","salaryMin","salaryMax","experienceMin","experienceMax","educationLevel","maxApplications","referralFee","jobSkill","createMany","skill","jobId","name","isRequired","totalJobsPosted","increment","updateJobStatus","newStatus","originalStatus","updatedJob","postedAt","undefined","decrement","UPDATE","oldValue","newValue","getJobById","updateJob","existingJob","deleteMany","deleteJob","delete","DELETE","message","getApplications","applications","headline","totalExperience","currentCompany","CandidateSkill","level"],"mappings":"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"}