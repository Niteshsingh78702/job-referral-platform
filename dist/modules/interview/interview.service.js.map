{"version":3,"sources":["../../../src/modules/interview/interview.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  NotFoundException,\r\n  BadRequestException,\r\n  ForbiddenException,\r\n} from '@nestjs/common';\r\nimport * as crypto from 'crypto';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport { EmailService } from '../email/email.service';\r\nimport { ConfirmInterviewDto } from './dto';\r\nimport {\r\n  InterviewStatus,\r\n  InterviewMode,\r\n  PaymentStatus,\r\n  AuditAction,\r\n  ApplicationStatus,\r\n} from '../../common/constants';\r\n\r\n@Injectable()\r\nexport class InterviewService {\r\n  constructor(\r\n    private prisma: PrismaService,\r\n    private emailService: EmailService,\r\n  ) { }\r\n\r\n  /**\r\n   * HR confirms an interview with scheduling details.\r\n   * NEW FLOW: HR sets date/time/mode upfront, then candidate pays to unlock.\r\n   * Creates Interview record with INTERVIEW_CONFIRMED status.\r\n   * Updates application status to INTERVIEW_CONFIRMED.\r\n   */\r\n  async confirmInterview(\r\n    userId: string,\r\n    applicationId: string,\r\n    dto: ConfirmInterviewDto,\r\n  ) {\r\n    // Verify HR owns the job for this application\r\n    const application = await this.prisma.jobApplication.findUnique({\r\n      where: { id: applicationId },\r\n      include: {\r\n        Job: { include: { HR: true } },\r\n        Candidate: { include: { User: true } },\r\n      },\r\n    });\r\n\r\n    if (!application) {\r\n      throw new NotFoundException('Application not found');\r\n    }\r\n\r\n    // Verify application is in APPLIED or TEST_PASSED_WAITING_HR status (test passed)\r\n    if (\r\n      application.status !== ApplicationStatus.APPLIED &&\r\n      application.status !== ApplicationStatus.TEST_PASSED_WAITING_HR\r\n    ) {\r\n      throw new BadRequestException(\r\n        `Cannot confirm interview. Application status is ${application.status}. Expected APPLIED or TEST_PASSED_WAITING_HR (test passed).`,\r\n      );\r\n    }\r\n\r\n    // Check if HR owns this job\r\n    const hr = await this.prisma.hR.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!hr || application.Job.hrId !== hr.id) {\r\n      throw new ForbiddenException(\r\n        'You can only confirm interviews for your own job applications',\r\n      );\r\n    }\r\n\r\n    // Check if interview already exists\r\n    const existingInterview = await this.prisma.interview.findUnique({\r\n      where: { applicationId },\r\n    });\r\n\r\n    if (existingInterview) {\r\n      throw new BadRequestException(\r\n        'Interview already confirmed for this application. Contact admin to modify.',\r\n      );\r\n    }\r\n\r\n    // Create interview with scheduling details and update application status\r\n    const interview = await this.prisma.$transaction(async (tx) => {\r\n      // Create interview record - shortlisting action\r\n      // scheduledDate/Time will be set AFTER payment via scheduleInterview\r\n      const newInterview = await tx.interview.create({\r\n        data: {\r\n          id: crypto.randomUUID(), // Generate unique id\r\n          applicationId,\r\n          mode: dto.mode as any,\r\n          scheduledDate: dto.scheduledDate ? new Date(dto.scheduledDate) : null, // Optional - set after payment\r\n          scheduledTime: dto.scheduledTime || null, // Optional - set after payment\r\n          hrNotes: dto.hrNote,\r\n          status: InterviewStatus.INTERVIEW_CONFIRMED as any,\r\n          paymentStatus: PaymentStatus.ELIGIBLE as any,\r\n          scheduledAt: null, // Will be set when HR schedules after payment\r\n          updatedAt: new Date(), // Required field without default\r\n        },\r\n      });\r\n\r\n      // Update application status to INTERVIEW_CONFIRMED\r\n      await tx.jobApplication.update({\r\n        where: { id: applicationId },\r\n        data: { status: ApplicationStatus.INTERVIEW_CONFIRMED as any },\r\n      });\r\n\r\n      // Create audit log\r\n      await tx.auditLog.create({\r\n        data: {\r\n          id: crypto.randomUUID(),\r\n          userId,\r\n          action: AuditAction.CREATE,\r\n          entityType: 'Interview',\r\n          entityId: newInterview.id,\r\n          newValue: {\r\n            mode: dto.mode,\r\n            scheduledDate: dto.scheduledDate,\r\n            scheduledTime: dto.scheduledTime,\r\n            applicationId,\r\n            status: InterviewStatus.INTERVIEW_CONFIRMED,\r\n          },\r\n        },\r\n      });\r\n\r\n      return newInterview;\r\n    });\r\n\r\n    // Send notification email to candidate - \"Pay ‚Çπ99 to unlock details\"\r\n    await this.sendInterviewConfirmedEmail(application, dto);\r\n\r\n    return {\r\n      message:\r\n        'Interview confirmed successfully. Candidate will be notified to make payment.',\r\n      interview: {\r\n        id: interview.id,\r\n        mode: interview.mode,\r\n        status: interview.status,\r\n        scheduledDate: interview.scheduledDate,\r\n        scheduledTime: interview.scheduledTime,\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * HR schedules interview after candidate has paid.\r\n   * Updates interview with date, time, meeting link, and details.\r\n   */\r\n  async scheduleInterview(\r\n    userId: string,\r\n    interviewId: string,\r\n    dto: {\r\n      scheduledDate: string;\r\n      scheduledTime: string;\r\n      mode?: string;\r\n      interviewLink?: string;\r\n      callDetails?: string;\r\n    },\r\n  ) {\r\n    // Get HR record\r\n    const hr = await this.prisma.hR.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!hr) {\r\n      throw new NotFoundException('HR profile not found');\r\n    }\r\n\r\n    // Get interview and verify ownership\r\n    const interview = await this.prisma.interview.findUnique({\r\n      where: { id: interviewId },\r\n      include: {\r\n        JobApplication: {\r\n          include: {\r\n            Job: true,\r\n            Candidate: {\r\n              include: {\r\n                User: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!interview) {\r\n      throw new NotFoundException('Interview not found');\r\n    }\r\n\r\n    // Verify HR owns this job\r\n    if (interview.JobApplication.Job.hrId !== hr.id) {\r\n      throw new ForbiddenException(\r\n        'You do not have permission to schedule this interview',\r\n      );\r\n    }\r\n\r\n    // Verify payment was successful\r\n    if (\r\n      interview.paymentStatus !== 'SUCCESS' &&\r\n      interview.status !== 'PAYMENT_SUCCESS'\r\n    ) {\r\n      throw new BadRequestException(\r\n        'Cannot schedule interview - payment not received',\r\n      );\r\n    }\r\n\r\n    // Update interview with schedule details\r\n    const updatedInterview = await this.prisma.interview.update({\r\n      where: { id: interviewId },\r\n      data: {\r\n        scheduledDate: new Date(dto.scheduledDate),\r\n        scheduledTime: dto.scheduledTime,\r\n        mode: dto.mode || interview.mode, // Update mode if provided\r\n        interviewLink: dto.interviewLink || null,\r\n        callDetails: dto.callDetails || null,\r\n        scheduledAt: new Date(),\r\n        updatedAt: new Date(),\r\n      },\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      message: 'Interview scheduled successfully. Candidate has been notified.',\r\n      interview: {\r\n        id: updatedInterview.id,\r\n        scheduledDate: updatedInterview.scheduledDate,\r\n        scheduledTime: updatedInterview.scheduledTime,\r\n        interviewLink: updatedInterview.interviewLink,\r\n        callDetails: updatedInterview.callDetails,\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Process successful payment - called by payment service.\r\n   * Transitions interview from INTERVIEW_CONFIRMED to PAYMENT_SUCCESS.\r\n   * Now candidate can see interview details.\r\n   */\r\n  async processPaymentSuccess(applicationId: string, paymentId: string) {\r\n    const interview = await this.prisma.interview.findUnique({\r\n      where: { applicationId },\r\n      include: {\r\n        JobApplication: {\r\n          include: {\r\n            Job: { include: { HR: { include: { User: true } } } },\r\n            Candidate: { include: { User: true } },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!interview) {\r\n      throw new NotFoundException('Interview not found for this application');\r\n    }\r\n\r\n    if (interview.status !== InterviewStatus.INTERVIEW_CONFIRMED) {\r\n      throw new BadRequestException(\r\n        `Interview is in ${interview.status} status. Expected INTERVIEW_CONFIRMED.`,\r\n      );\r\n    }\r\n\r\n    // Update interview and application status\r\n    const updatedInterview = await this.prisma.$transaction(async (tx) => {\r\n      const updated = await tx.interview.update({\r\n        where: { id: interview.id },\r\n        data: {\r\n          status: InterviewStatus.PAYMENT_SUCCESS as any,\r\n          paymentStatus: PaymentStatus.SUCCESS as any,\r\n          paidAt: new Date(),\r\n        },\r\n      });\r\n\r\n      // Update application status\r\n      await tx.jobApplication.update({\r\n        where: { id: applicationId },\r\n        data: { status: ApplicationStatus.PAYMENT_SUCCESS as any },\r\n      });\r\n\r\n      return updated;\r\n    });\r\n\r\n    // Send confirmation email to candidate with interview details\r\n    await this.sendPaymentSuccessEmail(interview);\r\n\r\n    // Notify HR that candidate has paid\r\n    await this.sendPaymentNotificationToHR(interview);\r\n\r\n    return updatedInterview;\r\n  }\r\n\r\n  /**\r\n   * Get interview details for candidate.\r\n   * CRITICAL: Only return interview details if payment is successful.\r\n   */\r\n  async getInterviewForCandidate(userId: string, interviewId: string) {\r\n    const candidate = await this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!candidate) {\r\n      throw new NotFoundException('Candidate profile not found');\r\n    }\r\n\r\n    const interview = await this.prisma.interview.findUnique({\r\n      where: { id: interviewId },\r\n      include: {\r\n        JobApplication: {\r\n          include: {\r\n            Job: {\r\n              select: {\r\n                id: true,\r\n                title: true,\r\n                companyName: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!interview) {\r\n      throw new NotFoundException('Interview not found');\r\n    }\r\n\r\n    // Verify candidate owns this interview's application\r\n    if (interview.JobApplication.candidateId !== candidate.id) {\r\n      throw new ForbiddenException('You can only view your own interviews');\r\n    }\r\n\r\n    // Base response (always visible)\r\n    const baseResponse = {\r\n      id: interview.id,\r\n      mode: interview.mode,\r\n      status: interview.status,\r\n      paymentStatus: interview.paymentStatus,\r\n      job: interview.JobApplication.Job,\r\n      createdAt: interview.createdAt,\r\n    };\r\n\r\n    // Return filtered data based on status\r\n    switch (interview.status) {\r\n      case InterviewStatus.INTERVIEW_CONFIRMED:\r\n        // Interview confirmed but not paid - show payment CTA\r\n        return {\r\n          ...baseResponse,\r\n          message:\r\n            'HR has scheduled your interview. Pay ‚Çπ99 to unlock details.',\r\n          requiresPayment: true,\r\n        };\r\n\r\n      case InterviewStatus.PAYMENT_SUCCESS:\r\n      case InterviewStatus.INTERVIEW_COMPLETED:\r\n        // Payment done - show full details\r\n        return {\r\n          ...baseResponse,\r\n          scheduledDate: interview.scheduledDate,\r\n          scheduledTime: interview.scheduledTime,\r\n          hrNote: interview.hrNotes,\r\n          paidAt: interview.paidAt,\r\n          message:\r\n            interview.status === InterviewStatus.PAYMENT_SUCCESS\r\n              ? 'Interview details unlocked. Best of luck!'\r\n              : 'Interview completed.',\r\n        };\r\n\r\n      case InterviewStatus.CANDIDATE_NO_SHOW:\r\n        return {\r\n          ...baseResponse,\r\n          message: 'You missed this interview. Contact support for assistance.',\r\n        };\r\n\r\n      case InterviewStatus.HR_NO_SHOW:\r\n        return {\r\n          ...baseResponse,\r\n          message:\r\n            'HR did not conduct this interview. A refund has been initiated.',\r\n        };\r\n\r\n      case InterviewStatus.CANCELLED:\r\n        return {\r\n          ...baseResponse,\r\n          message: 'This interview was cancelled.',\r\n        };\r\n\r\n      default:\r\n        return baseResponse;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get all interviews for candidate\r\n   */\r\n  async getCandidateInterviews(userId: string) {\r\n    const candidate = await this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!candidate) {\r\n      throw new NotFoundException('Candidate profile not found');\r\n    }\r\n\r\n    const interviews = await this.prisma.interview.findMany({\r\n      where: {\r\n        JobApplication: {\r\n          candidateId: candidate.id,\r\n        },\r\n      },\r\n      include: {\r\n        JobApplication: {\r\n          include: {\r\n            Job: {\r\n              select: {\r\n                id: true,\r\n                title: true,\r\n                companyName: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    // Filter sensitive data based on payment status\r\n    return interviews.map((interview) => {\r\n      const base = {\r\n        id: interview.id,\r\n        mode: interview.mode,\r\n        status: interview.status,\r\n        paymentStatus: interview.paymentStatus,\r\n        job: interview.JobApplication.Job,\r\n        createdAt: interview.createdAt,\r\n        paidAt: interview.paidAt,\r\n      };\r\n\r\n      // Only show interview details if payment successful\r\n      if (\r\n        interview.status === InterviewStatus.PAYMENT_SUCCESS ||\r\n        interview.status === InterviewStatus.INTERVIEW_COMPLETED\r\n      ) {\r\n        return {\r\n          ...base,\r\n          scheduledDate: interview.scheduledDate,\r\n          scheduledTime: interview.scheduledTime,\r\n          hrNote: interview.hrNotes,\r\n        };\r\n      }\r\n\r\n      return {\r\n        ...base,\r\n        requiresPayment:\r\n          interview.status === InterviewStatus.INTERVIEW_CONFIRMED,\r\n      };\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get interviews for HR's jobs (shows all details to HR)\r\n   */\r\n  async getHRInterviews(\r\n    userId: string,\r\n    filters?: { status?: string; jobId?: string },\r\n  ) {\r\n    const hr = await this.prisma.hR.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!hr) {\r\n      throw new NotFoundException('HR profile not found');\r\n    }\r\n\r\n    const where: any = {\r\n      JobApplication: {\r\n        Job: {\r\n          hrId: hr.id,\r\n        },\r\n      },\r\n    };\r\n\r\n    if (filters?.status) {\r\n      where.status = filters.status;\r\n    }\r\n\r\n    if (filters?.jobId) {\r\n      where.JobApplication = {\r\n        ...where.JobApplication,\r\n        jobId: filters.jobId,\r\n      };\r\n    }\r\n\r\n    const interviews = await this.prisma.interview.findMany({\r\n      where,\r\n      include: {\r\n        JobApplication: {\r\n          include: {\r\n            Candidate: {\r\n              select: {\r\n                id: true,\r\n                firstName: true,\r\n                lastName: true,\r\n                User: {\r\n                  select: {\r\n                    email: true,\r\n                  },\r\n                },\r\n              },\r\n            },\r\n            Job: {\r\n              select: {\r\n                id: true,\r\n                title: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    return interviews;\r\n  }\r\n\r\n  // ===========================================\r\n  // ADMIN METHODS\r\n  // ===========================================\r\n\r\n  /**\r\n   * Get interview statistics for admin\r\n   */\r\n  async getAdminInterviewStats() {\r\n    const [\r\n      total,\r\n      confirmed,\r\n      paymentSuccess,\r\n      completed,\r\n      candidateNoShow,\r\n      hrNoShow,\r\n    ] = await Promise.all([\r\n      this.prisma.interview.count(),\r\n      this.prisma.interview.count({\r\n        where: { status: InterviewStatus.INTERVIEW_CONFIRMED as any },\r\n      }),\r\n      this.prisma.interview.count({\r\n        where: { status: InterviewStatus.PAYMENT_SUCCESS as any },\r\n      }),\r\n      this.prisma.interview.count({\r\n        where: { status: InterviewStatus.INTERVIEW_COMPLETED as any },\r\n      }),\r\n      this.prisma.interview.count({\r\n        where: { status: InterviewStatus.CANDIDATE_NO_SHOW as any },\r\n      }),\r\n      this.prisma.interview.count({\r\n        where: { status: InterviewStatus.HR_NO_SHOW as any },\r\n      }),\r\n    ]);\r\n\r\n    // Get HRs with repeated confirmations without candidate payments (potential flag)\r\n    const flaggedHRs = await this.prisma.$queryRaw`\r\n            SELECT h.\"companyName\", h.\"userId\", COUNT(*) as pending_count\r\n            FROM \"Interview\" i\r\n            JOIN \"JobApplication\" ja ON ja.id = i.\"applicationId\"\r\n            JOIN \"Job\" j ON j.id = ja.\"jobId\"\r\n            JOIN \"HR\" h ON h.id = j.\"hrId\"\r\n            WHERE i.status = 'INTERVIEW_CONFIRMED'\r\n            AND i.\"scheduledAt\" < NOW() - INTERVAL '48 hours'\r\n            GROUP BY h.id\r\n            HAVING COUNT(*) > 2\r\n        `;\r\n\r\n    return {\r\n      total,\r\n      byStatus: {\r\n        confirmed,\r\n        paymentSuccess,\r\n        completed,\r\n        candidateNoShow,\r\n        hrNoShow,\r\n      },\r\n      flaggedHRs,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get all interviews for admin with pagination\r\n   */\r\n  async getAdminInterviews(\r\n    page: number = 1,\r\n    limit: number = 20,\r\n    status?: string,\r\n  ) {\r\n    const skip = (page - 1) * limit;\r\n    const where: any = {};\r\n\r\n    if (status) {\r\n      where.status = status;\r\n    }\r\n\r\n    const [interviews, total] = await Promise.all([\r\n      this.prisma.interview.findMany({\r\n        where,\r\n        skip,\r\n        take: limit,\r\n        include: {\r\n          JobApplication: {\r\n            include: {\r\n              Candidate: {\r\n                select: {\r\n                  firstName: true,\r\n                  lastName: true,\r\n                },\r\n              },\r\n              Job: {\r\n                select: {\r\n                  title: true,\r\n                  companyName: true,\r\n                  HR: {\r\n                    select: {\r\n                      companyName: true,\r\n                    },\r\n                  },\r\n                },\r\n              },\r\n            },\r\n          },\r\n        },\r\n        orderBy: { createdAt: 'desc' },\r\n      }),\r\n      this.prisma.interview.count({ where }),\r\n    ]);\r\n\r\n    return {\r\n      interviews,\r\n      pagination: {\r\n        page,\r\n        limit,\r\n        total,\r\n        totalPages: Math.ceil(total / limit),\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Admin marks an interview as no-show\r\n   */\r\n  async markNoShow(\r\n    interviewId: string,\r\n    type: 'CANDIDATE' | 'HR',\r\n    adminUserId: string,\r\n  ) {\r\n    const interview = await this.prisma.interview.findUnique({\r\n      where: { id: interviewId },\r\n    });\r\n\r\n    if (!interview) {\r\n      throw new NotFoundException('Interview not found');\r\n    }\r\n\r\n    const newStatus =\r\n      type === 'CANDIDATE'\r\n        ? InterviewStatus.CANDIDATE_NO_SHOW\r\n        : InterviewStatus.HR_NO_SHOW;\r\n\r\n    const updatedInterview = await this.prisma.$transaction(async (tx) => {\r\n      const updated = await tx.interview.update({\r\n        where: { id: interviewId },\r\n        data: {\r\n          status: newStatus as any,\r\n          completedAt: new Date(),\r\n        },\r\n      });\r\n\r\n      // Update application status\r\n      await tx.jobApplication.update({\r\n        where: { id: interview.applicationId },\r\n        data: {\r\n          status: (type === 'CANDIDATE'\r\n            ? ApplicationStatus.CANDIDATE_NO_SHOW\r\n            : ApplicationStatus.HR_NO_SHOW) as any,\r\n        },\r\n      });\r\n\r\n      // Create audit log\r\n      await tx.auditLog.create({\r\n        data: {\r\n          id: crypto.randomUUID(),\r\n          userId: adminUserId,\r\n          action: AuditAction.ADMIN_OVERRIDE,\r\n          entityType: 'Interview',\r\n          entityId: interviewId,\r\n          oldValue: { status: interview.status },\r\n          newValue: { status: newStatus, reason: `${type}_NO_SHOW` },\r\n        },\r\n      });\r\n\r\n      return updated;\r\n    });\r\n\r\n    return {\r\n      message: `Interview marked as ${type} no-show`,\r\n      interview: updatedInterview,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Admin marks interview as completed\r\n   */\r\n  async markCompleted(interviewId: string, adminUserId: string) {\r\n    const interview = await this.prisma.interview.findUnique({\r\n      where: { id: interviewId },\r\n    });\r\n\r\n    if (!interview) {\r\n      throw new NotFoundException('Interview not found');\r\n    }\r\n\r\n    if (interview.status !== InterviewStatus.PAYMENT_SUCCESS) {\r\n      throw new BadRequestException(\r\n        'Can only mark PAYMENT_SUCCESS interviews as completed',\r\n      );\r\n    }\r\n\r\n    const updatedInterview = await this.prisma.$transaction(async (tx) => {\r\n      const updated = await tx.interview.update({\r\n        where: { id: interviewId },\r\n        data: {\r\n          status: InterviewStatus.INTERVIEW_COMPLETED as any,\r\n          completedAt: new Date(),\r\n        },\r\n      });\r\n\r\n      // Update application status\r\n      await tx.jobApplication.update({\r\n        where: { id: interview.applicationId },\r\n        data: { status: ApplicationStatus.INTERVIEW_COMPLETED as any },\r\n      });\r\n\r\n      // Create audit log\r\n      await tx.auditLog.create({\r\n        data: {\r\n          id: crypto.randomUUID(),\r\n          userId: adminUserId,\r\n          action: AuditAction.UPDATE,\r\n          entityType: 'Interview',\r\n          entityId: interviewId,\r\n          oldValue: { status: interview.status },\r\n          newValue: { status: InterviewStatus.INTERVIEW_COMPLETED },\r\n        },\r\n      });\r\n\r\n      return updated;\r\n    });\r\n\r\n    return {\r\n      message: 'Interview marked as completed',\r\n      interview: updatedInterview,\r\n    };\r\n  }\r\n\r\n  // HR marks interview outcome (Selected/Not Selected/No Show)\r\n  async markInterviewOutcome(\r\n    userId: string,\r\n    interviewId: string,\r\n    dto: {\r\n      outcome: 'SELECTED' | 'NOT_SELECTED' | 'CANDIDATE_NO_SHOW';\r\n      notes?: string;\r\n      applicationId?: string;\r\n    },\r\n  ) {\r\n    // Verify HR owns this interview\r\n    const hr = await this.prisma.hR.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!hr) {\r\n      throw new NotFoundException('HR profile not found');\r\n    }\r\n\r\n    const interview = await this.prisma.interview.findUnique({\r\n      where: { id: interviewId },\r\n      include: {\r\n        JobApplication: {\r\n          include: {\r\n            Job: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!interview) {\r\n      throw new NotFoundException('Interview not found');\r\n    }\r\n\r\n    if (interview.JobApplication.Job.hrId !== hr.id) {\r\n      throw new ForbiddenException('You do not have access to this interview');\r\n    }\r\n\r\n    // Map outcome to interview status (must be valid InterviewStatus enum values)\r\n    // SELECTED and NOT_SELECTED both mean the interview is completed\r\n    const statusMap: Record<string, string> = {\r\n      SELECTED: 'INTERVIEW_COMPLETED',\r\n      NOT_SELECTED: 'INTERVIEW_COMPLETED',\r\n      CANDIDATE_NO_SHOW: 'CANDIDATE_NO_SHOW',\r\n    };\r\n\r\n    // Map outcome to application status\r\n    const applicationStatusMap: Record<string, string> = {\r\n      SELECTED: 'SELECTED', // Candidate selected after interview\r\n      NOT_SELECTED: 'INTERVIEW_REJECTED', // Candidate not selected after interview\r\n      CANDIDATE_NO_SHOW: 'CANDIDATE_NO_SHOW',\r\n    };\r\n\r\n    const newStatus = statusMap[dto.outcome] || 'INTERVIEW_COMPLETED';\r\n    const newAppStatus =\r\n      applicationStatusMap[dto.outcome] || 'INTERVIEW_COMPLETED';\r\n\r\n    // Update interview and application in transaction\r\n    const updatedInterview = await this.prisma.$transaction(async (tx) => {\r\n      // Update interview status\r\n      const updated = await tx.interview.update({\r\n        where: { id: interviewId },\r\n        data: {\r\n          status: newStatus as any,\r\n          updatedAt: new Date(),\r\n        },\r\n      });\r\n\r\n      // Update application status\r\n      await tx.jobApplication.update({\r\n        where: { id: interview.applicationId },\r\n        data: {\r\n          status: newAppStatus as any,\r\n          updatedAt: new Date(),\r\n        },\r\n      });\r\n\r\n      return updated;\r\n    });\r\n\r\n    return {\r\n      message: `Interview marked as ${dto.outcome.replace(/_/g, ' ')}`,\r\n      interview: updatedInterview,\r\n      applicationStatus: newAppStatus,\r\n    };\r\n  }\r\n\r\n  // ===========================================\r\n  // Email Helper Methods\r\n  // ============================================\r\n\r\n  private async sendInterviewConfirmedEmail(\r\n    application: any,\r\n    dto: ConfirmInterviewDto,\r\n  ) {\r\n    const candidateEmail = application.Candidate.User.email;\r\n    const candidateName = `${application.Candidate.firstName} ${application.Candidate.lastName}`;\r\n    const companyName = application.Job.companyName;\r\n    const jobTitle = application.Job.title;\r\n\r\n    const html = `\r\n            <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\r\n                <h2 style=\"color: #2563eb;\">üéâ Great News, ${candidateName}!</h2>\r\n                <p>The HR team at <strong>${companyName}</strong> has scheduled an interview for you!</p>\r\n                <div style=\"background: #f3f4f6; padding: 16px; border-radius: 8px; margin: 16px 0;\">\r\n                    <h3 style=\"margin: 0 0 8px 0;\">${jobTitle}</h3>\r\n                    <p style=\"margin: 0; color: #6b7280;\">${companyName}</p>\r\n                </div>\r\n                <div style=\"background: #fef3c7; padding: 16px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #f59e0b;\">\r\n                    <p style=\"margin: 0; font-weight: 500;\">\r\n                        <strong>Next Step:</strong> Pay ‚Çπ99 to unlock your interview details.\r\n                    </p>\r\n                </div>\r\n                <p style=\"color: #6b7280; font-size: 14px;\">\r\n                    This small fee ensures quality connections and shows your commitment to the opportunity.\r\n                    Your interview details will be revealed immediately after payment.\r\n                </p>\r\n                <a href=\"${process.env.FRONTEND_URL || 'http://localhost:3000'}#my-applications\" \r\n                   style=\"display: inline-block; background: #2563eb; color: white; padding: 12px 24px; \r\n                          border-radius: 6px; text-decoration: none; margin-top: 16px;\">\r\n                    Pay ‚Çπ99 & Unlock Details\r\n                </a>\r\n            </div>\r\n        `;\r\n\r\n    await this.emailService.sendEmail({\r\n      to: candidateEmail,\r\n      subject: `üéâ Interview Scheduled by ${companyName} - Pay ‚Çπ99 to Unlock Details`,\r\n      html,\r\n    });\r\n  }\r\n\r\n  private async sendPaymentSuccessEmail(interview: any) {\r\n    const candidateEmail = interview.application.candidate.user.email;\r\n    const candidateName = `${interview.application.candidate.firstName} ${interview.application.candidate.lastName}`;\r\n    const companyName = interview.application.job.companyName;\r\n    const jobTitle = interview.application.job.title;\r\n\r\n    const modeText =\r\n      {\r\n        CALL: 'üìû Phone Call',\r\n        VIDEO: 'üíª Video Call',\r\n        ONSITE: 'üè¢ On-site',\r\n      }[interview.mode] || interview.mode;\r\n\r\n    const html = `\r\n            <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\r\n                <h2 style=\"color: #059669;\">‚úÖ Interview Details Unlocked!</h2>\r\n                <p>Hi ${candidateName},</p>\r\n                <p>Your payment is confirmed. Here are your interview details:</p>\r\n                <div style=\"background: #f3f4f6; padding: 20px; border-radius: 8px; margin: 16px 0;\">\r\n                    <h3 style=\"margin: 0 0 12px 0;\">${jobTitle}</h3>\r\n                    <p style=\"margin: 4px 0;\"><strong>Company:</strong> ${companyName}</p>\r\n                    <p style=\"margin: 4px 0;\"><strong>Date:</strong> ${new Date(interview.scheduledDate).toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>\r\n                    <p style=\"margin: 4px 0;\"><strong>Time:</strong> ${interview.scheduledTime}</p>\r\n                    <p style=\"margin: 4px 0;\"><strong>Mode:</strong> ${modeText}</p>\r\n                    ${interview.hrNotes ? `<p style=\"margin: 12px 0 0 0; padding-top: 12px; border-top: 1px solid #ddd;\"><strong>Note from HR:</strong> ${interview.hrNotes}</p>` : ''}\r\n                </div>\r\n                <p style=\"color: #059669; font-weight: 500;\">Best of luck with your interview! üçÄ</p>\r\n            </div>\r\n        `;\r\n\r\n    await this.emailService.sendEmail({\r\n      to: candidateEmail,\r\n      subject: `‚úÖ Interview Details Unlocked - ${jobTitle} at ${companyName}`,\r\n      html,\r\n    });\r\n  }\r\n\r\n  private async sendPaymentNotificationToHR(interview: any) {\r\n    const hrEmail = interview.application.job.hr.user.email;\r\n    const candidateName = `${interview.application.candidate.firstName} ${interview.application.candidate.lastName}`;\r\n    const jobTitle = interview.application.job.title;\r\n\r\n    const html = `\r\n            <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\r\n                <h2 style=\"color: #059669;\">‚úÖ Candidate Has Confirmed</h2>\r\n                <p><strong>${candidateName}</strong> has paid and confirmed their interview for:</p>\r\n                <div style=\"background: #f3f4f6; padding: 16px; border-radius: 8px; margin: 16px 0;\">\r\n                    <h3 style=\"margin: 0 0 8px 0;\">${jobTitle}</h3>\r\n                    <p style=\"margin: 4px 0;\"><strong>Date:</strong> ${new Date(interview.scheduledDate).toLocaleDateString()}</p>\r\n                    <p style=\"margin: 4px 0;\"><strong>Time:</strong> ${interview.scheduledTime}</p>\r\n                    <p style=\"margin: 4px 0;\"><strong>Mode:</strong> ${interview.mode}</p>\r\n                </div>\r\n                <p>The candidate has been sent the interview details. Please be prepared for the interview.</p>\r\n            </div>\r\n        `;\r\n\r\n    await this.emailService.sendEmail({\r\n      to: hrEmail,\r\n      subject: `‚úÖ ${candidateName} Confirmed Interview for ${jobTitle}`,\r\n      html,\r\n    });\r\n  }\r\n}\r\n"],"names":["InterviewService","confirmInterview","userId","applicationId","dto","application","prisma","jobApplication","findUnique","where","id","include","Job","HR","Candidate","User","NotFoundException","status","ApplicationStatus","APPLIED","TEST_PASSED_WAITING_HR","BadRequestException","hr","hR","hrId","ForbiddenException","existingInterview","interview","$transaction","tx","newInterview","create","data","crypto","randomUUID","mode","scheduledDate","Date","scheduledTime","hrNotes","hrNote","InterviewStatus","INTERVIEW_CONFIRMED","paymentStatus","PaymentStatus","ELIGIBLE","scheduledAt","updatedAt","update","auditLog","action","AuditAction","CREATE","entityType","entityId","newValue","sendInterviewConfirmedEmail","message","scheduleInterview","interviewId","JobApplication","updatedInterview","interviewLink","callDetails","success","processPaymentSuccess","paymentId","updated","PAYMENT_SUCCESS","SUCCESS","paidAt","sendPaymentSuccessEmail","sendPaymentNotificationToHR","getInterviewForCandidate","candidate","select","title","companyName","candidateId","baseResponse","job","createdAt","requiresPayment","INTERVIEW_COMPLETED","CANDIDATE_NO_SHOW","HR_NO_SHOW","CANCELLED","getCandidateInterviews","interviews","findMany","orderBy","map","base","getHRInterviews","filters","jobId","firstName","lastName","email","getAdminInterviewStats","total","confirmed","paymentSuccess","completed","candidateNoShow","hrNoShow","Promise","all","count","flaggedHRs","$queryRaw","byStatus","getAdminInterviews","page","limit","skip","take","pagination","totalPages","Math","ceil","markNoShow","type","adminUserId","newStatus","completedAt","ADMIN_OVERRIDE","oldValue","reason","markCompleted","UPDATE","markInterviewOutcome","statusMap","SELECTED","NOT_SELECTED","applicationStatusMap","outcome","newAppStatus","replace","applicationStatus","candidateEmail","candidateName","jobTitle","html","process","env","FRONTEND_URL","emailService","sendEmail","to","subject","user","modeText","CALL","VIDEO","ONSITE","toLocaleDateString","weekday","year","month","day","hrEmail"],"mappings":";;;;+BAmBaA;;;eAAAA;;;wBAdN;gEACiB;+BACM;8BACD;2BAQtB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGA,IAAA,AAAMA,mBAAN,MAAMA;IAMX;;;;;GAKC,GACD,MAAMC,iBACJC,MAAc,EACdC,aAAqB,EACrBC,GAAwB,EACxB;QACA,8CAA8C;QAC9C,MAAMC,cAAc,MAAM,IAAI,CAACC,MAAM,CAACC,cAAc,CAACC,UAAU,CAAC;YAC9DC,OAAO;gBAAEC,IAAIP;YAAc;YAC3BQ,SAAS;gBACPC,KAAK;oBAAED,SAAS;wBAAEE,IAAI;oBAAK;gBAAE;gBAC7BC,WAAW;oBAAEH,SAAS;wBAAEI,MAAM;oBAAK;gBAAE;YACvC;QACF;QAEA,IAAI,CAACV,aAAa;YAChB,MAAM,IAAIW,yBAAiB,CAAC;QAC9B;QAEA,kFAAkF;QAClF,IACEX,YAAYY,MAAM,KAAKC,4BAAiB,CAACC,OAAO,IAChDd,YAAYY,MAAM,KAAKC,4BAAiB,CAACE,sBAAsB,EAC/D;YACA,MAAM,IAAIC,2BAAmB,CAC3B,CAAC,gDAAgD,EAAEhB,YAAYY,MAAM,CAAC,2DAA2D,CAAC;QAEtI;QAEA,4BAA4B;QAC5B,MAAMK,KAAK,MAAM,IAAI,CAAChB,MAAM,CAACiB,EAAE,CAACf,UAAU,CAAC;YACzCC,OAAO;gBAAEP;YAAO;QAClB;QAEA,IAAI,CAACoB,MAAMjB,YAAYO,GAAG,CAACY,IAAI,KAAKF,GAAGZ,EAAE,EAAE;YACzC,MAAM,IAAIe,0BAAkB,CAC1B;QAEJ;QAEA,oCAAoC;QACpC,MAAMC,oBAAoB,MAAM,IAAI,CAACpB,MAAM,CAACqB,SAAS,CAACnB,UAAU,CAAC;YAC/DC,OAAO;gBAAEN;YAAc;QACzB;QAEA,IAAIuB,mBAAmB;YACrB,MAAM,IAAIL,2BAAmB,CAC3B;QAEJ;QAEA,yEAAyE;QACzE,MAAMM,YAAY,MAAM,IAAI,CAACrB,MAAM,CAACsB,YAAY,CAAC,OAAOC;YACtD,gDAAgD;YAChD,qEAAqE;YACrE,MAAMC,eAAe,MAAMD,GAAGF,SAAS,CAACI,MAAM,CAAC;gBAC7CC,MAAM;oBACJtB,IAAIuB,QAAOC,UAAU;oBACrB/B;oBACAgC,MAAM/B,IAAI+B,IAAI;oBACdC,eAAehC,IAAIgC,aAAa,GAAG,IAAIC,KAAKjC,IAAIgC,aAAa,IAAI;oBACjEE,eAAelC,IAAIkC,aAAa,IAAI;oBACpCC,SAASnC,IAAIoC,MAAM;oBACnBvB,QAAQwB,0BAAe,CAACC,mBAAmB;oBAC3CC,eAAeC,wBAAa,CAACC,QAAQ;oBACrCC,aAAa;oBACbC,WAAW,IAAIV;gBACjB;YACF;YAEA,mDAAmD;YACnD,MAAMR,GAAGtB,cAAc,CAACyC,MAAM,CAAC;gBAC7BvC,OAAO;oBAAEC,IAAIP;gBAAc;gBAC3B6B,MAAM;oBAAEf,QAAQC,4BAAiB,CAACwB,mBAAmB;gBAAQ;YAC/D;YAEA,mBAAmB;YACnB,MAAMb,GAAGoB,QAAQ,CAAClB,MAAM,CAAC;gBACvBC,MAAM;oBACJtB,IAAIuB,QAAOC,UAAU;oBACrBhC;oBACAgD,QAAQC,sBAAW,CAACC,MAAM;oBAC1BC,YAAY;oBACZC,UAAUxB,aAAapB,EAAE;oBACzB6C,UAAU;wBACRpB,MAAM/B,IAAI+B,IAAI;wBACdC,eAAehC,IAAIgC,aAAa;wBAChCE,eAAelC,IAAIkC,aAAa;wBAChCnC;wBACAc,QAAQwB,0BAAe,CAACC,mBAAmB;oBAC7C;gBACF;YACF;YAEA,OAAOZ;QACT;QAEA,qEAAqE;QACrE,MAAM,IAAI,CAAC0B,2BAA2B,CAACnD,aAAaD;QAEpD,OAAO;YACLqD,SACE;YACF9B,WAAW;gBACTjB,IAAIiB,UAAUjB,EAAE;gBAChByB,MAAMR,UAAUQ,IAAI;gBACpBlB,QAAQU,UAAUV,MAAM;gBACxBmB,eAAeT,UAAUS,aAAa;gBACtCE,eAAeX,UAAUW,aAAa;YACxC;QACF;IACF;IAEA;;;GAGC,GACD,MAAMoB,kBACJxD,MAAc,EACdyD,WAAmB,EACnBvD,GAMC,EACD;QACA,gBAAgB;QAChB,MAAMkB,KAAK,MAAM,IAAI,CAAChB,MAAM,CAACiB,EAAE,CAACf,UAAU,CAAC;YACzCC,OAAO;gBAAEP;YAAO;QAClB;QAEA,IAAI,CAACoB,IAAI;YACP,MAAM,IAAIN,yBAAiB,CAAC;QAC9B;QAEA,qCAAqC;QACrC,MAAMW,YAAY,MAAM,IAAI,CAACrB,MAAM,CAACqB,SAAS,CAACnB,UAAU,CAAC;YACvDC,OAAO;gBAAEC,IAAIiD;YAAY;YACzBhD,SAAS;gBACPiD,gBAAgB;oBACdjD,SAAS;wBACPC,KAAK;wBACLE,WAAW;4BACTH,SAAS;gCACPI,MAAM;4BACR;wBACF;oBACF;gBACF;YACF;QACF;QAEA,IAAI,CAACY,WAAW;YACd,MAAM,IAAIX,yBAAiB,CAAC;QAC9B;QAEA,0BAA0B;QAC1B,IAAIW,UAAUiC,cAAc,CAAChD,GAAG,CAACY,IAAI,KAAKF,GAAGZ,EAAE,EAAE;YAC/C,MAAM,IAAIe,0BAAkB,CAC1B;QAEJ;QAEA,gCAAgC;QAChC,IACEE,UAAUgB,aAAa,KAAK,aAC5BhB,UAAUV,MAAM,KAAK,mBACrB;YACA,MAAM,IAAII,2BAAmB,CAC3B;QAEJ;QAEA,yCAAyC;QACzC,MAAMwC,mBAAmB,MAAM,IAAI,CAACvD,MAAM,CAACqB,SAAS,CAACqB,MAAM,CAAC;YAC1DvC,OAAO;gBAAEC,IAAIiD;YAAY;YACzB3B,MAAM;gBACJI,eAAe,IAAIC,KAAKjC,IAAIgC,aAAa;gBACzCE,eAAelC,IAAIkC,aAAa;gBAChCH,MAAM/B,IAAI+B,IAAI,IAAIR,UAAUQ,IAAI;gBAChC2B,eAAe1D,IAAI0D,aAAa,IAAI;gBACpCC,aAAa3D,IAAI2D,WAAW,IAAI;gBAChCjB,aAAa,IAAIT;gBACjBU,WAAW,IAAIV;YACjB;QACF;QAEA,OAAO;YACL2B,SAAS;YACTP,SAAS;YACT9B,WAAW;gBACTjB,IAAImD,iBAAiBnD,EAAE;gBACvB0B,eAAeyB,iBAAiBzB,aAAa;gBAC7CE,eAAeuB,iBAAiBvB,aAAa;gBAC7CwB,eAAeD,iBAAiBC,aAAa;gBAC7CC,aAAaF,iBAAiBE,WAAW;YAC3C;QACF;IACF;IAEA;;;;GAIC,GACD,MAAME,sBAAsB9D,aAAqB,EAAE+D,SAAiB,EAAE;QACpE,MAAMvC,YAAY,MAAM,IAAI,CAACrB,MAAM,CAACqB,SAAS,CAACnB,UAAU,CAAC;YACvDC,OAAO;gBAAEN;YAAc;YACvBQ,SAAS;gBACPiD,gBAAgB;oBACdjD,SAAS;wBACPC,KAAK;4BAAED,SAAS;gCAAEE,IAAI;oCAAEF,SAAS;wCAAEI,MAAM;oCAAK;gCAAE;4BAAE;wBAAE;wBACpDD,WAAW;4BAAEH,SAAS;gCAAEI,MAAM;4BAAK;wBAAE;oBACvC;gBACF;YACF;QACF;QAEA,IAAI,CAACY,WAAW;YACd,MAAM,IAAIX,yBAAiB,CAAC;QAC9B;QAEA,IAAIW,UAAUV,MAAM,KAAKwB,0BAAe,CAACC,mBAAmB,EAAE;YAC5D,MAAM,IAAIrB,2BAAmB,CAC3B,CAAC,gBAAgB,EAAEM,UAAUV,MAAM,CAAC,sCAAsC,CAAC;QAE/E;QAEA,0CAA0C;QAC1C,MAAM4C,mBAAmB,MAAM,IAAI,CAACvD,MAAM,CAACsB,YAAY,CAAC,OAAOC;YAC7D,MAAMsC,UAAU,MAAMtC,GAAGF,SAAS,CAACqB,MAAM,CAAC;gBACxCvC,OAAO;oBAAEC,IAAIiB,UAAUjB,EAAE;gBAAC;gBAC1BsB,MAAM;oBACJf,QAAQwB,0BAAe,CAAC2B,eAAe;oBACvCzB,eAAeC,wBAAa,CAACyB,OAAO;oBACpCC,QAAQ,IAAIjC;gBACd;YACF;YAEA,4BAA4B;YAC5B,MAAMR,GAAGtB,cAAc,CAACyC,MAAM,CAAC;gBAC7BvC,OAAO;oBAAEC,IAAIP;gBAAc;gBAC3B6B,MAAM;oBAAEf,QAAQC,4BAAiB,CAACkD,eAAe;gBAAQ;YAC3D;YAEA,OAAOD;QACT;QAEA,8DAA8D;QAC9D,MAAM,IAAI,CAACI,uBAAuB,CAAC5C;QAEnC,oCAAoC;QACpC,MAAM,IAAI,CAAC6C,2BAA2B,CAAC7C;QAEvC,OAAOkC;IACT;IAEA;;;GAGC,GACD,MAAMY,yBAAyBvE,MAAc,EAAEyD,WAAmB,EAAE;QAClE,MAAMe,YAAY,MAAM,IAAI,CAACpE,MAAM,CAACoE,SAAS,CAAClE,UAAU,CAAC;YACvDC,OAAO;gBAAEP;YAAO;QAClB;QAEA,IAAI,CAACwE,WAAW;YACd,MAAM,IAAI1D,yBAAiB,CAAC;QAC9B;QAEA,MAAMW,YAAY,MAAM,IAAI,CAACrB,MAAM,CAACqB,SAAS,CAACnB,UAAU,CAAC;YACvDC,OAAO;gBAAEC,IAAIiD;YAAY;YACzBhD,SAAS;gBACPiD,gBAAgB;oBACdjD,SAAS;wBACPC,KAAK;4BACH+D,QAAQ;gCACNjE,IAAI;gCACJkE,OAAO;gCACPC,aAAa;4BACf;wBACF;oBACF;gBACF;YACF;QACF;QAEA,IAAI,CAAClD,WAAW;YACd,MAAM,IAAIX,yBAAiB,CAAC;QAC9B;QAEA,qDAAqD;QACrD,IAAIW,UAAUiC,cAAc,CAACkB,WAAW,KAAKJ,UAAUhE,EAAE,EAAE;YACzD,MAAM,IAAIe,0BAAkB,CAAC;QAC/B;QAEA,iCAAiC;QACjC,MAAMsD,eAAe;YACnBrE,IAAIiB,UAAUjB,EAAE;YAChByB,MAAMR,UAAUQ,IAAI;YACpBlB,QAAQU,UAAUV,MAAM;YACxB0B,eAAehB,UAAUgB,aAAa;YACtCqC,KAAKrD,UAAUiC,cAAc,CAAChD,GAAG;YACjCqE,WAAWtD,UAAUsD,SAAS;QAChC;QAEA,uCAAuC;QACvC,OAAQtD,UAAUV,MAAM;YACtB,KAAKwB,0BAAe,CAACC,mBAAmB;gBACtC,sDAAsD;gBACtD,OAAO;oBACL,GAAGqC,YAAY;oBACftB,SACE;oBACFyB,iBAAiB;gBACnB;YAEF,KAAKzC,0BAAe,CAAC2B,eAAe;YACpC,KAAK3B,0BAAe,CAAC0C,mBAAmB;gBACtC,mCAAmC;gBACnC,OAAO;oBACL,GAAGJ,YAAY;oBACf3C,eAAeT,UAAUS,aAAa;oBACtCE,eAAeX,UAAUW,aAAa;oBACtCE,QAAQb,UAAUY,OAAO;oBACzB+B,QAAQ3C,UAAU2C,MAAM;oBACxBb,SACE9B,UAAUV,MAAM,KAAKwB,0BAAe,CAAC2B,eAAe,GAChD,8CACA;gBACR;YAEF,KAAK3B,0BAAe,CAAC2C,iBAAiB;gBACpC,OAAO;oBACL,GAAGL,YAAY;oBACftB,SAAS;gBACX;YAEF,KAAKhB,0BAAe,CAAC4C,UAAU;gBAC7B,OAAO;oBACL,GAAGN,YAAY;oBACftB,SACE;gBACJ;YAEF,KAAKhB,0BAAe,CAAC6C,SAAS;gBAC5B,OAAO;oBACL,GAAGP,YAAY;oBACftB,SAAS;gBACX;YAEF;gBACE,OAAOsB;QACX;IACF;IAEA;;GAEC,GACD,MAAMQ,uBAAuBrF,MAAc,EAAE;QAC3C,MAAMwE,YAAY,MAAM,IAAI,CAACpE,MAAM,CAACoE,SAAS,CAAClE,UAAU,CAAC;YACvDC,OAAO;gBAAEP;YAAO;QAClB;QAEA,IAAI,CAACwE,WAAW;YACd,MAAM,IAAI1D,yBAAiB,CAAC;QAC9B;QAEA,MAAMwE,aAAa,MAAM,IAAI,CAAClF,MAAM,CAACqB,SAAS,CAAC8D,QAAQ,CAAC;YACtDhF,OAAO;gBACLmD,gBAAgB;oBACdkB,aAAaJ,UAAUhE,EAAE;gBAC3B;YACF;YACAC,SAAS;gBACPiD,gBAAgB;oBACdjD,SAAS;wBACPC,KAAK;4BACH+D,QAAQ;gCACNjE,IAAI;gCACJkE,OAAO;gCACPC,aAAa;4BACf;wBACF;oBACF;gBACF;YACF;YACAa,SAAS;gBAAET,WAAW;YAAO;QAC/B;QAEA,gDAAgD;QAChD,OAAOO,WAAWG,GAAG,CAAC,CAAChE;YACrB,MAAMiE,OAAO;gBACXlF,IAAIiB,UAAUjB,EAAE;gBAChByB,MAAMR,UAAUQ,IAAI;gBACpBlB,QAAQU,UAAUV,MAAM;gBACxB0B,eAAehB,UAAUgB,aAAa;gBACtCqC,KAAKrD,UAAUiC,cAAc,CAAChD,GAAG;gBACjCqE,WAAWtD,UAAUsD,SAAS;gBAC9BX,QAAQ3C,UAAU2C,MAAM;YAC1B;YAEA,oDAAoD;YACpD,IACE3C,UAAUV,MAAM,KAAKwB,0BAAe,CAAC2B,eAAe,IACpDzC,UAAUV,MAAM,KAAKwB,0BAAe,CAAC0C,mBAAmB,EACxD;gBACA,OAAO;oBACL,GAAGS,IAAI;oBACPxD,eAAeT,UAAUS,aAAa;oBACtCE,eAAeX,UAAUW,aAAa;oBACtCE,QAAQb,UAAUY,OAAO;gBAC3B;YACF;YAEA,OAAO;gBACL,GAAGqD,IAAI;gBACPV,iBACEvD,UAAUV,MAAM,KAAKwB,0BAAe,CAACC,mBAAmB;YAC5D;QACF;IACF;IAEA;;GAEC,GACD,MAAMmD,gBACJ3F,MAAc,EACd4F,OAA6C,EAC7C;QACA,MAAMxE,KAAK,MAAM,IAAI,CAAChB,MAAM,CAACiB,EAAE,CAACf,UAAU,CAAC;YACzCC,OAAO;gBAAEP;YAAO;QAClB;QAEA,IAAI,CAACoB,IAAI;YACP,MAAM,IAAIN,yBAAiB,CAAC;QAC9B;QAEA,MAAMP,QAAa;YACjBmD,gBAAgB;gBACdhD,KAAK;oBACHY,MAAMF,GAAGZ,EAAE;gBACb;YACF;QACF;QAEA,IAAIoF,SAAS7E,QAAQ;YACnBR,MAAMQ,MAAM,GAAG6E,QAAQ7E,MAAM;QAC/B;QAEA,IAAI6E,SAASC,OAAO;YAClBtF,MAAMmD,cAAc,GAAG;gBACrB,GAAGnD,MAAMmD,cAAc;gBACvBmC,OAAOD,QAAQC,KAAK;YACtB;QACF;QAEA,MAAMP,aAAa,MAAM,IAAI,CAAClF,MAAM,CAACqB,SAAS,CAAC8D,QAAQ,CAAC;YACtDhF;YACAE,SAAS;gBACPiD,gBAAgB;oBACdjD,SAAS;wBACPG,WAAW;4BACT6D,QAAQ;gCACNjE,IAAI;gCACJsF,WAAW;gCACXC,UAAU;gCACVlF,MAAM;oCACJ4D,QAAQ;wCACNuB,OAAO;oCACT;gCACF;4BACF;wBACF;wBACAtF,KAAK;4BACH+D,QAAQ;gCACNjE,IAAI;gCACJkE,OAAO;4BACT;wBACF;oBACF;gBACF;YACF;YACAc,SAAS;gBAAET,WAAW;YAAO;QAC/B;QAEA,OAAOO;IACT;IAEA,8CAA8C;IAC9C,gBAAgB;IAChB,8CAA8C;IAE9C;;GAEC,GACD,MAAMW,yBAAyB;QAC7B,MAAM,CACJC,OACAC,WACAC,gBACAC,WACAC,iBACAC,SACD,GAAG,MAAMC,QAAQC,GAAG,CAAC;YACpB,IAAI,CAACrG,MAAM,CAACqB,SAAS,CAACiF,KAAK;YAC3B,IAAI,CAACtG,MAAM,CAACqB,SAAS,CAACiF,KAAK,CAAC;gBAC1BnG,OAAO;oBAAEQ,QAAQwB,0BAAe,CAACC,mBAAmB;gBAAQ;YAC9D;YACA,IAAI,CAACpC,MAAM,CAACqB,SAAS,CAACiF,KAAK,CAAC;gBAC1BnG,OAAO;oBAAEQ,QAAQwB,0BAAe,CAAC2B,eAAe;gBAAQ;YAC1D;YACA,IAAI,CAAC9D,MAAM,CAACqB,SAAS,CAACiF,KAAK,CAAC;gBAC1BnG,OAAO;oBAAEQ,QAAQwB,0BAAe,CAAC0C,mBAAmB;gBAAQ;YAC9D;YACA,IAAI,CAAC7E,MAAM,CAACqB,SAAS,CAACiF,KAAK,CAAC;gBAC1BnG,OAAO;oBAAEQ,QAAQwB,0BAAe,CAAC2C,iBAAiB;gBAAQ;YAC5D;YACA,IAAI,CAAC9E,MAAM,CAACqB,SAAS,CAACiF,KAAK,CAAC;gBAC1BnG,OAAO;oBAAEQ,QAAQwB,0BAAe,CAAC4C,UAAU;gBAAQ;YACrD;SACD;QAED,kFAAkF;QAClF,MAAMwB,aAAa,MAAM,IAAI,CAACvG,MAAM,CAACwG,SAAS,CAAC;;;;;;;;;;QAU3C,CAAC;QAEL,OAAO;YACLV;YACAW,UAAU;gBACRV;gBACAC;gBACAC;gBACAC;gBACAC;YACF;YACAI;QACF;IACF;IAEA;;GAEC,GACD,MAAMG,mBACJC,OAAe,CAAC,EAChBC,QAAgB,EAAE,EAClBjG,MAAe,EACf;QACA,MAAMkG,OAAO,AAACF,CAAAA,OAAO,CAAA,IAAKC;QAC1B,MAAMzG,QAAa,CAAC;QAEpB,IAAIQ,QAAQ;YACVR,MAAMQ,MAAM,GAAGA;QACjB;QAEA,MAAM,CAACuE,YAAYY,MAAM,GAAG,MAAMM,QAAQC,GAAG,CAAC;YAC5C,IAAI,CAACrG,MAAM,CAACqB,SAAS,CAAC8D,QAAQ,CAAC;gBAC7BhF;gBACA0G;gBACAC,MAAMF;gBACNvG,SAAS;oBACPiD,gBAAgB;wBACdjD,SAAS;4BACPG,WAAW;gCACT6D,QAAQ;oCACNqB,WAAW;oCACXC,UAAU;gCACZ;4BACF;4BACArF,KAAK;gCACH+D,QAAQ;oCACNC,OAAO;oCACPC,aAAa;oCACbhE,IAAI;wCACF8D,QAAQ;4CACNE,aAAa;wCACf;oCACF;gCACF;4BACF;wBACF;oBACF;gBACF;gBACAa,SAAS;oBAAET,WAAW;gBAAO;YAC/B;YACA,IAAI,CAAC3E,MAAM,CAACqB,SAAS,CAACiF,KAAK,CAAC;gBAAEnG;YAAM;SACrC;QAED,OAAO;YACL+E;YACA6B,YAAY;gBACVJ;gBACAC;gBACAd;gBACAkB,YAAYC,KAAKC,IAAI,CAACpB,QAAQc;YAChC;QACF;IACF;IAEA;;GAEC,GACD,MAAMO,WACJ9D,WAAmB,EACnB+D,IAAwB,EACxBC,WAAmB,EACnB;QACA,MAAMhG,YAAY,MAAM,IAAI,CAACrB,MAAM,CAACqB,SAAS,CAACnB,UAAU,CAAC;YACvDC,OAAO;gBAAEC,IAAIiD;YAAY;QAC3B;QAEA,IAAI,CAAChC,WAAW;YACd,MAAM,IAAIX,yBAAiB,CAAC;QAC9B;QAEA,MAAM4G,YACJF,SAAS,cACLjF,0BAAe,CAAC2C,iBAAiB,GACjC3C,0BAAe,CAAC4C,UAAU;QAEhC,MAAMxB,mBAAmB,MAAM,IAAI,CAACvD,MAAM,CAACsB,YAAY,CAAC,OAAOC;YAC7D,MAAMsC,UAAU,MAAMtC,GAAGF,SAAS,CAACqB,MAAM,CAAC;gBACxCvC,OAAO;oBAAEC,IAAIiD;gBAAY;gBACzB3B,MAAM;oBACJf,QAAQ2G;oBACRC,aAAa,IAAIxF;gBACnB;YACF;YAEA,4BAA4B;YAC5B,MAAMR,GAAGtB,cAAc,CAACyC,MAAM,CAAC;gBAC7BvC,OAAO;oBAAEC,IAAIiB,UAAUxB,aAAa;gBAAC;gBACrC6B,MAAM;oBACJf,QAASyG,SAAS,cACdxG,4BAAiB,CAACkE,iBAAiB,GACnClE,4BAAiB,CAACmE,UAAU;gBAClC;YACF;YAEA,mBAAmB;YACnB,MAAMxD,GAAGoB,QAAQ,CAAClB,MAAM,CAAC;gBACvBC,MAAM;oBACJtB,IAAIuB,QAAOC,UAAU;oBACrBhC,QAAQyH;oBACRzE,QAAQC,sBAAW,CAAC2E,cAAc;oBAClCzE,YAAY;oBACZC,UAAUK;oBACVoE,UAAU;wBAAE9G,QAAQU,UAAUV,MAAM;oBAAC;oBACrCsC,UAAU;wBAAEtC,QAAQ2G;wBAAWI,QAAQ,GAAGN,KAAK,QAAQ,CAAC;oBAAC;gBAC3D;YACF;YAEA,OAAOvD;QACT;QAEA,OAAO;YACLV,SAAS,CAAC,oBAAoB,EAAEiE,KAAK,QAAQ,CAAC;YAC9C/F,WAAWkC;QACb;IACF;IAEA;;GAEC,GACD,MAAMoE,cAActE,WAAmB,EAAEgE,WAAmB,EAAE;QAC5D,MAAMhG,YAAY,MAAM,IAAI,CAACrB,MAAM,CAACqB,SAAS,CAACnB,UAAU,CAAC;YACvDC,OAAO;gBAAEC,IAAIiD;YAAY;QAC3B;QAEA,IAAI,CAAChC,WAAW;YACd,MAAM,IAAIX,yBAAiB,CAAC;QAC9B;QAEA,IAAIW,UAAUV,MAAM,KAAKwB,0BAAe,CAAC2B,eAAe,EAAE;YACxD,MAAM,IAAI/C,2BAAmB,CAC3B;QAEJ;QAEA,MAAMwC,mBAAmB,MAAM,IAAI,CAACvD,MAAM,CAACsB,YAAY,CAAC,OAAOC;YAC7D,MAAMsC,UAAU,MAAMtC,GAAGF,SAAS,CAACqB,MAAM,CAAC;gBACxCvC,OAAO;oBAAEC,IAAIiD;gBAAY;gBACzB3B,MAAM;oBACJf,QAAQwB,0BAAe,CAAC0C,mBAAmB;oBAC3C0C,aAAa,IAAIxF;gBACnB;YACF;YAEA,4BAA4B;YAC5B,MAAMR,GAAGtB,cAAc,CAACyC,MAAM,CAAC;gBAC7BvC,OAAO;oBAAEC,IAAIiB,UAAUxB,aAAa;gBAAC;gBACrC6B,MAAM;oBAAEf,QAAQC,4BAAiB,CAACiE,mBAAmB;gBAAQ;YAC/D;YAEA,mBAAmB;YACnB,MAAMtD,GAAGoB,QAAQ,CAAClB,MAAM,CAAC;gBACvBC,MAAM;oBACJtB,IAAIuB,QAAOC,UAAU;oBACrBhC,QAAQyH;oBACRzE,QAAQC,sBAAW,CAAC+E,MAAM;oBAC1B7E,YAAY;oBACZC,UAAUK;oBACVoE,UAAU;wBAAE9G,QAAQU,UAAUV,MAAM;oBAAC;oBACrCsC,UAAU;wBAAEtC,QAAQwB,0BAAe,CAAC0C,mBAAmB;oBAAC;gBAC1D;YACF;YAEA,OAAOhB;QACT;QAEA,OAAO;YACLV,SAAS;YACT9B,WAAWkC;QACb;IACF;IAEA,6DAA6D;IAC7D,MAAMsE,qBACJjI,MAAc,EACdyD,WAAmB,EACnBvD,GAIC,EACD;QACA,gCAAgC;QAChC,MAAMkB,KAAK,MAAM,IAAI,CAAChB,MAAM,CAACiB,EAAE,CAACf,UAAU,CAAC;YACzCC,OAAO;gBAAEP;YAAO;QAClB;QAEA,IAAI,CAACoB,IAAI;YACP,MAAM,IAAIN,yBAAiB,CAAC;QAC9B;QAEA,MAAMW,YAAY,MAAM,IAAI,CAACrB,MAAM,CAACqB,SAAS,CAACnB,UAAU,CAAC;YACvDC,OAAO;gBAAEC,IAAIiD;YAAY;YACzBhD,SAAS;gBACPiD,gBAAgB;oBACdjD,SAAS;wBACPC,KAAK;oBACP;gBACF;YACF;QACF;QAEA,IAAI,CAACe,WAAW;YACd,MAAM,IAAIX,yBAAiB,CAAC;QAC9B;QAEA,IAAIW,UAAUiC,cAAc,CAAChD,GAAG,CAACY,IAAI,KAAKF,GAAGZ,EAAE,EAAE;YAC/C,MAAM,IAAIe,0BAAkB,CAAC;QAC/B;QAEA,8EAA8E;QAC9E,iEAAiE;QACjE,MAAM2G,YAAoC;YACxCC,UAAU;YACVC,cAAc;YACdlD,mBAAmB;QACrB;QAEA,oCAAoC;QACpC,MAAMmD,uBAA+C;YACnDF,UAAU;YACVC,cAAc;YACdlD,mBAAmB;QACrB;QAEA,MAAMwC,YAAYQ,SAAS,CAAChI,IAAIoI,OAAO,CAAC,IAAI;QAC5C,MAAMC,eACJF,oBAAoB,CAACnI,IAAIoI,OAAO,CAAC,IAAI;QAEvC,kDAAkD;QAClD,MAAM3E,mBAAmB,MAAM,IAAI,CAACvD,MAAM,CAACsB,YAAY,CAAC,OAAOC;YAC7D,0BAA0B;YAC1B,MAAMsC,UAAU,MAAMtC,GAAGF,SAAS,CAACqB,MAAM,CAAC;gBACxCvC,OAAO;oBAAEC,IAAIiD;gBAAY;gBACzB3B,MAAM;oBACJf,QAAQ2G;oBACR7E,WAAW,IAAIV;gBACjB;YACF;YAEA,4BAA4B;YAC5B,MAAMR,GAAGtB,cAAc,CAACyC,MAAM,CAAC;gBAC7BvC,OAAO;oBAAEC,IAAIiB,UAAUxB,aAAa;gBAAC;gBACrC6B,MAAM;oBACJf,QAAQwH;oBACR1F,WAAW,IAAIV;gBACjB;YACF;YAEA,OAAO8B;QACT;QAEA,OAAO;YACLV,SAAS,CAAC,oBAAoB,EAAErD,IAAIoI,OAAO,CAACE,OAAO,CAAC,MAAM,MAAM;YAChE/G,WAAWkC;YACX8E,mBAAmBF;QACrB;IACF;IAEA,8CAA8C;IAC9C,uBAAuB;IACvB,+CAA+C;IAE/C,MAAcjF,4BACZnD,WAAgB,EAChBD,GAAwB,EACxB;QACA,MAAMwI,iBAAiBvI,YAAYS,SAAS,CAACC,IAAI,CAACmF,KAAK;QACvD,MAAM2C,gBAAgB,GAAGxI,YAAYS,SAAS,CAACkF,SAAS,CAAC,CAAC,EAAE3F,YAAYS,SAAS,CAACmF,QAAQ,EAAE;QAC5F,MAAMpB,cAAcxE,YAAYO,GAAG,CAACiE,WAAW;QAC/C,MAAMiE,WAAWzI,YAAYO,GAAG,CAACgE,KAAK;QAEtC,MAAMmE,OAAO,CAAC;;2DAEyC,EAAEF,cAAc;0CACjC,EAAEhE,YAAY;;mDAEL,EAAEiE,SAAS;0DACJ,EAAEjE,YAAY;;;;;;;;;;;yBAW/C,EAAEmE,QAAQC,GAAG,CAACC,YAAY,IAAI,wBAAwB;;;;;;QAMvE,CAAC;QAEL,MAAM,IAAI,CAACC,YAAY,CAACC,SAAS,CAAC;YAChCC,IAAIT;YACJU,SAAS,CAAC,0BAA0B,EAAEzE,YAAY,4BAA4B,CAAC;YAC/EkE;QACF;IACF;IAEA,MAAcxE,wBAAwB5C,SAAc,EAAE;QACpD,MAAMiH,iBAAiBjH,UAAUtB,WAAW,CAACqE,SAAS,CAAC6E,IAAI,CAACrD,KAAK;QACjE,MAAM2C,gBAAgB,GAAGlH,UAAUtB,WAAW,CAACqE,SAAS,CAACsB,SAAS,CAAC,CAAC,EAAErE,UAAUtB,WAAW,CAACqE,SAAS,CAACuB,QAAQ,EAAE;QAChH,MAAMpB,cAAclD,UAAUtB,WAAW,CAAC2E,GAAG,CAACH,WAAW;QACzD,MAAMiE,WAAWnH,UAAUtB,WAAW,CAAC2E,GAAG,CAACJ,KAAK;QAEhD,MAAM4E,WACJ;YACEC,MAAM;YACNC,OAAO;YACPC,QAAQ;QACV,CAAC,CAAChI,UAAUQ,IAAI,CAAC,IAAIR,UAAUQ,IAAI;QAErC,MAAM4G,OAAO,CAAC;;;sBAGI,EAAEF,cAAc;;;oDAGc,EAAEC,SAAS;wEACS,EAAEjE,YAAY;qEACjB,EAAE,IAAIxC,KAAKV,UAAUS,aAAa,EAAEwH,kBAAkB,CAAC,SAAS;YAAEC,SAAS;YAAQC,MAAM;YAAWC,OAAO;YAAQC,KAAK;QAAU,GAAG;qEACrI,EAAErI,UAAUW,aAAa,CAAC;qEAC1B,EAAEkH,SAAS;oBAC5D,EAAE7H,UAAUY,OAAO,GAAG,CAAC,6GAA6G,EAAEZ,UAAUY,OAAO,CAAC,IAAI,CAAC,GAAG,GAAG;;;;QAI/K,CAAC;QAEL,MAAM,IAAI,CAAC4G,YAAY,CAACC,SAAS,CAAC;YAChCC,IAAIT;YACJU,SAAS,CAAC,+BAA+B,EAAER,SAAS,IAAI,EAAEjE,aAAa;YACvEkE;QACF;IACF;IAEA,MAAcvE,4BAA4B7C,SAAc,EAAE;QACxD,MAAMsI,UAAUtI,UAAUtB,WAAW,CAAC2E,GAAG,CAAC1D,EAAE,CAACiI,IAAI,CAACrD,KAAK;QACvD,MAAM2C,gBAAgB,GAAGlH,UAAUtB,WAAW,CAACqE,SAAS,CAACsB,SAAS,CAAC,CAAC,EAAErE,UAAUtB,WAAW,CAACqE,SAAS,CAACuB,QAAQ,EAAE;QAChH,MAAM6C,WAAWnH,UAAUtB,WAAW,CAAC2E,GAAG,CAACJ,KAAK;QAEhD,MAAMmE,OAAO,CAAC;;;2BAGS,EAAEF,cAAc;;mDAEQ,EAAEC,SAAS;qEACO,EAAE,IAAIzG,KAAKV,UAAUS,aAAa,EAAEwH,kBAAkB,GAAG;qEACzD,EAAEjI,UAAUW,aAAa,CAAC;qEAC1B,EAAEX,UAAUQ,IAAI,CAAC;;;;QAI9E,CAAC;QAEL,MAAM,IAAI,CAACgH,YAAY,CAACC,SAAS,CAAC;YAChCC,IAAIY;YACJX,SAAS,CAAC,EAAE,EAAET,cAAc,yBAAyB,EAAEC,UAAU;YACjEC;QACF;IACF;IAl6BA,YACE,AAAQzI,MAAqB,EAC7B,AAAQ6I,YAA0B,CAClC;aAFQ7I,SAAAA;aACA6I,eAAAA;IACN;AAg6BN"}