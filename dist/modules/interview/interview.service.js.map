{"version":3,"sources":["../../../src/modules/interview/interview.service.ts"],"sourcesContent":["import {\r\n    Injectable,\r\n    NotFoundException,\r\n    BadRequestException,\r\n    ForbiddenException,\r\n} from '@nestjs/common';\r\nimport * as crypto from 'crypto';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport { EmailService } from '../email/email.service';\r\nimport { ConfirmInterviewDto } from './dto';\r\nimport {\r\n    InterviewStatus,\r\n    InterviewMode,\r\n    PaymentStatus,\r\n    AuditAction,\r\n    ApplicationStatus,\r\n} from '../../common/constants';\r\n\r\n@Injectable()\r\nexport class InterviewService {\r\n    constructor(\r\n        private prisma: PrismaService,\r\n        private emailService: EmailService,\r\n    ) { }\r\n\r\n    /**\r\n     * HR confirms an interview with scheduling details.\r\n     * NEW FLOW: HR sets date/time/mode upfront, then candidate pays to unlock.\r\n     * Creates Interview record with INTERVIEW_CONFIRMED status.\r\n     * Updates application status to INTERVIEW_CONFIRMED.\r\n     */\r\n    async confirmInterview(userId: string, applicationId: string, dto: ConfirmInterviewDto) {\r\n        // Verify HR owns the job for this application\r\n        const application = await this.prisma.jobApplication.findUnique({\r\n            where: { id: applicationId },\r\n            include: {\r\n                job: { include: { hr: true } },\r\n                candidate: { include: { user: true } },\r\n            },\r\n        });\r\n\r\n        if (!application) {\r\n            throw new NotFoundException('Application not found');\r\n        }\r\n\r\n        // Verify application is in APPLIED status (test passed)\r\n        if (application.status !== ApplicationStatus.APPLIED) {\r\n            throw new BadRequestException(\r\n                `Cannot confirm interview. Application status is ${application.status}. Expected APPLIED (test passed).`\r\n            );\r\n        }\r\n\r\n        // Check if HR owns this job\r\n        const hr = await this.prisma.hR.findUnique({\r\n            where: { userId },\r\n        });\r\n\r\n        if (!hr || application.job.hrId !== hr.id) {\r\n            throw new ForbiddenException('You can only confirm interviews for your own job applications');\r\n        }\r\n\r\n        // Check if interview already exists\r\n        const existingInterview = await this.prisma.interview.findUnique({\r\n            where: { applicationId }\r\n        });\r\n\r\n        if (existingInterview) {\r\n            throw new BadRequestException('Interview already confirmed for this application. Contact admin to modify.');\r\n        }\r\n\r\n        // Create interview with scheduling details and update application status\r\n        const interview = await this.prisma.$transaction(async (tx) => {\r\n            // Create interview record with interview details already set\r\n            const newInterview = await tx.interview.create({\r\n                data: {\r\n                    applicationId,\r\n                    mode: dto.mode as any,\r\n                    scheduledDate: new Date(dto.scheduledDate),\r\n                    scheduledTime: dto.scheduledTime,\r\n                    hrNotes: dto.hrNote,\r\n                    status: InterviewStatus.INTERVIEW_CONFIRMED as any,\r\n                    paymentStatus: PaymentStatus.ELIGIBLE as any,\r\n                    scheduledAt: new Date(), // HR confirmed at this time\r\n                },\r\n            });\r\n\r\n            // Update application status to INTERVIEW_CONFIRMED\r\n            await tx.jobApplication.update({\r\n                where: { id: applicationId },\r\n                data: { status: ApplicationStatus.INTERVIEW_CONFIRMED as any },\r\n            });\r\n\r\n            // Create audit log\r\n            await tx.auditLog.create({\r\n                data: {\r\n                    id: crypto.randomUUID(),\r\n                    userId,\r\n                    action: AuditAction.CREATE,\r\n                    entityType: 'Interview',\r\n                    entityId: newInterview.id,\r\n                    newValue: {\r\n                        mode: dto.mode,\r\n                        scheduledDate: dto.scheduledDate,\r\n                        scheduledTime: dto.scheduledTime,\r\n                        applicationId,\r\n                        status: InterviewStatus.INTERVIEW_CONFIRMED,\r\n                    },\r\n                },\r\n            });\r\n\r\n            return newInterview;\r\n        });\r\n\r\n        // Send notification email to candidate - \"Pay ‚Çπ99 to unlock details\"\r\n        await this.sendInterviewConfirmedEmail(application, dto);\r\n\r\n        return {\r\n            message: 'Interview confirmed successfully. Candidate will be notified to make payment.',\r\n            interview: {\r\n                id: interview.id,\r\n                mode: interview.mode,\r\n                status: interview.status,\r\n                scheduledDate: interview.scheduledDate,\r\n                scheduledTime: interview.scheduledTime,\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Process successful payment - called by payment service.\r\n     * Transitions interview from INTERVIEW_CONFIRMED to PAYMENT_SUCCESS.\r\n     * Now candidate can see interview details.\r\n     */\r\n    async processPaymentSuccess(applicationId: string, paymentId: string) {\r\n        const interview = await this.prisma.interview.findUnique({\r\n            where: { applicationId },\r\n            include: {\r\n                application: {\r\n                    include: {\r\n                        job: { include: { hr: { include: { user: true } } } },\r\n                        candidate: { include: { user: true } },\r\n                    },\r\n                },\r\n            },\r\n        });\r\n\r\n        if (!interview) {\r\n            throw new NotFoundException('Interview not found for this application');\r\n        }\r\n\r\n        if (interview.status !== InterviewStatus.INTERVIEW_CONFIRMED) {\r\n            throw new BadRequestException(\r\n                `Interview is in ${interview.status} status. Expected INTERVIEW_CONFIRMED.`\r\n            );\r\n        }\r\n\r\n        // Update interview and application status\r\n        const updatedInterview = await this.prisma.$transaction(async (tx) => {\r\n            const updated = await tx.interview.update({\r\n                where: { id: interview.id },\r\n                data: {\r\n                    status: InterviewStatus.PAYMENT_SUCCESS as any,\r\n                    paymentStatus: PaymentStatus.SUCCESS as any,\r\n                    paidAt: new Date(),\r\n                },\r\n            });\r\n\r\n            // Update application status\r\n            await tx.jobApplication.update({\r\n                where: { id: applicationId },\r\n                data: { status: ApplicationStatus.PAYMENT_SUCCESS as any },\r\n            });\r\n\r\n            return updated;\r\n        });\r\n\r\n        // Send confirmation email to candidate with interview details\r\n        await this.sendPaymentSuccessEmail(interview);\r\n\r\n        // Notify HR that candidate has paid\r\n        await this.sendPaymentNotificationToHR(interview);\r\n\r\n        return updatedInterview;\r\n    }\r\n\r\n    /**\r\n     * Get interview details for candidate.\r\n     * CRITICAL: Only return interview details if payment is successful.\r\n     */\r\n    async getInterviewForCandidate(userId: string, interviewId: string) {\r\n        const candidate = await this.prisma.candidate.findUnique({\r\n            where: { userId },\r\n        });\r\n\r\n        if (!candidate) {\r\n            throw new NotFoundException('Candidate profile not found');\r\n        }\r\n\r\n        const interview = await this.prisma.interview.findUnique({\r\n            where: { id: interviewId },\r\n            include: {\r\n                application: {\r\n                    include: {\r\n                        job: {\r\n                            select: {\r\n                                id: true,\r\n                                title: true,\r\n                                companyName: true,\r\n                            },\r\n                        },\r\n                    },\r\n                },\r\n            },\r\n        });\r\n\r\n        if (!interview) {\r\n            throw new NotFoundException('Interview not found');\r\n        }\r\n\r\n        // Verify candidate owns this interview's application\r\n        if (interview.application.candidateId !== candidate.id) {\r\n            throw new ForbiddenException('You can only view your own interviews');\r\n        }\r\n\r\n        // Base response (always visible)\r\n        const baseResponse = {\r\n            id: interview.id,\r\n            mode: interview.mode,\r\n            status: interview.status,\r\n            paymentStatus: interview.paymentStatus,\r\n            job: interview.application.job,\r\n            createdAt: interview.createdAt,\r\n        };\r\n\r\n        // Return filtered data based on status\r\n        switch (interview.status) {\r\n            case InterviewStatus.INTERVIEW_CONFIRMED:\r\n                // Interview confirmed but not paid - show payment CTA\r\n                return {\r\n                    ...baseResponse,\r\n                    message: 'HR has scheduled your interview. Pay ‚Çπ99 to unlock details.',\r\n                    requiresPayment: true,\r\n                };\r\n\r\n            case InterviewStatus.PAYMENT_SUCCESS:\r\n            case InterviewStatus.INTERVIEW_COMPLETED:\r\n                // Payment done - show full details\r\n                return {\r\n                    ...baseResponse,\r\n                    scheduledDate: interview.scheduledDate,\r\n                    scheduledTime: interview.scheduledTime,\r\n                    hrNote: interview.hrNotes,\r\n                    paidAt: interview.paidAt,\r\n                    message: interview.status === InterviewStatus.PAYMENT_SUCCESS\r\n                        ? 'Interview details unlocked. Best of luck!'\r\n                        : 'Interview completed.',\r\n                };\r\n\r\n            case InterviewStatus.CANDIDATE_NO_SHOW:\r\n                return {\r\n                    ...baseResponse,\r\n                    message: 'You missed this interview. Contact support for assistance.',\r\n                };\r\n\r\n            case InterviewStatus.HR_NO_SHOW:\r\n                return {\r\n                    ...baseResponse,\r\n                    message: 'HR did not conduct this interview. A refund has been initiated.',\r\n                };\r\n\r\n            case InterviewStatus.CANCELLED:\r\n                return {\r\n                    ...baseResponse,\r\n                    message: 'This interview was cancelled.',\r\n                };\r\n\r\n            default:\r\n                return baseResponse;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get all interviews for candidate\r\n     */\r\n    async getCandidateInterviews(userId: string) {\r\n        const candidate = await this.prisma.candidate.findUnique({\r\n            where: { userId },\r\n        });\r\n\r\n        if (!candidate) {\r\n            throw new NotFoundException('Candidate profile not found');\r\n        }\r\n\r\n        const interviews = await this.prisma.interview.findMany({\r\n            where: {\r\n                application: {\r\n                    candidateId: candidate.id,\r\n                },\r\n            },\r\n            include: {\r\n                application: {\r\n                    include: {\r\n                        job: {\r\n                            select: {\r\n                                id: true,\r\n                                title: true,\r\n                                companyName: true,\r\n                            },\r\n                        },\r\n                    },\r\n                },\r\n            },\r\n            orderBy: { createdAt: 'desc' },\r\n        });\r\n\r\n        // Filter sensitive data based on payment status\r\n        return interviews.map((interview) => {\r\n            const base = {\r\n                id: interview.id,\r\n                mode: interview.mode,\r\n                status: interview.status,\r\n                paymentStatus: interview.paymentStatus,\r\n                job: interview.application.job,\r\n                createdAt: interview.createdAt,\r\n                paidAt: interview.paidAt,\r\n            };\r\n\r\n            // Only show interview details if payment successful\r\n            if (interview.status === InterviewStatus.PAYMENT_SUCCESS ||\r\n                interview.status === InterviewStatus.INTERVIEW_COMPLETED) {\r\n                return {\r\n                    ...base,\r\n                    scheduledDate: interview.scheduledDate,\r\n                    scheduledTime: interview.scheduledTime,\r\n                    hrNote: interview.hrNotes,\r\n                };\r\n            }\r\n\r\n            return {\r\n                ...base,\r\n                requiresPayment: interview.status === InterviewStatus.INTERVIEW_CONFIRMED,\r\n            };\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get interviews for HR's jobs (shows all details to HR)\r\n     */\r\n    async getHRInterviews(userId: string, filters?: { status?: string; jobId?: string }) {\r\n        const hr = await this.prisma.hR.findUnique({\r\n            where: { userId },\r\n        });\r\n\r\n        if (!hr) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        const where: any = {\r\n            application: {\r\n                job: {\r\n                    hrId: hr.id,\r\n                },\r\n            },\r\n        };\r\n\r\n        if (filters?.status) {\r\n            where.status = filters.status;\r\n        }\r\n\r\n        if (filters?.jobId) {\r\n            where.application = {\r\n                ...where.application,\r\n                jobId: filters.jobId,\r\n            };\r\n        }\r\n\r\n        const interviews = await this.prisma.interview.findMany({\r\n            where,\r\n            include: {\r\n                application: {\r\n                    include: {\r\n                        candidate: {\r\n                            select: {\r\n                                id: true,\r\n                                firstName: true,\r\n                                lastName: true,\r\n                                user: {\r\n                                    select: {\r\n                                        email: true,\r\n                                    },\r\n                                },\r\n                            },\r\n                        },\r\n                        job: {\r\n                            select: {\r\n                                id: true,\r\n                                title: true,\r\n                            },\r\n                        },\r\n                    },\r\n                },\r\n            },\r\n            orderBy: { createdAt: 'desc' },\r\n        });\r\n\r\n        return interviews;\r\n    }\r\n\r\n    // ===========================================\r\n    // ADMIN METHODS\r\n    // ===========================================\r\n\r\n    /**\r\n     * Get interview statistics for admin\r\n     */\r\n    async getAdminInterviewStats() {\r\n        const [total, confirmed, paymentSuccess, completed, candidateNoShow, hrNoShow] = await Promise.all([\r\n            this.prisma.interview.count(),\r\n            this.prisma.interview.count({ where: { status: InterviewStatus.INTERVIEW_CONFIRMED as any } }),\r\n            this.prisma.interview.count({ where: { status: InterviewStatus.PAYMENT_SUCCESS as any } }),\r\n            this.prisma.interview.count({ where: { status: InterviewStatus.INTERVIEW_COMPLETED as any } }),\r\n            this.prisma.interview.count({ where: { status: InterviewStatus.CANDIDATE_NO_SHOW as any } }),\r\n            this.prisma.interview.count({ where: { status: InterviewStatus.HR_NO_SHOW as any } }),\r\n        ]);\r\n\r\n        // Get HRs with repeated confirmations without candidate payments (potential flag)\r\n        const flaggedHRs = await this.prisma.$queryRaw`\r\n            SELECT h.\"companyName\", h.\"userId\", COUNT(*) as pending_count\r\n            FROM \"Interview\" i\r\n            JOIN \"JobApplication\" ja ON ja.id = i.\"applicationId\"\r\n            JOIN \"Job\" j ON j.id = ja.\"jobId\"\r\n            JOIN \"HR\" h ON h.id = j.\"hrId\"\r\n            WHERE i.status = 'INTERVIEW_CONFIRMED'\r\n            AND i.\"scheduledAt\" < NOW() - INTERVAL '48 hours'\r\n            GROUP BY h.id\r\n            HAVING COUNT(*) > 2\r\n        `;\r\n\r\n        return {\r\n            total,\r\n            byStatus: {\r\n                confirmed,\r\n                paymentSuccess,\r\n                completed,\r\n                candidateNoShow,\r\n                hrNoShow,\r\n            },\r\n            flaggedHRs,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get all interviews for admin with pagination\r\n     */\r\n    async getAdminInterviews(page: number = 1, limit: number = 20, status?: string) {\r\n        const skip = (page - 1) * limit;\r\n        const where: any = {};\r\n\r\n        if (status) {\r\n            where.status = status;\r\n        }\r\n\r\n        const [interviews, total] = await Promise.all([\r\n            this.prisma.interview.findMany({\r\n                where,\r\n                skip,\r\n                take: limit,\r\n                include: {\r\n                    application: {\r\n                        include: {\r\n                            candidate: {\r\n                                select: {\r\n                                    firstName: true,\r\n                                    lastName: true,\r\n                                },\r\n                            },\r\n                            job: {\r\n                                select: {\r\n                                    title: true,\r\n                                    companyName: true,\r\n                                    hr: {\r\n                                        select: {\r\n                                            companyName: true,\r\n                                        },\r\n                                    },\r\n                                },\r\n                            },\r\n                        },\r\n                    },\r\n                },\r\n                orderBy: { createdAt: 'desc' },\r\n            }),\r\n            this.prisma.interview.count({ where }),\r\n        ]);\r\n\r\n        return {\r\n            interviews,\r\n            pagination: {\r\n                page,\r\n                limit,\r\n                total,\r\n                totalPages: Math.ceil(total / limit),\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Admin marks an interview as no-show\r\n     */\r\n    async markNoShow(interviewId: string, type: 'CANDIDATE' | 'HR', adminUserId: string) {\r\n        const interview = await this.prisma.interview.findUnique({\r\n            where: { id: interviewId },\r\n        });\r\n\r\n        if (!interview) {\r\n            throw new NotFoundException('Interview not found');\r\n        }\r\n\r\n        const newStatus = type === 'CANDIDATE'\r\n            ? InterviewStatus.CANDIDATE_NO_SHOW\r\n            : InterviewStatus.HR_NO_SHOW;\r\n\r\n        const updatedInterview = await this.prisma.$transaction(async (tx) => {\r\n            const updated = await tx.interview.update({\r\n                where: { id: interviewId },\r\n                data: {\r\n                    status: newStatus as any,\r\n                    completedAt: new Date(),\r\n                },\r\n            });\r\n\r\n            // Update application status\r\n            await tx.jobApplication.update({\r\n                where: { id: interview.applicationId },\r\n                data: {\r\n                    status: (type === 'CANDIDATE'\r\n                        ? ApplicationStatus.CANDIDATE_NO_SHOW\r\n                        : ApplicationStatus.HR_NO_SHOW) as any\r\n                },\r\n            });\r\n\r\n            // Create audit log\r\n            await tx.auditLog.create({\r\n                data: {\r\n                    id: crypto.randomUUID(),\r\n                    userId: adminUserId,\r\n                    action: AuditAction.ADMIN_OVERRIDE,\r\n                    entityType: 'Interview',\r\n                    entityId: interviewId,\r\n                    oldValue: { status: interview.status },\r\n                    newValue: { status: newStatus, reason: `${type}_NO_SHOW` },\r\n                },\r\n            });\r\n\r\n            return updated;\r\n        });\r\n\r\n        return {\r\n            message: `Interview marked as ${type} no-show`,\r\n            interview: updatedInterview,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Admin marks interview as completed\r\n     */\r\n    async markCompleted(interviewId: string, adminUserId: string) {\r\n        const interview = await this.prisma.interview.findUnique({\r\n            where: { id: interviewId },\r\n        });\r\n\r\n        if (!interview) {\r\n            throw new NotFoundException('Interview not found');\r\n        }\r\n\r\n        if (interview.status !== InterviewStatus.PAYMENT_SUCCESS) {\r\n            throw new BadRequestException('Can only mark PAYMENT_SUCCESS interviews as completed');\r\n        }\r\n\r\n        const updatedInterview = await this.prisma.$transaction(async (tx) => {\r\n            const updated = await tx.interview.update({\r\n                where: { id: interviewId },\r\n                data: {\r\n                    status: InterviewStatus.INTERVIEW_COMPLETED as any,\r\n                    completedAt: new Date(),\r\n                },\r\n            });\r\n\r\n            // Update application status\r\n            await tx.jobApplication.update({\r\n                where: { id: interview.applicationId },\r\n                data: { status: ApplicationStatus.INTERVIEW_COMPLETED as any },\r\n            });\r\n\r\n            // Create audit log\r\n            await tx.auditLog.create({\r\n                data: {\r\n                    id: crypto.randomUUID(),\r\n                    userId: adminUserId,\r\n                    action: AuditAction.UPDATE,\r\n                    entityType: 'Interview',\r\n                    entityId: interviewId,\r\n                    oldValue: { status: interview.status },\r\n                    newValue: { status: InterviewStatus.INTERVIEW_COMPLETED },\r\n                },\r\n            });\r\n\r\n            return updated;\r\n        });\r\n\r\n        return {\r\n            message: 'Interview marked as completed',\r\n            interview: updatedInterview,\r\n        };\r\n    }\r\n\r\n    // ===========================================\r\n    // Email Helper Methods\r\n    // ===========================================\r\n\r\n    private async sendInterviewConfirmedEmail(application: any, dto: ConfirmInterviewDto) {\r\n        const candidateEmail = application.candidate.user.email;\r\n        const candidateName = `${application.candidate.firstName} ${application.candidate.lastName}`;\r\n        const companyName = application.job.companyName;\r\n        const jobTitle = application.job.title;\r\n\r\n        const html = `\r\n            <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\r\n                <h2 style=\"color: #2563eb;\">üéâ Great News, ${candidateName}!</h2>\r\n                <p>The HR team at <strong>${companyName}</strong> has scheduled an interview for you!</p>\r\n                <div style=\"background: #f3f4f6; padding: 16px; border-radius: 8px; margin: 16px 0;\">\r\n                    <h3 style=\"margin: 0 0 8px 0;\">${jobTitle}</h3>\r\n                    <p style=\"margin: 0; color: #6b7280;\">${companyName}</p>\r\n                </div>\r\n                <div style=\"background: #fef3c7; padding: 16px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #f59e0b;\">\r\n                    <p style=\"margin: 0; font-weight: 500;\">\r\n                        <strong>Next Step:</strong> Pay ‚Çπ99 to unlock your interview details.\r\n                    </p>\r\n                </div>\r\n                <p style=\"color: #6b7280; font-size: 14px;\">\r\n                    This small fee ensures quality connections and shows your commitment to the opportunity.\r\n                    Your interview details will be revealed immediately after payment.\r\n                </p>\r\n                <a href=\"${process.env.FRONTEND_URL || 'http://localhost:3000'}#my-applications\" \r\n                   style=\"display: inline-block; background: #2563eb; color: white; padding: 12px 24px; \r\n                          border-radius: 6px; text-decoration: none; margin-top: 16px;\">\r\n                    Pay ‚Çπ99 & Unlock Details\r\n                </a>\r\n            </div>\r\n        `;\r\n\r\n        await this.emailService.sendEmail({\r\n            to: candidateEmail,\r\n            subject: `üéâ Interview Scheduled by ${companyName} - Pay ‚Çπ99 to Unlock Details`,\r\n            html,\r\n        });\r\n    }\r\n\r\n    private async sendPaymentSuccessEmail(interview: any) {\r\n        const candidateEmail = interview.application.candidate.user.email;\r\n        const candidateName = `${interview.application.candidate.firstName} ${interview.application.candidate.lastName}`;\r\n        const companyName = interview.application.job.companyName;\r\n        const jobTitle = interview.application.job.title;\r\n\r\n        const modeText = {\r\n            CALL: 'üìû Phone Call',\r\n            VIDEO: 'üíª Video Call',\r\n            ONSITE: 'üè¢ On-site',\r\n        }[interview.mode] || interview.mode;\r\n\r\n        const html = `\r\n            <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\r\n                <h2 style=\"color: #059669;\">‚úÖ Interview Details Unlocked!</h2>\r\n                <p>Hi ${candidateName},</p>\r\n                <p>Your payment is confirmed. Here are your interview details:</p>\r\n                <div style=\"background: #f3f4f6; padding: 20px; border-radius: 8px; margin: 16px 0;\">\r\n                    <h3 style=\"margin: 0 0 12px 0;\">${jobTitle}</h3>\r\n                    <p style=\"margin: 4px 0;\"><strong>Company:</strong> ${companyName}</p>\r\n                    <p style=\"margin: 4px 0;\"><strong>Date:</strong> ${new Date(interview.scheduledDate).toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>\r\n                    <p style=\"margin: 4px 0;\"><strong>Time:</strong> ${interview.scheduledTime}</p>\r\n                    <p style=\"margin: 4px 0;\"><strong>Mode:</strong> ${modeText}</p>\r\n                    ${interview.hrNotes ? `<p style=\"margin: 12px 0 0 0; padding-top: 12px; border-top: 1px solid #ddd;\"><strong>Note from HR:</strong> ${interview.hrNotes}</p>` : ''}\r\n                </div>\r\n                <p style=\"color: #059669; font-weight: 500;\">Best of luck with your interview! üçÄ</p>\r\n            </div>\r\n        `;\r\n\r\n        await this.emailService.sendEmail({\r\n            to: candidateEmail,\r\n            subject: `‚úÖ Interview Details Unlocked - ${jobTitle} at ${companyName}`,\r\n            html,\r\n        });\r\n    }\r\n\r\n    private async sendPaymentNotificationToHR(interview: any) {\r\n        const hrEmail = interview.application.job.hr.user.email;\r\n        const candidateName = `${interview.application.candidate.firstName} ${interview.application.candidate.lastName}`;\r\n        const jobTitle = interview.application.job.title;\r\n\r\n        const html = `\r\n            <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\r\n                <h2 style=\"color: #059669;\">‚úÖ Candidate Has Confirmed</h2>\r\n                <p><strong>${candidateName}</strong> has paid and confirmed their interview for:</p>\r\n                <div style=\"background: #f3f4f6; padding: 16px; border-radius: 8px; margin: 16px 0;\">\r\n                    <h3 style=\"margin: 0 0 8px 0;\">${jobTitle}</h3>\r\n                    <p style=\"margin: 4px 0;\"><strong>Date:</strong> ${new Date(interview.scheduledDate).toLocaleDateString()}</p>\r\n                    <p style=\"margin: 4px 0;\"><strong>Time:</strong> ${interview.scheduledTime}</p>\r\n                    <p style=\"margin: 4px 0;\"><strong>Mode:</strong> ${interview.mode}</p>\r\n                </div>\r\n                <p>The candidate has been sent the interview details. Please be prepared for the interview.</p>\r\n            </div>\r\n        `;\r\n\r\n        await this.emailService.sendEmail({\r\n            to: hrEmail,\r\n            subject: `‚úÖ ${candidateName} Confirmed Interview for ${jobTitle}`,\r\n            html,\r\n        });\r\n    }\r\n}\r\n\r\n\r\n"],"names":["InterviewService","confirmInterview","userId","applicationId","dto","application","prisma","jobApplication","findUnique","where","id","include","job","hr","candidate","user","NotFoundException","status","ApplicationStatus","APPLIED","BadRequestException","hR","hrId","ForbiddenException","existingInterview","interview","$transaction","tx","newInterview","create","data","mode","scheduledDate","Date","scheduledTime","hrNotes","hrNote","InterviewStatus","INTERVIEW_CONFIRMED","paymentStatus","PaymentStatus","ELIGIBLE","scheduledAt","update","auditLog","crypto","randomUUID","action","AuditAction","CREATE","entityType","entityId","newValue","sendInterviewConfirmedEmail","message","processPaymentSuccess","paymentId","updatedInterview","updated","PAYMENT_SUCCESS","SUCCESS","paidAt","sendPaymentSuccessEmail","sendPaymentNotificationToHR","getInterviewForCandidate","interviewId","select","title","companyName","candidateId","baseResponse","createdAt","requiresPayment","INTERVIEW_COMPLETED","CANDIDATE_NO_SHOW","HR_NO_SHOW","CANCELLED","getCandidateInterviews","interviews","findMany","orderBy","map","base","getHRInterviews","filters","jobId","firstName","lastName","email","getAdminInterviewStats","total","confirmed","paymentSuccess","completed","candidateNoShow","hrNoShow","Promise","all","count","flaggedHRs","$queryRaw","byStatus","getAdminInterviews","page","limit","skip","take","pagination","totalPages","Math","ceil","markNoShow","type","adminUserId","newStatus","completedAt","ADMIN_OVERRIDE","oldValue","reason","markCompleted","UPDATE","candidateEmail","candidateName","jobTitle","html","process","env","FRONTEND_URL","emailService","sendEmail","to","subject","modeText","CALL","VIDEO","ONSITE","toLocaleDateString","weekday","year","month","day","hrEmail"],"mappings":"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"}