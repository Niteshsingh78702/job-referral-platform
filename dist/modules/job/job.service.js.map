{"version":3,"sources":["../../../src/modules/job/job.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  NotFoundException,\r\n  BadRequestException,\r\n  ForbiddenException,\r\n} from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport { CreateJobDto, UpdateJobDto, ApplyJobDto, JobQueryDto } from './dto';\r\nimport { JobStatus, ApplicationStatus, UserRole } from '../../common/constants';\r\nimport { SkillBucketService } from '../skill-bucket/skill-bucket.service';\r\nimport { SkillTestStatusDto } from '../skill-bucket/dto';\r\n\r\n@Injectable()\r\nexport class JobService {\r\n  constructor(\r\n    private prisma: PrismaService,\r\n    private skillBucketService: SkillBucketService,\r\n  ) { }\r\n\r\n  // Create job\r\n  async createJob(hrId: string, dto: CreateJobDto) {\r\n    // Verify HR exists and is approved\r\n    const hr = await this.prisma.hR.findUnique({\r\n      where: { userId: hrId },\r\n    });\r\n\r\n    if (!hr) {\r\n      throw new NotFoundException('HR profile not found');\r\n    }\r\n\r\n    if (hr.approvalStatus !== 'APPROVED') {\r\n      throw new ForbiddenException('HR account not yet approved');\r\n    }\r\n\r\n    // Generate SEO-friendly slug\r\n    const slug = this.generateSlug(dto.title, dto.companyName);\r\n\r\n    // Create job with skills\r\n    const job = await this.prisma.$transaction(async (tx) => {\r\n      const newJob = await tx.job.create({\r\n        data: {\r\n          id: require('crypto').randomUUID(),\r\n          slug,\r\n          title: dto.title,\r\n          description: dto.description,\r\n          requirements: dto.requirements,\r\n          responsibilities: dto.responsibilities,\r\n          companyName: dto.companyName,\r\n          companyLogo: dto.companyLogo,\r\n          location: dto.location,\r\n          isRemote: dto.isRemote || false,\r\n          salaryMin: dto.salaryMin,\r\n          salaryMax: dto.salaryMax,\r\n          salaryCurrency: dto.salaryCurrency || 'INR',\r\n          experienceMin: dto.experienceMin,\r\n          experienceMax: dto.experienceMax,\r\n          educationLevel: dto.educationLevel,\r\n          maxApplications: dto.maxApplications || 100, // Ensure field name matches schema\r\n          referralFee: dto.referralFee || 499,\r\n          testId: dto.testId,\r\n          hrId: hr.id,\r\n          status: JobStatus.PENDING_APPROVAL,\r\n          updatedAt: new Date(),\r\n        },\r\n      });\r\n\r\n      // Add skills if provided\r\n      if (dto.skills && dto.skills.length > 0) {\r\n        await tx.jobSkill.createMany({\r\n          data: dto.skills.map((skill: any) => ({\r\n            id: require('crypto').randomUUID(),\r\n            jobId: newJob.id,\r\n            name: skill.name,\r\n            isRequired: skill.isRequired ?? true,\r\n          })),\r\n        });\r\n      }\r\n\r\n      // Update HR stats\r\n      await tx.hR.update({\r\n        where: { id: hr.id },\r\n        data: { totalJobsPosted: { increment: 1 } },\r\n      });\r\n\r\n      return newJob;\r\n    });\r\n\r\n    return this.getJobById(job.id);\r\n  }\r\n\r\n  // Get all active jobs (public)\r\n  async getActiveJobs(query: JobQueryDto) {\r\n    const {\r\n      search,\r\n      location,\r\n      company,\r\n      experienceMin,\r\n      experienceMax,\r\n      isRemote,\r\n      page,\r\n      limit,\r\n    } = query;\r\n\r\n    const where: any = {\r\n      status: JobStatus.ACTIVE,\r\n    };\r\n\r\n    if (search) {\r\n      where.OR = [\r\n        { title: { contains: search, mode: 'insensitive' } },\r\n        { description: { contains: search, mode: 'insensitive' } },\r\n        { companyName: { contains: search, mode: 'insensitive' } },\r\n      ];\r\n    }\r\n\r\n    if (location) {\r\n      where.location = { contains: location, mode: 'insensitive' };\r\n    }\r\n\r\n    if (company) {\r\n      where.companyName = { contains: company, mode: 'insensitive' };\r\n    }\r\n\r\n    if (typeof isRemote === 'boolean') {\r\n      where.isRemote = isRemote;\r\n    }\r\n\r\n    if (experienceMin !== undefined) {\r\n      where.experienceMin = { gte: experienceMin };\r\n    }\r\n\r\n    if (experienceMax !== undefined) {\r\n      where.experienceMax = { lte: experienceMax };\r\n    }\r\n\r\n    const skip = ((page || 1) - 1) * (limit || 10);\r\n    const take = limit || 10;\r\n\r\n    const [jobs, total] = await Promise.all([\r\n      this.prisma.job.findMany({\r\n        where,\r\n        skip,\r\n        take,\r\n        include: {\r\n          JobSkill: true,\r\n          HR: {\r\n            select: {\r\n              companyName: true,\r\n            },\r\n          },\r\n        },\r\n        orderBy: { createdAt: 'desc' },\r\n      }),\r\n      this.prisma.job.count({ where }),\r\n    ]);\r\n\r\n    return {\r\n      data: jobs,\r\n      meta: {\r\n        page: page || 1,\r\n        limit: limit || 10,\r\n        total,\r\n        totalPages: Math.ceil(total / (limit || 10)),\r\n      },\r\n    };\r\n  }\r\n\r\n  // Get job by ID or slug\r\n  async getJobById(idOrSlug: string) {\r\n    const job = await this.prisma.job.findFirst({\r\n      where: {\r\n        OR: [{ id: idOrSlug }, { slug: idOrSlug }],\r\n      },\r\n      include: {\r\n        JobSkill: true,\r\n        Test: {\r\n          select: {\r\n            id: true,\r\n            title: true,\r\n            duration: true,\r\n            totalQuestions: true,\r\n          },\r\n        },\r\n        HR: {\r\n          select: {\r\n            companyName: true,\r\n            companyWebsite: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!job) {\r\n      throw new NotFoundException('Job not found');\r\n    }\r\n\r\n    return job;\r\n  }\r\n\r\n  // Update job\r\n  async updateJob(jobId: string, hrId: string, dto: UpdateJobDto) {\r\n    const job = await this.prisma.job.findUnique({\r\n      where: { id: jobId },\r\n      include: { HR: true },\r\n    });\r\n\r\n    if (!job) {\r\n      throw new NotFoundException('Job not found');\r\n    }\r\n\r\n    // Check if HR owns this job (skip for admin-created jobs with no HR)\r\n    if (job.HR && job.HR.userId !== hrId) {\r\n      throw new ForbiddenException('Not authorized to update this job');\r\n    }\r\n\r\n    // If job has no HR and user is not the creator, deny access\r\n    if (!job.HR) {\r\n      throw new ForbiddenException('Only admin can update admin-created jobs');\r\n    }\r\n\r\n    return this.prisma.job.update({\r\n      where: { id: jobId },\r\n      data: dto,\r\n      include: { JobSkill: true },\r\n    });\r\n  }\r\n\r\n  // Apply for job\r\n  async applyForJob(jobId: string, userId: string, dto: ApplyJobDto) {\r\n    // Get candidate\r\n    const candidate = await this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!candidate) {\r\n      throw new NotFoundException('Candidate profile not found');\r\n    }\r\n\r\n    // Get job with skillBucket\r\n    const job = await this.prisma.job.findUnique({\r\n      where: { id: jobId },\r\n      include: {\r\n        SkillBucket: {\r\n          include: {\r\n            Test: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!job) {\r\n      throw new NotFoundException('Job not found');\r\n    }\r\n\r\n    if (job.status !== JobStatus.ACTIVE) {\r\n      throw new BadRequestException('Job is not accepting applications');\r\n    }\r\n\r\n    if (job.applicationCount >= job.maxApplications) {\r\n      throw new BadRequestException('Job has reached maximum applications');\r\n    }\r\n\r\n    // Check if already applied (including withdrawn applications for cooldown check)\r\n    const existingApplication = await this.prisma.jobApplication.findUnique({\r\n      where: {\r\n        candidateId_jobId: {\r\n          candidateId: candidate.id,\r\n          jobId: job.id,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (existingApplication) {\r\n      // Check if application was withdrawn\r\n      if (existingApplication.status === 'WITHDRAWN') {\r\n        // Check 24-hour cooldown\r\n        const withdrawnAt = existingApplication.updatedAt;\r\n        const cooldownHours = 24;\r\n        const cooldownMs = cooldownHours * 60 * 60 * 1000;\r\n        const now = new Date();\r\n        const timeSinceWithdrawal = now.getTime() - withdrawnAt.getTime();\r\n\r\n        if (timeSinceWithdrawal < cooldownMs) {\r\n          const hoursRemaining = Math.ceil((cooldownMs - timeSinceWithdrawal) / (60 * 60 * 1000));\r\n          throw new BadRequestException(\r\n            `You withdrew this application recently. Please wait ${hoursRemaining} hour(s) before re-applying.`\r\n          );\r\n        }\r\n\r\n        // Cooldown has passed - delete the old withdrawn application to allow new one\r\n        await this.prisma.jobApplication.delete({\r\n          where: { id: existingApplication.id },\r\n        });\r\n        console.log(`Deleted withdrawn application ${existingApplication.id} to allow re-application after cooldown`);\r\n      } else {\r\n        // Active application exists\r\n        throw new BadRequestException('Already applied for this job');\r\n      }\r\n    }\r\n\r\n    // Skill-based test logic - now supports composite requirements (Full Stack etc.)\r\n    let applicationStatus = ApplicationStatus.APPLIED;\r\n    let skillCheckResult: {\r\n      canApply: boolean;\r\n      missingTests: SkillTestStatusDto[];\r\n      passedTests: SkillTestStatusDto[];\r\n      hasRequirements: boolean;\r\n    } | null = null;\r\n\r\n    // Check ALL required skills for this job (supports multiple skill requirements)\r\n    skillCheckResult =\r\n      await this.skillBucketService.checkAllRequiredSkillsForJob(\r\n        candidate.id,\r\n        job.id,\r\n      );\r\n\r\n    if (skillCheckResult.hasRequirements) {\r\n      if (skillCheckResult.canApply) {\r\n        // All required skills are passed and valid - allow instant application\r\n        applicationStatus = ApplicationStatus.APPLIED;\r\n      } else {\r\n        // Some skills are missing - show detailed error\r\n        const missingSkillNames = skillCheckResult.missingTests\r\n          .map((t) => t.displayName || t.skillBucketName)\r\n          .join(', ');\r\n\r\n        // Check if any are in cooldown (failed recently)\r\n        const inCooldown = skillCheckResult.missingTests.filter(\r\n          (t) => t.isFailed && !t.canRetest,\r\n        );\r\n        if (inCooldown.length > 0) {\r\n          const cooldownInfo = inCooldown\r\n            .map((t) => `${t.skillBucketName} (${t.retestInHours}h remaining)`)\r\n            .join(', ');\r\n          throw new BadRequestException(\r\n            `You are in cooldown for: ${cooldownInfo}. Please wait before retrying.`,\r\n          );\r\n        }\r\n\r\n        // Check if any are expired\r\n        const expired = skillCheckResult.missingTests.filter(\r\n          (t) => t.isPassed && !t.isValid,\r\n        );\r\n        if (expired.length > 0) {\r\n          throw new BadRequestException(\r\n            `Your verification has expired for: ${missingSkillNames}. Please retake the HR Shortlisting Check.`,\r\n          );\r\n        }\r\n\r\n        // Need to take tests for missing skills\r\n        throw new BadRequestException(\r\n          `You need to pass the following skill tests before applying: ${missingSkillNames}`,\r\n        );\r\n      }\r\n    } else if (job.testId) {\r\n      // Fallback to old per-job test logic (for backwards compatibility)\r\n      applicationStatus = ApplicationStatus.TEST_REQUIRED;\r\n    }\r\n\r\n    // Create application\r\n    const application = await this.prisma.$transaction(async (tx) => {\r\n      // Get the first passed test score if any (for backward compatibility)\r\n      const firstPassedTest = skillCheckResult?.passedTests[0];\r\n\r\n      const app = await tx.jobApplication.create({\r\n        data: {\r\n          id: crypto.randomUUID(),\r\n          candidateId: candidate.id,\r\n          jobId: job.id,\r\n          status: applicationStatus,\r\n          coverLetter: dto.coverLetter,\r\n          updatedAt: new Date(),\r\n          // If valid skill pass, mark test as passed\r\n          ...(firstPassedTest && {\r\n            testScore: firstPassedTest.score,\r\n            testPassedAt: new Date(),\r\n          }),\r\n        },\r\n      });\r\n\r\n      // Increment application count\r\n      await tx.job.update({\r\n        where: { id: job.id },\r\n        data: { applicationCount: { increment: 1 } },\r\n      });\r\n\r\n      return app;\r\n    });\r\n\r\n    // Return with skill status info\r\n    return {\r\n      ...application,\r\n      skillTestInfo: skillCheckResult?.hasRequirements\r\n        ? {\r\n          passedJobSkill: skillCheckResult.passedTests.map((t) => ({\r\n            skillBucketName: t.skillBucketName,\r\n            displayName: t.displayName,\r\n            score: t.score,\r\n            validTill: t.validTill,\r\n            validDaysRemaining: t.validDaysRemaining,\r\n          })),\r\n          canApply: skillCheckResult.canApply,\r\n        }\r\n        : null,\r\n    };\r\n  }\r\n\r\n  // Get HR's jobs\r\n  async getHRJobs(hrId: string, status?: JobStatus) {\r\n    const hr = await this.prisma.hR.findUnique({\r\n      where: { userId: hrId },\r\n    });\r\n\r\n    if (!hr) {\r\n      throw new NotFoundException('HR profile not found');\r\n    }\r\n\r\n    return this.prisma.job.findMany({\r\n      where: {\r\n        hrId: hr.id,\r\n        ...(status && { status }),\r\n      },\r\n      include: {\r\n        JobSkill: true,\r\n        _count: {\r\n          select: { JobApplication: true },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Check if a candidate can apply for a job (for frontend pre-check)\r\n   * This allows the frontend to show appropriate UI before the user clicks Apply\r\n   */\r\n  async getApplyEligibility(jobId: string, userId: string) {\r\n    // Get candidate\r\n    const candidate = await this.prisma.candidate.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!candidate) {\r\n      return {\r\n        canApply: false,\r\n        reason: 'Candidate profile not found',\r\n        requiresProfile: true,\r\n      };\r\n    }\r\n\r\n    // Get job\r\n    const job = await this.prisma.job.findUnique({\r\n      where: { id: jobId },\r\n    });\r\n\r\n    if (!job) {\r\n      return {\r\n        canApply: false,\r\n        reason: 'Job not found',\r\n      };\r\n    }\r\n\r\n    if (job.status !== JobStatus.ACTIVE) {\r\n      return {\r\n        canApply: false,\r\n        reason: 'Job is not accepting applications',\r\n      };\r\n    }\r\n\r\n    if (job.applicationCount >= job.maxApplications) {\r\n      return {\r\n        canApply: false,\r\n        reason: 'Job has reached maximum applications',\r\n      };\r\n    }\r\n\r\n    // Check if already applied\r\n    const existingApplication = await this.prisma.jobApplication.findUnique({\r\n      where: {\r\n        candidateId_jobId: {\r\n          candidateId: candidate.id,\r\n          jobId: job.id,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (existingApplication) {\r\n      return {\r\n        canApply: false,\r\n        reason: 'Already applied for this job',\r\n        applicationId: existingApplication.id,\r\n        applicationStatus: existingApplication.status,\r\n      };\r\n    }\r\n\r\n    // Check skill requirements\r\n    const skillCheckResult =\r\n      await this.skillBucketService.checkAllRequiredSkillsForJob(\r\n        candidate.id,\r\n        job.id,\r\n      );\r\n\r\n    if (skillCheckResult.hasRequirements && !skillCheckResult.canApply) {\r\n      // Check if any are in cooldown\r\n      const inCooldown = skillCheckResult.missingTests.filter(\r\n        (t) => t.isFailed && !t.canRetest,\r\n      );\r\n      if (inCooldown.length > 0) {\r\n        return {\r\n          canApply: false,\r\n          reason: 'In retest cooldown',\r\n          cooldownTests: inCooldown.map((t) => ({\r\n            skillName: t.skillBucketName,\r\n            displayName: t.displayName,\r\n            retestInHours: t.retestInHours,\r\n          })),\r\n        };\r\n      }\r\n\r\n      // Check if any are expired\r\n      const expired = skillCheckResult.missingTests.filter(\r\n        (t) => t.isPassed && !t.isValid,\r\n      );\r\n      if (expired.length > 0) {\r\n        return {\r\n          canApply: false,\r\n          reason: 'Skill test expired',\r\n          expiredTests: expired.map((t) => ({\r\n            skillName: t.skillBucketName,\r\n            displayName: t.displayName,\r\n          })),\r\n          requiresRetest: true,\r\n        };\r\n      }\r\n\r\n      // Need to take tests\r\n      return {\r\n        canApply: false,\r\n        reason: 'Skill tests required',\r\n        missingTests: skillCheckResult.missingTests.map((t) => ({\r\n          skillBucketId: t.skillBucketId,\r\n          skillName: t.skillBucketName,\r\n          displayName: t.displayName,\r\n          neverTaken: t.neverTaken,\r\n        })),\r\n        requiresTest: true,\r\n      };\r\n    }\r\n\r\n    // All checks passed\r\n    return {\r\n      canApply: true,\r\n      skillTestInfo: skillCheckResult.hasRequirements\r\n        ? {\r\n          passedSkills: skillCheckResult.passedTests.map((t) => ({\r\n            skillName: t.skillBucketName,\r\n            displayName: t.displayName,\r\n            validDaysRemaining: t.validDaysRemaining,\r\n          })),\r\n        }\r\n        : null,\r\n    };\r\n  }\r\n\r\n  // Helper: Generate slug\r\n  private generateSlug(title: string, company: string): string {\r\n    const base = `${title}-at-${company}`\r\n      .toLowerCase()\r\n      .replace(/[^a-z0-9]+/g, '-')\r\n      .replace(/(^-|-$)/g, '');\r\n    const timestamp = Date.now().toString(36);\r\n    return `${base}-${timestamp}`;\r\n  }\r\n}\r\n"],"names":["JobService","createJob","hrId","dto","hr","prisma","hR","findUnique","where","userId","NotFoundException","approvalStatus","ForbiddenException","slug","generateSlug","title","companyName","job","$transaction","tx","newJob","create","data","id","require","randomUUID","description","requirements","responsibilities","companyLogo","location","isRemote","salaryMin","salaryMax","salaryCurrency","experienceMin","experienceMax","educationLevel","maxApplications","referralFee","testId","status","JobStatus","PENDING_APPROVAL","updatedAt","Date","skills","length","jobSkill","createMany","map","skill","jobId","name","isRequired","update","totalJobsPosted","increment","getJobById","getActiveJobs","query","search","company","page","limit","ACTIVE","OR","contains","mode","undefined","gte","lte","skip","take","jobs","total","Promise","all","findMany","include","JobSkill","HR","select","orderBy","createdAt","count","meta","totalPages","Math","ceil","idOrSlug","findFirst","Test","duration","totalQuestions","companyWebsite","updateJob","applyForJob","candidate","SkillBucket","BadRequestException","applicationCount","existingApplication","jobApplication","candidateId_jobId","candidateId","withdrawnAt","cooldownHours","cooldownMs","now","timeSinceWithdrawal","getTime","hoursRemaining","delete","console","log","applicationStatus","ApplicationStatus","APPLIED","skillCheckResult","skillBucketService","checkAllRequiredSkillsForJob","hasRequirements","canApply","missingSkillNames","missingTests","t","displayName","skillBucketName","join","inCooldown","filter","isFailed","canRetest","cooldownInfo","retestInHours","expired","isPassed","isValid","TEST_REQUIRED","application","firstPassedTest","passedTests","app","crypto","coverLetter","testScore","score","testPassedAt","skillTestInfo","passedJobSkill","validTill","validDaysRemaining","getHRJobs","_count","JobApplication","getApplyEligibility","reason","requiresProfile","applicationId","cooldownTests","skillName","expiredTests","requiresRetest","skillBucketId","neverTaken","requiresTest","passedSkills","base","toLowerCase","replace","timestamp","toString"],"mappings":"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"}