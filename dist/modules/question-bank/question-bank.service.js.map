{"version":3,"sources":["../../../src/modules/question-bank/question-bank.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, BadRequestException } from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport {\r\n    CreateQuestionDto,\r\n    UpdateQuestionDto,\r\n    QuestionFiltersDto,\r\n    BulkQuestionDto,\r\n} from './dto';\r\n\r\n@Injectable()\r\nexport class QuestionBankService {\r\n    constructor(private prisma: PrismaService) { }\r\n\r\n    /**\r\n     * Create a single question\r\n     */\r\n    async createQuestion(dto: CreateQuestionDto, createdById: string) {\r\n        // Validate options count\r\n        if (dto.options.length !== 4) {\r\n            throw new BadRequestException('Questions must have exactly 4 options');\r\n        }\r\n\r\n        return this.prisma.questionBank.create({\r\n            data: {\r\n                question: dto.question,\r\n                options: dto.options,\r\n                correctAnswer: dto.correctAnswer,\r\n                explanation: dto.explanation,\r\n                difficulty: dto.difficulty,\r\n                category: dto.category,\r\n                tags: dto.tags,\r\n                roleType: dto.roleType,\r\n                createdById,\r\n            },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Bulk upload questions (for CSV import)\r\n     */\r\n    async bulkUpload(QuestionBank: BulkQuestionDto[], createdById: string) {\r\n        const createdQuestionBank: any[] = [];\r\n        const errors: { row: number; error: string }[] = [];\r\n\r\n        for (let i = 0; i < questions.length; i++) {\r\n            const q = questions[i];\r\n            try {\r\n                const options = [q.optionA, q.optionB, q.optionC, q.optionD];\r\n                const tags = q.tags ? q.tags.split('|').map(t => t.trim()) : [];\r\n\r\n                const created = await this.prisma.questionBank.create({\r\n                    data: {\r\n                        question: q.question,\r\n                        options,\r\n                        correctAnswer: q.correctAnswer,\r\n                        explanation: q.explanation,\r\n                        difficulty: q.difficulty as any,\r\n                        category: q.category as any,\r\n                        tags,\r\n                        roleType: q.roleType,\r\n                        createdById,\r\n                    },\r\n                });\r\n                createdQuestions.push(created);\r\n            } catch (error) {\r\n                errors.push({ row: i + 1, error: error.message });\r\n            }\r\n        }\r\n\r\n        return {\r\n            success: createdQuestions.length,\r\n            failed: errors.length,\r\n            errors,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get questions with filters and pagination\r\n     * Uses efficient indexed queries for performance\r\n     */\r\n    async getQuestions(filters: QuestionFiltersDto) {\r\n        const { page = 1, limit = 20, roleType, difficulty, category, search, tags } = filters;\r\n        const skip = (page - 1) * limit;\r\n\r\n        const where: any = {\r\n            isActive: true,\r\n        };\r\n\r\n        // Use indexed fields for filtering\r\n        if (roleType) where.roleType = roleType;\r\n        if (difficulty) where.difficulty = difficulty;\r\n        if (category) where.category = category;\r\n\r\n        // Search by question text\r\n        if (search) {\r\n            where.question = {\r\n                contains: search,\r\n                mode: 'insensitive',\r\n            };\r\n        }\r\n\r\n        // Filter by tags (any match)\r\n        if (tags && tags.length > 0) {\r\n            where.tags = {\r\n                hasSome: tags,\r\n            };\r\n        }\r\n\r\n        const [questions, total] = await Promise.all([\r\n            this.prisma.questionBank.findMany({\r\n                where,\r\n                skip,\r\n                take: limit,\r\n                orderBy: { createdAt: 'desc' },\r\n                select: {\r\n                    id: true,\r\n                    question: true,\r\n                    options: true,\r\n                    correctAnswer: true,\r\n                    difficulty: true,\r\n                    category: true,\r\n                    tags: true,\r\n                    roleType: true,\r\n                    createdAt: true,\r\n                    // Don't include explanation in list view for performance\r\n                },\r\n            }),\r\n            this.prisma.questionBank.count({ where }),\r\n        ]);\r\n\r\n        return {\r\n            questions,\r\n            pagination: {\r\n                page,\r\n                limit,\r\n                total,\r\n                totalPages: Math.ceil(total / limit),\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get a single question by ID\r\n     */\r\n    async getQuestionById(id: string) {\r\n        const question = await this.prisma.questionBank.findUnique({\r\n            where: { id },\r\n        });\r\n\r\n        if (!question) {\r\n            throw new NotFoundException('Question not found');\r\n        }\r\n\r\n        return question;\r\n    }\r\n\r\n    /**\r\n     * Update a question\r\n     */\r\n    async updateQuestion(id: string, dto: UpdateQuestionDto) {\r\n        await this.getQuestionById(id); // Verify exists\r\n\r\n        if (dto.options && dto.options.length !== 4) {\r\n            throw new BadRequestException('Questions must have exactly 4 options');\r\n        }\r\n\r\n        return this.prisma.questionBank.update({\r\n            where: { id },\r\n            data: dto as any,\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Soft delete a question\r\n     */\r\n    async deleteQuestion(id: string) {\r\n        await this.getQuestionById(id); // Verify exists\r\n\r\n        return this.prisma.questionBank.update({\r\n            where: { id },\r\n            data: { isActive: false },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get random questions for rapid fire test\r\n     * Uses efficient query to avoid loading all questions\r\n     */\r\n    async getRandomQuestions(params: {\r\n        count: number;\r\n        roleType?: string;\r\n        tags?: string[];\r\n        difficulty?: string;\r\n    }) {\r\n        const { count, roleType, tags, difficulty } = params;\r\n\r\n        const where: any = { isActive: true };\r\n        if (roleType) where.roleType = roleType;\r\n        if (difficulty) where.difficulty = difficulty;\r\n        if (tags && tags.length > 0) {\r\n            where.tags = { hasSome: tags };\r\n        }\r\n\r\n        // Get total count\r\n        const totalCount = await this.prisma.questionBank.count({ where });\r\n\r\n        if (totalCount === 0) {\r\n            return [];\r\n        }\r\n\r\n        // For large pools, use random skip strategy\r\n        // For small pools, fetch all and shuffle\r\n        if (totalCount > count * 2) {\r\n            // Random sampling for large pools\r\n            const QuestionBank: any[] = [];\r\n            const usedIds = new Set<string>();\r\n\r\n            while (questions.length < count && questions.length < totalCount) {\r\n                const skip = Math.floor(Math.random() * totalCount);\r\n                const [question] = await this.prisma.questionBank.findMany({\r\n                    where,\r\n                    skip,\r\n                    take: 1,\r\n                });\r\n\r\n                if (question && !usedIds.has(question.id)) {\r\n                    usedIds.add(question.id);\r\n                    questions.push(question);\r\n                }\r\n            }\r\n\r\n            return questions;\r\n        } else {\r\n            // Fetch all and shuffle for small pools\r\n            const allQuestions = await this.prisma.questionBank.findMany({ where });\r\n            return this.shuffleArray(allQuestions).slice(0, count);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get statistics for admin dashboard\r\n     */\r\n    async getStats() {\r\n        const [total, byRole, byDifficulty, byCategory] = await Promise.all([\r\n            this.prisma.questionBank.count({ where: { isActive: true } }),\r\n            this.prisma.questionBank.groupBy({\r\n                by: ['roleType'],\r\n                where: { isActive: true },\r\n                _count: true,\r\n            }),\r\n            this.prisma.questionBank.groupBy({\r\n                by: ['difficulty'],\r\n                where: { isActive: true },\r\n                _count: true,\r\n            }),\r\n            this.prisma.questionBank.groupBy({\r\n                by: ['category'],\r\n                where: { isActive: true },\r\n                _count: true,\r\n            }),\r\n        ]);\r\n\r\n        return {\r\n            total,\r\n            byRole: byRole.map(r => ({ roleType: r.roleType || 'Unassigned', count: r._count })),\r\n            byDifficulty: byDifficulty.map(d => ({ difficulty: d.difficulty, count: d._count })),\r\n            byCategory: byCategory.map(c => ({ category: c.category, count: c._count })),\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get unique role types for dropdown\r\n     */\r\n    async getRoleTypes() {\r\n        const roles = await this.prisma.questionBank.findMany({\r\n            where: { isActive: true, roleType: { not: null } },\r\n            select: { roleType: true },\r\n            distinct: ['roleType'],\r\n        });\r\n\r\n        return roles.map(r => r.roleType).filter(Boolean);\r\n    }\r\n\r\n    /**\r\n     * Fisher-Yates shuffle algorithm\r\n     */\r\n    private shuffleArray<T>(array: T[]): T[] {\r\n        const shuffled = [...array];\r\n        for (let i = shuffled.length - 1; i > 0; i--) {\r\n            const j = Math.floor(Math.random() * (i + 1));\r\n            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];\r\n        }\r\n        return shuffled;\r\n    }\r\n}\r\n"],"names":["QuestionBankService","createQuestion","dto","createdById","options","length","BadRequestException","prisma","questionBank","create","data","question","correctAnswer","explanation","difficulty","category","tags","roleType","bulkUpload","QuestionBank","createdQuestionBank","errors","i","questions","q","optionA","optionB","optionC","optionD","split","map","t","trim","created","createdQuestions","push","error","row","message","success","failed","getQuestions","filters","page","limit","search","skip","where","isActive","contains","mode","hasSome","total","Promise","all","findMany","take","orderBy","createdAt","select","id","count","pagination","totalPages","Math","ceil","getQuestionById","findUnique","NotFoundException","updateQuestion","update","deleteQuestion","getRandomQuestions","params","totalCount","usedIds","Set","floor","random","has","add","allQuestions","shuffleArray","slice","getStats","byRole","byDifficulty","byCategory","groupBy","by","_count","r","d","c","getRoleTypes","roles","not","distinct","filter","Boolean","array","shuffled","j"],"mappings":"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"}