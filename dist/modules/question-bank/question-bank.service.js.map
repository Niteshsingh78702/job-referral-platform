{"version":3,"sources":["../../../src/modules/question-bank/question-bank.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, BadRequestException } from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport * as crypto from 'crypto';\r\nimport {\r\n    CreateQuestionDto,\r\n    UpdateQuestionDto,\r\n    QuestionFiltersDto,\r\n    BulkQuestionDto,\r\n} from './dto';\r\n\r\n@Injectable()\r\nexport class QuestionBankService {\r\n    constructor(private prisma: PrismaService) { }\r\n\r\n    /**\r\n     * Create a single question\r\n     */\r\n    async createQuestion(dto: CreateQuestionDto, createdById: string) {\r\n        // Validate options count\r\n        if (dto.options.length !== 4) {\r\n            throw new BadRequestException('Questions must have exactly 4 options');\r\n        }\r\n\r\n        return this.prisma.questionBank.create({\r\n            data: {\r\n                id: crypto.randomUUID(),\r\n                question: dto.question,\r\n                options: dto.options,\r\n                correctAnswer: dto.correctAnswer,\r\n                explanation: dto.explanation,\r\n                difficulty: dto.difficulty,\r\n                category: dto.category,\r\n                tags: dto.tags,\r\n                roleType: dto.roleType,\r\n                createdById,\r\n            },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Bulk upload questions (for CSV import)\r\n     */\r\n    async bulkUpload(questions: BulkQuestionDto[], createdById: string) {\r\n        const createdQuestions: any[] = [];\r\n        const errors: { row: number; error: string }[] = [];\r\n\r\n        for (let i = 0; i < questions.length; i++) {\r\n            const q = questions[i];\r\n            try {\r\n                const options = [q.optionA, q.optionB, q.optionC, q.optionD];\r\n                const tags = q.tags ? q.tags.split('|').map(t => t.trim()) : [];\r\n\r\n                const created = await this.prisma.questionBank.create({\r\n                    data: {\r\n                        id: crypto.randomUUID(),\r\n                        question: q.question,\r\n                        options,\r\n                        correctAnswer: q.correctAnswer,\r\n                        explanation: q.explanation,\r\n                        difficulty: q.difficulty as any,\r\n                        category: q.category as any,\r\n                        tags,\r\n                        roleType: q.roleType,\r\n                        createdById,\r\n                    },\r\n                });\r\n                createdQuestions.push(created);\r\n            } catch (error) {\r\n                errors.push({ row: i + 1, error: error.message });\r\n            }\r\n        }\r\n\r\n        return {\r\n            success: createdQuestions.length,\r\n            failed: errors.length,\r\n            errors,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get questions with filters and pagination\r\n     * Uses efficient indexed queries for performance\r\n     */\r\n    async getQuestions(filters: QuestionFiltersDto) {\r\n        const { page = 1, limit = 20, roleType, difficulty, category, search, tags } = filters;\r\n        const skip = (page - 1) * limit;\r\n\r\n        const where: any = {\r\n            isActive: true,\r\n        };\r\n\r\n        // Use indexed fields for filtering\r\n        if (roleType) where.roleType = roleType;\r\n        if (difficulty) where.difficulty = difficulty;\r\n        if (category) where.category = category;\r\n\r\n        // Search by question text\r\n        if (search) {\r\n            where.question = {\r\n                contains: search,\r\n                mode: 'insensitive',\r\n            };\r\n        }\r\n\r\n        // Filter by tags (any match)\r\n        if (tags && tags.length > 0) {\r\n            where.tags = {\r\n                hasSome: tags,\r\n            };\r\n        }\r\n\r\n        const [questions, total] = await Promise.all([\r\n            this.prisma.questionBank.findMany({\r\n                where,\r\n                skip,\r\n                take: limit,\r\n                orderBy: { createdAt: 'desc' },\r\n                select: {\r\n                    id: true,\r\n                    question: true,\r\n                    options: true,\r\n                    correctAnswer: true,\r\n                    difficulty: true,\r\n                    category: true,\r\n                    tags: true,\r\n                    roleType: true,\r\n                    createdAt: true,\r\n                    // Don't include explanation in list view for performance\r\n                },\r\n            }),\r\n            this.prisma.questionBank.count({ where }),\r\n        ]);\r\n\r\n        return {\r\n            questions,\r\n            pagination: {\r\n                page,\r\n                limit,\r\n                total,\r\n                totalPages: Math.ceil(total / limit),\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get a single question by ID\r\n     */\r\n    async getQuestionById(id: string) {\r\n        const question = await this.prisma.questionBank.findUnique({\r\n            where: { id },\r\n        });\r\n\r\n        if (!question) {\r\n            throw new NotFoundException('Question not found');\r\n        }\r\n\r\n        return question;\r\n    }\r\n\r\n    /**\r\n     * Update a question\r\n     */\r\n    async updateQuestion(id: string, dto: UpdateQuestionDto) {\r\n        await this.getQuestionById(id); // Verify exists\r\n\r\n        if (dto.options && dto.options.length !== 4) {\r\n            throw new BadRequestException('Questions must have exactly 4 options');\r\n        }\r\n\r\n        return this.prisma.questionBank.update({\r\n            where: { id },\r\n            data: dto as any,\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Soft delete a question\r\n     */\r\n    async deleteQuestion(id: string) {\r\n        await this.getQuestionById(id); // Verify exists\r\n\r\n        return this.prisma.questionBank.update({\r\n            where: { id },\r\n            data: { isActive: false },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get random questions for rapid fire test\r\n     * Uses efficient query to avoid loading all questions\r\n     */\r\n    async getRandomQuestions(params: {\r\n        count: number;\r\n        roleType?: string;\r\n        tags?: string[];\r\n        difficulty?: string;\r\n    }) {\r\n        const { count, roleType, tags, difficulty } = params;\r\n\r\n        const where: any = { isActive: true };\r\n        if (roleType) where.roleType = roleType;\r\n        if (difficulty) where.difficulty = difficulty;\r\n        if (tags && tags.length > 0) {\r\n            where.tags = { hasSome: tags };\r\n        }\r\n\r\n        // Get total count\r\n        const totalCount = await this.prisma.questionBank.count({ where });\r\n\r\n        if (totalCount === 0) {\r\n            return [];\r\n        }\r\n\r\n        // For large pools, use random skip strategy\r\n        // For small pools, fetch all and shuffle\r\n        if (totalCount > count * 2) {\r\n            // Random sampling for large pools\r\n            const questions: any[] = [];\r\n            const usedIds = new Set<string>();\r\n\r\n            while (questions.length < count && questions.length < totalCount) {\r\n                const skip = Math.floor(Math.random() * totalCount);\r\n                const [question] = await this.prisma.questionBank.findMany({\r\n                    where,\r\n                    skip,\r\n                    take: 1,\r\n                });\r\n\r\n                if (question && !usedIds.has(question.id)) {\r\n                    usedIds.add(question.id);\r\n                    questions.push(question);\r\n                }\r\n            }\r\n\r\n            return questions;\r\n        } else {\r\n            // Fetch all and shuffle for small pools\r\n            const allQuestions = await this.prisma.questionBank.findMany({ where });\r\n            return this.shuffleArray(allQuestions).slice(0, count);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get statistics for admin dashboard\r\n     */\r\n    async getStats() {\r\n        const [total, byRole, byDifficulty, byCategory] = await Promise.all([\r\n            this.prisma.questionBank.count({ where: { isActive: true } }),\r\n            this.prisma.questionBank.groupBy({\r\n                by: ['roleType'],\r\n                where: { isActive: true },\r\n                _count: true,\r\n            }),\r\n            this.prisma.questionBank.groupBy({\r\n                by: ['difficulty'],\r\n                where: { isActive: true },\r\n                _count: true,\r\n            }),\r\n            this.prisma.questionBank.groupBy({\r\n                by: ['category'],\r\n                where: { isActive: true },\r\n                _count: true,\r\n            }),\r\n        ]);\r\n\r\n        return {\r\n            total,\r\n            byRole: byRole.map(r => ({ roleType: r.roleType || 'Unassigned', count: r._count })),\r\n            byDifficulty: byDifficulty.map(d => ({ difficulty: d.difficulty, count: d._count })),\r\n            byCategory: byCategory.map(c => ({ category: c.category, count: c._count })),\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get unique role types for dropdown\r\n     */\r\n    async getRoleTypes() {\r\n        const roles = await this.prisma.questionBank.findMany({\r\n            where: { isActive: true, roleType: { not: null } },\r\n            select: { roleType: true },\r\n            distinct: ['roleType'],\r\n        });\r\n\r\n        return roles.map(r => r.roleType).filter(Boolean);\r\n    }\r\n\r\n    /**\r\n     * Fisher-Yates shuffle algorithm\r\n     */\r\n    private shuffleArray<T>(array: T[]): T[] {\r\n        const shuffled = [...array];\r\n        for (let i = shuffled.length - 1; i > 0; i--) {\r\n            const j = Math.floor(Math.random() * (i + 1));\r\n            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];\r\n        }\r\n        return shuffled;\r\n    }\r\n}\r\n"],"names":["QuestionBankService","createQuestion","dto","createdById","options","length","BadRequestException","prisma","questionBank","create","data","id","crypto","randomUUID","question","correctAnswer","explanation","difficulty","category","tags","roleType","bulkUpload","questions","createdQuestions","errors","i","q","optionA","optionB","optionC","optionD","split","map","t","trim","created","push","error","row","message","success","failed","getQuestions","filters","page","limit","search","skip","where","isActive","contains","mode","hasSome","total","Promise","all","findMany","take","orderBy","createdAt","select","count","pagination","totalPages","Math","ceil","getQuestionById","findUnique","NotFoundException","updateQuestion","update","deleteQuestion","getRandomQuestions","params","totalCount","usedIds","Set","floor","random","has","add","allQuestions","shuffleArray","slice","getStats","byRole","byDifficulty","byCategory","groupBy","by","_count","r","d","c","getRoleTypes","roles","not","distinct","filter","Boolean","array","shuffled","j"],"mappings":"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"}