{"version":3,"sources":["../../../src/modules/referral/referral.service.ts"],"sourcesContent":["import {\r\n    Injectable,\r\n    NotFoundException,\r\n    BadRequestException,\r\n    ForbiddenException,\r\n} from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport { ConfirmReferralDto, UpdateReferralStatusDto } from './dto';\r\nimport {\r\n    ReferralStatus,\r\n    ReferralType,\r\n    ApplicationStatus,\r\n} from '../../common/constants';\r\n\r\n@Injectable()\r\nexport class ReferralService {\r\n    constructor(private prisma: PrismaService) { }\r\n\r\n    // Get pending referrals for HR\r\n    async getPendingReferralsForHR(hrUserId: string) {\r\n        const hr = await this.prisma.hR.findUnique({\r\n            where: { userId: hrUserId },\r\n        });\r\n\r\n        if (!hr) {\r\n            throw new NotFoundException('HR profile not found');\r\n        }\r\n\r\n        return this.prisma.referral.findMany({\r\n            where: {\r\n                status: { in: [ReferralStatus.PENDING, ReferralStatus.CONFIRMED] },\r\n                application: {\r\n                    Job: {\r\n                        hrId: hr.id,\r\n                    },\r\n                },\r\n            },\r\n            include: {\r\n                application: {\r\n                    include: {\r\n                        Candidate: {\r\n                            select: {\r\n                                firstName: true,\r\n                                lastName: true,\r\n                                headline: true,\r\n                                totalExperience: true,\r\n                                currentCompany: true,\r\n                                JobSkill: true,\r\n                                // Don't include contact until payment\r\n                            },\r\n                        },\r\n                        Job: {\r\n                            select: {\r\n                                title: true,\r\n                                companyName: true,\r\n                            },\r\n                        },\r\n                    },\r\n                },\r\n            },\r\n            orderBy: { createdAt: 'desc' },\r\n        });\r\n    }\r\n\r\n    // Get pending referrals for Employee\r\n    async getPendingReferralsForEmployee(employeeUserId: string) {\r\n        const employee = await this.prisma.employee.findUnique({\r\n            where: { userId: employeeUserId },\r\n        });\r\n\r\n        if (!employee) {\r\n            throw new NotFoundException('Employee profile not found');\r\n        }\r\n\r\n        // Get jobs at employee's company that need referrals\r\n        return this.prisma.referral.findMany({\r\n            where: {\r\n                status: ReferralStatus.PENDING,\r\n                type: ReferralType.Employee,\r\n                OR: [\r\n                    { employeeId: employee.id },\r\n                    {\r\n                        application: {\r\n                            Job: {\r\n                                companyName: { equals: employee.companyName, mode: 'insensitive' },\r\n                            },\r\n                        },\r\n                    },\r\n                ],\r\n            },\r\n            include: {\r\n                application: {\r\n                    include: {\r\n                        Candidate: {\r\n                            select: {\r\n                                firstName: true,\r\n                                lastName: true,\r\n                                headline: true,\r\n                                totalExperience: true,\r\n                                JobSkill: true,\r\n                            },\r\n                        },\r\n                        Job: {\r\n                            select: {\r\n                                title: true,\r\n                                companyName: true,\r\n                                location: true,\r\n                            },\r\n                        },\r\n                    },\r\n                },\r\n            },\r\n            orderBy: { createdAt: 'desc' },\r\n        });\r\n    }\r\n\r\n    // Confirm referral (HR or Employee)\r\n    async confirmReferral(\r\n        referralId: string,\r\n        userId: string,\r\n        userRole: string,\r\n        dto: ConfirmReferralDto,\r\n    ) {\r\n        const referral = await this.prisma.referral.findUnique({\r\n            where: { id: referralId },\r\n            include: {\r\n                application: {\r\n                    include: {\r\n                        Job: { include: { HR: true } },\r\n                    },\r\n                },\r\n            },\r\n        });\r\n\r\n        if (!referral) {\r\n            throw new NotFoundException('Referral not found');\r\n        }\r\n\r\n        if (referral.status !== ReferralStatus.PENDING) {\r\n            throw new BadRequestException('Referral is not in pending state');\r\n        }\r\n\r\n        // Verify authorization\r\n        if (userRole === 'HR') {\r\n            if (!referral.application.job.HR || referral.application.job.hr.userId !== userId) {\r\n                throw new ForbiddenException('Not authorized to confirm this referral');\r\n            }\r\n        } else if (userRole === 'EMPLOYEE') {\r\n            const employee = await this.prisma.employee.findUnique({\r\n                where: { userId },\r\n            });\r\n            if (!employee) {\r\n                throw new ForbiddenException('Employee profile not found');\r\n            }\r\n            // Verify employee is at the same company\r\n            if (\r\n                employee.companyName.toLowerCase() !==\r\n                referral.application.job.companyName.toLowerCase()\r\n            ) {\r\n                throw new ForbiddenException('Not authorized to refer for this company');\r\n            }\r\n        }\r\n\r\n        // Update referral\r\n        const updatedReferral = await this.prisma.$transaction(async (tx) => {\r\n            const ref = await tx.referral.update({\r\n                where: { id: referralId },\r\n                data: {\r\n                    status: ReferralStatus.CONFIRMED,\r\n                    confirmedAt: new Date(),\r\n                    type: dto.type || referral.type,\r\n                    ...(userRole === 'EMPLOYEE' && {\r\n                        employeeId: (\r\n                            await tx.employee.findUnique({ where: { userId } })\r\n                        )?.id,\r\n                    }),\r\n                    ...(userRole === 'HR' && {\r\n                        hrId: (await tx.hR.findUnique({ where: { userId } }))?.id,\r\n                    }),\r\n                },\r\n            });\r\n\r\n            // Update application status - keep as APPLIED (test passed, waiting for HR interview confirmation)\r\n            await tx.jobApplication.update({\r\n                where: { id: referral.applicationId },\r\n                data: { status: ApplicationStatus.APPLIED },\r\n            });\r\n\r\n            return ref;\r\n        });\r\n\r\n        return updatedReferral;\r\n    }\r\n\r\n    // Mark as contacted\r\n    async markAsContacted(\r\n        referralId: string,\r\n        userId: string,\r\n        feedback?: string,\r\n    ) {\r\n        const referral = await this.prisma.referral.findUnique({\r\n            where: { id: referralId },\r\n            include: {\r\n                application: {\r\n                    include: {\r\n                        Job: { include: { HR: true } },\r\n                    },\r\n                },\r\n            },\r\n        });\r\n\r\n        if (!referral) {\r\n            throw new NotFoundException('Referral not found');\r\n        }\r\n\r\n        // Only HR can mark as contacted\r\n        if (!referral.application.job.HR || referral.application.job.hr.userId !== userId) {\r\n            throw new ForbiddenException('Only HR can mark as contacted');\r\n        }\r\n\r\n        return this.prisma.referral.update({\r\n            where: { id: referralId },\r\n            data: {\r\n                status: ReferralStatus.CONTACTED,\r\n                contactedAt: new Date(),\r\n                hrFeedback: feedback,\r\n            },\r\n        });\r\n    }\r\n\r\n    // Close referral\r\n    async closeReferral(referralId: string, userId: string, feedback?: string) {\r\n        const referral = await this.prisma.referral.findUnique({\r\n            where: { id: referralId },\r\n            include: {\r\n                application: {\r\n                    include: {\r\n                        Job: { include: { HR: true } },\r\n                    },\r\n                },\r\n            },\r\n        });\r\n\r\n        if (!referral) {\r\n            throw new NotFoundException('Referral not found');\r\n        }\r\n\r\n        if (!referral.application.job.HR || referral.application.job.hr.userId !== userId) {\r\n            throw new ForbiddenException('Not authorized');\r\n        }\r\n\r\n        return this.prisma.$transaction(async (tx) => {\r\n            await tx.referral.update({\r\n                where: { id: referralId },\r\n                data: {\r\n                    status: ReferralStatus.CLOSED,\r\n                    closedAt: new Date(),\r\n                    hrFeedback: feedback,\r\n                },\r\n            });\r\n\r\n            await tx.jobApplication.update({\r\n                where: { id: referral.applicationId },\r\n                data: { status: ApplicationStatus.REJECTED },\r\n            });\r\n\r\n            return { success: true };\r\n        });\r\n    }\r\n\r\n    // Get referral history\r\n    async getReferralHistory(userId: string, userRole: string) {\r\n        if (userRole === 'HR') {\r\n            const hr = await this.prisma.hR.findUnique({\r\n                where: { userId },\r\n            });\r\n            if (!hr) {\r\n                throw new NotFoundException('HR profile not found');\r\n            }\r\n            return this.prisma.referral.findMany({\r\n                where: { hrId: hr.id },\r\n                include: {\r\n                    application: {\r\n                        include: {\r\n                            Candidate: {\r\n                                select: {\r\n                                    firstName: true,\r\n                                    lastName: true,\r\n                                },\r\n                            },\r\n                            Job: {\r\n                                select: {\r\n                                    title: true,\r\n                                },\r\n                            },\r\n                        },\r\n                    },\r\n                },\r\n                orderBy: { createdAt: 'desc' },\r\n            });\r\n        } else if (userRole === 'EMPLOYEE') {\r\n            const employee = await this.prisma.employee.findUnique({\r\n                where: { userId },\r\n            });\r\n            if (!employee) {\r\n                throw new NotFoundException('Employee profile not found');\r\n            }\r\n            return this.prisma.referral.findMany({\r\n                where: { employeeId: employee.id },\r\n                include: {\r\n                    application: {\r\n                        include: {\r\n                            Candidate: {\r\n                                select: {\r\n                                    firstName: true,\r\n                                    lastName: true,\r\n                                },\r\n                            },\r\n                            Job: {\r\n                                select: {\r\n                                    title: true,\r\n                                    companyName: true,\r\n                                },\r\n                            },\r\n                        },\r\n                    },\r\n                },\r\n                orderBy: { createdAt: 'desc' },\r\n            });\r\n        }\r\n\r\n        throw new BadRequestException('Invalid user role for referral history');\r\n    }\r\n}\r\n\r\n"],"names":["ReferralService","getPendingReferralsForHR","hrUserId","hr","prisma","hR","findUnique","where","userId","NotFoundException","referral","findMany","status","in","ReferralStatus","PENDING","CONFIRMED","application","Job","hrId","id","include","Candidate","select","firstName","lastName","headline","totalExperience","currentCompany","JobSkill","title","companyName","orderBy","createdAt","getPendingReferralsForEmployee","employeeUserId","employee","type","ReferralType","Employee","OR","employeeId","equals","mode","location","confirmReferral","referralId","userRole","dto","HR","BadRequestException","job","ForbiddenException","toLowerCase","updatedReferral","$transaction","tx","ref","update","data","confirmedAt","Date","jobApplication","applicationId","ApplicationStatus","APPLIED","markAsContacted","feedback","CONTACTED","contactedAt","hrFeedback","closeReferral","CLOSED","closedAt","REJECTED","success","getReferralHistory"],"mappings":"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"}