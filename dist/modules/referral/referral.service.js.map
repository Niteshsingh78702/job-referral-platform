{"version":3,"sources":["../../../src/modules/referral/referral.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  NotFoundException,\r\n  BadRequestException,\r\n  ForbiddenException,\r\n} from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport { ConfirmReferralDto, UpdateReferralStatusDto } from './dto';\r\nimport {\r\n  ReferralStatus,\r\n  ReferralType,\r\n  ApplicationStatus,\r\n} from '../../common/constants';\r\n\r\n@Injectable()\r\nexport class ReferralService {\r\n  constructor(private prisma: PrismaService) { }\r\n\r\n  // Get pending referrals for HR\r\n  async getPendingReferralsForHR(hrUserId: string) {\r\n    const hr = await this.prisma.hR.findUnique({\r\n      where: { userId: hrUserId },\r\n    });\r\n\r\n    if (!hr) {\r\n      throw new NotFoundException('HR profile not found');\r\n    }\r\n\r\n    return this.prisma.referral.findMany({\r\n      where: {\r\n        status: { in: [ReferralStatus.PENDING, ReferralStatus.CONFIRMED] },\r\n        JobApplication: {\r\n          Job: {\r\n            hrId: hr.id,\r\n          },\r\n        },\r\n      },\r\n      include: {\r\n        JobApplication: {\r\n          include: {\r\n            Candidate: {\r\n              select: {\r\n                firstName: true,\r\n                lastName: true,\r\n                headline: true,\r\n                totalExperience: true,\r\n                currentCompany: true,\r\n                CandidateSkill: true,\r\n                // Don't include contact until payment\r\n              },\r\n            },\r\n            Job: {\r\n              select: {\r\n                title: true,\r\n                companyName: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  // Get pending referrals for Employee\r\n  async getPendingReferralsForEmployee(employeeUserId: string) {\r\n    const employee = await this.prisma.employee.findUnique({\r\n      where: { userId: employeeUserId },\r\n    });\r\n\r\n    if (!employee) {\r\n      throw new NotFoundException('Employee profile not found');\r\n    }\r\n\r\n    // Get jobs at employee's company that need referrals\r\n    return this.prisma.referral.findMany({\r\n      where: {\r\n        status: ReferralStatus.PENDING,\r\n        type: ReferralType.EMPLOYEE,\r\n        OR: [\r\n          { employeeId: employee.id },\r\n          {\r\n            JobApplication: {\r\n              Job: {\r\n                companyName: {\r\n                  equals: employee.companyName,\r\n                  mode: 'insensitive',\r\n                },\r\n              },\r\n            },\r\n          },\r\n        ],\r\n      },\r\n      include: {\r\n        JobApplication: {\r\n          include: {\r\n            Candidate: {\r\n              select: {\r\n                firstName: true,\r\n                lastName: true,\r\n                headline: true,\r\n                totalExperience: true,\r\n                CandidateSkill: true,\r\n              },\r\n            },\r\n            Job: {\r\n              select: {\r\n                title: true,\r\n                companyName: true,\r\n                location: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  // Confirm referral (HR or Employee)\r\n  async confirmReferral(\r\n    referralId: string,\r\n    userId: string,\r\n    userRole: string,\r\n    dto: ConfirmReferralDto,\r\n  ) {\r\n    const referral = await this.prisma.referral.findUnique({\r\n      where: { id: referralId },\r\n      include: {\r\n        JobApplication: {\r\n          include: {\r\n            Job: { include: { HR: true } },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!referral) {\r\n      throw new NotFoundException('Referral not found');\r\n    }\r\n\r\n    if (referral.status !== ReferralStatus.PENDING) {\r\n      throw new BadRequestException('Referral is not in pending state');\r\n    }\r\n\r\n    // Verify authorization\r\n    if (userRole === 'HR') {\r\n      if (\r\n        !referral.JobApplication.Job.HR ||\r\n        referral.JobApplication.Job.HR.userId !== userId\r\n      ) {\r\n        throw new ForbiddenException('Not authorized to confirm this referral');\r\n      }\r\n    } else if (userRole === 'EMPLOYEE') {\r\n      const employee = await this.prisma.employee.findUnique({\r\n        where: { userId },\r\n      });\r\n      if (!employee) {\r\n        throw new ForbiddenException('Employee profile not found');\r\n      }\r\n      // Verify employee is at the same company\r\n      if (\r\n        employee.companyName.toLowerCase() !==\r\n        referral.JobApplication.Job.companyName.toLowerCase()\r\n      ) {\r\n        throw new ForbiddenException(\r\n          'Not authorized to refer for this company',\r\n        );\r\n      }\r\n    }\r\n\r\n    // Update referral\r\n    const updatedReferral = await this.prisma.$transaction(async (tx) => {\r\n      const ref = await tx.referral.update({\r\n        where: { id: referralId },\r\n        data: {\r\n          status: ReferralStatus.CONFIRMED,\r\n          confirmedAt: new Date(),\r\n          type: dto.type || referral.type,\r\n          ...(userRole === 'EMPLOYEE' && {\r\n            employeeId: (await tx.employee.findUnique({ where: { userId } }))\r\n              ?.id,\r\n          }),\r\n          ...(userRole === 'HR' && {\r\n            hrId: (await tx.hR.findUnique({ where: { userId } }))?.id,\r\n          }),\r\n        },\r\n      });\r\n\r\n      // Update application status - keep as APPLIED (test passed, waiting for HR interview confirmation)\r\n      await tx.jobApplication.update({\r\n        where: { id: referral.applicationId },\r\n        data: { status: ApplicationStatus.APPLIED },\r\n      });\r\n\r\n      return ref;\r\n    });\r\n\r\n    return updatedReferral;\r\n  }\r\n\r\n  // Mark as contacted\r\n  async markAsContacted(referralId: string, userId: string, feedback?: string) {\r\n    const referral = await this.prisma.referral.findUnique({\r\n      where: { id: referralId },\r\n      include: {\r\n        JobApplication: {\r\n          include: {\r\n            Job: { include: { HR: true } },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!referral) {\r\n      throw new NotFoundException('Referral not found');\r\n    }\r\n\r\n    // Only HR can mark as contacted\r\n    if (\r\n      !referral.JobApplication.Job.HR ||\r\n      referral.JobApplication.Job.HR.userId !== userId\r\n    ) {\r\n      throw new ForbiddenException('Only HR can mark as contacted');\r\n    }\r\n\r\n    return this.prisma.referral.update({\r\n      where: { id: referralId },\r\n      data: {\r\n        status: ReferralStatus.CONTACTED,\r\n        contactedAt: new Date(),\r\n        hrFeedback: feedback,\r\n      },\r\n    });\r\n  }\r\n\r\n  // Close referral\r\n  async closeReferral(referralId: string, userId: string, feedback?: string) {\r\n    const referral = await this.prisma.referral.findUnique({\r\n      where: { id: referralId },\r\n      include: {\r\n        JobApplication: {\r\n          include: {\r\n            Job: { include: { HR: true } },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!referral) {\r\n      throw new NotFoundException('Referral not found');\r\n    }\r\n\r\n    if (\r\n      !referral.JobApplication.Job.HR ||\r\n      referral.JobApplication.Job.HR.userId !== userId\r\n    ) {\r\n      throw new ForbiddenException('Not authorized');\r\n    }\r\n\r\n    return this.prisma.$transaction(async (tx) => {\r\n      await tx.referral.update({\r\n        where: { id: referralId },\r\n        data: {\r\n          status: ReferralStatus.CLOSED,\r\n          closedAt: new Date(),\r\n          hrFeedback: feedback,\r\n        },\r\n      });\r\n\r\n      await tx.jobApplication.update({\r\n        where: { id: referral.applicationId },\r\n        data: { status: ApplicationStatus.REJECTED },\r\n      });\r\n\r\n      return { success: true };\r\n    });\r\n  }\r\n\r\n  // Get referral history\r\n  async getReferralHistory(userId: string, userRole: string) {\r\n    if (userRole === 'HR') {\r\n      const hr = await this.prisma.hR.findUnique({\r\n        where: { userId },\r\n      });\r\n      if (!hr) {\r\n        throw new NotFoundException('HR profile not found');\r\n      }\r\n      return this.prisma.referral.findMany({\r\n        where: { hrId: hr.id },\r\n        include: {\r\n          JobApplication: {\r\n            include: {\r\n              Candidate: {\r\n                select: {\r\n                  firstName: true,\r\n                  lastName: true,\r\n                },\r\n              },\r\n              Job: {\r\n                select: {\r\n                  title: true,\r\n                },\r\n              },\r\n            },\r\n          },\r\n        },\r\n        orderBy: { createdAt: 'desc' },\r\n      });\r\n    } else if (userRole === 'EMPLOYEE') {\r\n      const employee = await this.prisma.employee.findUnique({\r\n        where: { userId },\r\n      });\r\n      if (!employee) {\r\n        throw new NotFoundException('Employee profile not found');\r\n      }\r\n      return this.prisma.referral.findMany({\r\n        where: { employeeId: employee.id },\r\n        include: {\r\n          JobApplication: {\r\n            include: {\r\n              Candidate: {\r\n                select: {\r\n                  firstName: true,\r\n                  lastName: true,\r\n                },\r\n              },\r\n              Job: {\r\n                select: {\r\n                  title: true,\r\n                  companyName: true,\r\n                },\r\n              },\r\n            },\r\n          },\r\n        },\r\n        orderBy: { createdAt: 'desc' },\r\n      });\r\n    }\r\n\r\n    throw new BadRequestException('Invalid user role for referral history');\r\n  }\r\n}\r\n"],"names":["ReferralService","getPendingReferralsForHR","hrUserId","hr","prisma","hR","findUnique","where","userId","NotFoundException","referral","findMany","status","in","ReferralStatus","PENDING","CONFIRMED","JobApplication","Job","hrId","id","include","Candidate","select","firstName","lastName","headline","totalExperience","currentCompany","CandidateSkill","title","companyName","orderBy","createdAt","getPendingReferralsForEmployee","employeeUserId","employee","type","ReferralType","EMPLOYEE","OR","employeeId","equals","mode","location","confirmReferral","referralId","userRole","dto","HR","BadRequestException","ForbiddenException","toLowerCase","updatedReferral","$transaction","tx","ref","update","data","confirmedAt","Date","jobApplication","applicationId","ApplicationStatus","APPLIED","markAsContacted","feedback","CONTACTED","contactedAt","hrFeedback","closeReferral","CLOSED","closedAt","REJECTED","success","getReferralHistory"],"mappings":"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"}