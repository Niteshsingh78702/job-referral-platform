{"version":3,"sources":["../../../src/modules/test-template/test-template.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, BadRequestException } from '@nestjs/common';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport { CreateTestTemplateDto, UpdateTestTemplateDto, TemplateFiltersDto, AssignTemplateDto } from './dto';\r\n\r\n@Injectable()\r\nexport class TestTemplateService {\r\n    constructor(private prisma: PrismaService) { }\r\n\r\n    /**\r\n     * Create a new test template\r\n     */\r\n    async createTemplate(dto: CreateTestTemplateDto) {\r\n        // Validate that question pool is available if auto-select\r\n        if (dto.autoSelect) {\r\n            const questionCount = await this.getAvailableQuestionCount(\r\n                dto.selectionRoleType,\r\n                dto.selectionTags,\r\n            );\r\n\r\n            if (questionCount < dto.questionPoolSize) {\r\n                throw new BadRequestException(\r\n                    `Not enough questions available. Found ${questionCount}, need ${dto.questionPoolSize}`,\r\n                );\r\n            }\r\n        }\r\n\r\n        return this.prisma.testTemplate.create({\r\n            data: {\r\n                name: dto.name,\r\n                description: dto.description,\r\n                testType: dto.testType,\r\n                duration: dto.duration,\r\n                passingCriteria: dto.passingCriteria,\r\n                questionPoolSize: dto.questionPoolSize,\r\n                autoSelect: dto.autoSelect,\r\n                selectionTags: dto.selectionTags || [],\r\n                selectionRoleType: dto.selectionRoleType,\r\n                allowSkip: dto.allowSkip ?? true,\r\n                showLiveScore: dto.showLiveScore ?? false,\r\n            },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get templates with filters and pagination\r\n     */\r\n    async getTemplates(filters: TemplateFiltersDto) {\r\n        const { page = 1, limit = 20, testType, isActive } = filters;\r\n        const skip = (page - 1) * limit;\r\n\r\n        const where: any = {};\r\n        if (testType) where.testType = testType;\r\n        if (isActive !== undefined) where.isActive = isActive;\r\n\r\n        const [templates, total] = await Promise.all([\r\n            this.prisma.testTemplate.findMany({\r\n                where,\r\n                skip,\r\n                take: limit,\r\n                orderBy: { createdAt: 'desc' },\r\n                include: {\r\n                    SkillBucket: {\r\n                        select: { id: true, code: true, name: true },\r\n                    },\r\n                    _count: {\r\n                        select: { TestSession: true },\r\n                    },\r\n                },\r\n            }),\r\n            this.prisma.testTemplate.count({ where }),\r\n        ]);\r\n\r\n        return {\r\n            templates,\r\n            pagination: {\r\n                page,\r\n                limit,\r\n                total,\r\n                totalPages: Math.ceil(total / limit),\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get a single template by ID\r\n     */\r\n    async getTemplateById(id: string) {\r\n        const template = await this.prisma.testTemplate.findUnique({\r\n            where: { id },\r\n            include: {\r\n                SkillBucket: {\r\n                    select: { id: true, code: true, name: true },\r\n                },\r\n            },\r\n        });\r\n\r\n        if (!template) {\r\n            throw new NotFoundException('Test template not found');\r\n        }\r\n\r\n        // Get available question count\r\n        const questionCount = await this.getAvailableQuestionCount(\r\n            template.selectionRoleType,\r\n            template.selectionTags,\r\n        );\r\n\r\n        return {\r\n            ...template,\r\n            availableQuestionBank: questionCount,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Update a template\r\n     */\r\n    async updateTemplate(id: string, dto: UpdateTestTemplateDto) {\r\n        await this.getTemplateById(id); // Verify exists\r\n\r\n        return this.prisma.testTemplate.update({\r\n            where: { id },\r\n            data: dto as any,\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Delete a template (soft delete)\r\n     */\r\n    async deleteTemplate(id: string) {\r\n        const template = await this.getTemplateById(id);\r\n\r\n        // Check if assigned to any skill bucket\r\n        if (template.skillBuckets && template.skillBuckets.length > 0) {\r\n            throw new BadRequestException(\r\n                'Cannot delete template that is assigned to skill buckets. Unassign first.',\r\n            );\r\n        }\r\n\r\n        return this.prisma.testTemplate.update({\r\n            where: { id },\r\n            data: { isActive: false },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Assign template to a skill bucket\r\n     */\r\n    async assignToSkillBucket(templateId: string, dto: AssignTemplateDto) {\r\n        const template = await this.getTemplateById(templateId);\r\n\r\n        // Check if skill bucket exists\r\n        const skillBucket = await this.prisma.skillBucket.findUnique({\r\n            where: { id: dto.skillBucketId },\r\n        });\r\n\r\n        if (!skillBucket) {\r\n            throw new NotFoundException('Skill bucket not found');\r\n        }\r\n\r\n        // Update skill bucket to link to this template\r\n        await this.prisma.skillBucket.update({\r\n            where: { id: dto.skillBucketId },\r\n            data: { testTemplateId: templateId },\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            message: `Template \"${template.name}\" assigned to skill bucket \"${skillBucket.name}\"`,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Unassign template from a skill bucket\r\n     */\r\n    async unassignFromSkillBucket(skillBucketId: string) {\r\n        const skillBucket = await this.prisma.skillBucket.findUnique({\r\n            where: { id: skillBucketId },\r\n        });\r\n\r\n        if (!skillBucket) {\r\n            throw new NotFoundException('Skill bucket not found');\r\n        }\r\n\r\n        await this.prisma.skillBucket.update({\r\n            where: { id: skillBucketId },\r\n            data: { testTemplateId: null },\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            message: `Template unassigned from skill bucket \"${skillBucket.name}\"`,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get available question count for a template's selection criteria\r\n     */\r\n    private async getAvailableQuestionCount(\r\n        roleType?: string | null,\r\n        tags?: string[],\r\n    ): Promise<number> {\r\n        const where: any = { isActive: true };\r\n        if (roleType) where.roleType = roleType;\r\n        if (tags && tags.length > 0) {\r\n            where.tags = { hasSome: tags };\r\n        }\r\n\r\n        return this.prisma.questionBank.count({ where });\r\n    }\r\n\r\n    /**\r\n     * Preview questions that would be selected for a template\r\n     */\r\n    async previewQuestions(templateId: string, count: number = 10) {\r\n        const template = await this.getTemplateById(templateId);\r\n\r\n        const where: any = { isActive: true };\r\n        if (template.selectionRoleType) where.roleType = template.selectionRoleType;\r\n        if (template.selectionTags && template.selectionTags.length > 0) {\r\n            where.tags = { hasSome: template.selectionTags };\r\n        }\r\n\r\n        const questions = await this.prisma.questionBank.findMany({\r\n            where,\r\n            take: count,\r\n            orderBy: { createdAt: 'desc' },\r\n            select: {\r\n                id: true,\r\n                question: true,\r\n                difficulty: true,\r\n                category: true,\r\n                tags: true,\r\n            },\r\n        });\r\n\r\n        return questions;\r\n    }\r\n}\r\n"],"names":["TestTemplateService","createTemplate","dto","autoSelect","questionCount","getAvailableQuestionCount","selectionRoleType","selectionTags","questionPoolSize","BadRequestException","prisma","testTemplate","create","data","name","description","testType","duration","passingCriteria","allowSkip","showLiveScore","getTemplates","filters","page","limit","isActive","skip","where","undefined","templates","total","Promise","all","findMany","take","orderBy","createdAt","include","SkillBucket","select","id","code","_count","TestSession","count","pagination","totalPages","Math","ceil","getTemplateById","template","findUnique","NotFoundException","availableQuestionBank","updateTemplate","update","deleteTemplate","skillBuckets","length","assignToSkillBucket","templateId","skillBucket","skillBucketId","testTemplateId","success","message","unassignFromSkillBucket","roleType","tags","hasSome","questionBank","previewQuestions","questions","question","difficulty","category"],"mappings":"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"}