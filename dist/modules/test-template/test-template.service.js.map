{"version":3,"sources":["../../../src/modules/test-template/test-template.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  NotFoundException,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport * as crypto from 'crypto';\r\nimport { PrismaService } from '../../prisma/prisma.service';\r\nimport {\r\n  CreateTestTemplateDto,\r\n  UpdateTestTemplateDto,\r\n  TemplateFiltersDto,\r\n  AssignTemplateDto,\r\n} from './dto';\r\n\r\n@Injectable()\r\nexport class TestTemplateService {\r\n  constructor(private prisma: PrismaService) { }\r\n\r\n  /**\r\n   * Create a new test template\r\n   */\r\n  async createTemplate(dto: CreateTestTemplateDto) {\r\n    // Validate that question pool is available if auto-select\r\n    if (dto.autoSelect) {\r\n      const questionCount = await this.getAvailableQuestionCount(\r\n        dto.selectionRoleType,\r\n        dto.selectionTags,\r\n      );\r\n\r\n      if (questionCount < dto.questionPoolSize) {\r\n        throw new BadRequestException(\r\n          `Not enough questions available. Found ${questionCount}, need ${dto.questionPoolSize}`,\r\n        );\r\n      }\r\n    }\r\n\r\n    return this.prisma.testTemplate.create({\r\n      data: {\r\n        id: crypto.randomUUID(),\r\n        name: dto.name,\r\n        description: dto.description,\r\n        testType: dto.testType,\r\n        duration: dto.duration,\r\n        passingCriteria: dto.passingCriteria,\r\n        questionPoolSize: dto.questionPoolSize,\r\n        autoSelect: dto.autoSelect,\r\n        selectionTags: dto.selectionTags || [],\r\n        selectionRoleType: dto.selectionRoleType,\r\n        allowSkip: dto.allowSkip ?? true,\r\n        showLiveScore: dto.showLiveScore ?? false,\r\n        updatedAt: new Date(),\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get templates with filters and pagination\r\n   */\r\n  async getTemplates(filters: TemplateFiltersDto) {\r\n    const { page = 1, limit = 20, testType, isActive } = filters;\r\n    const skip = (page - 1) * limit;\r\n\r\n    const where: any = {};\r\n    if (testType) where.testType = testType;\r\n    if (isActive !== undefined) where.isActive = isActive;\r\n\r\n    const [templates, total] = await Promise.all([\r\n      this.prisma.testTemplate.findMany({\r\n        where,\r\n        skip,\r\n        take: limit,\r\n        orderBy: { createdAt: 'desc' },\r\n        include: {\r\n          SkillBucket: {\r\n            select: { id: true, code: true, name: true },\r\n          },\r\n          _count: {\r\n            select: { TestSession: true },\r\n          },\r\n        },\r\n      }),\r\n      this.prisma.testTemplate.count({ where }),\r\n    ]);\r\n\r\n    return {\r\n      templates,\r\n      pagination: {\r\n        page,\r\n        limit,\r\n        total,\r\n        totalPages: Math.ceil(total / limit),\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get a single template by ID\r\n   */\r\n  async getTemplateById(id: string) {\r\n    const template = await this.prisma.testTemplate.findUnique({\r\n      where: { id },\r\n      include: {\r\n        SkillBucket: {\r\n          select: { id: true, code: true, name: true },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!template) {\r\n      throw new NotFoundException('Test template not found');\r\n    }\r\n\r\n    // Get available question count - use skill bucket code as fallback\r\n    const roleTypeForQuestions =\r\n      template.selectionRoleType || template.SkillBucket?.[0]?.code;\r\n    const questionCount = await this.getAvailableQuestionCount(\r\n      roleTypeForQuestions,\r\n      template.selectionTags,\r\n    );\r\n\r\n    return {\r\n      ...template,\r\n      availableQuestionBank: questionCount,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Update a template\r\n   */\r\n  async updateTemplate(id: string, dto: UpdateTestTemplateDto) {\r\n    await this.getTemplateById(id); // Verify exists\r\n\r\n    return this.prisma.testTemplate.update({\r\n      where: { id },\r\n      data: dto as any,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Delete a template (soft delete)\r\n   */\r\n  async deleteTemplate(id: string) {\r\n    const template = await this.getTemplateById(id);\r\n\r\n    // Check if assigned to any skill bucket\r\n    if (template.SkillBucket && template.SkillBucket.length > 0) {\r\n      throw new BadRequestException(\r\n        'Cannot delete template that is assigned to skill buckets. Unassign first.',\r\n      );\r\n    }\r\n\r\n    return this.prisma.testTemplate.update({\r\n      where: { id },\r\n      data: { isActive: false },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Assign template to a skill bucket\r\n   */\r\n  async assignToSkillBucket(templateId: string, dto: AssignTemplateDto) {\r\n    const template = await this.getTemplateById(templateId);\r\n\r\n    // Check if skill bucket exists\r\n    const skillBucket = await this.prisma.skillBucket.findUnique({\r\n      where: { id: dto.skillBucketId },\r\n    });\r\n\r\n    if (!skillBucket) {\r\n      throw new NotFoundException('Skill bucket not found');\r\n    }\r\n\r\n    // Update skill bucket to link to this template\r\n    await this.prisma.skillBucket.update({\r\n      where: { id: dto.skillBucketId },\r\n      data: { testTemplateId: templateId },\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      message: `Template \"${template.name}\" assigned to skill bucket \"${skillBucket.name}\"`,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Unassign template from a skill bucket\r\n   */\r\n  async unassignFromSkillBucket(skillBucketId: string) {\r\n    const skillBucket = await this.prisma.skillBucket.findUnique({\r\n      where: { id: skillBucketId },\r\n    });\r\n\r\n    if (!skillBucket) {\r\n      throw new NotFoundException('Skill bucket not found');\r\n    }\r\n\r\n    await this.prisma.skillBucket.update({\r\n      where: { id: skillBucketId },\r\n      data: { testTemplateId: null },\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      message: `Template unassigned from skill bucket \"${skillBucket.name}\"`,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get available question count for a template's selection criteria\r\n   */\r\n  private async getAvailableQuestionCount(\r\n    roleType?: string | null,\r\n    tags?: string[],\r\n  ): Promise<number> {\r\n    const where: any = { isActive: true };\r\n    if (roleType) where.roleType = roleType;\r\n    if (tags && tags.length > 0) {\r\n      where.tags = { hasSome: tags };\r\n    }\r\n\r\n    return this.prisma.questionBank.count({ where });\r\n  }\r\n\r\n  /**\r\n   * Preview questions that would be selected for a template\r\n   */\r\n  async previewQuestions(templateId: string, count: number = 10) {\r\n    const template = await this.getTemplateById(templateId);\r\n\r\n    const where: any = { isActive: true };\r\n    if (template.selectionRoleType) where.roleType = template.selectionRoleType;\r\n    if (template.selectionTags && template.selectionTags.length > 0) {\r\n      where.tags = { hasSome: template.selectionTags };\r\n    }\r\n\r\n    const questions = await this.prisma.questionBank.findMany({\r\n      where,\r\n      take: count,\r\n      orderBy: { createdAt: 'desc' },\r\n      select: {\r\n        id: true,\r\n        question: true,\r\n        difficulty: true,\r\n        category: true,\r\n        tags: true,\r\n      },\r\n    });\r\n\r\n    return questions;\r\n  }\r\n}\r\n"],"names":["TestTemplateService","createTemplate","dto","autoSelect","questionCount","getAvailableQuestionCount","selectionRoleType","selectionTags","questionPoolSize","BadRequestException","prisma","testTemplate","create","data","id","crypto","randomUUID","name","description","testType","duration","passingCriteria","allowSkip","showLiveScore","updatedAt","Date","getTemplates","filters","page","limit","isActive","skip","where","undefined","templates","total","Promise","all","findMany","take","orderBy","createdAt","include","SkillBucket","select","code","_count","TestSession","count","pagination","totalPages","Math","ceil","getTemplateById","template","findUnique","NotFoundException","roleTypeForQuestions","availableQuestionBank","updateTemplate","update","deleteTemplate","length","assignToSkillBucket","templateId","skillBucket","skillBucketId","testTemplateId","success","message","unassignFromSkillBucket","roleType","tags","hasSome","questionBank","previewQuestions","questions","question","difficulty","category"],"mappings":";;;;+BAeaA;;;eAAAA;;;wBAXN;gEACiB;+BACM;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AASvB,IAAA,AAAMA,sBAAN,MAAMA;IAGX;;GAEC,GACD,MAAMC,eAAeC,GAA0B,EAAE;QAC/C,0DAA0D;QAC1D,IAAIA,IAAIC,UAAU,EAAE;YAClB,MAAMC,gBAAgB,MAAM,IAAI,CAACC,yBAAyB,CACxDH,IAAII,iBAAiB,EACrBJ,IAAIK,aAAa;YAGnB,IAAIH,gBAAgBF,IAAIM,gBAAgB,EAAE;gBACxC,MAAM,IAAIC,2BAAmB,CAC3B,CAAC,sCAAsC,EAAEL,cAAc,OAAO,EAAEF,IAAIM,gBAAgB,EAAE;YAE1F;QACF;QAEA,OAAO,IAAI,CAACE,MAAM,CAACC,YAAY,CAACC,MAAM,CAAC;YACrCC,MAAM;gBACJC,IAAIC,QAAOC,UAAU;gBACrBC,MAAMf,IAAIe,IAAI;gBACdC,aAAahB,IAAIgB,WAAW;gBAC5BC,UAAUjB,IAAIiB,QAAQ;gBACtBC,UAAUlB,IAAIkB,QAAQ;gBACtBC,iBAAiBnB,IAAImB,eAAe;gBACpCb,kBAAkBN,IAAIM,gBAAgB;gBACtCL,YAAYD,IAAIC,UAAU;gBAC1BI,eAAeL,IAAIK,aAAa,IAAI,EAAE;gBACtCD,mBAAmBJ,IAAII,iBAAiB;gBACxCgB,WAAWpB,IAAIoB,SAAS,IAAI;gBAC5BC,eAAerB,IAAIqB,aAAa,IAAI;gBACpCC,WAAW,IAAIC;YACjB;QACF;IACF;IAEA;;GAEC,GACD,MAAMC,aAAaC,OAA2B,EAAE;QAC9C,MAAM,EAAEC,OAAO,CAAC,EAAEC,QAAQ,EAAE,EAAEV,QAAQ,EAAEW,QAAQ,EAAE,GAAGH;QACrD,MAAMI,OAAO,AAACH,CAAAA,OAAO,CAAA,IAAKC;QAE1B,MAAMG,QAAa,CAAC;QACpB,IAAIb,UAAUa,MAAMb,QAAQ,GAAGA;QAC/B,IAAIW,aAAaG,WAAWD,MAAMF,QAAQ,GAAGA;QAE7C,MAAM,CAACI,WAAWC,MAAM,GAAG,MAAMC,QAAQC,GAAG,CAAC;YAC3C,IAAI,CAAC3B,MAAM,CAACC,YAAY,CAAC2B,QAAQ,CAAC;gBAChCN;gBACAD;gBACAQ,MAAMV;gBACNW,SAAS;oBAAEC,WAAW;gBAAO;gBAC7BC,SAAS;oBACPC,aAAa;wBACXC,QAAQ;4BAAE9B,IAAI;4BAAM+B,MAAM;4BAAM5B,MAAM;wBAAK;oBAC7C;oBACA6B,QAAQ;wBACNF,QAAQ;4BAAEG,aAAa;wBAAK;oBAC9B;gBACF;YACF;YACA,IAAI,CAACrC,MAAM,CAACC,YAAY,CAACqC,KAAK,CAAC;gBAAEhB;YAAM;SACxC;QAED,OAAO;YACLE;YACAe,YAAY;gBACVrB;gBACAC;gBACAM;gBACAe,YAAYC,KAAKC,IAAI,CAACjB,QAAQN;YAChC;QACF;IACF;IAEA;;GAEC,GACD,MAAMwB,gBAAgBvC,EAAU,EAAE;QAChC,MAAMwC,WAAW,MAAM,IAAI,CAAC5C,MAAM,CAACC,YAAY,CAAC4C,UAAU,CAAC;YACzDvB,OAAO;gBAAElB;YAAG;YACZ4B,SAAS;gBACPC,aAAa;oBACXC,QAAQ;wBAAE9B,IAAI;wBAAM+B,MAAM;wBAAM5B,MAAM;oBAAK;gBAC7C;YACF;QACF;QAEA,IAAI,CAACqC,UAAU;YACb,MAAM,IAAIE,yBAAiB,CAAC;QAC9B;QAEA,mEAAmE;QACnE,MAAMC,uBACJH,SAAShD,iBAAiB,IAAIgD,SAASX,WAAW,EAAE,CAAC,EAAE,EAAEE;QAC3D,MAAMzC,gBAAgB,MAAM,IAAI,CAACC,yBAAyB,CACxDoD,sBACAH,SAAS/C,aAAa;QAGxB,OAAO;YACL,GAAG+C,QAAQ;YACXI,uBAAuBtD;QACzB;IACF;IAEA;;GAEC,GACD,MAAMuD,eAAe7C,EAAU,EAAEZ,GAA0B,EAAE;QAC3D,MAAM,IAAI,CAACmD,eAAe,CAACvC,KAAK,gBAAgB;QAEhD,OAAO,IAAI,CAACJ,MAAM,CAACC,YAAY,CAACiD,MAAM,CAAC;YACrC5B,OAAO;gBAAElB;YAAG;YACZD,MAAMX;QACR;IACF;IAEA;;GAEC,GACD,MAAM2D,eAAe/C,EAAU,EAAE;QAC/B,MAAMwC,WAAW,MAAM,IAAI,CAACD,eAAe,CAACvC;QAE5C,wCAAwC;QACxC,IAAIwC,SAASX,WAAW,IAAIW,SAASX,WAAW,CAACmB,MAAM,GAAG,GAAG;YAC3D,MAAM,IAAIrD,2BAAmB,CAC3B;QAEJ;QAEA,OAAO,IAAI,CAACC,MAAM,CAACC,YAAY,CAACiD,MAAM,CAAC;YACrC5B,OAAO;gBAAElB;YAAG;YACZD,MAAM;gBAAEiB,UAAU;YAAM;QAC1B;IACF;IAEA;;GAEC,GACD,MAAMiC,oBAAoBC,UAAkB,EAAE9D,GAAsB,EAAE;QACpE,MAAMoD,WAAW,MAAM,IAAI,CAACD,eAAe,CAACW;QAE5C,+BAA+B;QAC/B,MAAMC,cAAc,MAAM,IAAI,CAACvD,MAAM,CAACuD,WAAW,CAACV,UAAU,CAAC;YAC3DvB,OAAO;gBAAElB,IAAIZ,IAAIgE,aAAa;YAAC;QACjC;QAEA,IAAI,CAACD,aAAa;YAChB,MAAM,IAAIT,yBAAiB,CAAC;QAC9B;QAEA,+CAA+C;QAC/C,MAAM,IAAI,CAAC9C,MAAM,CAACuD,WAAW,CAACL,MAAM,CAAC;YACnC5B,OAAO;gBAAElB,IAAIZ,IAAIgE,aAAa;YAAC;YAC/BrD,MAAM;gBAAEsD,gBAAgBH;YAAW;QACrC;QAEA,OAAO;YACLI,SAAS;YACTC,SAAS,CAAC,UAAU,EAAEf,SAASrC,IAAI,CAAC,4BAA4B,EAAEgD,YAAYhD,IAAI,CAAC,CAAC,CAAC;QACvF;IACF;IAEA;;GAEC,GACD,MAAMqD,wBAAwBJ,aAAqB,EAAE;QACnD,MAAMD,cAAc,MAAM,IAAI,CAACvD,MAAM,CAACuD,WAAW,CAACV,UAAU,CAAC;YAC3DvB,OAAO;gBAAElB,IAAIoD;YAAc;QAC7B;QAEA,IAAI,CAACD,aAAa;YAChB,MAAM,IAAIT,yBAAiB,CAAC;QAC9B;QAEA,MAAM,IAAI,CAAC9C,MAAM,CAACuD,WAAW,CAACL,MAAM,CAAC;YACnC5B,OAAO;gBAAElB,IAAIoD;YAAc;YAC3BrD,MAAM;gBAAEsD,gBAAgB;YAAK;QAC/B;QAEA,OAAO;YACLC,SAAS;YACTC,SAAS,CAAC,uCAAuC,EAAEJ,YAAYhD,IAAI,CAAC,CAAC,CAAC;QACxE;IACF;IAEA;;GAEC,GACD,MAAcZ,0BACZkE,QAAwB,EACxBC,IAAe,EACE;QACjB,MAAMxC,QAAa;YAAEF,UAAU;QAAK;QACpC,IAAIyC,UAAUvC,MAAMuC,QAAQ,GAAGA;QAC/B,IAAIC,QAAQA,KAAKV,MAAM,GAAG,GAAG;YAC3B9B,MAAMwC,IAAI,GAAG;gBAAEC,SAASD;YAAK;QAC/B;QAEA,OAAO,IAAI,CAAC9D,MAAM,CAACgE,YAAY,CAAC1B,KAAK,CAAC;YAAEhB;QAAM;IAChD;IAEA;;GAEC,GACD,MAAM2C,iBAAiBX,UAAkB,EAAEhB,QAAgB,EAAE,EAAE;QAC7D,MAAMM,WAAW,MAAM,IAAI,CAACD,eAAe,CAACW;QAE5C,MAAMhC,QAAa;YAAEF,UAAU;QAAK;QACpC,IAAIwB,SAAShD,iBAAiB,EAAE0B,MAAMuC,QAAQ,GAAGjB,SAAShD,iBAAiB;QAC3E,IAAIgD,SAAS/C,aAAa,IAAI+C,SAAS/C,aAAa,CAACuD,MAAM,GAAG,GAAG;YAC/D9B,MAAMwC,IAAI,GAAG;gBAAEC,SAASnB,SAAS/C,aAAa;YAAC;QACjD;QAEA,MAAMqE,YAAY,MAAM,IAAI,CAAClE,MAAM,CAACgE,YAAY,CAACpC,QAAQ,CAAC;YACxDN;YACAO,MAAMS;YACNR,SAAS;gBAAEC,WAAW;YAAO;YAC7BG,QAAQ;gBACN9B,IAAI;gBACJ+D,UAAU;gBACVC,YAAY;gBACZC,UAAU;gBACVP,MAAM;YACR;QACF;QAEA,OAAOI;IACT;IAzOA,YAAY,AAAQlE,MAAqB,CAAE;aAAvBA,SAAAA;IAAyB;AA0O/C"}