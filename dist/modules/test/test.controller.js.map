{"version":3,"sources":["../../../src/modules/test/test.controller.ts"],"sourcesContent":["import { Controller, Get, Post, Patch, Body, Param } from '@nestjs/common';\r\nimport { TestService } from './test.service';\r\nimport {\r\n  CreateTestDto,\r\n  CreateRoleTestDto,\r\n  UpdateTestDto,\r\n  AddQuestionDto,\r\n  SubmitAnswerDto,\r\n  TestEventDto,\r\n} from './dto';\r\nimport { CurrentUser, Roles } from '../../common/decorators';\r\nimport { UserRole } from '../../common/constants';\r\n\r\n@Controller('tests')\r\nexport class TestController {\r\n  constructor(private readonly testService: TestService) {}\r\n\r\n  // ===========================================\r\n  // ADMIN: Test Management\r\n  // ===========================================\r\n\r\n  @Post()\r\n  @Roles(UserRole.ADMIN)\r\n  async createTest(@Body() dto: CreateTestDto) {\r\n    return this.testService.createTest(dto);\r\n  }\r\n\r\n  // ===========================================\r\n  // ADMIN: Role-Based Test Management\r\n  // IMPORTANT: These specific routes MUST come before :testId param route\r\n  // ===========================================\r\n\r\n  @Post('role-tests')\r\n  @Roles(UserRole.ADMIN)\r\n  async createRoleTest(@Body() dto: CreateRoleTestDto) {\r\n    return this.testService.createRoleTest(dto);\r\n  }\r\n\r\n  @Get('role-tests/all')\r\n  @Roles(UserRole.ADMIN)\r\n  async getAllRoleTests() {\r\n    return this.testService.getAllRoleTests();\r\n  }\r\n\r\n  @Get('role-tests/skill-bucket/:skillBucketId')\r\n  @Roles(UserRole.ADMIN)\r\n  async getTestBySkillBucket(@Param('skillBucketId') skillBucketId: string) {\r\n    return this.testService.getTestBySkillBucket(skillBucketId);\r\n  }\r\n\r\n  // ===========================================\r\n  // CANDIDATE: Test Eligibility\r\n  // IMPORTANT: This must come before :testId param route\r\n  // ===========================================\r\n\r\n  @Get('eligibility/:jobId')\r\n  @Roles(UserRole.CANDIDATE)\r\n  async checkTestEligibility(\r\n    @Param('jobId') jobId: string,\r\n    @CurrentUser('sub') userId: string,\r\n  ) {\r\n    // Get candidate ID from user ID\r\n    const candidate = await this.testService['prisma'].candidate.findUnique({\r\n      where: { userId },\r\n    });\r\n    if (!candidate) {\r\n      return {\r\n        eligible: false,\r\n        reason: 'NO_PROFILE',\r\n        message: 'Candidate profile not found',\r\n      };\r\n    }\r\n    return this.testService.getTestEligibility(candidate.id, jobId);\r\n  }\r\n\r\n  // ===========================================\r\n  // CANDIDATE: Test Taking\r\n  // IMPORTANT: These specific routes must come before :testId param route\r\n  // ===========================================\r\n\r\n  @Post('application/:applicationId/start')\r\n  @Roles(UserRole.CANDIDATE)\r\n  async startTest(\r\n    @Param('applicationId') applicationId: string,\r\n    @CurrentUser('sub') userId: string,\r\n  ) {\r\n    return this.testService.startTest(applicationId, userId);\r\n  }\r\n\r\n  @Get('session/:sessionId')\r\n  @Roles(UserRole.CANDIDATE)\r\n  async getSession(\r\n    @Param('sessionId') sessionId: string,\r\n    @CurrentUser('sub') userId: string,\r\n  ) {\r\n    return this.testService.getTestSession(sessionId, userId);\r\n  }\r\n\r\n  @Post('session/:sessionId/answer')\r\n  @Roles(UserRole.CANDIDATE)\r\n  async submitAnswer(\r\n    @Param('sessionId') sessionId: string,\r\n    @CurrentUser('sub') userId: string,\r\n    @Body() dto: SubmitAnswerDto,\r\n  ) {\r\n    return this.testService.submitAnswer(sessionId, userId, dto);\r\n  }\r\n\r\n  @Post('session/:sessionId/submit')\r\n  @Roles(UserRole.CANDIDATE)\r\n  async submitTest(\r\n    @Param('sessionId') sessionId: string,\r\n    @CurrentUser('sub') userId: string,\r\n  ) {\r\n    return this.testService.submitTest(sessionId, userId);\r\n  }\r\n\r\n  @Post('session/:sessionId/event')\r\n  @Roles(UserRole.CANDIDATE)\r\n  async logEvent(\r\n    @Param('sessionId') sessionId: string,\r\n    @CurrentUser('sub') userId: string,\r\n    @Body() dto: TestEventDto,\r\n  ) {\r\n    return this.testService.logTestEvent(sessionId, userId, dto);\r\n  }\r\n\r\n  // ===========================================\r\n  // PARAMETERIZED ROUTES - Must be LAST\r\n  // These catch-all param routes must come after all specific routes\r\n  // ===========================================\r\n\r\n  @Post(':testId/questions')\r\n  @Roles(UserRole.ADMIN)\r\n  async addQuestion(\r\n    @Param('testId') testId: string,\r\n    @Body() dto: AddQuestionDto,\r\n  ) {\r\n    return this.testService.addQuestion(testId, dto);\r\n  }\r\n\r\n  @Get(':testId')\r\n  @Roles(UserRole.ADMIN)\r\n  async getTest(@Param('testId') testId: string) {\r\n    return this.testService.getTestById(testId);\r\n  }\r\n\r\n  @Patch(':testId')\r\n  @Roles(UserRole.ADMIN)\r\n  async updateTest(\r\n    @Param('testId') testId: string,\r\n    @Body() dto: UpdateTestDto,\r\n  ) {\r\n    return this.testService.updateTest(testId, dto);\r\n  }\r\n\r\n  @Patch(':testId/activate')\r\n  @Roles(UserRole.ADMIN)\r\n  async activateTest(@Param('testId') testId: string) {\r\n    return this.testService.activateTest(testId);\r\n  }\r\n\r\n  @Patch(':testId/deactivate')\r\n  @Roles(UserRole.ADMIN)\r\n  async deactivateTest(@Param('testId') testId: string) {\r\n    return this.testService.deactivateTest(testId);\r\n  }\r\n}\r\n"],"names":["TestController","createTest","dto","testService","createRoleTest","getAllRoleTests","getTestBySkillBucket","skillBucketId","checkTestEligibility","jobId","userId","candidate","findUnique","where","eligible","reason","message","getTestEligibility","id","startTest","applicationId","getSession","sessionId","getTestSession","submitAnswer","submitTest","logEvent","logTestEvent","addQuestion","testId","getTest","getTestById","updateTest","activateTest","deactivateTest","ADMIN","CANDIDATE"],"mappings":"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"}