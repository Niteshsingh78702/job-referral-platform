{"version":3,"sources":["../../../src/modules/test/test.controller.ts"],"sourcesContent":["import {\r\n    Controller,\r\n    Get,\r\n    Post,\r\n    Patch,\r\n    Body,\r\n    Param,\r\n} from '@nestjs/common';\r\nimport { TestService } from './test.service';\r\nimport { CreateTestDto, CreateRoleTestDto, UpdateTestDto, AddQuestionDto, SubmitAnswerDto, TestEventDto } from './dto';\r\nimport { CurrentUser, Roles } from '../../common/decorators';\r\nimport { UserRole } from '../../common/constants';\r\n\r\n@Controller('tests')\r\nexport class TestController {\r\n    constructor(private readonly testService: TestService) { }\r\n\r\n    // ===========================================\r\n    // ADMIN: Test Management\r\n    // ===========================================\r\n\r\n    @Post()\r\n    @Roles(UserRole.ADMIN)\r\n    async createTest(@Body() dto: CreateTestDto) {\r\n        return this.testService.createTest(dto);\r\n    }\r\n\r\n    // ===========================================\r\n    // ADMIN: Role-Based Test Management\r\n    // IMPORTANT: These specific routes MUST come before :testId param route\r\n    // ===========================================\r\n\r\n    @Post('role-tests')\r\n    @Roles(UserRole.ADMIN)\r\n    async createRoleTest(@Body() dto: CreateRoleTestDto) {\r\n        return this.testService.createRoleTest(dto);\r\n    }\r\n\r\n    @Get('role-tests/all')\r\n    @Roles(UserRole.ADMIN)\r\n    async getAllRoleTests() {\r\n        return this.testService.getAllRoleTests();\r\n    }\r\n\r\n    @Get('role-tests/skill-bucket/:skillBucketId')\r\n    @Roles(UserRole.ADMIN)\r\n    async getTestBySkillBucket(@Param('skillBucketId') skillBucketId: string) {\r\n        return this.testService.getTestBySkillBucket(skillBucketId);\r\n    }\r\n\r\n    // ===========================================\r\n    // CANDIDATE: Test Eligibility\r\n    // IMPORTANT: This must come before :testId param route\r\n    // ===========================================\r\n\r\n    @Get('eligibility/:jobId')\r\n    @Roles(UserRole.CANDIDATE)\r\n    async checkTestEligibility(\r\n        @Param('jobId') jobId: string,\r\n        @CurrentUser('sub') userId: string,\r\n    ) {\r\n        // Get candidate ID from user ID\r\n        const candidate = await this.testService['prisma'].candidate.findUnique({\r\n            where: { userId },\r\n        });\r\n        if (!candidate) {\r\n            return { eligible: false, reason: 'NO_PROFILE', message: 'Candidate profile not found' };\r\n        }\r\n        return this.testService.getTestEligibility(candidate.id, jobId);\r\n    }\r\n\r\n    // ===========================================\r\n    // CANDIDATE: Test Taking\r\n    // IMPORTANT: These specific routes must come before :testId param route\r\n    // ===========================================\r\n\r\n    @Post('application/:applicationId/start')\r\n    @Roles(UserRole.CANDIDATE)\r\n    async startTest(\r\n        @Param('applicationId') applicationId: string,\r\n        @CurrentUser('sub') userId: string,\r\n    ) {\r\n        return this.testService.startTest(applicationId, userId);\r\n    }\r\n\r\n    @Get('session/:sessionId')\r\n    @Roles(UserRole.CANDIDATE)\r\n    async getSession(\r\n        @Param('sessionId') sessionId: string,\r\n        @CurrentUser('sub') userId: string,\r\n    ) {\r\n        return this.testService.getTestSession(sessionId, userId);\r\n    }\r\n\r\n    @Post('session/:sessionId/answer')\r\n    @Roles(UserRole.CANDIDATE)\r\n    async submitAnswer(\r\n        @Param('sessionId') sessionId: string,\r\n        @CurrentUser('sub') userId: string,\r\n        @Body() dto: SubmitAnswerDto,\r\n    ) {\r\n        return this.testService.submitAnswer(sessionId, userId, dto);\r\n    }\r\n\r\n    @Post('session/:sessionId/submit')\r\n    @Roles(UserRole.CANDIDATE)\r\n    async submitTest(\r\n        @Param('sessionId') sessionId: string,\r\n        @CurrentUser('sub') userId: string,\r\n    ) {\r\n        return this.testService.submitTest(sessionId, userId);\r\n    }\r\n\r\n    @Post('session/:sessionId/event')\r\n    @Roles(UserRole.CANDIDATE)\r\n    async logEvent(\r\n        @Param('sessionId') sessionId: string,\r\n        @CurrentUser('sub') userId: string,\r\n        @Body() dto: TestEventDto,\r\n    ) {\r\n        return this.testService.logTestEvent(sessionId, userId, dto);\r\n    }\r\n\r\n    // ===========================================\r\n    // PARAMETERIZED ROUTES - Must be LAST\r\n    // These catch-all param routes must come after all specific routes\r\n    // ===========================================\r\n\r\n    @Post(':testId/questions')\r\n    @Roles(UserRole.ADMIN)\r\n    async addQuestion(\r\n        @Param('testId') testId: string,\r\n        @Body() dto: AddQuestionDto,\r\n    ) {\r\n        return this.testService.addQuestion(testId, dto);\r\n    }\r\n\r\n    @Get(':testId')\r\n    @Roles(UserRole.ADMIN)\r\n    async getTest(@Param('testId') testId: string) {\r\n        return this.testService.getTestById(testId);\r\n    }\r\n\r\n    @Patch(':testId')\r\n    @Roles(UserRole.ADMIN)\r\n    async updateTest(\r\n        @Param('testId') testId: string,\r\n        @Body() dto: UpdateTestDto,\r\n    ) {\r\n        return this.testService.updateTest(testId, dto);\r\n    }\r\n\r\n    @Patch(':testId/activate')\r\n    @Roles(UserRole.ADMIN)\r\n    async activateTest(@Param('testId') testId: string) {\r\n        return this.testService.activateTest(testId);\r\n    }\r\n\r\n    @Patch(':testId/deactivate')\r\n    @Roles(UserRole.ADMIN)\r\n    async deactivateTest(@Param('testId') testId: string) {\r\n        return this.testService.deactivateTest(testId);\r\n    }\r\n}\r\n"],"names":["TestController","createTest","dto","testService","createRoleTest","getAllRoleTests","getTestBySkillBucket","skillBucketId","checkTestEligibility","jobId","userId","candidate","findUnique","where","eligible","reason","message","getTestEligibility","id","startTest","applicationId","getSession","sessionId","getTestSession","submitAnswer","submitTest","logEvent","logTestEvent","addQuestion","testId","getTest","getTestById","updateTest","activateTest","deactivateTest","ADMIN","CANDIDATE"],"mappings":"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"}