{"version":3,"sources":["../../src/prisma/prisma.service.ts"],"sourcesContent":["import { Injectable, OnModuleInit, OnModuleDestroy, Logger } from '@nestjs/common';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\n@Injectable()\r\nexport class PrismaService\r\n    extends PrismaClient\r\n    implements OnModuleInit, OnModuleDestroy {\r\n\r\n    private readonly logger = new Logger(PrismaService.name);\r\n\r\n    constructor() {\r\n        super({\r\n            log: process.env.NODE_ENV === 'development'\r\n                ? ['query', 'info', 'warn', 'error']\r\n                : ['error'],\r\n        });\r\n\r\n        this.logger.log('PrismaService initialized');\r\n    }\r\n\r\n    async onModuleInit() {\r\n        await this.connectWithRetry();\r\n    }\r\n\r\n    private async connectWithRetry(maxRetries = 5): Promise<void> {\r\n        for (let attempt = 1; attempt <= maxRetries; attempt++) {\r\n            try {\r\n                this.logger.log(`Connecting to database (attempt ${attempt}/${maxRetries})...`);\r\n                await this.$connect();\r\n\r\n                // Warm up the connection with a simple query\r\n                await this.$queryRaw`SELECT 1`;\r\n\r\n                this.logger.log('Successfully connected to database');\r\n                return;\r\n            } catch (error) {\r\n                this.logger.warn(`Connection attempt ${attempt} failed: ${(error as Error).message}`);\r\n\r\n                if (attempt === maxRetries) {\r\n                    this.logger.error('Failed to connect to database after all retries:', error);\r\n                    throw error;\r\n                }\r\n\r\n                // Exponential backoff: 1s, 2s, 4s, 8s, 16s\r\n                const delay = Math.min(1000 * Math.pow(2, attempt - 1), 16000);\r\n                this.logger.log(`Retrying in ${delay / 1000}s...`);\r\n                await new Promise(resolve => setTimeout(resolve, delay));\r\n            }\r\n        }\r\n    }\r\n\r\n    // Reconnect if connection is lost (handles Neon cold starts)\r\n    async ensureConnection(): Promise<void> {\r\n        try {\r\n            await this.$queryRaw`SELECT 1`;\r\n        } catch {\r\n            this.logger.warn('Connection lost, reconnecting...');\r\n            await this.connectWithRetry(3);\r\n        }\r\n    }\r\n\r\n    async onModuleDestroy() {\r\n        await this.$disconnect();\r\n    }\r\n\r\n    // Helper for transactions with retry\r\n    async executeInTransaction<T>(\r\n        fn: (prisma: Omit<PrismaClient, '$connect' | '$disconnect' | '$on' | '$transaction' | '$use' | '$extends'>) => Promise<T>,\r\n        maxRetries = 3,\r\n    ): Promise<T> {\r\n        let lastError: Error | undefined;\r\n\r\n        for (let attempt = 1; attempt <= maxRetries; attempt++) {\r\n            try {\r\n                return await this.$transaction(fn, {\r\n                    maxWait: 30000,\r\n                    timeout: 30000,\r\n                });\r\n            } catch (error) {\r\n                lastError = error as Error;\r\n                this.logger.warn(`Transaction attempt ${attempt} failed: ${(error as Error).message}`);\r\n\r\n                if (attempt < maxRetries) {\r\n                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));\r\n                }\r\n            }\r\n        }\r\n\r\n        throw lastError;\r\n    }\r\n}\r\n"],"names":["PrismaService","PrismaClient","onModuleInit","connectWithRetry","maxRetries","attempt","logger","log","$connect","$queryRaw","error","warn","message","delay","Math","min","pow","Promise","resolve","setTimeout","ensureConnection","onModuleDestroy","$disconnect","executeInTransaction","fn","lastError","$transaction","maxWait","timeout","process","env","NODE_ENV","Logger","name"],"mappings":";;;;+BAIaA;;;eAAAA;;;wBAJqD;wBACrC;;;;;;;;;;AAGtB,IAAA,AAAMA,gBAAN,MAAMA,sBACDC,oBAAY;IAepB,MAAMC,eAAe;QACjB,MAAM,IAAI,CAACC,gBAAgB;IAC/B;IAEA,MAAcA,iBAAiBC,aAAa,CAAC,EAAiB;QAC1D,IAAK,IAAIC,UAAU,GAAGA,WAAWD,YAAYC,UAAW;YACpD,IAAI;gBACA,IAAI,CAACC,MAAM,CAACC,GAAG,CAAC,CAAC,gCAAgC,EAAEF,QAAQ,CAAC,EAAED,WAAW,IAAI,CAAC;gBAC9E,MAAM,IAAI,CAACI,QAAQ;gBAEnB,6CAA6C;gBAC7C,MAAM,IAAI,CAACC,SAAS,CAAC,QAAQ,CAAC;gBAE9B,IAAI,CAACH,MAAM,CAACC,GAAG,CAAC;gBAChB;YACJ,EAAE,OAAOG,OAAO;gBACZ,IAAI,CAACJ,MAAM,CAACK,IAAI,CAAC,CAAC,mBAAmB,EAAEN,QAAQ,SAAS,EAAE,AAACK,MAAgBE,OAAO,EAAE;gBAEpF,IAAIP,YAAYD,YAAY;oBACxB,IAAI,CAACE,MAAM,CAACI,KAAK,CAAC,oDAAoDA;oBACtE,MAAMA;gBACV;gBAEA,2CAA2C;gBAC3C,MAAMG,QAAQC,KAAKC,GAAG,CAAC,OAAOD,KAAKE,GAAG,CAAC,GAAGX,UAAU,IAAI;gBACxD,IAAI,CAACC,MAAM,CAACC,GAAG,CAAC,CAAC,YAAY,EAAEM,QAAQ,KAAK,IAAI,CAAC;gBACjD,MAAM,IAAII,QAAQC,CAAAA,UAAWC,WAAWD,SAASL;YACrD;QACJ;IACJ;IAEA,6DAA6D;IAC7D,MAAMO,mBAAkC;QACpC,IAAI;YACA,MAAM,IAAI,CAACX,SAAS,CAAC,QAAQ,CAAC;QAClC,EAAE,OAAM;YACJ,IAAI,CAACH,MAAM,CAACK,IAAI,CAAC;YACjB,MAAM,IAAI,CAACR,gBAAgB,CAAC;QAChC;IACJ;IAEA,MAAMkB,kBAAkB;QACpB,MAAM,IAAI,CAACC,WAAW;IAC1B;IAEA,qCAAqC;IACrC,MAAMC,qBACFC,EAAyH,EACzHpB,aAAa,CAAC,EACJ;QACV,IAAIqB;QAEJ,IAAK,IAAIpB,UAAU,GAAGA,WAAWD,YAAYC,UAAW;YACpD,IAAI;gBACA,OAAO,MAAM,IAAI,CAACqB,YAAY,CAACF,IAAI;oBAC/BG,SAAS;oBACTC,SAAS;gBACb;YACJ,EAAE,OAAOlB,OAAO;gBACZe,YAAYf;gBACZ,IAAI,CAACJ,MAAM,CAACK,IAAI,CAAC,CAAC,oBAAoB,EAAEN,QAAQ,SAAS,EAAE,AAACK,MAAgBE,OAAO,EAAE;gBAErF,IAAIP,UAAUD,YAAY;oBACtB,MAAM,IAAIa,QAAQC,CAAAA,UAAWC,WAAWD,SAAS,OAAOb;gBAC5D;YACJ;QACJ;QAEA,MAAMoB;IACV;IA/EA,aAAc;QACV,KAAK,CAAC;YACFlB,KAAKsB,QAAQC,GAAG,CAACC,QAAQ,KAAK,gBACxB;gBAAC;gBAAS;gBAAQ;gBAAQ;aAAQ,GAClC;gBAAC;aAAQ;QACnB,SAPazB,SAAS,IAAI0B,cAAM,CAAChC,cAAciC,IAAI;QASnD,IAAI,CAAC3B,MAAM,CAACC,GAAG,CAAC;IACpB;AAwEJ"}