<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5">
    <title>All Opportunities | NaukriShetu - Skill-Based Career Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="assets/images/fab.png">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>window.GOOGLE_CLIENT_ID = '29990959574-h0bekp3eu5rarn8ji69mlmogc845hm9p.apps.googleusercontent.com';</script>
    <style>
        @keyframes btnSpin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Jobs Page Specific Styles */
        .jobs-page-container {
            min-height: 100vh;
            padding-top: 100px;
        }

        .jobs-page-header {
            padding: 60px 0 30px;
            text-align: center;
        }

        .jobs-page-header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .jobs-page-header p {
            color: var(--text-secondary);
        }

        .jobs-count {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            margin-left: 8px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 40px 0;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 10px 16px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination button:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .pagination button.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .no-jobs-found {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .no-jobs-found .icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            margin-bottom: 20px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--primary);
        }

        .jobs-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .results-info {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Autocomplete Suggestions */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .search-suggestions.active {
            display: block;
        }

        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover,
        .suggestion-item.active {
            background: rgba(26, 115, 232, 0.08);
        }

        .suggestion-icon {
            font-size: 16px;
            opacity: 0.6;
        }

        .suggestion-text {
            flex: 1;
        }

        .suggestion-text .title {
            font-weight: 500;
            color: var(--text-primary);
        }

        .suggestion-text .subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .suggestion-count {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .suggestion-category {
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-darker);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .jobs-page-container {
                padding-top: 70px;
            }

            .jobs-page-header {
                padding: 24px 0 16px;
            }

            .jobs-page-header h1 {
                font-size: 1.5rem;
            }

            .nav-links {
                display: none;
            }

            .nav-auth {
                gap: 8px;
            }

            .nav-auth .btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .search-bar {
                padding: 16px;
            }

            .search-row {
                flex-direction: column;
                gap: 12px;
            }

            .search-input-wrapper {
                width: 100%;
            }

            .search-row .btn {
                width: 100%;
            }

            .filters-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .filter-select {
                width: 100%;
                min-width: unset;
                font-size: 13px;
                padding: 10px 12px;
                text-align: left;
                box-sizing: border-box;
            }

            .filters-row .btn-ghost {
                grid-column: 1 / -1;
                width: 100%;
                margin-top: 4px;
            }

            .jobs-grid {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }

            .job-card {
                padding: 16px;
            }

            .job-title {
                font-size: 16px;
            }

            .job-details {
                flex-wrap: wrap;
            }

            .job-footer {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .job-footer-left {
                flex-direction: column;
                gap: 4px;
            }

            .pagination {
                gap: 4px;
            }

            .pagination button {
                padding: 8px 12px;
                font-size: 12px;
            }

            .back-link {
                font-size: 14px;
            }

            /* Modal responsive */
            .modal {
                width: 95% !important;
                max-width: 95% !important;
                margin: 16px auto;
                max-height: calc(100vh - 32px);
            }

            .job-detail-header {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }

            .flow-steps-grid {
                flex-direction: column;
                align-items: center;
            }

            .flow-step-arrow {
                transform: rotate(90deg);
            }
        }

        @media (max-width: 480px) {
            .jobs-page-header h1 {
                font-size: 1.25rem;
            }

            .jobs-count {
                font-size: 12px;
                padding: 3px 8px;
            }

            .filter-select {
                flex: 1 1 100%;
            }

            .pagination button {
                padding: 6px 10px;
                font-size: 11px;
            }

            .company-logo {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .skill-tag {
                font-size: 11px;
                padding: 4px 8px;
            }
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="logo">
                <img src="assets/images/naukrishetu-logo.png" alt="NaukriShetu" class="logo-img">
            </a>
            <div class="nav-links">
                <a href="/" class="nav-link">Home</a>
                <a href="/#how-it-works" class="nav-link">How It Works</a>
                <a href="/#pricing" class="nav-link">Pricing</a>
            </div>
            <div class="nav-auth" id="navAuth">
                <button class="btn btn-outline" onclick="window.location.href='/'">Login</button>
                <button class="btn btn-primary" onclick="window.location.href='/'">Get Started</button>
            </div>
            <div class="nav-user" id="navUser" style="display: none;">
                <a href="/" class="nav-link">My Dashboard</a>
                <div class="profile-dropdown">
                    <button class="profile-btn" onclick="toggleProfileMenu()">
                        <span class="profile-avatar" id="userAvatar">U</span>
                        <span id="userName">User</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    <div class="profile-menu" id="profileMenu">
                        <a href="/#dashboard" class="menu-item">üìä Dashboard</a>
                        <a href="/#profile" class="menu-item">üë§ My Profile</a>
                        <a href="/#applications" class="menu-item">üìã Applications</a>
                        <a href="/#settings" class="menu-item">‚öôÔ∏è Settings</a>
                        <hr class="menu-divider">
                        <a href="#" onclick="logoutFromJobs()" class="menu-item menu-item-danger">üö™ Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Jobs Page Content -->
    <div class="jobs-page-container">
        <div class="container">
            <a href="/" class="back-link">‚Üê Back to Home</a>

            <div class="jobs-page-header">
                <h1>All Opportunities <span class="jobs-count" id="totalJobsCount">0</span></h1>
                <p>Find opportunities that match your skills. Apply for free.</p>
            </div>

            <!-- Search & Filters -->
            <div class="search-bar">
                <div class="search-row">
                    <div class="search-input-wrapper" style="position: relative;">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="jobSearch" placeholder="Search by title, company, or skills..."
                            class="search-input"
                            onkeypress="if(event.key==='Enter') { hideSuggestions(); searchJobs(); }"
                            oninput="showSuggestions(this.value)" onfocus="showSuggestions(this.value)"
                            autocomplete="off">
                        <div class="search-suggestions" id="searchSuggestions"></div>
                    </div>
                    <button class="btn btn-primary" onclick="searchJobs()">Search</button>
                    <button class="btn btn-outline saved-jobs-btn" onclick="toggleSavedJobsView()" id="savedJobsBtn">
                        ‚ù§Ô∏è Saved
                    </button>
                </div>
                <div class="filters-row">
                    <select id="locationFilter" class="filter-select" onchange="searchJobs()">
                        <option value="">All Locations</option>
                        <option value="bangalore">Bangalore</option>
                        <option value="mumbai">Mumbai</option>
                        <option value="delhi">Delhi NCR</option>
                        <option value="noida">Noida</option>
                        <option value="gurgaon">Gurgaon</option>
                        <option value="hyderabad">Hyderabad</option>
                        <option value="pune">Pune</option>
                        <option value="chennai">Chennai</option>
                        <option value="kolkata">Kolkata</option>
                        <option value="ahmedabad">Ahmedabad</option>
                        <option value="jaipur">Jaipur</option>
                        <option value="kochi">Kochi</option>
                        <option value="chandigarh">Chandigarh</option>
                        <option value="indore">Indore</option>
                        <option value="remote">Remote</option>
                    </select>
                    <select id="experienceFilter" class="filter-select" onchange="searchJobs()">
                        <option value="">Experience</option>
                        <option value="0-1">Fresher (0-1 yrs)</option>
                        <option value="1-2">1-2 years</option>
                        <option value="2-4">2-4 years</option>
                        <option value="4-6">4-6 years</option>
                        <option value="6-10">6-10 years</option>
                        <option value="10+">10+ years</option>
                    </select>
                    <select id="jobTypeFilter" class="filter-select" onchange="searchJobs()">
                        <option value="">Type</option>
                        <option value="fulltime">Full-time</option>
                        <option value="parttime">Part-time</option>
                        <option value="contract">Contract</option>
                        <option value="internship">Internship</option>
                    </select>
                    <select id="workModeFilter" class="filter-select" onchange="searchJobs()">
                        <option value="">Work Mode</option>
                        <option value="office">Office</option>
                        <option value="hybrid">Hybrid</option>
                        <option value="remote">Remote</option>
                    </select>
                    <select id="postedDateFilter" class="filter-select" onchange="searchJobs()">
                        <option value="">Posted Date</option>
                        <option value="24h">Last 24 hours</option>
                        <option value="week">Last Week</option>
                        <option value="month">Last Month</option>
                    </select>
                    <select id="sortBy" class="filter-select" onchange="searchJobs()">
                        <option value="relevance">Sort: Relevance</option>
                        <option value="date">Sort: Newest</option>
                        <option value="salary">Sort: Salary ‚Üì</option>
                    </select>
                    <button class="btn btn-ghost btn-sm" onclick="clearAllFilters()">Clear Filters</button>
                </div>
            </div>

            <!-- Jobs Stats -->
            <div class="jobs-stats">
                <span class="results-info" id="resultsInfo">Loading opportunities...</span>
            </div>

            <!-- Job Cards Grid -->
            <div class="jobs-grid" id="jobsGrid">
                <div class="loading-spinner" id="jobsLoading">
                    <div class="spinner"></div>
                    <p>Loading opportunities...</p>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <!-- Job Detail Modal -->
    <div class="modal-overlay" id="jobModalOverlay" onclick="closeJobModal()"></div>
    <div class="modal modal-lg job-detail-modal" id="jobDetailModal">
        <button class="modal-close" onclick="closeJobModal()">√ó</button>
        <div class="modal-content" id="jobDetailContent"></div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        const API_BASE_URL = '/api/v1';

        // State management
        const state = {
            jobs: [],
            allJobs: [],
            filteredJobs: [],
            currentPage: 1,
            jobsPerPage: 12,
            token: localStorage.getItem('token'),
            user: JSON.parse(localStorage.getItem('user') || 'null')
        };

        // Saved jobs from localStorage
        let savedJobs = JSON.parse(localStorage.getItem('savedJobs') || '[]');
        let showingSavedOnly = false;

        // Track which jobs user already applied to
        let appliedJobIds = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateNavAuth();
            loadJobs();
            parseURLFilters();
            loadAppliedJobs();
        });

        // Update navbar based on auth state
        function updateNavAuth() {
            if (state.token && state.user) {
                document.getElementById('navAuth').style.display = 'none';
                document.getElementById('navUser').style.display = 'flex';

                // Get display name using same logic as homepage
                let displayName = 'User';
                if (state.user.firstName) {
                    displayName = state.user.firstName;
                } else if (state.user.candidate?.firstName) {
                    displayName = state.user.candidate.firstName;
                } else if (state.user.name) {
                    displayName = state.user.name.split(' ')[0];
                } else if (state.user.fullName) {
                    displayName = state.user.fullName.split(' ')[0];
                } else if (state.user.email) {
                    displayName = state.user.email.split('@')[0];
                }

                const initial = displayName.charAt(0).toUpperCase();
                const userNameEl = document.getElementById('userName');
                const userAvatarEl = document.getElementById('userAvatar');
                if (userNameEl) userNameEl.textContent = displayName;
                if (userAvatarEl) userAvatarEl.textContent = initial;
            }
        }

        function toggleProfileMenu() {
            const menu = document.getElementById('profileMenu');
            if (menu) menu.classList.toggle('active');
        }

        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.profile-dropdown')) {
                document.getElementById('profileMenu')?.classList.remove('active');
            }
        });

        function logoutFromJobs() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // Load already-applied jobs from API
        async function loadAppliedJobs() {
            if (!state.token) return;
            try {
                const response = await fetch(`${API_BASE_URL}/candidates/applications`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                const data = await response.json();
                if (data.success && data.data) {
                    const apps = Array.isArray(data.data) ? data.data : (data.data.data || []);
                    appliedJobIds = apps.map(a => a.jobId || a.job?.id).filter(Boolean);
                    // Re-render to show updated button states
                    if (state.filteredJobs.length > 0) renderPaginatedJobs();
                }
            } catch (e) {
                console.log('Could not load applied jobs:', e);
            }
        }

        // Parse URL parameters for filters
        function parseURLFilters() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('search')) document.getElementById('jobSearch').value = params.get('search');
            if (params.get('location')) document.getElementById('locationFilter').value = params.get('location');
            if (params.get('experience')) document.getElementById('experienceFilter').value = params.get('experience');
        }

        // Load all jobs from API
        async function loadJobs() {
            try {
                const response = await fetch(`${API_BASE_URL}/jobs?limit=100`);
                const data = await response.json();

                let jobs = [];
                if (data.success && data.data) {
                    jobs = Array.isArray(data.data) ? data.data : (data.data.data || []);
                } else if (Array.isArray(data)) {
                    jobs = data;
                }

                state.allJobs = jobs;
                state.jobs = jobs;
                document.getElementById('totalJobsCount').textContent = jobs.length;
                document.getElementById('jobsLoading').style.display = 'none';

                searchJobs(); // Apply any URL filters
            } catch (error) {
                console.error('Error loading jobs:', error);
                document.getElementById('jobsLoading').innerHTML = `
                    <div class="no-jobs-found">
                        <div class="icon">üòï</div>
                        <p>Unable to load jobs. Please try again later.</p>
                    </div>
                `;
            }
        }

        // Autocomplete suggestions
        function showSuggestions(query) {
            const suggestionsDiv = document.getElementById('searchSuggestions');

            if (!query || query.length < 1) {
                suggestionsDiv.classList.remove('active');
                return;
            }

            // Get the current search term (text after last comma)
            const terms = query.split(',');
            const currentTerm = terms[terms.length - 1].trim();

            if (!currentTerm || currentTerm.length < 1) {
                suggestionsDiv.classList.remove('active');
                return;
            }

            const queryLower = currentTerm.toLowerCase();

            // Get unique job titles, skills and companies matching the query
            const titleMatches = new Map();
            const skillMatches = new Map();
            const companyMatches = new Map();

            state.allJobs.forEach(job => {
                // Title matches
                if (job.title.toLowerCase().includes(queryLower)) {
                    const key = job.title;
                    titleMatches.set(key, (titleMatches.get(key) || 0) + 1);
                }

                // Skill matches
                (job.skills || []).forEach(skill => {
                    if (skill.name.toLowerCase().includes(queryLower)) {
                        const key = skill.name;
                        skillMatches.set(key, (skillMatches.get(key) || 0) + 1);
                    }
                });

                // Company matches
                if (job.companyName?.toLowerCase().includes(queryLower)) {
                    const key = job.companyName;
                    companyMatches.set(key, (companyMatches.get(key) || 0) + 1);
                }
            });

            let html = '';

            // Job titles
            if (titleMatches.size > 0) {
                html += '<div class="suggestion-category">Job Titles</div>';
                [...titleMatches.entries()].slice(0, 5).forEach(([title, count]) => {
                    html += `
                        <div class="suggestion-item" onclick="selectSuggestion('${title.replace(/'/g, "\\'")}')">
                            <span class="suggestion-icon">üíº</span>
                            <div class="suggestion-text">
                                <div class="title">${title}</div>
                            </div>
                            <span class="suggestion-count">${count} job${count > 1 ? 's' : ''}</span>
                        </div>
                    `;
                });
            }

            // Skills
            if (skillMatches.size > 0) {
                html += '<div class="suggestion-category">Skills</div>';
                [...skillMatches.entries()].slice(0, 5).forEach(([skill, count]) => {
                    html += `
                        <div class="suggestion-item" onclick="selectSuggestion('${skill.replace(/'/g, "\\'")}')">
                            <span class="suggestion-icon">üéØ</span>
                            <div class="suggestion-text">
                                <div class="title">${skill}</div>
                            </div>
                            <span class="suggestion-count">${count} job${count > 1 ? 's' : ''}</span>
                        </div>
                    `;
                });
            }

            // Companies
            if (companyMatches.size > 0) {
                html += '<div class="suggestion-category">Companies</div>';
                [...companyMatches.entries()].slice(0, 3).forEach(([company, count]) => {
                    html += `
                        <div class="suggestion-item" onclick="selectSuggestion('${company.replace(/'/g, "\\'")}')">
                            <span class="suggestion-icon">üè¢</span>
                            <div class="suggestion-text">
                                <div class="title">${company}</div>
                            </div>
                            <span class="suggestion-count">${count} job${count > 1 ? 's' : ''}</span>
                        </div>
                    `;
                });
            }

            if (html) {
                suggestionsDiv.innerHTML = html;
                suggestionsDiv.classList.add('active');
            } else {
                suggestionsDiv.classList.remove('active');
            }
        }

        function hideSuggestions() {
            document.getElementById('searchSuggestions').classList.remove('active');
        }

        function selectSuggestion(value) {
            const input = document.getElementById('jobSearch');
            const currentValue = input.value.trim();

            // If there's already content, check for last comma
            if (currentValue) {
                const lastCommaIndex = currentValue.lastIndexOf(',');
                if (lastCommaIndex !== -1) {
                    // Replace text after last comma
                    input.value = currentValue.substring(0, lastCommaIndex + 1) + ' ' + value + ', ';
                } else {
                    // Replace entire text and add comma for next term
                    input.value = value + ', ';
                }
            } else {
                input.value = value + ', ';
            }

            hideSuggestions();
            input.focus();
            // Don't auto-search, let user add more terms
        }

        // Close suggestions on click outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-input-wrapper')) {
                hideSuggestions();
            }
        });

        // Search and filter jobs
        function searchJobs() {
            // Show skeleton loading
            const jobsGrid = document.getElementById('jobsGrid');
            jobsGrid.classList.add('loading');
            jobsGrid.innerHTML = `
                ${[1, 2, 3, 4, 5, 6].map(() => `
                    <div class="skeleton-card">
                        <div class="skeleton-row">
                            <div class="skeleton-line badge"></div>
                        </div>
                        <div class="skeleton-line title"></div>
                        <div class="skeleton-line company"></div>
                        <div class="skeleton-row">
                            <div class="skeleton-line badge"></div>
                            <div class="skeleton-line badge"></div>
                        </div>
                        <div class="skeleton-line description"></div>
                        <div class="skeleton-line description"></div>
                    </div>
                `).join('')}
            `;

            // Delay filter to show loading animation
            setTimeout(() => {
                performSearch();
            }, 200);
        }

        function performSearch() {
            const searchTerm = document.getElementById('jobSearch').value.toLowerCase();
            const location = document.getElementById('locationFilter').value.toLowerCase();
            const experience = document.getElementById('experienceFilter')?.value;
            const jobType = document.getElementById('jobTypeFilter')?.value;
            const workMode = document.getElementById('workModeFilter')?.value;
            const postedDate = document.getElementById('postedDateFilter')?.value;
            const sortBy = document.getElementById('sortBy')?.value || 'relevance';

            let filtered = [...state.allJobs];

            // Text search - handle comma-separated terms (like Naukri)
            if (searchTerm) {
                // Split by comma first, then by spaces within each term
                const searchTerms = searchTerm.split(',')
                    .map(t => t.trim().toLowerCase())
                    .filter(t => t.length > 0);

                filtered = filtered.filter(job => {
                    const titleLower = job.title.toLowerCase();
                    const companyLower = job.companyName?.toLowerCase() || '';
                    const skillNames = (job.skills || []).map(s => s.name.toLowerCase()).join(' ');
                    const locationLower = job.location?.toLowerCase() || '';
                    const searchText = `${titleLower} ${companyLower} ${skillNames} ${locationLower}`;

                    // Job must match ALL comma-separated terms
                    return searchTerms.every(term => {
                        // Each term can have multiple words - match if ANY word in term is found
                        const words = term.split(/\s+/).filter(w => w.length > 0);
                        return words.some(word => searchText.includes(word));
                    });
                });
            }

            // Location filter
            if (location) {
                const locationAliases = {
                    'delhi': ['delhi', 'new delhi', 'ncr', 'delhi ncr'],
                    'gurgaon': ['gurgaon', 'gurugram'],
                    'bangalore': ['bangalore', 'bengaluru'],
                    'mumbai': ['mumbai', 'bombay'],
                    'chennai': ['chennai', 'madras'],
                    'kolkata': ['kolkata', 'calcutta']
                };

                const aliases = locationAliases[location] || [location];
                filtered = filtered.filter(job => {
                    const jobLoc = job.location?.toLowerCase() || '';
                    return aliases.some(alias => jobLoc.includes(alias)) ||
                        (location === 'remote' && job.isRemote);
                });
            }

            // Experience filter
            if (experience) {
                const [minExp, maxExp] = experience === '10+' ? [10, 50] : experience.split('-').map(Number);
                filtered = filtered.filter(job => {
                    const jobMin = job.experienceMin || 0;
                    const jobMax = job.experienceMax || 50;
                    return jobMin <= maxExp && jobMax >= minExp;
                });
            }

            // Work mode filter
            if (workMode) {
                filtered = filtered.filter(job => {
                    if (workMode === 'remote') return job.isRemote;
                    if (workMode === 'hybrid') return job.workMode?.toLowerCase() === 'hybrid';
                    return !job.isRemote;
                });
            }

            // Posted date filter
            if (postedDate) {
                const now = new Date();
                const cutoff = new Date();
                if (postedDate === '24h') cutoff.setHours(now.getHours() - 24);
                else if (postedDate === 'week') cutoff.setDate(now.getDate() - 7);
                else if (postedDate === 'month') cutoff.setMonth(now.getMonth() - 1);

                filtered = filtered.filter(job => {
                    const postedAt = new Date(job.postedAt || job.createdAt);
                    return postedAt >= cutoff;
                });
            }

            // Sort
            if (sortBy === 'date') {
                filtered.sort((a, b) => new Date(b.postedAt || b.createdAt) - new Date(a.postedAt || a.createdAt));
            } else if (sortBy === 'salary') {
                filtered.sort((a, b) => (b.salaryMax || 0) - (a.salaryMax || 0));
            }

            // Saved jobs filter
            if (showingSavedOnly) {
                filtered = filtered.filter(job => savedJobs.includes(job.id));
            }

            state.filteredJobs = filtered;
            state.currentPage = 1;

            // Update results info
            document.getElementById('resultsInfo').textContent =
                `Showing ${filtered.length} of ${state.allJobs.length} jobs`;

            renderPaginatedJobs();
        }

        // Render jobs with pagination
        function renderPaginatedJobs() {
            const start = (state.currentPage - 1) * state.jobsPerPage;
            const end = start + state.jobsPerPage;
            const pageJobs = state.filteredJobs.slice(start, end);

            const jobsGrid = document.getElementById('jobsGrid');
            jobsGrid.classList.remove('loading');

            if (pageJobs.length === 0) {
                jobsGrid.innerHTML = `
                    <div class="no-jobs-found" style="grid-column: 1 / -1;">
                        <div class="icon">üîç</div>
                        <h3>No jobs found</h3>
                        <p>Try adjusting your search or filters</p>
                        <button class="btn btn-primary" onclick="clearAllFilters()" style="margin-top: 16px;">Clear All Filters</button>
                    </div>
                `;
            } else {
                jobsGrid.innerHTML = pageJobs.map(job => renderJobCard(job)).join('');
            }

            renderPagination();
        }

        // Render single job card
        function renderJobCard(job) {
            return `
                <div class="job-card" onclick="showJobDetails('${job.id}')" style="cursor: pointer;">
                    <button class="save-job-btn ${isJobSaved(job.id) ? 'saved' : ''}" onclick="toggleSaveJob('${job.id}', event)" title="${isJobSaved(job.id) ? 'Remove from saved' : 'Save job'}">
                        ${isJobSaved(job.id) ? '‚ù§Ô∏è' : 'ü§ç'}
                    </button>
                    <div class="job-header">
                        <div class="company-logo" style="background: ${getRandomGradient()}">${job.companyName?.charAt(0) || 'J'}</div>
                        <div class="job-meta">
                            <h3 class="job-title">${job.title}</h3>
                            <p class="company-name">${job.companyName}</p>
                        </div>
                        ${job.isHot ? '<span class="job-badge">Hot üî•</span>' : ''}
                    </div>
                    <div class="job-details">
                        <span class="job-detail"><span class="detail-icon">üìç</span> ${job.location}${job.isRemote ? ' (Remote)' : ''}</span>
                        <span class="job-detail"><span class="detail-icon">üíº</span> ${job.experienceMin || 0}-${job.experienceMax || 'Any'} years</span>
                        ${job.salaryMin ? `<span class="job-detail"><span class="detail-icon">üí∞</span> ‚Çπ${formatSalary(job.salaryMin)}-${formatSalary(job.salaryMax)} LPA</span>` : ''}
                    </div>
                    <div class="job-skills">
                        ${(job.skills || []).slice(0, 3).map(skill => `<span class="skill-tag">${skill.name}</span>`).join('')}
                        ${(job.skills || []).length > 3 ? `<span class="skill-tag">+${job.skills.length - 3}</span>` : ''}
                    </div>
                    <div class="skill-test-notice">
                        <span class="test-required-badge">üß™ Skill Test Required (Valid 7 Days)</span>
                    </div>
                    <div class="job-footer">
                        <div class="job-footer-left">
                            <span class="interview-fee">üí≥ Pay ‚Çπ99 only if interview scheduled</span>
                            <span class="posted-time">üìÖ ${getTimeAgo(job.postedAt || job.createdAt)}</span>
                        </div>
                        ${getApplyButtonHtml(job.id, true)}
                    </div>
                </div>
            `;
        }

        // Render pagination
        function renderPagination() {
            const totalPages = Math.ceil(state.filteredJobs.length / state.jobsPerPage);
            const paginationDiv = document.getElementById('pagination');

            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }

            let html = '';

            // Previous button
            html += `<button ${state.currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${state.currentPage - 1})">‚Üê Previous</button>`;

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= state.currentPage - 2 && i <= state.currentPage + 2)) {
                    html += `<button class="${i === state.currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
                } else if (i === state.currentPage - 3 || i === state.currentPage + 3) {
                    html += `<button disabled>...</button>`;
                }
            }

            // Next button
            html += `<button ${state.currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${state.currentPage + 1})">Next ‚Üí</button>`;

            paginationDiv.innerHTML = html;
        }

        function goToPage(page) {
            state.currentPage = page;
            renderPaginatedJobs();
            window.scrollTo({ top: 200, behavior: 'smooth' });
        }

        // Clear all filters
        function clearAllFilters() {
            document.getElementById('jobSearch').value = '';
            document.getElementById('locationFilter').value = '';
            document.getElementById('experienceFilter').value = '';
            document.getElementById('jobTypeFilter').value = '';
            document.getElementById('workModeFilter').value = '';
            document.getElementById('postedDateFilter').value = '';
            document.getElementById('sortBy').value = 'relevance';
            showingSavedOnly = false;
            document.getElementById('savedJobsBtn')?.classList.remove('active');
            searchJobs();
        }

        // Toggle saved jobs view
        function toggleSavedJobsView() {
            showingSavedOnly = !showingSavedOnly;
            const btn = document.getElementById('savedJobsBtn');
            if (showingSavedOnly) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
            searchJobs();
        }

        // Save/unsave jobs
        function toggleSaveJob(jobId, event) {
            if (event) event.stopPropagation();

            const index = savedJobs.indexOf(jobId);
            if (index > -1) {
                savedJobs.splice(index, 1);
            } else {
                savedJobs.push(jobId);
            }
            localStorage.setItem('savedJobs', JSON.stringify(savedJobs));
            renderPaginatedJobs();
        }

        function isJobSaved(jobId) {
            return savedJobs.includes(jobId);
        }

        // Job detail modal
        function showJobDetails(jobId) {
            const job = state.allJobs.find(j => j.id === jobId);
            if (!job) return;

            const content = document.getElementById('jobDetailContent');
            content.innerHTML = `
                <div class="job-detail-header">
                    <div class="company-logo-lg" style="background: ${getRandomGradient()}">${job.companyName?.charAt(0) || 'J'}</div>
                    <div>
                        <h2 class="modal-title">${job.title}</h2>
                        <p class="modal-subtitle">${job.companyName} ‚Ä¢ ${job.location}${job.isRemote ? ' (Remote)' : ''}</p>
                    </div>
                    ${job.isHot ? '<span class="job-badge" style="margin-left: auto;">Hot üî•</span>' : ''}
                </div>
                
                <div class="job-detail-info">
                    <div class="info-item">
                        <span class="info-label">Experience</span>
                        <span class="info-value">${job.experienceMin || 0}-${job.experienceMax || 'Any'} years</span>
                    </div>
                    ${job.salaryMin ? `
                    <div class="info-item">
                        <span class="info-label">Salary Range</span>
                        <span class="info-value">‚Çπ${formatSalary(job.salaryMin)}-${formatSalary(job.salaryMax)} LPA</span>
                    </div>
                    ` : ''}
                    <div class="info-item">
                        <span class="info-label">Interview Fee</span>
                        <span class="info-value" style="color: var(--success);">‚Çπ99 (only if scheduled)</span>
                    </div>
                </div>
                
                <div class="job-flow-steps">
                    <h4>üìã How to Apply</h4>
                    <div class="flow-steps-grid">
                        <div class="flow-step">
                            <span class="flow-step-icon">üß™</span>
                            <span class="flow-step-text">Pass Skill Test (Valid 7 Days)</span>
                        </div>
                        <div class="flow-step-arrow">‚Üí</div>
                        <div class="flow-step">
                            <span class="flow-step-icon">üìù</span>
                            <span class="flow-step-text">Submit Application (Free)</span>
                        </div>
                        <div class="flow-step-arrow">‚Üí</div>
                        <div class="flow-step">
                            <span class="flow-step-icon">üìÖ</span>
                            <span class="flow-step-text">HR Schedules Interview</span>
                        </div>
                        <div class="flow-step-arrow">‚Üí</div>
                        <div class="flow-step">
                            <span class="flow-step-icon">üí≥</span>
                            <span class="flow-step-text">Pay ‚Çπ99 to Unlock Details</span>
                        </div>
                    </div>
                </div>
                
                <div class="job-detail-skills">
                    <h4>Required Skills</h4>
                    <div class="skills-list">
                        ${(job.skills || []).map(skill => `<span class="skill-tag">${skill.name}</span>`).join('')}
                        ${(!job.skills || job.skills.length === 0) ? '<span class="text-muted">No specific skills listed</span>' : ''}
                    </div>
                </div>
                
                ${job.description ? `
                <div class="job-detail-description">
                    <h4>Job Description</h4>
                    <p>${job.description}</p>
                </div>
                ` : ''}
                
                <div class="job-detail-actions">
                    ${getApplyButtonHtml(job.id, false)}
                    <button class="btn btn-outline ${isJobSaved(job.id) ? 'saved' : ''}" onclick="toggleSaveJob('${job.id}'); closeJobModal(); setTimeout(() => showJobDetails('${job.id}'), 300);">
                        ${isJobSaved(job.id) ? '‚ù§Ô∏è Saved' : 'ü§ç Save Job'}
                    </button>
                </div>
            `;

            document.getElementById('jobModalOverlay').classList.add('active');
            document.getElementById('jobDetailModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeJobModal() {
            document.getElementById('jobModalOverlay')?.classList.remove('active');
            document.getElementById('jobDetailModal')?.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Apply for job - actually submit the application
        async function applyForJob(jobId) {
            if (!state.token) {
                showToast('info', 'Please login to apply for jobs');
                setTimeout(() => {
                    window.location.href = '/?apply=' + jobId;
                }, 1000);
                return;
            }

            // Show loading state on the button
            const btns = document.querySelectorAll(`button[onclick*="applyForJob('${jobId}')"]`);
            const originalTexts = [];
            btns.forEach(btn => {
                originalTexts.push(btn.innerHTML);
                btn.disabled = true;
                btn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:6px;"><span style="width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:btnSpin 0.6s linear infinite;display:inline-block;"></span> Applying...</span>';
                btn.style.opacity = '0.7';
                btn.style.pointerEvents = 'none';
            });

            // Find job details
            const job = state.allJobs.find(j => j.id === jobId);
            const jobTitle = job?.title || 'Unknown Position';
            const company = job?.companyName || 'Unknown Company';

            try {
                const response = await fetch(`${API_BASE_URL}/jobs/${jobId}/apply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.token}`,
                    },
                });

                if (response.status === 401) {
                    showToast('warning', 'Session expired. Please login again.');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    setTimeout(() => { window.location.href = '/?apply=' + jobId; }, 1500);
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    // Track this job as applied
                    appliedJobIds.push(jobId);

                    // Close job detail modal if open
                    closeJobModal();

                    // Show professional success modal
                    showApplicationSuccessModal(jobTitle, company);

                    // Re-render to update button state
                    renderPaginatedJobs();
                } else {
                    // Restore buttons on error
                    btns.forEach((btn, i) => {
                        btn.disabled = false;
                        btn.innerHTML = originalTexts[i];
                        btn.style.opacity = '';
                        btn.style.pointerEvents = '';
                    });
                    const message = data.message || '';
                    if (message.toLowerCase().includes('already applied')) {
                        showToast('info', 'You have already applied for this job. Go to Applications to take the test.');
                    } else if (message.includes('skill tests before applying') || message.includes('Skill tests required')) {
                        showToast('warning', message);
                    } else if (message.includes('cooldown') || message.includes('wait before')) {
                        showToast('warning', message);
                    } else if (message.includes('expired')) {
                        showToast('warning', message);
                    } else {
                        showToast('error', message || 'Failed to apply. Please try again.');
                    }
                }
            } catch (error) {
                // Restore buttons on network error
                btns.forEach((btn, i) => {
                    btn.disabled = false;
                    btn.innerHTML = originalTexts[i];
                    btn.style.opacity = '';
                    btn.style.pointerEvents = '';
                });
                console.error('Apply error:', error);
                showToast('error', 'Unable to apply. Please try again.');
            }
        }

        // Professional success modal after applying
        function showApplicationSuccessModal(jobTitle, company) {
            const existing = document.getElementById('applicationSuccessModal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'applicationSuccessModal';
            modal.innerHTML = `
                <style>
                    @keyframes successFadeIn { from { opacity: 0; } to { opacity: 1; } }
                    @keyframes successScaleIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
                    @keyframes successBounceIn { 0% { opacity: 0; transform: scale(0.3); } 50% { transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }
                </style>
                <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; animation: successFadeIn 0.3s ease;">
                    <div style="background: white; border-radius: 16px; max-width: 440px; width: 100%; padding: 40px 32px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: successScaleIn 0.3s ease;">
                        <div style="width: 72px; height: 72px; background: linear-gradient(135deg, #22c55e, #16a34a); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; animation: successBounceIn 0.5s ease 0.2s both;">
                            <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        <h2 style="font-size: 22px; font-weight: 700; color: #1e293b; margin: 0 0 8px;">Application Submitted! üéâ</h2>
                        <p style="font-size: 15px; color: #64748b; margin: 0 0 20px; line-height: 1.5;">
                            You've successfully applied for<br>
                            <strong style="color: #1e293b;">${jobTitle}</strong> at <strong style="color: #1e293b;">${company}</strong>
                        </p>
                        <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 10px; padding: 14px 16px; margin-bottom: 24px; text-align: left;">
                            <p style="font-size: 13px; color: #15803d; margin: 0; line-height: 1.6;">
                                <strong>üìã Next Step:</strong> Go to <strong>My Applications</strong> to take the skill assessment test. Your application status will be updated once completed.
                            </p>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="window.location.href='/#applications'" 
                                style="flex: 1; padding: 12px 16px; background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;">
                                üìã My Applications
                            </button>
                            <button onclick="document.getElementById('applicationSuccessModal').remove();" 
                                style="flex: 1; padding: 12px 16px; background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;">
                                Keep Browsing
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function getApplyButtonHtml(jobId, isSmall = true) {
            const sizeClass = isSmall ? 'btn-sm' : '';
            if (appliedJobIds.includes(jobId)) {
                return `<button class="btn btn-outline ${sizeClass}" disabled style="opacity:0.7;cursor:default;">Applied ‚úì</button>`;
            }
            return `<button class="btn btn-primary ${sizeClass}" onclick="event.stopPropagation(); applyForJob('${jobId}')">Apply Now</button>`;
        }

        // Utility functions
        function formatSalary(amount) {
            if (!amount) return '0';
            if (amount >= 10000000) return (amount / 10000000).toFixed(1) + 'Cr';
            if (amount >= 100000) return (amount / 100000).toFixed(0);
            return amount.toString();
        }

        function getTimeAgo(dateString) {
            if (!dateString) return 'Recently';
            const now = new Date();
            const date = new Date(dateString);
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            return `${Math.floor(diffDays / 30)} months ago`;
        }

        function getRandomGradient() {
            const gradients = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
            ];
            return gradients[Math.floor(Math.random() * gradients.length)];
        }

        function showToast(type, message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>

</html>