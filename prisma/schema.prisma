// Prisma Schema for Job Referral Platform
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
  engineType = "client"
}

datasource db {
  provider = "postgresql"
}

// ===========================================
// ENUMS
// ===========================================

enum UserRole {
  CANDIDATE
  HR
  EMPLOYEE
  ADMIN
}

enum UserStatus {
  PENDING
  ACTIVE
  BLOCKED
  DELETED
}

enum JobStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  EXPIRED
  CLOSED
}

enum ApplicationStatus {
  APPLIED
  TEST_PENDING
  TEST_PASSED
  TEST_FAILED
  REFERRAL_PENDING
  REFERRAL_CONFIRMED
  PAYMENT_PENDING
  CONTACT_UNLOCKED
  CLOSED
  EXPIRED
}

enum TestSessionStatus {
  ACTIVE
  SUBMITTED
  AUTO_SUBMITTED
  EXPIRED
}

enum ReferralStatus {
  PENDING
  CONFIRMED
  PAYMENT_PENDING
  CONTACTED
  CLOSED
  EXPIRED
}

enum ReferralType {
  EMPLOYEE
  HR_DIRECT
}

enum PaymentStatus {
  ELIGIBLE
  ORDER_CREATED
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum RefundStatus {
  REQUESTED
  APPROVED
  REJECTED
  PROCESSED
}

enum HRApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  EMAIL
  SMS
  PUSH
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  TEST_START
  TEST_SUBMIT
  TEST_TAB_SWITCH
  PAYMENT_INITIATED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  REFUND_REQUESTED
  REFUND_PROCESSED
  ADMIN_OVERRIDE
}

enum EarningStatus {
  PENDING       // Referral confirmed, awaiting hire completion
  ELIGIBLE      // Hire confirmed, payment eligible
  PROCESSING    // Payout initiated
  PAID          // Payout completed
  CANCELLED     // Referral cancelled/expired
}

// ===========================================
// USER & AUTH MODELS
// ===========================================

model User {
  id            String     @id @default(uuid())
  email         String     @unique
  phone         String?    @unique
  passwordHash  String?
  role          UserRole   @default(CANDIDATE)
  status        UserStatus @default(PENDING)
  emailVerified Boolean    @default(false)
  phoneVerified Boolean    @default(false)
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  candidate     Candidate?
  hr            HR?
  employee      Employee?
  
  otpTokens     OTPToken[]
  refreshTokens RefreshToken[]
  deviceLogs    DeviceLog[]
  auditLogs     AuditLog[]
  notifications Notification[]
  
  @@index([email])
  @@index([phone])
  @@index([role])
  @@index([status])
}

model OTPToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  otp       String
  type      String   // email_verify, phone_verify, login
  expiresAt DateTime
  usedAt    DateTime?
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([otp, type])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token     String   @unique
  deviceId  String?
  expiresAt DateTime
  revokedAt DateTime?
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
}

model DeviceLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  deviceId  String
  ipAddress String
  userAgent String?
  location  String?
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([deviceId])
}

// ===========================================
// CANDIDATE MODELS
// ===========================================

model Candidate {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Profile
  firstName   String
  lastName    String
  headline    String?
  bio         String?
  avatarUrl   String?
  resumeUrl   String?
  
  // Experience
  totalExperience Float?    // in years
  currentCompany  String?
  currentRole     String?
  expectedSalary  Float?
  noticePeriod    Int?      // in days
  
  // Location
  city            String?
  state           String?
  country         String?
  willingToRelocate Boolean @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  skills          CandidateSkill[]
  experiences     Experience[]
  educations      Education[]
  applications    JobApplication[]
  
  @@index([userId])
}

model CandidateSkill {
  id          String    @id @default(uuid())
  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  
  name        String
  level       Int       @default(1) // 1-5 proficiency
  yearsOfExp  Float?
  
  @@unique([candidateId, name])
  @@index([candidateId])
}

model Experience {
  id          String    @id @default(uuid())
  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  
  company     String
  role        String
  description String?
  location    String?
  startDate   DateTime
  endDate     DateTime?
  isCurrent   Boolean   @default(false)
  
  createdAt   DateTime  @default(now())
  
  @@index([candidateId])
}

model Education {
  id          String    @id @default(uuid())
  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  
  institution String
  degree      String
  field       String?
  grade       String?
  startYear   Int
  endYear     Int?
  
  createdAt   DateTime  @default(now())
  
  @@index([candidateId])
}

// ===========================================
// HR / RECRUITER MODELS
// ===========================================

model HR {
  id              String           @id @default(uuid())
  userId          String           @unique
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Company Details
  companyName     String
  companyEmail    String
  companyWebsite  String?
  designation     String?
  linkedinUrl     String?
  
  // Verification
  approvalStatus  HRApprovalStatus @default(PENDING)
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?
  
  // Stats
  totalJobsPosted Int              @default(0)
  activeJobs      Int              @default(0)
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  // Relations
  jobs            Job[]
  referrals       Referral[]
  
  @@index([userId])
  @@index([companyEmail])
  @@index([approvalStatus])
}

// ===========================================
// EMPLOYEE REFERRAL MODELS
// ===========================================

model Employee {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Company Details
  companyName     String
  companyEmail    String
  designation     String?
  employeeId      String?  // Internal employee ID
  linkedinUrl     String?
  
  // Verification
  isVerified      Boolean  @default(false)
  verifiedAt      DateTime?
  
  // Gamification
  referralCount   Int      @default(0)
  successfulReferrals Int  @default(0)
  badges          String[] @default([])
  points          Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  referrals       Referral[]
  earnings        EmployeeEarning[]
  
  @@index([userId])
  @@index([companyEmail])
  @@index([companyName])
}

// ===========================================
// JOB MODELS
// ===========================================

model Job {
  id              String    @id @default(uuid())
  slug            String    @unique // SEO-friendly URL
  
  // Basic Info
  title           String
  description     String
  requirements    String?
  responsibilities String?
  
  // Company
  companyName     String
  companyLogo     String?
  location        String
  isRemote        Boolean   @default(false)
  
  // Compensation
  salaryMin       Float?
  salaryMax       Float?
  salaryCurrency  String    @default("INR")
  
  // Requirements
  experienceMin   Float?    // in years
  experienceMax   Float?
  educationLevel  String?
  
  // Job Settings
  status          JobStatus @default(DRAFT)
  maxApplications Int       @default(100)
  applicationCount Int      @default(0)
  
  // Payment for candidates
  referralFee     Float     @default(499)
  
  // Test Configuration
  testId          String?
  test            Test?     @relation(fields: [testId], references: [id])
  
  // HR who posted (optional for admin-created jobs)
  hrId            String?
  hr              HR?       @relation(fields: [hrId], references: [id])
  
  // Timestamps
  postedAt        DateTime?
  expiresAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  skills          JobSkill[]
  applications    JobApplication[]
  
  @@index([slug])
  @@index([status])
  @@index([hrId])
  @@index([companyName])
  @@index([location])
}

model JobSkill {
  id        String @id @default(uuid())
  jobId     String
  job       Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  name      String
  isRequired Boolean @default(true)
  
  @@unique([jobId, name])
  @@index([jobId])
}

// ===========================================
// APPLICATION MODELS
// ===========================================

model JobApplication {
  id            String            @id @default(uuid())
  
  candidateId   String
  candidate     Candidate         @relation(fields: [candidateId], references: [id])
  
  jobId         String
  job           Job               @relation(fields: [jobId], references: [id])
  
  status        ApplicationStatus @default(APPLIED)
  
  // Cover letter
  coverLetter   String?
  
  // Test info
  testScore     Float?
  testPassedAt  DateTime?
  
  // Contact unlocked
  contactUnlockedAt DateTime?
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  // Relations
  testSessions  TestSession[]
  referral      Referral?
  payments      Payment[]
  
  @@unique([candidateId, jobId])
  @@index([candidateId])
  @@index([jobId])
  @@index([status])
}

// ===========================================
// TEST ENGINE MODELS
// ===========================================

model Test {
  id              String   @id @default(uuid())
  
  title           String
  description     String?
  
  // Configuration
  duration        Int      @default(30)  // minutes
  passingScore    Float    @default(70)  // percentage
  totalQuestions  Int      @default(20)
  shuffleQuestions Boolean @default(true)
  maxTabSwitches  Int      @default(2)
  
  // Difficulty
  difficulty      String   @default("MEDIUM") // EASY, MEDIUM, HARD
  
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  questions       TestQuestion[]
  jobs            Job[]
  sessions        TestSession[]
  
  @@index([isActive])
}

model TestQuestion {
  id            String   @id @default(uuid())
  testId        String
  test          Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
  
  question      String
  options       Json     // Array of options
  correctAnswer Int      // Index of correct option
  explanation   String?
  points        Int      @default(1)
  
  // Ordering
  orderIndex    Int
  
  createdAt     DateTime @default(now())
  
  // Relations
  answers       TestAnswer[]
  
  @@index([testId])
}

model TestSession {
  id               String            @id @default(uuid())
  
  applicationId    String
  application      JobApplication    @relation(fields: [applicationId], references: [id])
  
  testId           String
  test             Test              @relation(fields: [testId], references: [id])
  
  status           TestSessionStatus @default(ACTIVE)
  
  // Timing
  startedAt        DateTime          @default(now())
  endsAt           DateTime
  submittedAt      DateTime?
  
  // Results
  score            Float?
  totalQuestions   Int
  correctAnswers   Int               @default(0)
  isPassed         Boolean?
  
  // Anti-cheat
  tabSwitchCount   Int               @default(0)
  warningCount     Int               @default(0)
  
  // Question order (shuffled indices)
  questionOrder    Int[]
  
  createdAt        DateTime          @default(now())
  
  // Relations
  answers          TestAnswer[]
  events           TestEvent[]
  
  @@index([applicationId])
  @@index([testId])
  @@index([status])
}

model TestAnswer {
  id            String       @id @default(uuid())
  
  sessionId     String
  session       TestSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  questionId    String
  question      TestQuestion @relation(fields: [questionId], references: [id])
  
  selectedAnswer Int?
  isCorrect      Boolean?
  answeredAt     DateTime     @default(now())
  
  @@unique([sessionId, questionId])
  @@index([sessionId])
}

model TestEvent {
  id          String      @id @default(uuid())
  
  sessionId   String
  session     TestSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  eventType   String      // TAB_SWITCH, COPY_ATTEMPT, PASTE_ATTEMPT, RIGHT_CLICK, WARNING_ISSUED
  eventData   Json?
  
  createdAt   DateTime    @default(now())
  
  @@index([sessionId])
  @@index([eventType])
}

// ===========================================
// REFERRAL MODELS
// ===========================================

model Referral {
  id              String         @id @default(uuid())
  
  applicationId   String         @unique
  application     JobApplication @relation(fields: [applicationId], references: [id])
  
  type            ReferralType
  status          ReferralStatus @default(PENDING)
  
  // If employee referral
  employeeId      String?
  employee        Employee?      @relation(fields: [employeeId], references: [id])
  
  // If HR direct
  hrId            String?
  hr              HR?            @relation(fields: [hrId], references: [id])
  
  // Timestamps
  confirmedAt     DateTime?
  contactedAt     DateTime?
  closedAt        DateTime?
  expiresAt       DateTime?
  
  // Feedback
  hrFeedback      String?
  candidateFeedback String?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Earning relation
  earning         EmployeeEarning?
  
  @@index([applicationId])
  @@index([employeeId])
  @@index([hrId])
  @@index([status])
}

// ===========================================
// PAYMENT MODELS
// ===========================================

model Payment {
  id              String         @id @default(uuid())
  
  applicationId   String
  application     JobApplication @relation(fields: [applicationId], references: [id])
  
  // Razorpay
  razorpayOrderId String?        @unique
  razorpayPaymentId String?      @unique
  razorpaySignature String?
  
  // Amount
  amount          Float
  currency        String         @default("INR")
  
  status          PaymentStatus  @default(ELIGIBLE)
  
  // Metadata
  failureReason   String?
  webhookPayload  Json?
  
  // Timestamps
  orderCreatedAt  DateTime?
  paidAt          DateTime?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Relations
  refund          Refund?
  
  @@index([applicationId])
  @@index([razorpayOrderId])
  @@index([status])
}

model Refund {
  id              String       @id @default(uuid())
  
  paymentId       String       @unique
  payment         Payment      @relation(fields: [paymentId], references: [id])
  
  amount          Float
  reason          String
  status          RefundStatus @default(REQUESTED)
  
  // Admin handling
  processedBy     String?
  processedAt     DateTime?
  adminNotes      String?
  
  // Razorpay refund
  razorpayRefundId String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([paymentId])
  @@index([status])
}

// ===========================================
// NOTIFICATION MODELS
// ===========================================

model Notification {
  id        String           @id @default(uuid())
  
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      NotificationType
  title     String
  message   String
  data      Json?
  
  isRead    Boolean          @default(false)
  readAt    DateTime?
  
  createdAt DateTime         @default(now())
  
  @@index([userId])
  @@index([isRead])
}

// ===========================================
// AUDIT LOG MODELS
// ===========================================

model AuditLog {
  id          String      @id @default(uuid())
  
  userId      String?
  user        User?       @relation(fields: [userId], references: [id])
  
  action      AuditAction
  entityType  String      // User, Job, Payment, etc.
  entityId    String
  
  oldValue    Json?
  newValue    Json?
  metadata    Json?       // IP, user agent, etc.
  
  createdAt   DateTime    @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
}

// ===========================================
// EMPLOYEE EARNING MODELS
// ===========================================

model EmployeeEarning {
  id              String        @id @default(uuid())
  
  employeeId      String
  employee        Employee      @relation(fields: [employeeId], references: [id])
  
  referralId      String        @unique
  referral        Referral      @relation(fields: [referralId], references: [id])
  
  // Amount earned
  amount          Float
  status          EarningStatus @default(PENDING)
  
  // Bonus support
  bonusAmount     Float         @default(0)
  bonusReason     String?
  
  // Tier at time of earning
  tierName        String?
  commissionRate  Float?        // Percentage applied
  
  // Payout tracking
  processedAt     DateTime?
  paidAt          DateTime?
  payoutReference String?       // UPI/Bank transaction reference
  payoutMethod    String?       // UPI, BANK, etc.
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([employeeId])
  @@index([status])
  @@index([createdAt])
}

model CommissionTier {
  id                  String   @id @default(uuid())
  
  name                String   @unique  // e.g., "Bronze", "Silver", "Gold", "Platinum"
  minReferrals        Int               // Minimum referrals to reach this tier
  commissionPercent   Float             // Percentage of referral fee
  bonusPerReferral    Float   @default(0) // Additional bonus per referral
  
  // Tier benefits
  description         String?
  badgeIcon           String?
  
  isActive            Boolean @default(true)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([minReferrals])
}

// ===========================================
// CMS / ADMIN MODELS
// ===========================================

model CMSPage {
  id        String   @id @default(uuid())
  
  slug      String   @unique
  title     String
  content   String
  
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([slug])
}

model SystemConfig {
  id        String   @id @default(uuid())
  
  key       String   @unique
  value     String
  type      String   @default("string") // string, number, boolean, json
  
  updatedAt DateTime @updatedAt
  
  @@index([key])
}
