generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AuditLog {
  id         String      @id @default(cuid())
  userId     String?
  action     AuditAction
  entityType String
  entityId   String
  oldValue   Json?
  newValue   Json?
  metadata   Json?
  createdAt  DateTime    @default(now())
  User       User?       @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([createdAt])
  @@index([entityType])
  @@index([userId])
}

model CMSPage {
  id        String   @id
  slug      String   @unique
  title     String
  content   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@index([slug])
}

model Candidate {
  id                String             @id
  userId            String             @unique
  firstName         String
  lastName          String
  headline          String?
  bio               String?
  avatarUrl         String?
  resumeUrl         String?
  totalExperience   Float?
  currentCompany    String?
  currentRole       String?
  expectedSalary    Float?
  noticePeriod      Int?
  city              String?
  state             String?
  country           String?
  willingToRelocate Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime
  User              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  CandidateSkill    CandidateSkill[]
  Education         Education[]
  Experience        Experience[]
  JobApplication    JobApplication[]
  SkillTestAttempt  SkillTestAttempt[]

  @@index([userId])
}

model CandidateSkill {
  id          String    @id
  candidateId String
  name        String
  level       Int       @default(1)
  yearsOfExp  Float?
  Candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@unique([candidateId, name])
  @@index([candidateId])
}

model CommissionTier {
  id                String   @id
  name              String   @unique
  minReferrals      Int
  commissionPercent Float
  bonusPerReferral  Float    @default(0)
  description       String?
  badgeIcon         String?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime

  @@index([minReferrals])
}

model DeviceLog {
  id        String   @id @default(cuid())
  userId    String
  deviceId  String
  ipAddress String
  userAgent String?
  location  String?
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([deviceId])
  @@index([userId])
}

model Education {
  id          String    @id
  candidateId String
  institution String
  degree      String
  field       String?
  grade       String?
  startYear   Int
  endYear     Int?
  createdAt   DateTime  @default(now())
  Candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
}

model Employee {
  id                  String            @id
  userId              String            @unique
  companyName         String
  companyEmail        String
  designation         String?
  employeeId          String?
  linkedinUrl         String?
  isVerified          Boolean           @default(false)
  verifiedAt          DateTime?
  referralCount       Int               @default(0)
  successfulReferrals Int               @default(0)
  badges              String[]          @default([])
  points              Int               @default(0)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime
  User                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  EmployeeEarning     EmployeeEarning[]
  Referral            Referral[]

  @@index([companyEmail])
  @@index([companyName])
  @@index([userId])
}

model EmployeeEarning {
  id              String        @id
  employeeId      String
  referralId      String        @unique
  amount          Float
  status          EarningStatus @default(PENDING)
  bonusAmount     Float         @default(0)
  bonusReason     String?
  tierName        String?
  commissionRate  Float?
  processedAt     DateTime?
  paidAt          DateTime?
  payoutReference String?
  payoutMethod    String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime
  Employee        Employee      @relation(fields: [employeeId], references: [id])
  Referral        Referral      @relation(fields: [referralId], references: [id])

  @@index([createdAt])
  @@index([employeeId])
  @@index([status])
}

model Experience {
  id          String    @id
  candidateId String
  company     String
  role        String
  description String?
  location    String?
  startDate   DateTime
  endDate     DateTime?
  isCurrent   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  Candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
}

model HR {
  id              String           @id
  userId          String           @unique
  companyName     String
  companyEmail    String
  companyWebsite  String?
  designation     String?
  linkedinUrl     String?
  approvalStatus  HRApprovalStatus @default(PENDING)
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?
  totalJobsPosted Int              @default(0)
  activeJobs      Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime
  User            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  Job             Job[]
  Referral        Referral[]

  @@index([approvalStatus])
  @@index([companyEmail])
  @@index([userId])
}

model Interview {
  id                  String          @id
  applicationId       String          @unique
  mode                InterviewMode
  preferredTimeWindow String?
  hrNotes             String?
  status              InterviewStatus @default(PAYMENT_PENDING)
  paymentStatus       PaymentStatus   @default(ELIGIBLE)
  scheduledDate       DateTime?
  scheduledTime       String?
  interviewLink       String?
  callDetails         String?
  requestedAt         DateTime        @default(now())
  paidAt              DateTime?
  scheduledAt         DateTime?
  completedAt         DateTime?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime
  JobApplication      JobApplication  @relation(fields: [applicationId], references: [id])

  @@index([applicationId])
  @@index([paymentStatus])
  @@index([status])
}

model Job {
  id                     String                   @id
  slug                   String                   @unique
  title                  String
  description            String
  requirements           String?
  responsibilities       String?
  companyName            String
  companyLogo            String?
  location               String
  isRemote               Boolean                  @default(false)
  salaryMin              Float?
  salaryMax              Float?
  salaryCurrency         String                   @default("INR")
  experienceMin          Float?
  experienceMax          Float?
  educationLevel         String?
  status                 JobStatus                @default(DRAFT)
  maxApplications        Int                      @default(100)
  applicationCount       Int                      @default(0)
  referralFee            Float                    @default(499)
  testId                 String?
  hrId                   String?
  postedAt               DateTime?
  expiresAt              DateTime?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  skillBucketId          String?
  HR                     HR?                      @relation(fields: [hrId], references: [id])
  SkillBucket            SkillBucket?             @relation(fields: [skillBucketId], references: [id])
  Test                   Test?                    @relation(fields: [testId], references: [id])
  JobApplication         JobApplication[]
  JobRequiredSkillBucket JobRequiredSkillBucket[]
  JobSkill               JobSkill[]

  @@index([companyName])
  @@index([hrId])
  @@index([location])
  @@index([skillBucketId])
  @@index([slug])
  @@index([status])
}

model JobApplication {
  id                String            @id
  candidateId       String
  jobId             String
  status            ApplicationStatus @default(APPLIED)
  coverLetter       String?
  testScore         Float?
  testPassedAt      DateTime?
  contactUnlockedAt DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime
  Interview         Interview?
  Candidate         Candidate         @relation(fields: [candidateId], references: [id])
  Job               Job               @relation(fields: [jobId], references: [id])
  Payment           Payment[]
  Referral          Referral?
  TestSession       TestSession[]

  @@unique([candidateId, jobId])
  @@index([candidateId])
  @@index([jobId])
  @@index([status])
}

model JobRequiredSkillBucket {
  id            String      @id
  jobId         String
  skillBucketId String
  displayOrder  Int         @default(0)
  createdAt     DateTime    @default(now())
  Job           Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  SkillBucket   SkillBucket @relation(fields: [skillBucketId], references: [id])

  @@unique([jobId, skillBucketId])
  @@index([jobId])
  @@index([skillBucketId])
}

model JobSkill {
  id         String  @id
  jobId      String
  name       String
  isRequired Boolean @default(true)
  Job        Job     @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([jobId, name])
  @@index([jobId])
}

model Notification {
  id        String           @id
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())
  User      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isRead])
  @@index([userId])
}

model OTPToken {
  id        String    @id
  userId    String
  otp       String
  type      String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([otp, type])
  @@index([userId])
}

model PasswordResetToken {
  id        String    @id
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Payment {
  id                String         @id
  applicationId     String
  razorpayOrderId   String?        @unique
  razorpayPaymentId String?        @unique
  razorpaySignature String?
  amount            Float
  currency          String         @default("INR")
  status            PaymentStatus  @default(ELIGIBLE)
  failureReason     String?
  webhookPayload    Json?
  orderCreatedAt    DateTime?
  paidAt            DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime
  JobApplication    JobApplication @relation(fields: [applicationId], references: [id])
  Refund            Refund?

  @@index([applicationId])
  @@index([razorpayOrderId])
  @@index([status])
}

model QuestionBank {
  id            String             @id
  question      String
  options       Json
  correctAnswer Int
  explanation   String?
  difficulty    QuestionDifficulty @default(MEDIUM)
  category      QuestionCategory   @default(TECHNICAL)
  tags          String[]
  roleType      String?
  createdById   String
  createdAt     DateTime           @default(now())
  updatedAt     DateTime
  isActive      Boolean            @default(true)

  @@index([category])
  @@index([createdAt])
  @@index([difficulty])
  @@index([roleType, isActive])
}

model Referral {
  id                String           @id
  applicationId     String           @unique
  type              ReferralType
  status            ReferralStatus   @default(PENDING)
  employeeId        String?
  hrId              String?
  confirmedAt       DateTime?
  contactedAt       DateTime?
  closedAt          DateTime?
  expiresAt         DateTime?
  hrFeedback        String?
  candidateFeedback String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime
  EmployeeEarning   EmployeeEarning?
  JobApplication    JobApplication   @relation(fields: [applicationId], references: [id])
  Employee          Employee?        @relation(fields: [employeeId], references: [id])
  HR                HR?              @relation(fields: [hrId], references: [id])

  @@index([applicationId])
  @@index([employeeId])
  @@index([hrId])
  @@index([status])
}

model RefreshToken {
  id        String    @id
  userId    String
  token     String    @unique
  deviceId  String?
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Refund {
  id               String       @id
  paymentId        String       @unique
  amount           Float
  reason           String
  status           RefundStatus @default(REQUESTED)
  processedBy      String?
  processedAt      DateTime?
  adminNotes       String?
  razorpayRefundId String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime
  Payment          Payment      @relation(fields: [paymentId], references: [id])

  @@index([paymentId])
  @@index([status])
}

model SkillBucket {
  id                     String                   @id
  code                   String                   @unique
  name                   String
  description            String?
  displayName            String?
  experienceMin          Float                    @default(0)
  experienceMax          Float                    @default(3)
  isActive               Boolean                  @default(true)
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  testId                 String?                  @unique
  testTemplateId         String?
  Job                    Job[]
  JobRequiredSkillBucket JobRequiredSkillBucket[]
  Test                   Test?                    @relation(fields: [testId], references: [id])
  TestTemplate           TestTemplate?            @relation(fields: [testTemplateId], references: [id])
  SkillTestAttempt       SkillTestAttempt[]

  @@index([code])
  @@index([isActive])
}

model SkillTestAttempt {
  id              String      @id
  candidateId     String
  skillBucketId   String
  isPassed        Boolean
  score           Float
  attemptedAt     DateTime    @default(now())
  validTill       DateTime?
  retestAllowedAt DateTime?
  testSessionId   String?
  Candidate       Candidate   @relation(fields: [candidateId], references: [id])
  SkillBucket     SkillBucket @relation(fields: [skillBucketId], references: [id])

  @@index([candidateId])
  @@index([candidateId, skillBucketId])
  @@index([skillBucketId])
  @@index([validTill])
}

model SystemConfig {
  id        String   @id
  key       String   @unique
  value     String
  type      String   @default("string")
  updatedAt DateTime

  @@index([key])
}

model Test {
  id               String         @id
  title            String
  description      String?
  duration         Int            @default(30)
  passingScore     Float          @default(70)
  totalQuestions   Int            @default(20)
  shuffleQuestions Boolean        @default(true)
  maxTabSwitches   Int            @default(2)
  difficulty       String         @default("MEDIUM")
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime
  Job              Job[]
  SkillBucket      SkillBucket?
  TestQuestion     TestQuestion[]
  TestSession      TestSession[]

  @@index([isActive])
}

model TestAnswer {
  id             String       @id
  sessionId      String
  questionId     String
  selectedAnswer Int?
  isCorrect      Boolean?
  answeredAt     DateTime     @default(now())
  TestQuestion   TestQuestion @relation(fields: [questionId], references: [id])
  TestSession    TestSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, questionId])
  @@index([sessionId])
}

model TestEvent {
  id          String      @id
  sessionId   String
  eventType   String
  eventData   Json?
  createdAt   DateTime    @default(now())
  TestSession TestSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([eventType])
  @@index([sessionId])
}

model TestQuestion {
  id            String       @id
  testId        String
  question      String
  options       Json
  correctAnswer Int
  explanation   String?
  points        Int          @default(1)
  orderIndex    Int
  createdAt     DateTime     @default(now())
  TestAnswer    TestAnswer[]
  Test          Test         @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
}

model TestSession {
  id                  String            @id
  applicationId       String?
  testId              String?
  testTemplateId      String?
  status              TestSessionStatus @default(ACTIVE)
  startedAt           DateTime          @default(now())
  endsAt              DateTime
  submittedAt         DateTime?
  score               Float?
  totalQuestions      Int
  correctAnswers      Int               @default(0)
  isPassed            Boolean?
  tabSwitchCount      Int               @default(0)
  warningCount        Int               @default(0)
  questionOrder       Int[]
  selectedQuestionIds String[]
  answeredCount       Int               @default(0)
  createdAt           DateTime          @default(now())
  TestAnswer          TestAnswer[]
  TestEvent           TestEvent[]
  JobApplication      JobApplication?   @relation(fields: [applicationId], references: [id])
  Test                Test?             @relation(fields: [testId], references: [id])
  TestTemplate        TestTemplate?     @relation(fields: [testTemplateId], references: [id])

  @@index([applicationId])
  @@index([status])
  @@index([testId])
  @@index([testTemplateId])
}

model TestTemplate {
  id                String        @id
  name              String
  description       String?
  testType          TestType      @default(RAPID_FIRE)
  duration          Int           @default(20)
  passingCriteria   Float         @default(70.0)
  questionPoolSize  Int           @default(100)
  autoSelect        Boolean       @default(true)
  selectionTags     String[]
  selectionRoleType String?
  allowSkip         Boolean       @default(true)
  showLiveScore     Boolean       @default(false)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime
  isActive          Boolean       @default(true)
  SkillBucket       SkillBucket[]
  TestSession       TestSession[]

  @@index([isActive])
  @@index([testType])
}

model User {
  id                 String               @id
  email              String               @unique
  phone              String?              @unique
  passwordHash       String?
  role               UserRole             @default(CANDIDATE)
  status             UserStatus           @default(PENDING)
  emailVerified      Boolean              @default(false)
  phoneVerified      Boolean              @default(false)
  googleId           String?              @unique
  authProvider       String               @default("email")
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  lastLoginAt        DateTime?
  AuditLog           AuditLog[]
  Candidate          Candidate?
  DeviceLog          DeviceLog[]
  Employee           Employee?
  HR                 HR?
  Notification       Notification[]
  OTPToken           OTPToken[]
  PasswordResetToken PasswordResetToken[]
  RefreshToken       RefreshToken[]

  @@index([email])
  @@index([googleId])
  @@index([phone])
  @@index([role])
  @@index([status])
}

enum ApplicationStatus {
  APPLIED
  TEST_PENDING
  TEST_REQUIRED
  TEST_IN_PROGRESS
  TEST_PASSED
  TEST_FAILED
  REFERRAL_PENDING
  REFERRAL_CONFIRMED
  INTERVIEW_REQUESTED
  INTERVIEW_CONFIRMED
  PAYMENT_PENDING
  PAYMENT_SUCCESS
  INTERVIEW_COMPLETED
  CANDIDATE_NO_SHOW
  HR_NO_SHOW
  CONTACT_UNLOCKED
  CLOSED
  EXPIRED
  REJECTED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  TEST_START
  TEST_SUBMIT
  TEST_TAB_SWITCH
  PAYMENT_INITIATED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  REFUND_REQUESTED
  REFUND_PROCESSED
  ADMIN_OVERRIDE
}

enum EarningStatus {
  PENDING
  ELIGIBLE
  PROCESSING
  PAID
  CANCELLED
}

enum HRApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum InterviewMode {
  CALL
  VIDEO
  ONSITE
}

enum InterviewStatus {
  INTERVIEW_CONFIRMED
  PAYMENT_PENDING
  PAYMENT_SUCCESS
  INTERVIEW_COMPLETED
  CANDIDATE_NO_SHOW
  HR_NO_SHOW
  CANCELLED
}

enum JobStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  EXPIRED
  CLOSED
}

enum NotificationType {
  EMAIL
  SMS
  PUSH
}

enum PaymentStatus {
  ELIGIBLE
  ORDER_CREATED
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum QuestionCategory {
  TECHNICAL
  BEHAVIORAL
  APTITUDE
  DOMAIN_SPECIFIC
}

enum QuestionDifficulty {
  EASY
  MEDIUM
  HARD
}

enum ReferralStatus {
  PENDING
  CONFIRMED
  PAYMENT_PENDING
  CONTACTED
  CLOSED
  EXPIRED
}

enum ReferralType {
  EMPLOYEE
  HR_DIRECT
}

enum RefundStatus {
  REQUESTED
  APPROVED
  REJECTED
  PROCESSED
}

enum TestSessionStatus {
  ACTIVE
  SUBMITTED
  AUTO_SUBMITTED
  EXPIRED
}

enum TestType {
  STANDARD
  RAPID_FIRE
}

enum UserRole {
  CANDIDATE
  HR
  EMPLOYEE
  ADMIN
}

enum UserStatus {
  PENDING
  ACTIVE
  BLOCKED
  DELETED
}
